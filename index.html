<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>MyStudySpace Ultimate ğŸš€</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           DESIGN SYSTEM â€” THÃˆMES
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        :root {
            --primary: #6366f1;
            --primary-light: #818cf8;
            --secondary: #8b5cf6;
            --accent: #ec4899;
            --bg-main: #f1f5f9;
            --bg-card: #ffffff;
            --bg-nav: rgba(255,255,255,0.85);
            --text-main: #0f172a;
            --text-soft: #64748b;
            --border: #e2e8f0;
            --shadow-sm: 0 1px 3px rgba(0,0,0,.06), 0 1px 2px rgba(0,0,0,.04);
            --shadow-md: 0 4px 16px rgba(0,0,0,.08);
            --shadow-lg: 0 12px 40px rgba(0,0,0,.12);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
        }

        /* â”€â”€ ThÃ¨me sombre â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        [data-theme="dark"] {
            --primary: #818cf8;
            --primary-light: #a5b4fc;
            --secondary: #a78bfa;
            --accent: #f472b6;
            --bg-main: #0b0f1a;
            --bg-card: #141926;
            --bg-nav: rgba(14,18,31,0.92);
            --text-main: #e2e8f0;
            --text-soft: #94a3b8;
            --border: #1e2a3a;
            --shadow-sm: 0 1px 3px rgba(0,0,0,.3);
            --shadow-md: 0 4px 16px rgba(0,0,0,.4);
            --shadow-lg: 0 12px 40px rgba(0,0,0,.5);
        }
        [data-theme="dark"] input,
        [data-theme="dark"] select,
        [data-theme="dark"] textarea {
            background: #1e2a3a; color: #e2e8f0; border-color: #1e2a3a;
        }
        [data-theme="dark"] input::placeholder,
        [data-theme="dark"] textarea::placeholder { color: #475569; }
        [data-theme="dark"] option { background: #141926; color: #e2e8f0; }

        /* â”€â”€ ThÃ¨me OcÃ©an â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  */
        [data-theme="ocean"] {
            --primary: #0ea5e9; --primary-light: #38bdf8;
            --secondary: #06b6d4; --accent: #22d3ee;
            --bg-main: #f0f9ff; --bg-card: #ffffff;
            --bg-nav: rgba(255,255,255,0.9);
            --text-main: #0c4a6e; --text-soft: #0369a1; --border: #bae6fd;
        }
        /* â”€â”€ ThÃ¨me Coucher de soleil â”€ */
        [data-theme="sunset"] {
            --primary: #f97316; --primary-light: #fb923c;
            --secondary: #ef4444; --accent: #fbbf24;
            --bg-main: #fff7ed; --bg-card: #ffffff;
            --bg-nav: rgba(255,255,255,0.9);
            --text-main: #431407; --text-soft: #9a3412; --border: #fed7aa;
        }
        /* â”€â”€ ThÃ¨me ForÃªt â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        [data-theme="forest"] {
            --primary: #22c55e; --primary-light: #4ade80;
            --secondary: #10b981; --accent: #84cc16;
            --bg-main: #f0fdf4; --bg-card: #ffffff;
            --bg-nav: rgba(255,255,255,0.9);
            --text-main: #052e16; --text-soft: #166534; --border: #bbf7d0;
        }
        /* â”€â”€ ThÃ¨me Minuit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        [data-theme="midnight"] {
            --primary: #c084fc; --primary-light: #d8b4fe;
            --secondary: #e879f9; --accent: #67e8f9;
            --bg-main: #04020f; --bg-card: #0d0820;
            --bg-nav: rgba(4,2,15,0.95);
            --text-main: #f0e6ff; --text-soft: #a78bfa; --border: #1e1040;
            --shadow-sm: 0 1px 3px rgba(100,0,200,.2);
            --shadow-md: 0 4px 16px rgba(100,0,200,.3);
        }
        [data-theme="midnight"] input,
        [data-theme="midnight"] select,
        [data-theme="midnight"] textarea {
            background: #1e1040; color: #f0e6ff; border-color: #1e1040;
        }
        /* â”€â”€ ThÃ¨me RosÃ© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        [data-theme="rose"] {
            --primary: #f43f5e; --primary-light: #fb7185;
            --secondary: #e11d48; --accent: #fb923c;
            --bg-main: #fff1f2; --bg-card: #ffffff;
            --bg-nav: rgba(255,255,255,0.9);
            --text-main: #4c0519; --text-soft: #9f1239; --border: #fecdd3;
        }
        /* â”€â”€ ThÃ¨me Nord â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        [data-theme="nord"] {
            --primary: #88c0d0; --primary-light: #8fbcbb;
            --secondary: #81a1c1; --accent: #a3be8c;
            --bg-main: #2e3440; --bg-card: #3b4252;
            --bg-nav: rgba(46,52,64,0.95);
            --text-main: #eceff4; --text-soft: #d8dee9; --border: #434c5e;
            --shadow-sm: 0 1px 3px rgba(0,0,0,.3);
            --shadow-md: 0 4px 16px rgba(0,0,0,.4);
        }
        [data-theme="nord"] input,
        [data-theme="nord"] select,
        [data-theme="nord"] textarea {
            background: #434c5e; color: #eceff4; border-color: #4c566a;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           THÃˆMES SUPER-HÃ‰ROS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        /* â”€â”€ Spider-Man ğŸ•·ï¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        [data-theme="spiderman"] {
            --primary: #e23636; --primary-light: #ff5252;
            --secondary: #0d47a1; --accent: #ffffff;
            --bg-main: #1a1a1a; --bg-card: #2d2d2d;
            --bg-nav: rgba(226,54,54,0.95);
            --text-main: #ffffff; --text-soft: #b0b0b0; --border: #3d3d3d;
            --shadow-sm: 0 1px 3px rgba(226,54,54,.3);
            --shadow-md: 0 4px 16px rgba(226,54,54,.4);
        }
        [data-theme="spiderman"] input,
        [data-theme="spiderman"] select,
        [data-theme="spiderman"] textarea {
            background: #3d3d3d; color: #ffffff; border-color: #e23636;
        }

        /* â”€â”€ Batman ğŸ¦‡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        [data-theme="batman"] {
            --primary: #ffd700; --primary-light: #ffe44d;
            --secondary: #1a1a1a; --accent: #ffd700;
            --bg-main: #0a0a0a; --bg-card: #1a1a1a;
            --bg-nav: rgba(26,26,26,0.98);
            --text-main: #ffffff; --text-soft: #888888; --border: #2d2d2d;
            --shadow-sm: 0 1px 3px rgba(255,215,0,.2);
            --shadow-md: 0 4px 16px rgba(255,215,0,.3);
            --shadow-lg: 0 12px 40px rgba(255,215,0,.4);
        }
        [data-theme="batman"] input,
        [data-theme="batman"] select,
        [data-theme="batman"] textarea {
            background: #2d2d2d; color: #ffffff; border-color: #ffd700;
        }

        /* â”€â”€ Iron Man ğŸ¤– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        [data-theme="ironman"] {
            --primary: #dc143c; --primary-light: #ff1744;
            --secondary: #ffd700; --accent: #c0c0c0;
            --bg-main: #1a0000; --bg-card: #2d0a0a;
            --bg-nav: rgba(220,20,60,0.95);
            --text-main: #ffffff; --text-soft: #ffb3b3; --border: #4d1a1a;
            --shadow-sm: 0 1px 3px rgba(220,20,60,.3);
            --shadow-md: 0 4px 16px rgba(220,20,60,.4);
        }
        [data-theme="ironman"] input,
        [data-theme="ironman"] select,
        [data-theme="ironman"] textarea {
            background: #4d1a1a; color: #ffffff; border-color: #dc143c;
        }

        /* â”€â”€ Hulk ğŸ’ª â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        [data-theme="hulk"] {
            --primary: #00ff00; --primary-light: #4dff4d;
            --secondary: #9933ff; --accent: #ffffff;
            --bg-main: #0a1a0a; --bg-card: #1a2d1a;
            --bg-nav: rgba(0,255,0,0.15);
            --text-main: #00ff00; --text-soft: #66ff66; --border: #2d4d2d;
            --shadow-sm: 0 1px 3px rgba(0,255,0,.3);
            --shadow-md: 0 4px 16px rgba(0,255,0,.4);
        }
        [data-theme="hulk"] input,
        [data-theme="hulk"] select,
        [data-theme="hulk"] textarea {
            background: #2d4d2d; color: #00ff00; border-color: #00ff00;
        }

        /* â”€â”€ Captain America ğŸ›¡ï¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        [data-theme="captain"] {
            --primary: #0d47a1; --primary-light: #1976d2;
            --secondary: #c62828; --accent: #ffffff;
            --bg-main: #e3f2fd; --bg-card: #ffffff;
            --bg-nav: rgba(13,71,161,0.9);
            --text-main: #0d47a1; --text-soft: #1976d2; --border: #90caf9;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           THÃˆMES MÃ‰TALLIQUES
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        /* â”€â”€ Chrome ğŸ”˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        [data-theme="chrome"] {
            --primary: #c0c0c0; --primary-light: #e0e0e0;
            --secondary: #808080; --accent: #ffffff;
            --bg-main: #1a1a1a; --bg-card: #2d2d2d;
            --bg-nav: rgba(192,192,192,0.15);
            --text-main: #ffffff; --text-soft: #c0c0c0; --border: #404040;
            --shadow-sm: 0 1px 3px rgba(192,192,192,.2);
            --shadow-md: 0 4px 16px rgba(192,192,192,.3);
        }
        [data-theme="chrome"] input,
        [data-theme="chrome"] select,
        [data-theme="chrome"] textarea {
            background: #404040; color: #ffffff; border-color: #808080;
        }

        /* â”€â”€ Or ğŸ¥‡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        [data-theme="gold"] {
            --primary: #ffd700; --primary-light: #ffed4e;
            --secondary: #ff8c00; --accent: #ffffff;
            --bg-main: #1a1506; --bg-card: #2d2410;
            --bg-nav: rgba(255,215,0,0.15);
            --text-main: #ffd700; --text-soft: #ffed4e; --border: #4d3810;
            --shadow-sm: 0 1px 3px rgba(255,215,0,.3);
            --shadow-md: 0 4px 16px rgba(255,215,0,.4);
        }
        [data-theme="gold"] input,
        [data-theme="gold"] select,
        [data-theme="gold"] textarea {
            background: #4d3810; color: #ffd700; border-color: #ffd700;
        }

        /* â”€â”€ Cuivre ğŸŸ  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        [data-theme="copper"] {
            --primary: #b87333; --primary-light: #d4935b;
            --secondary: #8b4513; --accent: #cd853f;
            --bg-main: #1a0f08; --bg-card: #2d1810;
            --bg-nav: rgba(184,115,51,0.15);
            --text-main: #d4935b; --text-soft: #b87333; --border: #4d2810;
            --shadow-sm: 0 1px 3px rgba(184,115,51,.3);
            --shadow-md: 0 4px 16px rgba(184,115,51,.4);
        }
        [data-theme="copper"] input,
        [data-theme="copper"] select,
        [data-theme="copper"] textarea {
            background: #4d2810; color: #d4935b; border-color: #b87333;
        }

        /* â”€â”€ Acier ğŸ”© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        [data-theme="steel"] {
            --primary: #b0c4de; --primary-light: #d3e0f0;
            --secondary: #708090; --accent: #f0f8ff;
            --bg-main: #0f1419; --bg-card: #1a2128;
            --bg-nav: rgba(176,196,222,0.12);
            --text-main: #e0e8f0; --text-soft: #b0c4de; --border: #2d3a47;
            --shadow-sm: 0 1px 3px rgba(176,196,222,.2);
            --shadow-md: 0 4px 16px rgba(176,196,222,.3);
        }
        [data-theme="steel"] input,
        [data-theme="steel"] select,
        [data-theme="steel"] textarea {
            background: #2d3a47; color: #e0e8f0; border-color: #708090;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           THÃˆMES SPÃ‰CIAUX
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        /* â”€â”€ Matrix ğŸŸ¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        [data-theme="matrix"] {
            --primary: #00ff41; --primary-light: #39ff6f;
            --secondary: #008f11; --accent: #00ff41;
            --bg-main: #000000; --bg-card: #0a0a0a;
            --bg-nav: rgba(0,255,65,0.05);
            --text-main: #00ff41; --text-soft: #008f11; --border: #003b00;
            --shadow-sm: 0 1px 3px rgba(0,255,65,.3);
            --shadow-md: 0 4px 16px rgba(0,255,65,.4);
        }
        [data-theme="matrix"] input,
        [data-theme="matrix"] select,
        [data-theme="matrix"] textarea {
            background: #0a0a0a; color: #00ff41; border-color: #008f11;
        }

        /* â”€â”€ Neon ğŸ’¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        [data-theme="neon"] {
            --primary: #ff00ff; --primary-light: #ff4dff;
            --secondary: #00ffff; --accent: #ffff00;
            --bg-main: #0a0014; --bg-card: #1a0028;
            --bg-nav: rgba(255,0,255,0.1);
            --text-main: #ff00ff; --text-soft: #ff4dff; --border: #330066;
            --shadow-sm: 0 1px 3px rgba(255,0,255,.4);
            --shadow-md: 0 4px 16px rgba(255,0,255,.5);
        }
        [data-theme="neon"] input,
        [data-theme="neon"] select,
        [data-theme="neon"] textarea {
            background: #1a0028; color: #ff00ff; border-color: #ff00ff;
        }

        /* â”€â”€ Cyberpunk ğŸŒ† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        [data-theme="cyberpunk"] {
            --primary: #ff0080; --primary-light: #ff4da6;
            --secondary: #00d4ff; --accent: #ffff00;
            --bg-main: #0d0221; --bg-card: #1a0440;
            --bg-nav: rgba(255,0,128,0.15);
            --text-main: #ff0080; --text-soft: #ff4da6; --border: #2d0850;
            --shadow-sm: 0 1px 3px rgba(255,0,128,.3);
            --shadow-md: 0 4px 16px rgba(255,0,128,.4);
        }
        [data-theme="cyberpunk"] input,
        [data-theme="cyberpunk"] select,
        [data-theme="cyberpunk"] textarea {
            background: #2d0850; color: #ff0080; border-color: #ff0080;
        }

        /* â”€â”€ Retro ğŸ“¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        [data-theme="retro"] {
            --primary: #ff6b35; --primary-light: #ff8c5a;
            --secondary: #f7931e; --accent: #fdc02f;
            --bg-main: #f4e8c1; --bg-card: #ffffff;
            --bg-nav: rgba(255,107,53,0.1);
            --text-main: #2c1810; --text-soft: #8b4513; --border: #e6d5b8;
        }

        /* â”€â”€ Galaxy ğŸŒŒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        [data-theme="galaxy"] {
            --primary: #9d4edd; --primary-light: #c77dff;
            --secondary: #7209b7; --accent: #f72585;
            --bg-main: #10002b; --bg-card: #240046;
            --bg-nav: rgba(157,78,221,0.15);
            --text-main: #e0aaff; --text-soft: #c77dff; --border: #3c096c;
            --shadow-sm: 0 1px 3px rgba(157,78,221,.3);
            --shadow-md: 0 4px 16px rgba(157,78,221,.4);
        }
        [data-theme="galaxy"] input,
        [data-theme="galaxy"] select,
        [data-theme="galaxy"] textarea {
            background: #3c096c; color: #e0aaff; border-color: #9d4edd;
        }

        /* â”€â”€ Lava ğŸŒ‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        [data-theme="lava"] {
            --primary: #ff4500; --primary-light: #ff6347;
            --secondary: #dc143c; --accent: #ffa500;
            --bg-main: #1a0000; --bg-card: #2d0a00;
            --bg-nav: rgba(255,69,0,0.15);
            --text-main: #ff4500; --text-soft: #ff6347; --border: #4d1400;
            --shadow-sm: 0 1px 3px rgba(255,69,0,.3);
            --shadow-md: 0 4px 16px rgba(255,69,0,.4);
        }
        [data-theme="lava"] input,
        [data-theme="lava"] select,
        [data-theme="lava"] textarea {
            background: #4d1400; color: #ff4500; border-color: #ff4500;
        }

        /* â”€â”€ Ice ğŸ§Š â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        [data-theme="ice"] {
            --primary: #00bfff; --primary-light: #4dd2ff;
            --secondary: #87ceeb; --accent: #b0e0e6;
            --bg-main: #0a1a2e; --bg-card: #16213e;
            --bg-nav: rgba(0,191,255,0.12);
            --text-main: #e6f7ff; --text-soft: #87ceeb; --border: #1f4068;
            --shadow-sm: 0 1px 3px rgba(0,191,255,.3);
            --shadow-md: 0 4px 16px rgba(0,191,255,.4);
        }
        [data-theme="ice"] input,
        [data-theme="ice"] select,
        [data-theme="ice"] textarea {
            background: #1f4068; color: #e6f7ff; border-color: #00bfff;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           BASE
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        *, *::before, *::after { box-sizing: border-box; }
        
        html {
            min-width: 320px;
            overflow-x: hidden;
            /* Forcer le zoom Ã  100% */
            zoom: 1.0;
            -moz-transform: scale(1.0);
            -webkit-transform: scale(1.0);
            transform: scale(1.0);
        }

        body {
            font-family: 'Plus Jakarta Sans', 'Segoe UI', sans-serif;
            background: var(--bg-main);
            color: var(--text-main);
            transition: background 0.4s ease, color 0.4s ease;
            -webkit-font-smoothing: antialiased;
            min-width: 320px;
            overflow-x: hidden;
            /* Forcer le zoom Ã  100% */
            zoom: 1.0;
            -moz-transform: scale(1.0);
            -webkit-transform: scale(1.0);
            transform: scale(1.0);
            transform-origin: top left;
        }

        input, select, textarea {
            background: var(--bg-card);
            color: var(--text-main);
            transition: border-color .2s, box-shadow .2s;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary) 25%, transparent);
            border-color: var(--primary) !important;
        }
        input::placeholder, textarea::placeholder { color: var(--text-soft); opacity: .7; }

        /* Scrollbars stylisÃ©es */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 99px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           NAVIGATION
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        nav.card {
            background: var(--bg-nav) !important;
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid var(--border) !important;
            border-radius: 0 !important;
            box-shadow: var(--shadow-sm) !important;
        }

        .nav-item {
            position: relative;
            padding: 6px 12px;
            border-radius: var(--radius-sm);
            font-size: 0.82rem;
            font-weight: 600;
            color: var(--text-soft);
            transition: color .2s, background .2s;
            border-bottom: none !important;
            white-space: nowrap;
        }
        .nav-item:hover { color: var(--primary); background: color-mix(in srgb, var(--primary) 8%, transparent); }
        .nav-item.active {
            color: var(--primary);
            background: color-mix(in srgb, var(--primary) 12%, transparent);
            border-bottom: none !important;
        }
        .nav-item.active::after {
            content: '';
            position: absolute;
            bottom: -2px; left: 20%; right: 20%;
            height: 2px;
            background: var(--primary);
            border-radius: 99px;
        }

        /* â”€â”€ Boutons de la nav (ENT, Mail, Settings) â”€â”€â”€ */
        .nav-pill {
            display: flex; align-items: center; gap: 6px;
            padding: 6px 14px;
            border-radius: var(--radius-md);
            font-size: 0.82rem; font-weight: 700;
            transition: all .2s; cursor: pointer;
            border: none;
        }
        .nav-pill:hover { filter: brightness(1.1); transform: translateY(-1px); box-shadow: var(--shadow-md); }
        .nav-pill:active { transform: translateY(0); }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           CARDS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            transition: transform .3s ease, box-shadow .3s ease;
        }
        @media (hover: hover) {
            .card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        }

        /* â”€â”€ Stat cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .stat-card {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: var(--radius-lg);
            padding: 20px;
            position: relative; overflow: hidden;
            box-shadow: var(--shadow-md);
        }
        .stat-card::before {
            content: '';
            position: absolute; top: -30%; right: -10%;
            width: 120px; height: 120px;
            background: rgba(255,255,255,.1);
            border-radius: 50%;
        }
        .stat-card::after {
            content: '';
            position: absolute; bottom: -40%; right: 10%;
            width: 80px; height: 80px;
            background: rgba(255,255,255,.07);
            border-radius: 50%;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           BOUTONS PRIMAIRES
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .btn-primary {
            display: inline-flex; align-items: center; gap: 8px;
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white; font-weight: 700; font-size: 0.875rem;
            border: none; border-radius: var(--radius-md);
            cursor: pointer; transition: all .2s;
            box-shadow: 0 2px 8px color-mix(in srgb, var(--primary) 40%, transparent);
        }
        .btn-primary:hover { filter: brightness(1.1); transform: translateY(-1px); box-shadow: 0 6px 20px color-mix(in srgb, var(--primary) 40%, transparent); }
        .btn-primary:active { transform: translateY(0); filter: brightness(0.98); }

        .btn-ghost {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 8px 16px;
            background: transparent; border: 1.5px solid var(--border);
            color: var(--text-main); font-weight: 600; font-size: 0.82rem;
            border-radius: var(--radius-md); cursor: pointer; transition: all .2s;
        }
        .btn-ghost:hover { border-color: var(--primary); color: var(--primary); background: color-mix(in srgb, var(--primary) 6%, transparent); }

        .btn-danger {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 8px 16px;
            background: transparent; border: 1.5px solid #fca5a5;
            color: #ef4444; font-weight: 600; font-size: 0.82rem;
            border-radius: var(--radius-md); cursor: pointer; transition: all .2s;
        }
        .btn-danger:hover { background: #fef2f2; border-color: #ef4444; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           FILTER BUTTONS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .filter-btn {
            padding: 6px 16px; border-radius: 99px;
            font-size: 0.8rem; font-weight: 600;
            border: 1.5px solid var(--border);
            color: var(--text-soft);
            background: transparent;
            cursor: pointer; transition: all .2s;
        }
        .filter-btn:hover { border-color: var(--primary); color: var(--primary); }
        .filter-btn.active {
            background: var(--primary); color: white;
            border-color: var(--primary);
            box-shadow: 0 2px 8px color-mix(in srgb, var(--primary) 40%, transparent);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           BADGES
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .badge {
            display: inline-flex; align-items: center;
            padding: 3px 10px;
            border-radius: 99px;
            font-size: 0.72rem; font-weight: 700;
            letter-spacing: .02em;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           PLANNING / SCHEDULE
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .schedule-grid {
            display: grid;
            background: var(--border);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }
        .schedule-grid > * { outline: 1px solid var(--border); }

        .schedule-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 12px 8px;
            font-weight: 700; font-size: 0.8rem;
            text-align: center;
        }
        .schedule-cell {
            background: var(--bg-card);
            min-height: 70px; padding: 8px;
            font-size: 0.82rem;
            transition: background .15s;
            position: relative;
        }
        .schedule-cell:hover { background: color-mix(in srgb, var(--primary) 4%, var(--bg-card)); }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           PROGRESS BARS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .progress-bar {
            background: color-mix(in srgb, var(--primary) 15%, transparent);
            border-radius: 99px; overflow: hidden; height: 7px;
        }
        .progress-fill {
            background: linear-gradient(90deg, var(--primary), var(--accent));
            height: 100%; transition: width .6s cubic-bezier(.4,0,.2,1);
            border-radius: 99px;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           MODALS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .modal {
            display: none; position: fixed;
            inset: 0;
            background: rgba(0,0,0,.45);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center; justify-content: center;
            padding: 16px;
        }
        .modal.active { display: flex; animation: fadeIn .25s ease; }
        .modal-content {
            background: var(--bg-card);
            padding: 28px;
            border-radius: var(--radius-xl);
            max-width: 600px; width: 100%;
            max-height: 88vh; overflow-y: auto;
            color: var(--text-main);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           GRADIENT TEXT
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .gradient-text {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           NOTIFICATIONS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .notification {
            position: fixed; top: 72px; right: 16px;
            background: var(--bg-card);
            padding: 14px 20px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            border-left: 3px solid var(--primary);
            z-index: 2000;
            animation: notifIn .3s cubic-bezier(.34,1.56,.64,1);
            font-weight: 600; font-size: 0.875rem;
            max-width: 320px;
        }
        @keyframes notifIn {
            from { opacity: 0; transform: translateX(20px) scale(.95); }
            to   { opacity: 1; transform: translateX(0) scale(1); }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           FLOATING ACTION BUTTON
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .floating-action {
            position: fixed; bottom: 28px; right: 28px;
            width: 56px; height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            box-shadow: 0 8px 24px color-mix(in srgb, var(--primary) 50%, transparent);
            transition: all .3s cubic-bezier(.34,1.56,.64,1);
            z-index: 100; border: none;
        }
        .floating-action:hover { transform: scale(1.12) rotate(90deg); box-shadow: 0 12px 32px color-mix(in srgb, var(--primary) 60%, transparent); }
        .floating-action:active { transform: scale(0.95); }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           EMOJI PICKER
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .emoji-picker { display: grid; grid-template-columns: repeat(8,1fr); gap: 6px; max-height: 200px; overflow-y: auto; }
        .emoji-btn { font-size: 1.4rem; cursor: pointer; padding: 6px; border-radius: var(--radius-sm); transition: all .15s; text-align: center; }
        .emoji-btn:hover { background: var(--border); transform: scale(1.2); }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ANIMATIONS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn .3s ease; }

        @keyframes fadeIn { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }
        @keyframes slideIn { from { transform:translateX(-100%); opacity:0; } to { transform:translateX(0); opacity:1; } }
        @keyframes pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.08)} }

        .streak-flame { animation: pulse 1.2s ease infinite; }
        .confetti { position:fixed; width:9px; height:9px; background:var(--primary); animation:fall 3s linear; border-radius: 2px; }
        @keyframes fall { to { transform:translateY(100vh) rotate(360deg); opacity:0; } }

        /* â”€â”€ Animations au chargement des cartes â”€â”€â”€ */
        .course-card { animation: fadeIn .3s ease both; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           RESPONSIVE â€” MOBILE PORTRAIT
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        @media (max-width: 640px) {
            body { font-size: 14px; }
            .modal-content { padding: 20px; border-radius: var(--radius-lg); }
            .notification { right: 10px; left: 10px; top: 68px; }
            .floating-action { bottom: 16px; right: 16px; width: 52px; height: 52px; }
            h2, h3 { font-size: 1.2rem !important; }
            h4 { font-size: 0.95rem !important; }
            .stat-card .text-4xl { font-size: 1.9rem !important; }
            .badge:not(:first-child):not(:nth-child(2)) { display: none; }
            .space-y-6 > * + * { margin-top: 0.875rem !important; }
            .p-6 { padding: 1rem !important; }
            .p-5 { padding: 0.875rem !important; }
            .schedule-grid { font-size: 0.68rem; grid-template-columns: 52px repeat(5, minmax(90px,1fr)) !important; }
            .schedule-header { padding: 8px 4px; font-size: 0.68rem; }
            .schedule-cell { min-height: 60px; padding: 4px; font-size: 0.65rem; }
            input[type="file"] { font-size: 0.72rem; }
        }

        /* â”€ Mobile paysage â”€â”€â”€ */
        @media (max-height: 480px) and (orientation: landscape) {
            .modal-content { max-height: 96vh; }
            .stat-card { padding: 12px 16px; }
            .stat-card .text-4xl { font-size: 1.6rem !important; }
        }

        /* â”€ Tablette portrait â”€â”€â”€ */
        @media (min-width: 641px) and (max-width: 1024px) {
            .schedule-grid { grid-template-columns: 64px repeat(5,1fr) !important; }
            .stat-card .text-4xl { font-size: 2.4rem !important; }
            .modal-content { max-width: 78%; }
        }

        /* â”€ Tablette paysage â”€â”€â”€ */
        @media (min-width: 768px) and (max-width: 1024px) and (orientation: landscape) {
            .grid.md\:grid-cols-4 { grid-template-columns: repeat(4,1fr) !important; }
        }

        /* â”€ Desktop large â”€â”€â”€ */
        @media (min-width: 1280px) {
            .schedule-grid { min-width: 960px; }
            .overflow-y-auto { scrollbar-width: thin; scrollbar-color: var(--primary) var(--border); }
        }
        @media (min-width: 1536px) { .max-w-7xl { max-width: 90rem; } }

        /* â”€ Touch devices â”€â”€â”€ */
        @media (hover: none) and (pointer: coarse) {
            button, .nav-item, .filter-btn, .nav-pill { min-height: 42px; }
            .card:hover { transform: none; box-shadow: var(--shadow-sm); }
            .schedule-cell:hover { background: var(--bg-card); }
            input[type="checkbox"] { width: 20px; height: 20px; }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           SETTINGS PANEL CUSTOM
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .theme-swatch {
            border-radius: var(--radius-md);
            cursor: pointer; overflow: hidden;
            border: 2px solid transparent;
            transition: all .2s;
            aspect-ratio: 4/3;
        }
        .theme-swatch:hover { transform: scale(1.04); box-shadow: var(--shadow-md); }
        .theme-swatch.active { border-color: var(--primary); box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary) 30%, transparent); }

        /* Settings tabs */
        .settings-tab-btn {
            flex: 1; padding: 8px 4px;
            font-size: 0.75rem; font-weight: 700;
            border: none; background: transparent;
            color: var(--text-soft);
            border-bottom: 2px solid transparent;
            cursor: pointer; transition: all .2s;
        }
        .settings-tab-btn.active { color: var(--primary); border-color: var(--primary); }

        .settings-panel { display: none; }
        .settings-panel.active { display: block; animation: fadeIn .2s ease; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           NAV MOBILE â€” bottom bar
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .nav-item-mobile {
            transition: all .2s;
            border-radius: var(--radius-sm);
        }
        .nav-item-mobile.active {
            background: var(--primary) !important;
            color: white !important; font-weight: 700;
        }
        .nav-item-mobile:hover { background: var(--border) !important; }
        [data-theme="dark"] .nav-item-mobile:hover { background: #1e2a3a !important; }

        /* â”€ Quick action cards â”€â”€â”€ */
        .quick-action-card {
            display: flex; flex-direction: column; align-items: center;
            padding: 16px 8px; border-radius: var(--radius-md);
            border: 1.5px dashed var(--border);
            background: transparent;
            cursor: pointer; transition: all .2s;
            color: var(--text-main);
        }
        .quick-action-card:hover {
            border-style: solid;
            background: color-mix(in srgb, var(--primary) 5%, transparent);
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }
        .quick-action-card:active { transform: translateY(0); }
    </style>
</head>
<body>

    <!-- Navigation Premium -->
    <nav class="card sticky top-0 z-50 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center space-x-4">
                    <span class="text-2xl font-bold gradient-text" title="DÃ©veloppÃ© par Mathieu Mercera">
                        <i class="fas fa-graduation-cap"></i> <span class="hidden sm:inline">MyStudySpace</span>
                    </span>
                    <span class="badge hidden md:inline" style="background: var(--primary); color: white;">ULTIMATE</span>
                </div>
                
                <!-- Navigation Desktop -->
                <div class="hidden lg:flex space-x-6 items-center">
                    <button onclick="showTab('dashboard')" class="nav-item active px-3 py-2 text-sm font-medium hover:text-blue-600">
                        <i class="fas fa-home mr-1"></i> Dashboard
                    </button>
                    <button onclick="showTab('courses')" class="nav-item px-3 py-2 text-sm font-medium hover:text-blue-600">
                        <i class="fas fa-book mr-1"></i> Cours
                    </button>
                    <button onclick="showTab('schedule')" class="nav-item px-3 py-2 text-sm font-medium hover:text-blue-600">
                        <i class="fas fa-calendar mr-1"></i> Planning
                    </button>
                    <button onclick="showTab('grades')" class="nav-item px-3 py-2 text-sm font-medium hover:text-blue-600">
                        <i class="fas fa-chart-line mr-1"></i> Notes
                    </button>
                    <button onclick="showTab('stats')" class="nav-item px-3 py-2 text-sm font-medium hover:text-blue-600">
                        <i class="fas fa-chart-bar mr-1"></i> Stats
                    </button>
                    <button onclick="showTab('tasks')" class="nav-item px-3 py-2 text-sm font-medium hover:text-blue-600">
                        <i class="fas fa-tasks mr-1"></i> TÃ¢ches
                    </button>
                    <a href="https://ent.univ-amu.fr/" target="_blank" rel="noopener noreferrer"
                       class="nav-pill" style="background:linear-gradient(135deg,var(--primary),var(--secondary)); color:white;"
                       title="ENT AMU">
                        <i class="fas fa-university"></i>
                        <span class="hidden xl:inline">ENT</span>
                    </a>
                    <a href="https://outlook.cloud.microsoft/mail/?realm=etu.univ-amu.fr" target="_blank" rel="noopener noreferrer"
                       class="nav-pill" style="background:linear-gradient(135deg,#0078d4,#106ebe); color:white;"
                       title="Mails AMU">
                        <i class="fas fa-envelope"></i>
                        <span class="hidden xl:inline">Mails</span>
                    </a>
                    <button onclick="openSettings()" class="nav-pill btn-ghost" title="ParamÃ¨tres">
                        <i class="fas fa-sliders-h"></i>
                    </button>
                </div>

                <!-- Navigation Mobile -->
                <div class="flex lg:hidden items-center gap-2">
                    <a href="https://ent.univ-amu.fr/" target="_blank" rel="noopener noreferrer"
                       class="nav-pill" style="background:linear-gradient(135deg,var(--primary),var(--secondary)); color:white;" title="ENT">
                        <i class="fas fa-university text-sm"></i>
                    </a>
                    <a href="https://outlook.cloud.microsoft/mail/?realm=etu.univ-amu.fr" target="_blank" rel="noopener noreferrer"
                       class="nav-pill" style="background:linear-gradient(135deg,#0078d4,#106ebe); color:white;" title="Mails">
                        <i class="fas fa-envelope text-sm"></i>
                    </a>
                    <button onclick="openSettings()" class="nav-pill btn-ghost" title="ParamÃ¨tres">
                        <i class="fas fa-sliders-h text-sm"></i>
                    </button>
                    <button onclick="toggleMobileMenu()" class="px-3 py-2 text-sm font-medium hover:text-blue-600" id="mobileMenuBtn">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                </div>
            </div>

            <!-- Menu Mobile DÃ©roulant -->
            <div id="mobileMenu" class="lg:hidden hidden border-t pt-2 pb-3" style="border-color: var(--border);">
                <div class="flex flex-col space-y-1">
                    <button onclick="showTab('dashboard'); closeMobileMenu()" class="nav-item-mobile active px-3 py-3 text-sm font-medium text-left hover:bg-gray-50 rounded">
                        <i class="fas fa-home mr-2 w-5"></i> Dashboard
                    </button>
                    <button onclick="showTab('courses'); closeMobileMenu()" class="nav-item-mobile px-3 py-3 text-sm font-medium text-left hover:bg-gray-50 rounded">
                        <i class="fas fa-book mr-2 w-5"></i> Cours
                    </button>
                    <button onclick="showTab('schedule'); closeMobileMenu()" class="nav-item-mobile px-3 py-3 text-sm font-medium text-left hover:bg-gray-50 rounded">
                        <i class="fas fa-calendar mr-2 w-5"></i> Planning
                    </button>
                    <button onclick="showTab('grades'); closeMobileMenu()" class="nav-item-mobile px-3 py-3 text-sm font-medium text-left hover:bg-gray-50 rounded">
                        <i class="fas fa-chart-line mr-2 w-5"></i> Notes
                    </button>
                    <button onclick="showTab('stats'); closeMobileMenu()" class="nav-item-mobile px-3 py-3 text-sm font-medium text-left hover:bg-gray-50 rounded">
                        <i class="fas fa-chart-bar mr-2 w-5"></i> Stats
                    </button>
                    <button onclick="showTab('tasks'); closeMobileMenu()" class="nav-item-mobile px-3 py-3 text-sm font-medium text-left hover:bg-gray-50 rounded">
                        <i class="fas fa-tasks mr-2 w-5"></i> TÃ¢ches
                    </button>
                    <a href="https://ent.univ-amu.fr/" target="_blank" rel="noopener noreferrer"
                       class="nav-item-mobile px-3 py-3 text-sm font-medium text-left rounded flex items-center"
                       style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; margin-top: 4px;">
                        <i class="fas fa-university mr-2 w-5"></i> ENT AMU
                        <i class="fas fa-external-link-alt ml-auto text-xs opacity-70"></i>
                    </a>
                    <a href="https://outlook.cloud.microsoft/mail/?realm=etu.univ-amu.fr" target="_blank" rel="noopener noreferrer"
                       class="nav-item-mobile px-3 py-3 text-sm font-medium text-left rounded flex items-center"
                       style="background: linear-gradient(135deg, #0078d4, #106ebe); color: white; margin-top: 4px;">
                        <i class="fas fa-envelope mr-2 w-5"></i> Mails AMU
                        <i class="fas fa-external-link-alt ml-auto text-xs opacity-70"></i>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8" style="width: 100%;">

        <!-- DASHBOARD ULTIMATE -->
        <div id="dashboard" class="tab-content active space-y-6">
            
            <!-- Greeting personnalisÃ© -->
            <div class="card rounded-lg p-6 shadow-lg">
                <div class="flex justify-between items-start flex-wrap gap-2">
                    <div>
                        <h2 class="text-3xl font-bold mb-1" id="greeting">ğŸ‘‹ Salut champion !</h2>
                        <p class="text-sm opacity-60" id="motivational-quote">La rÃ©ussite commence par un effort quotidien.</p>
                    </div>
                    <div class="text-right flex-shrink-0">
                        <div id="live-clock" class="font-mono font-bold text-2xl" style="color:var(--primary); letter-spacing:.05em;">--:--:--</div>
                        <div class="text-xs opacity-50" id="dash-date"></div>
                    </div>
                </div>
            </div>

            <!-- Stats rapides -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="stat-card">
                    <div class="flex items-center justify-between mb-2">
                        <div>
                            <p class="text-sm opacity-80">Moyenne GÃ©nÃ©rale</p>
                            <p class="text-4xl font-bold mt-2" id="dash-global-avg">--/20</p>
                        </div>
                        <i class="fas fa-trophy text-5xl opacity-20"></i>
                    </div>
                    <div class="flex items-center gap-2 mb-2">
                        <select id="semesterSelector" onchange="updateDashboardAverage()" 
                            class="text-xs px-2 py-1 rounded border" 
                            style="border-color: var(--border); font-weight: 600;">
                            <option value="current">ğŸ“— Semestre actuel</option>
                            <option value="previous">ğŸ“˜ Semestre prÃ©cÃ©dent</option>
                        </select>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="avg-progress" style="width: 0%"></div>
                    </div>
                </div>

                <div class="stat-card" style="background: linear-gradient(135deg, #22c55e, #16a34a);">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm opacity-80">Fichiers stockÃ©s</p>
                            <p class="text-4xl font-bold mt-2" id="dash-files-count">0</p>
                        </div>
                        <i class="fas fa-file-alt text-5xl opacity-20"></i>
                    </div>
                </div>

                <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm opacity-80">SÃ©rie de travail</p>
                            <p class="text-4xl font-bold mt-2"><span id="streak-count">1</span> <i class="fas fa-fire streak-flame"></i></p>
                            <p class="text-xs opacity-70 mt-1">Record : <span id="streak-record">1</span> jours ğŸ†</p>
                        </div>
                        <i class="fas fa-bolt text-5xl opacity-20"></i>
                    </div>
                </div>

                <div class="stat-card" style="background: linear-gradient(135deg, #ec4899, #db2777);">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm opacity-80">TÃ¢ches complÃ©tÃ©es</p>
                            <p class="text-4xl font-bold mt-2"><span id="tasks-completed">0</span>/<span id="tasks-total">0</span></p>
                        </div>
                        <i class="fas fa-check-circle text-5xl opacity-20"></i>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card rounded-lg p-6 shadow-lg">
                <h3 class="text-xl font-bold mb-4">âš¡ Actions rapides</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4">
                    <button onclick="quickAddCourse()" class="p-3 md:p-4 rounded-lg border-2 border-dashed hover:border-solid transition" style="border-color: var(--primary);">
                        <i class="fas fa-plus-circle text-2xl md:text-3xl mb-2" style="color: var(--primary);"></i>
                        <p class="text-xs md:text-sm font-medium">Nouveau cours</p>
                    </button>
                    <button onclick="quickAddGrade()" class="p-3 md:p-4 rounded-lg border-2 border-dashed hover:border-solid transition" style="border-color: var(--secondary);">
                        <i class="fas fa-star text-2xl md:text-3xl mb-2" style="color: var(--secondary);"></i>
                        <p class="text-xs md:text-sm font-medium">Ajouter note</p>
                    </button>
                    <button onclick="quickAddTask()" class="p-3 md:p-4 rounded-lg border-2 border-dashed hover:border-solid transition" style="border-color: var(--accent);">
                        <i class="fas fa-clipboard-list text-2xl md:text-3xl mb-2" style="color: var(--accent);"></i>
                        <p class="text-xs md:text-sm font-medium">Nouvelle tÃ¢che</p>
                    </button>
                    <button onclick="exportData()" class="p-3 md:p-4 rounded-lg border-2 border-dashed hover:border-solid transition" style="border-color: #22c55e;">
                        <i class="fas fa-download text-2xl md:text-3xl mb-2" style="color: #22c55e;"></i>
                        <p class="text-xs md:text-sm font-medium">Exporter donnÃ©es</p>
                    </button>
                </div>
            </div>

            <!-- Prochain cours + semaine -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="card rounded-lg p-6 shadow-lg">
                    <h3 class="text-xl font-bold mb-4">ğŸ“… Aujourd'hui</h3>
                    <div id="today-schedule" class="space-y-2">
                        <p class="text-sm opacity-70">Chargement du planning...</p>
                    </div>
                </div>
                <div class="card rounded-lg p-6 shadow-lg">
                    <h3 class="text-xl font-bold mb-4">ğŸ“Š Cette semaine</h3>
                    <div id="week-summary" class="space-y-2">
                        <p class="text-sm opacity-70">Chargement...</p>
                    </div>
                </div>
            </div>

            <!-- Progression du semestre -->
            <div class="card rounded-lg p-6 shadow-lg">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-xl font-bold">ğŸ—“ï¸ Progression du semestre</h3>
                    <span id="semester-percent" class="text-sm font-bold" style="color:var(--primary);">--</span>
                </div>
                <div class="progress-bar mb-2">
                    <div class="progress-fill" id="semester-progress-bar" style="width:0%"></div>
                </div>
                <div class="flex justify-between text-xs opacity-50">
                    <span id="semester-start-label">DÃ©but</span>
                    <span id="semester-end-label">Fin</span>
                </div>
            </div>
        </div>

        <!-- COURS & FICHIERS AMÃ‰LIORÃ‰S -->
        <div id="courses" class="tab-content space-y-6">
            <div class="card shadow-lg rounded-lg p-6">
                <!-- Barre titre + actions -->
                <div class="flex flex-wrap justify-between items-center gap-3 mb-5">
                    <h3 class="text-2xl font-bold gradient-text">ğŸ“š Mes MatiÃ¨res</h3>
                    <div class="flex flex-wrap gap-2">
                        <!-- Recherche -->
                        <div class="relative hidden sm:block">
                            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-xs opacity-40"></i>
                            <input type="text" id="courseSearch" placeholder="Rechercher..." oninput="searchCourses(this.value)"
                                class="pl-8 pr-3 py-2 text-sm border rounded-lg" style="border-color:var(--border); width:160px;">
                        </div>
                        <!-- Vue grille/liste -->
                        <button onclick="toggleCoursesView()" id="coursesViewBtn" title="Changer la vue"
                            class="px-3 py-2 rounded-lg border text-sm" style="border-color:var(--border);">
                            <i class="fas fa-th-large"></i>
                        </button>
                        <!-- Supprimer tous -->
                        <button onclick="deleteAllCourses()" title="Supprimer tous les cours"
                            class="px-3 py-2 rounded-lg border text-sm text-red-500 hover:bg-red-50 transition" style="border-color:#fca5a5;">
                            <i class="fas fa-trash-alt mr-1"></i><span class="hidden sm:inline">Tout supprimer</span>
                        </button>
                        <!-- Trier -->
                        <select id="coursesSortSelect" onchange="renderCourses()" class="px-3 py-2 text-sm border rounded-lg" style="border-color:var(--border);">
                            <option value="name">Trier : Aâ†’Z</option>
                            <option value="avg">Trier : Moyenne</option>
                            <option value="semester">Trier : Semestre</option>
                        </select>
                        <!-- Nouveau cours -->
                        <button onclick="openCourseModal()" class="px-4 py-2 rounded-lg font-medium text-white text-sm" style="background: linear-gradient(135deg, var(--primary), var(--secondary));">
                            <i class="fas fa-plus mr-1"></i> Nouveau
                        </button>
                    </div>
                </div>

                <!-- Recherche mobile -->
                <div class="sm:hidden mb-4">
                    <div class="relative">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-xs opacity-40"></i>
                        <input type="text" placeholder="Rechercher un cours..." oninput="searchCourses(this.value)"
                            class="w-full pl-8 pr-3 py-2 text-sm border rounded-lg" style="border-color:var(--border);">
                    </div>
                </div>

                <!-- Filtres semestre -->
                <div class="flex gap-2 mb-5 flex-wrap">
                    <button onclick="filterCourses('all')" class="filter-btn active px-3 py-1.5 rounded-lg transition text-sm" data-filter="all">Tous</button>
                    <button onclick="filterCourses('S1')" class="filter-btn px-3 py-1.5 rounded-lg transition text-sm" data-filter="S1">ğŸ“˜ S1</button>
                    <button onclick="filterCourses('S2')" class="filter-btn px-3 py-1.5 rounded-lg transition text-sm" data-filter="S2">ğŸ“— S2</button>
                </div>

                <!-- Compteur -->
                <div id="coursesCount" class="text-xs opacity-50 mb-4"></div>

                <div id="coursesList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </div>
        </div>

        <!-- AGENDA HEBDOMADAIRE -->
        <div id="schedule" class="tab-content">
            <div class="card shadow-lg rounded-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold gradient-text hidden md:block">ğŸ“… Mon Agenda Hebdomadaire</h3>
                    <h3 class="text-xl font-bold gradient-text md:hidden">ğŸ“… Agenda</h3>
                    <div class="flex gap-2 flex-wrap">
                        <div class="flex gap-1">
                            <button onclick="previousWeek()" class="px-3 py-2 rounded-lg border hover:bg-gray-100" title="Semaine prÃ©cÃ©dente">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button onclick="currentWeek()" class="px-3 py-2 rounded-lg border hover:bg-blue-50 text-sm md:text-base" style="color: var(--primary);">
                                <span class="hidden md:inline">Aujourd'hui</span>
                                <i class="fas fa-home md:hidden"></i>
                            </button>
                            <button onclick="nextWeek()" class="px-3 py-2 rounded-lg border hover:bg-gray-100" title="Semaine suivante">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <button onclick="openScheduleSettings()" class="px-3 py-2 rounded-lg border hover:bg-purple-50 hidden md:block">
                            <i class="fas fa-palette mr-2"></i> Personnaliser
                        </button>
                        <button onclick="openScheduleSettings()" class="px-3 py-2 rounded-lg border hover:bg-purple-50 md:hidden" title="Personnaliser">
                            <i class="fas fa-palette"></i>
                        </button>
                        <button onclick="clearSchedule()" class="px-3 py-2 rounded-lg border hover:bg-red-50 text-red-600 hidden md:block">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button onclick="exportSchedule()" class="px-3 py-2 rounded-lg hidden md:block" style="background: var(--primary); color: white;">
                            <i class="fas fa-download mr-2"></i> Exporter
                        </button>
                        <button onclick="exportSchedule()" class="px-3 py-2 rounded-lg md:hidden" style="background: var(--primary); color: white;" title="Exporter">
                            <i class="fas fa-download"></i>
                        </button>
                        <button onclick="openEdtImportModal()" class="px-3 py-2 rounded-lg hidden md:block font-medium" style="background: linear-gradient(135deg, #f97316, #ea580c); color: white;">
                            <i class="fas fa-university mr-2"></i> EDT AMU
                        </button>
                        <button onclick="openEdtImportModal()" class="px-3 py-2 rounded-lg md:hidden" style="background: linear-gradient(135deg, #f97316, #ea580c); color: white;" title="Importer EDT AMU">
                            <i class="fas fa-university"></i>
                        </button>
                    </div>
                </div>
                
                <div class="mb-4 p-4 rounded-lg" style="background: var(--border);">
                    <p class="font-bold text-lg mb-2" id="weekDisplay">Semaine du ...</p>
                    <p class="text-sm opacity-70">
                        ğŸ’¡ <strong>Astuce :</strong> 
                        <span class="hidden md:inline">Clique sur une case pour ajouter/modifier un cours. Double-clique pour supprimer.</span>
                        <span class="md:hidden">Appuie sur + pour ajouter un cours. Appui long pour supprimer.</span>
                        <span class="md:hidden block mt-1">ğŸ‘‰ Fais dÃ©filer horizontalement pour voir tous les jours</span>
                    </p>
                </div>

                <!-- Bandeau statut import EDT -->
                <div id="edtImportStatus" class="hidden mb-4 p-3 rounded-lg flex items-center gap-3 text-sm font-medium" style="background: #fff7ed; border: 1px solid #fed7aa; color: #c2410c;">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span id="edtImportStatusText">Importation en cours...</span>
                </div>
                
                <div class="overflow-x-auto pb-4" style="-webkit-overflow-scrolling: touch;">
                    <div class="schedule-grid" id="scheduleGrid" style="min-width: 900px;"></div>
                </div>
            </div>
        </div>

        <!-- NOTES & ANALYSES -->
        <div id="grades" class="tab-content">
            <div class="card shadow-lg rounded-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold gradient-text">ğŸ¯ Mes Notes</h3>
                    <button onclick="saveAllGrades()" class="px-6 py-3 rounded-lg text-white font-medium" style="background: linear-gradient(135deg, #22c55e, #16a34a);">
                        <i class="fas fa-save mr-2"></i> Sauvegarder tout
                    </button>
                </div>
                
                <div class="card p-4 mb-6">
                    <h4 class="font-bold mb-3">â• Ajouter une note</h4>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <select id="gradeCourseSelect" class="p-3 border rounded-lg" style="border-color: var(--border);">
                            <option>Choisir une matiÃ¨re...</option>
                        </select>
                        <input type="number" id="gradeValue" placeholder="Note /20" min="0" max="20" step="0.25" class="p-3 border rounded-lg" style="border-color: var(--border);">
                        <input type="number" id="gradeCoef" placeholder="Coefficient" min="0.5" max="10" step="0.5" value="1" class="p-3 border rounded-lg" style="border-color: var(--border);">
                        <input type="text" id="gradeLabel" placeholder="IntitulÃ© (ex: Partiel)" class="p-3 border rounded-lg" style="border-color: var(--border);">
                    </div>
                    <button onclick="addGrade()" class="w-full mt-4 px-6 py-3 rounded-lg text-white font-medium" style="background: linear-gradient(135deg, #22c55e, #16a34a);">
                        <i class="fas fa-check mr-2"></i> Enregistrer la note
                    </button>
                </div>

                <!-- Affichage par matiÃ¨re -->
                <div id="gradesList" class="space-y-6"></div>
            </div>
        </div>

        <!-- STATISTIQUES AVANCÃ‰ES -->
        <div id="stats" class="tab-content space-y-6">
            <div class="card shadow-lg rounded-lg p-6">
                <h3 class="text-2xl font-bold gradient-text mb-6">ğŸ“Š Statistiques & Analyses</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card p-4">
                        <h4 class="font-bold mb-4">Ã‰volution de ta moyenne</h4>
                        <canvas id="gradesChart"></canvas>
                    </div>
                    
                    <div class="card p-4">
                        <h4 class="font-bold mb-4">RÃ©partition par matiÃ¨re</h4>
                        <canvas id="subjectsChart"></canvas>
                    </div>
                    
                    <div class="card p-4">
                        <h4 class="font-bold mb-4">Progression mensuelle</h4>
                        <canvas id="progressChart"></canvas>
                    </div>
                    
                    <div class="card p-4">
                        <h4 class="font-bold mb-4">Insights personnalisÃ©s</h4>
                        <div id="insights" class="space-y-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- GESTIONNAIRE DE TÃ‚CHES -->
        <div id="tasks" class="tab-content space-y-6">
            <div class="card shadow-lg rounded-lg p-6">
                <h3 class="text-2xl font-bold gradient-text mb-6">âœ… Mes TÃ¢ches</h3>
                
                <div class="card p-4 mb-6">
                    <div class="flex gap-4">
                        <input type="text" id="taskInput" placeholder="Nouvelle tÃ¢che..." class="flex-1 p-3 border rounded-lg" style="border-color: var(--border);">
                        <select id="taskPriority" class="p-3 border rounded-lg" style="border-color: var(--border);">
                            <option value="low">ğŸŸ¢ Faible</option>
                            <option value="medium" selected>ğŸŸ¡ Moyenne</option>
                            <option value="high">ğŸ”´ Haute</option>
                        </select>
                        <input type="date" id="taskDate" class="p-3 border rounded-lg" style="border-color: var(--border);">
                        <button onclick="addTask()" class="px-6 py-3 rounded-lg text-white font-medium" style="background: var(--primary);">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="card p-4">
                        <h4 class="font-bold mb-3 flex items-center"><span class="w-3 h-3 rounded-full bg-yellow-400 mr-2"></span> Ã€ faire</h4>
                        <div id="tasks-todo" class="space-y-2"></div>
                    </div>
                    <div class="card p-4">
                        <h4 class="font-bold mb-3 flex items-center"><span class="w-3 h-3 rounded-full bg-blue-400 mr-2"></span> En cours</h4>
                        <div id="tasks-inprogress" class="space-y-2"></div>
                    </div>
                    <div class="card p-4">
                        <h4 class="font-bold mb-3 flex items-center"><span class="w-3 h-3 rounded-full bg-green-400 mr-2"></span> TerminÃ©</h4>
                        <div id="tasks-done" class="space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Footer avec crÃ©dits -->
    <footer class="mt-12 pb-6 text-center">
        <div class="max-w-7xl mx-auto px-4">
            <div class="card rounded-lg p-4 shadow-sm" style="background: var(--bg-card); border: 1px solid var(--border);">
                <div class="flex flex-col items-center gap-2">
                    <div class="flex items-center gap-2 text-sm">
                        <span class="opacity-70">DÃ©veloppÃ© avec</span>
                        <span class="text-red-500 animate-pulse">â¤ï¸</span>
                        <span class="opacity-70">par</span>
                        <span class="font-bold gradient-text">Mathieu Mercera</span>
                    </div>
                    <div class="text-xs opacity-50">
                        MyStudySpace Ultimate Â© 2026 - Tous droits rÃ©servÃ©s
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- Modal ParamÃ¨tres -->
    <div id="settingsModal" class="modal">
        <div class="modal-content" style="max-width:580px;">
            <div class="flex justify-between items-center mb-5">
                <h3 class="text-2xl font-bold gradient-text">âš™ï¸ ParamÃ¨tres</h3>
                <button onclick="closeSettings()" class="btn-ghost" style="padding:6px 10px; font-size:1.1rem;">&times;</button>
            </div>

            <!-- Onglets settings -->
            <div class="flex border-b mb-5" style="border-color:var(--border);">
                <button class="settings-tab-btn active" onclick="switchSettingsTab(this,'tab-theme')">ğŸ¨ ThÃ¨me</button>
                <button class="settings-tab-btn" onclick="switchSettingsTab(this,'tab-profile')">ğŸ‘¤ Profil</button>
                <button class="settings-tab-btn" onclick="switchSettingsTab(this,'tab-display')">ğŸ–¥ï¸ Affichage</button>
                <button class="settings-tab-btn" onclick="switchSettingsTab(this,'tab-options')">ğŸ¯ Options</button>
                <button class="settings-tab-btn" onclick="switchSettingsTab(this,'tab-data')">ğŸ’¾ DonnÃ©es</button>
            </div>

            <!-- TAB THÃˆME -->
            <div id="tab-theme" class="settings-panel active" style="max-height: 500px; overflow-y: auto;">
                <p class="text-xs font-semibold uppercase opacity-50 mb-3">ğŸ¨ ThÃ¨mes Classiques</p>
                <div class="grid grid-cols-4 gap-3 mb-5">
                    <button onclick="setTheme('light')" class="theme-swatch" id="swatch-light">
                        <div class="h-full w-full" style="background:linear-gradient(135deg,#6366f1,#ec4899);"></div>
                        <p class="text-xs font-semibold text-center mt-1" style="color:var(--text-main);">Indigo</p>
                    </button>
                    <button onclick="setTheme('dark')" class="theme-swatch" id="swatch-dark">
                        <div class="h-full w-full" style="background:linear-gradient(135deg,#818cf8,#a78bfa); position:relative;">
                            <div style="position:absolute;inset:0;background:rgba(0,0,0,.55);"></div>
                        </div>
                        <p class="text-xs font-semibold text-center mt-1" style="color:var(--text-main);">Sombre</p>
                    </button>
                    <button onclick="setTheme('midnight')" class="theme-swatch" id="swatch-midnight">
                        <div class="h-full w-full" style="background:linear-gradient(135deg,#c084fc,#67e8f9); position:relative;">
                            <div style="position:absolute;inset:0;background:rgba(4,2,15,.7);"></div>
                        </div>
                        <p class="text-xs font-semibold text-center mt-1" style="color:var(--text-main);">Minuit</p>
                    </button>
                    <button onclick="setTheme('nord')" class="theme-swatch" id="swatch-nord">
                        <div class="h-full w-full" style="background:linear-gradient(135deg,#88c0d0,#a3be8c); position:relative;">
                            <div style="position:absolute;inset:0;background:rgba(46,52,64,.6);"></div>
                        </div>
                        <p class="text-xs font-semibold text-center mt-1" style="color:var(--text-main);">Nord</p>
                    </button>
                    <button onclick="setTheme('ocean')" class="theme-swatch" id="swatch-ocean">
                        <div class="h-full w-full" style="background:linear-gradient(135deg,#0ea5e9,#22d3ee);"></div>
                        <p class="text-xs font-semibold text-center mt-1" style="color:var(--text-main);">OcÃ©an</p>
                    </button>
                    <button onclick="setTheme('sunset')" class="theme-swatch" id="swatch-sunset">
                        <div class="h-full w-full" style="background:linear-gradient(135deg,#f97316,#ef4444);"></div>
                        <p class="text-xs font-semibold text-center mt-1" style="color:var(--text-main);">Sunset</p>
                    </button>
                    <button onclick="setTheme('forest')" class="theme-swatch" id="swatch-forest">
                        <div class="h-full w-full" style="background:linear-gradient(135deg,#22c55e,#84cc16);"></div>
                        <p class="text-xs font-semibold text-center mt-1" style="color:var(--text-main);">ForÃªt</p>
                    </button>
                    <button onclick="setTheme('rose')" class="theme-swatch" id="swatch-rose">
                        <div class="h-full w-full" style="background:linear-gradient(135deg,#f43f5e,#fb923c);"></div>
                        <p class="text-xs font-semibold text-center mt-1" style="color:var(--text-main);">RosÃ©</p>
                    </button>
                </div>

                <p class="text-xs font-semibold uppercase opacity-50 mb-3">ğŸ¦¸ ThÃ¨mes Super-HÃ©ros</p>
                <div class="grid grid-cols-4 gap-3 mb-5">
                    <button onclick="setTheme('spiderman')" class="theme-swatch" id="swatch-spiderman">
                        <div class="h-full w-full" style="background:linear-gradient(135deg,#e23636,#0d47a1); position:relative;">
                            <div style="position:absolute;inset:0;background:rgba(0,0,0,.3);"></div>
                        </div>
                        <p class="text-xs font-semibold text-center mt-1" style="color:var(--text-main);">Spider-Man ğŸ•·ï¸</p>
                    </button>
                    <button onclick="setTheme('batman')" class="theme-swatch" id="swatch-batman">
                        <div class="h-full w-full" style="background:linear-gradient(135deg,#ffd700,#1a1a1a); position:relative;">
                            <div style="position:absolute;inset:0;background:rgba(0,0,0,.7);"></div>
                        </div>
                        <p class="text-xs font-semibold text-center mt-1" style="color:var(--text-main);">Batman ğŸ¦‡</p>
                    </button>
                    <button onclick="setTheme('ironman')" class="theme-swatch" id="swatch-ironman">
                        <div class="h-full w-full" style="background:linear-gradient(135deg,#dc143c,#ffd700); position:relative;">
                            <div style="position:absolute;inset:0;background:rgba(0,0,0,.4);"></div>
                        </div>
                        <p class="text-xs font-semibold text-center mt-1" style="color:var(--text-main);">Iron Man ğŸ¤–</p>
                    </button>
                    <button onclick="setTheme('hulk')" class="theme-swatch" id="swatch-hulk">
                        <div class="h-full w-full" style="background:linear-gradient(135deg,#00ff00,#9933ff); position:relative;">
                            <div style="position:absolute;inset:0;background:rgba(0,0,0,.5);"></div>
                        </div>
                        <p class="text-xs font-semibold text-center mt-1" style="color:var(--text-main);">Hulk ğŸ’ª</p>
                    </button>
                    <button onclick="setTheme('captain')" class="theme-swatch" id="swatch-captain">
                        <div class="h-full w-full" style="background:linear-gradient(135deg,#0d47a1,#c62828);"></div>
                        <p class="text-xs font-semibold text-center mt-1" style="color:var(--text-main);">Captain ğŸ›¡ï¸</p>
                    </button>
                </div>

                <p class="text-xs font-semibold uppercase opacity-50 mb-3">âš™ï¸ ThÃ¨mes MÃ©talliques</p>
                <div class="grid grid-cols-4 gap-3 mb-5">
                    <button onclick="setTheme('chrome')" class="theme-swatch" id="swatch-chrome">
                        <div class="h-full w-full" style="background:linear-gradient(135deg,#c0c0c0,#808080); position:relative;">
                            <div style="position:absolute;inset:0;background:rgba(0,0,0,.5);"></div>
                        </div>
                        <p class="text-xs font-semibold text-center mt-1" style="color:var(--text-main);">Chrome ğŸ”˜</p>
                    </button>
                    <button onclick="setTheme('gold')" class="theme-swatch" id="swatch-gold">
                        <div class="h-full w-full" style="background:linear-gradient(135deg,#ffd700,#ff8c00); position:relative;">
                            <div style="position:absolute;inset:0;background:rgba(0,0,0,.3);"></div>
                        </div>
                        <p class="text-xs font-semibold text-center mt-1" style="color:var(--text-main);">Or ğŸ¥‡</p>
                    </button>
                    <button onclick="setTheme('copper')" class="theme-swatch" id="swatch-copper">
                        <div class="h-full w-full" style="background:linear-gradient(135deg,#b87333,#8b4513); position:relative;">
                            <div style="position:absolute;inset:0;background:rgba(0,0,0,.3);"></div>
                        </div>
                        <p class="text-xs font-semibold text-center mt-1" style="color:var(--text-main);">Cuivre ğŸŸ </p>
                    </button>
                    <button onclick="setTheme('steel')" class="theme-swatch" id="swatch-steel">
                        <div class="h-full w-full" style="background:linear-gradient(135deg,#b0c4de,#708090); position:relative;">
                            <div style="position:absolute;inset:0;background:rgba(0,0,0,.4);"></div>
                        </div>
                        <p class="text-xs font-semibold text-center mt-1" style="color:var(--text-main);">Acier ğŸ”©</p>
                    </button>
                </div>

                <p class="text-xs font-semibold uppercase opacity-50 mb-3">âœ¨ ThÃ¨mes SpÃ©ciaux</p>
                <div class="grid grid-cols-4 gap-3 mb-5">
                    <button onclick="setTheme('matrix')" class="theme-swatch" id="swatch-matrix">
                        <div class="h-full w-full" style="background:linear-gradient(135deg,#00ff41,#008f11); position:relative;">
                            <div style="position:absolute;inset:0;background:rgba(0,0,0,.8);"></div>
                        </div>
                        <p class="text-xs font-semibold text-center mt-1" style="color:var(--text-main);">Matrix ğŸŸ¢</p>
                    </button>
                    <button onclick="setTheme('neon')" class="theme-swatch" id="swatch-neon">
                        <div class="h-full w-full" style="background:linear-gradient(135deg,#ff00ff,#00ffff); position:relative;">
                            <div style="position:absolute;inset:0;background:rgba(0,0,0,.6);"></div>
                        </div>
                        <p class="text-xs font-semibold text-center mt-1" style="color:var(--text-main);">Neon ğŸ’¡</p>
                    </button>
                    <button onclick="setTheme('cyberpunk')" class="theme-swatch" id="swatch-cyberpunk">
                        <div class="h-full w-full" style="background:linear-gradient(135deg,#ff0080,#00d4ff); position:relative;">
                            <div style="position:absolute;inset:0;background:rgba(0,0,0,.5);"></div>
                        </div>
                        <p class="text-xs font-semibold text-center mt-1" style="color:var(--text-main);">Cyberpunk ğŸŒ†</p>
                    </button>
                    <button onclick="setTheme('retro')" class="theme-swatch" id="swatch-retro">
                        <div class="h-full w-full" style="background:linear-gradient(135deg,#ff6b35,#fdc02f);"></div>
                        <p class="text-xs font-semibold text-center mt-1" style="color:var(--text-main);">Retro ğŸ“¼</p>
                    </button>
                    <button onclick="setTheme('galaxy')" class="theme-swatch" id="swatch-galaxy">
                        <div class="h-full w-full" style="background:linear-gradient(135deg,#9d4edd,#f72585); position:relative;">
                            <div style="position:absolute;inset:0;background:rgba(0,0,0,.5);"></div>
                        </div>
                        <p class="text-xs font-semibold text-center mt-1" style="color:var(--text-main);">Galaxy ğŸŒŒ</p>
                    </button>
                    <button onclick="setTheme('lava')" class="theme-swatch" id="swatch-lava">
                        <div class="h-full w-full" style="background:linear-gradient(135deg,#ff4500,#dc143c); position:relative;">
                            <div style="position:absolute;inset:0;background:rgba(0,0,0,.4);"></div>
                        </div>
                        <p class="text-xs font-semibold text-center mt-1" style="color:var(--text-main);">Lava ğŸŒ‹</p>
                    </button>
                    <button onclick="setTheme('ice')" class="theme-swatch" id="swatch-ice">
                        <div class="h-full w-full" style="background:linear-gradient(135deg,#00bfff,#87ceeb); position:relative;">
                            <div style="position:absolute;inset:0;background:rgba(0,0,0,.4);"></div>
                        </div>
                        <p class="text-xs font-semibold text-center mt-1" style="color:var(--text-main);">Ice ğŸ§Š</p>
                    </button>
                </div>

                <p class="text-xs font-semibold uppercase opacity-50 mb-3">ğŸ¨ Couleurs personnalisÃ©es</p>
                <div class="grid grid-cols-2 gap-3">
                    <label class="flex items-center gap-3 p-3 rounded-xl cursor-pointer card">
                        <input type="color" id="customPrimaryColor" value="#6366f1" onchange="applyCustomColor('primary', this.value)" class="w-9 h-9 rounded-lg cursor-pointer border-0 flex-shrink-0">
                        <div><p class="text-sm font-semibold">Primaire</p><p class="text-xs opacity-50">Boutons, liens actifs</p></div>
                    </label>
                    <label class="flex items-center gap-3 p-3 rounded-xl cursor-pointer card">
                        <input type="color" id="customAccentColor" value="#ec4899" onchange="applyCustomColor('accent', this.value)" class="w-9 h-9 rounded-lg cursor-pointer border-0 flex-shrink-0">
                        <div><p class="text-sm font-semibold">Accent</p><p class="text-xs opacity-50">DÃ©gradÃ©s, highlights</p></div>
                    </label>
                </div>
            </div>

            <!-- TAB PROFIL -->
            <div id="tab-profile" class="settings-panel">
                <input type="text" id="userName" placeholder="Ton prÃ©nom" class="w-full p-3 border rounded-xl mb-4 text-sm font-medium" style="border-color: var(--border);">
                <p class="text-xs font-semibold uppercase opacity-50 mb-3">Choisis ton avatar</p>
                <div class="emoji-picker">
                    <span class="emoji-btn" onclick="setAvatar('ğŸ‘¨â€ğŸ“')">ğŸ‘¨â€ğŸ“</span><span class="emoji-btn" onclick="setAvatar('ğŸ‘©â€ğŸ“')">ğŸ‘©â€ğŸ“</span>
                    <span class="emoji-btn" onclick="setAvatar('ğŸ¦¸â€â™‚ï¸')">ğŸ¦¸â€â™‚ï¸</span><span class="emoji-btn" onclick="setAvatar('ğŸ¦¸â€â™€ï¸')">ğŸ¦¸â€â™€ï¸</span>
                    <span class="emoji-btn" onclick="setAvatar('ğŸ§™â€â™‚ï¸')">ğŸ§™â€â™‚ï¸</span><span class="emoji-btn" onclick="setAvatar('ğŸ§™â€â™€ï¸')">ğŸ§™â€â™€ï¸</span>
                    <span class="emoji-btn" onclick="setAvatar('ğŸ±')">ğŸ±</span><span class="emoji-btn" onclick="setAvatar('ğŸ¶')">ğŸ¶</span>
                    <span class="emoji-btn" onclick="setAvatar('ğŸ¦Š')">ğŸ¦Š</span><span class="emoji-btn" onclick="setAvatar('ğŸ¼')">ğŸ¼</span>
                    <span class="emoji-btn" onclick="setAvatar('ğŸ¦')">ğŸ¦</span><span class="emoji-btn" onclick="setAvatar('ğŸ¯')">ğŸ¯</span>
                    <span class="emoji-btn" onclick="setAvatar('ğŸš€')">ğŸš€</span><span class="emoji-btn" onclick="setAvatar('âš¡')">âš¡</span>
                    <span class="emoji-btn" onclick="setAvatar('ğŸ”¥')">ğŸ”¥</span><span class="emoji-btn" onclick="setAvatar('ğŸ’')">ğŸ’</span>
                    <span class="emoji-btn" onclick="setAvatar('ğŸµ')">ğŸµ</span><span class="emoji-btn" onclick="setAvatar('ğŸŒ™')">ğŸŒ™</span>
                    <span class="emoji-btn" onclick="setAvatar('ğŸŒˆ')">ğŸŒˆ</span><span class="emoji-btn" onclick="setAvatar('ğŸ€')">ğŸ€</span>
                </div>
                <button onclick="saveSettings()" class="btn-primary w-full mt-5">
                    <i class="fas fa-save"></i> Sauvegarder le profil
                </button>
            </div>

            <!-- TAB AFFICHAGE -->
            <div id="tab-display" class="settings-panel">
                <div class="mb-4">
                    <p class="text-xs font-semibold uppercase opacity-50 mb-2">Police</p>
                    <select id="fontSelect" onchange="applyFont(this.value)" class="w-full p-2.5 border rounded-xl text-sm font-medium" style="border-color:var(--border);">
                        <option value="'Plus Jakarta Sans', sans-serif">Plus Jakarta Sans</option>
                        <option value="'Poppins', sans-serif">Poppins</option>
                        <option value="'Inter', sans-serif">Inter</option>
                        <option value="'Roboto', sans-serif">Roboto</option>
                        <option value="'Nunito', sans-serif">Nunito</option>
                        <option value="monospace">Monospace</option>
                    </select>
                </div>
                <div class="mb-4">
                    <p class="text-xs font-semibold uppercase opacity-50 mb-2">DensitÃ©</p>
                    <div class="flex gap-2">
                        <button onclick="setDensity('compact')" id="density-compact" class="flex-1 py-2.5 text-xs rounded-xl border font-semibold transition" style="border-color:var(--border);">Compact</button>
                        <button onclick="setDensity('normal')" id="density-normal" class="flex-1 py-2.5 text-xs rounded-xl border font-semibold transition" style="background:var(--primary);color:white;border-color:var(--primary);">Normal</button>
                        <button onclick="setDensity('comfortable')" id="density-comfortable" class="flex-1 py-2.5 text-xs rounded-xl border font-semibold transition" style="border-color:var(--border);">Large</button>
                    </div>
                </div>
                <div>
                    <p class="text-xs font-semibold uppercase opacity-50 mb-2">Rayon des cartes</p>
                    <div class="flex gap-2">
                        <button onclick="setRadius('sharp')" class="flex-1 py-2.5 text-xs rounded border font-semibold" style="border-color:var(--border);" id="radius-sharp">CarrÃ©</button>
                        <button onclick="setRadius('normal')" class="flex-1 py-2.5 text-xs rounded-xl border font-semibold" style="background:var(--primary);color:white;border-color:var(--primary);" id="radius-normal">Normal</button>
                        <button onclick="setRadius('round')" class="flex-1 py-2.5 text-xs rounded-2xl border font-semibold" style="border-color:var(--border);" id="radius-round">Arrondi</button>
                    </div>
                </div>
                <div class="mt-4">
                    <p class="text-xs font-semibold uppercase opacity-50 mb-2">Raccourcis clavier</p>
                    <div class="grid grid-cols-2 gap-1.5 text-xs">
                        <div class="p-2 rounded-lg font-medium" style="background:var(--border);"><kbd class="font-mono">Alt+1</kbd> Dashboard</div>
                        <div class="p-2 rounded-lg font-medium" style="background:var(--border);"><kbd class="font-mono">Alt+2</kbd> Cours</div>
                        <div class="p-2 rounded-lg font-medium" style="background:var(--border);"><kbd class="font-mono">Alt+3</kbd> Planning</div>
                        <div class="p-2 rounded-lg font-medium" style="background:var(--border);"><kbd class="font-mono">Alt+4</kbd> Notes</div>
                        <div class="p-2 rounded-lg font-medium" style="background:var(--border);"><kbd class="font-mono">Alt+5</kbd> Stats</div>
                        <div class="p-2 rounded-lg font-medium" style="background:var(--border);"><kbd class="font-mono">Alt+6</kbd> TÃ¢ches</div>
                    </div>
                </div>
            </div>

            <!-- TAB OPTIONS -->
            <div id="tab-options" class="settings-panel">
                <div class="space-y-2">
                    <label class="flex items-center justify-between p-3 rounded-xl card cursor-pointer">
                        <div><span class="font-semibold text-sm">Animations</span><p class="text-xs opacity-50">Transitions et effets</p></div>
                        <input type="checkbox" id="animationsToggle" checked class="w-5 h-5">
                    </label>
                    <label class="flex items-center justify-between p-3 rounded-xl card cursor-pointer">
                        <div><span class="font-semibold text-sm">Notifications</span><p class="text-xs opacity-50">Confirmations d'actions</p></div>
                        <input type="checkbox" id="notificationsToggle" checked class="w-5 h-5">
                    </label>
                    <label class="flex items-center justify-between p-3 rounded-xl card cursor-pointer">
                        <div><span class="font-semibold text-sm">Confettis ğŸ‰</span><p class="text-xs opacity-50">CÃ©lÃ©bration des bonnes notes</p></div>
                        <input type="checkbox" id="confettiToggle" checked class="w-5 h-5">
                    </label>
                    <label class="flex items-center justify-between p-3 rounded-xl card cursor-pointer">
                        <div><span class="font-semibold text-sm">Badge CM/TD/TP</span><p class="text-xs opacity-50">Type de cours sur le planning</p></div>
                        <input type="checkbox" id="showCourseTypeToggle" checked class="w-5 h-5">
                    </label>
                    <label class="flex items-center justify-between p-3 rounded-xl card cursor-pointer">
                        <div><span class="font-semibold text-sm">Mode focus ğŸ¯</span><p class="text-xs opacity-50">Interface Ã©purÃ©e</p></div>
                        <input type="checkbox" id="focusModeToggle" class="w-5 h-5" onchange="toggleFocusMode(this.checked)">
                    </label>
                    <label class="flex items-center justify-between p-3 rounded-xl card cursor-pointer">
                        <div><span class="font-semibold text-sm">Horloge en temps rÃ©el</span><p class="text-xs opacity-50">AffichÃ©e sur le dashboard</p></div>
                        <input type="checkbox" id="clockToggle" checked class="w-5 h-5" onchange="toggleClock(this.checked)">
                    </label>
                    
                    <div class="h-px my-3" style="background:var(--border);"></div>
                    
                    <button onclick="resetStreak()" class="btn-ghost w-full justify-center" style="border-color:#fed7aa; color:#f97316;">
                        <i class="fas fa-redo-alt"></i> RÃ©initialiser la sÃ©rie de travail
                    </button>
                </div>
            </div>

            <!-- TAB DONNÃ‰ES -->
            <div id="tab-data" class="settings-panel">
                <div class="space-y-2.5">
                    <button onclick="exportAllData()" class="btn-ghost w-full justify-center">
                        <i class="fas fa-download" style="color:#22c55e;"></i> Exporter toutes les donnÃ©es
                    </button>
                    <button onclick="importData()" class="btn-ghost w-full justify-center">
                        <i class="fas fa-upload" style="color:#3b82f6;"></i> Importer des donnÃ©es
                    </button>
                    <div class="h-px my-1" style="background:var(--border);"></div>
                    <button onclick="deleteAllCourses()" class="btn-ghost w-full justify-center" style="border-color:#fed7aa; color:#f97316;">
                        <i class="fas fa-trash-alt"></i> Supprimer tous les cours
                    </button>
                    <button onclick="resetApp()" class="btn-danger w-full justify-center">
                        <i class="fas fa-exclamation-triangle"></i> RÃ©initialiser l'application
                    </button>
                </div>
                <div class="mt-4 p-3 rounded-xl text-xs text-center" style="background:var(--border);">
                    <p class="opacity-50 mb-2">Toutes les donnÃ©es sont stockÃ©es localement dans ton navigateur.</p>
                    <div class="mt-3 pt-3" style="border-top: 1px solid var(--border);">
                        <p class="text-xs opacity-70 mb-1">DÃ©veloppÃ© par</p>
                        <p class="font-bold gradient-text">Mathieu Mercera</p>
                        <p class="text-xs opacity-50 mt-1">MyStudySpace Ultimate Â© 2026</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Nouveau Cours -->
    <div id="courseModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold gradient-text">â• Nouveau Cours</h3>
                <button onclick="closeCourseModal()" class="text-2xl">&times;</button>
            </div>
            
            <input type="text" id="courseNameInput" placeholder="Nom de la matiÃ¨re" class="w-full p-3 border rounded-lg mb-4" style="border-color: var(--border);">
            
            <select id="courseSemesterInput" class="w-full p-3 border rounded-lg mb-4" style="border-color: var(--border);">
                <option value="S1">Semestre 1</option>
                <option value="S2">Semestre 2</option>
            </select>
            
            <input type="number" id="courseEctsInput" placeholder="CrÃ©dits ECTS (optionnel)" min="0" max="30" step="0.5" class="w-full p-3 border rounded-lg mb-4" style="border-color: var(--border);">
            
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Couleur de la matiÃ¨re (pour l'agenda)</label>
                <div class="flex gap-2">
                    <button onclick="setCourseColor('#3b82f6')" class="w-10 h-10 rounded-full bg-blue-500 border-2 border-transparent hover:border-gray-800"></button>
                    <button onclick="setCourseColor('#8b5cf6')" class="w-10 h-10 rounded-full bg-purple-500 border-2 border-transparent hover:border-gray-800"></button>
                    <button onclick="setCourseColor('#ec4899')" class="w-10 h-10 rounded-full bg-pink-500 border-2 border-transparent hover:border-gray-800"></button>
                    <button onclick="setCourseColor('#22c55e')" class="w-10 h-10 rounded-full bg-green-500 border-2 border-transparent hover:border-gray-800"></button>
                    <button onclick="setCourseColor('#f59e0b')" class="w-10 h-10 rounded-full bg-amber-500 border-2 border-transparent hover:border-gray-800"></button>
                    <button onclick="setCourseColor('#ef4444')" class="w-10 h-10 rounded-full bg-red-500 border-2 border-transparent hover:border-gray-800"></button>
                    <button onclick="setCourseColor('#06b6d4')" class="w-10 h-10 rounded-full bg-cyan-500 border-2 border-transparent hover:border-gray-800"></button>
                </div>
            </div>
            
            <button onclick="addCourse()" class="w-full px-6 py-3 rounded-lg text-white font-medium" style="background: linear-gradient(135deg, var(--primary), var(--secondary));">
                <i class="fas fa-check mr-2"></i> CrÃ©er le cours
            </button>
        </div>
    </div>

    <!-- Modal Personnalisation Agenda -->
    <div id="scheduleSettingsModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold gradient-text">ğŸ¨ Personnaliser l'Agenda</h3>
                <button onclick="closeScheduleSettings()" class="text-2xl">&times;</button>
            </div>
            
            <div class="mb-6">
                <h4 class="font-bold mb-3">Horaires personnalisÃ©s</h4>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm mb-1">Heure de dÃ©but</label>
                        <input type="time" id="scheduleStartTime" value="08:00" class="w-full p-2 border rounded-lg" style="border-color: var(--border);">
                    </div>
                    <div>
                        <label class="block text-sm mb-1">Heure de fin</label>
                        <input type="time" id="scheduleEndTime" value="18:00" class="w-full p-2 border rounded-lg" style="border-color: var(--border);">
                    </div>
                </div>
            </div>

            <div class="mb-6">
                <h4 class="font-bold mb-3">Couleurs par matiÃ¨re</h4>
                <p class="text-sm opacity-70 mb-3">Choisis une couleur pour chaque cours dans l'agenda</p>
                <div id="courseColorsList" class="space-y-2"></div>
            </div>

            <div class="mb-6">
                <h4 class="font-bold mb-3">Affichage</h4>
                <label class="flex items-center justify-between mb-3 p-3 rounded-lg card cursor-pointer">
                    <span>Afficher le week-end</span>
                    <input type="checkbox" id="showWeekendToggle" class="w-5 h-5">
                </label>
                <label class="flex items-center justify-between mb-3 p-3 rounded-lg card cursor-pointer">
                    <span>Vue compacte</span>
                    <input type="checkbox" id="compactViewToggle" class="w-5 h-5">
                </label>
            </div>

            <button onclick="applyScheduleSettings()" class="w-full px-6 py-3 rounded-lg text-white font-medium" style="background: linear-gradient(135deg, var(--primary), var(--secondary));">
                <i class="fas fa-save mr-2"></i> Appliquer les paramÃ¨tres
            </button>
        </div>
    </div>

    <!-- Modal Ajouter / Modifier Cours Ã  l'Agenda -->
    <div id="addScheduleEventModal" class="modal">
        <div class="modal-content" style="max-width:520px;">
            <div class="flex justify-between items-center mb-5">
                <h3 id="scheduleModalTitle" class="text-2xl font-bold gradient-text">â• Ajouter un cours</h3>
                <button onclick="closeAddScheduleEvent()" class="text-2xl">&times;</button>
            </div>

            <!-- Onglets : Choisir depuis mes cours / Nom libre -->
            <div class="flex rounded-lg overflow-hidden border mb-5" style="border-color:var(--border);">
                <button id="tabPickCourse" onclick="switchEventTab('pick')"
                    class="flex-1 py-2 text-sm font-medium transition"
                    style="background:var(--primary);color:white;">
                    <i class="fas fa-book mr-1"></i> Mes cours
                </button>
                <button id="tabFreeName" onclick="switchEventTab('free')"
                    class="flex-1 py-2 text-sm font-medium transition"
                    style="background:var(--border);color:var(--text-main);">
                    <i class="fas fa-pen mr-1"></i> Nom libre
                </button>
            </div>

            <!-- Panneau : SÃ©lection depuis mes cours -->
            <div id="panelPickCourse">
                <label class="block text-sm font-medium mb-2">MatiÃ¨re</label>
                <select id="eventCourseSelect" class="w-full p-3 border rounded-lg mb-4" style="border-color:var(--border);">
                    <option value="">SÃ©lectionner une matiÃ¨re...</option>
                </select>
            </div>

            <!-- Panneau : Nom libre -->
            <div id="panelFreeName" class="hidden">
                <label class="block text-sm font-medium mb-2">Nom du cours</label>
                <input type="text" id="eventFreeName" placeholder="ex: SLP2U09L" class="w-full p-3 border rounded-lg mb-3" style="border-color:var(--border);">
                <label class="block text-sm font-medium mb-2">Couleur</label>
                <div class="flex gap-2 mb-4">
                    <button onclick="setEventFreeColor('#3b82f6')" class="w-8 h-8 rounded-full bg-blue-500 ring-2 ring-offset-1 ring-transparent hover:ring-blue-500 transition" data-freecolor="#3b82f6"></button>
                    <button onclick="setEventFreeColor('#8b5cf6')" class="w-8 h-8 rounded-full bg-purple-500 ring-2 ring-offset-1 ring-transparent hover:ring-purple-500 transition" data-freecolor="#8b5cf6"></button>
                    <button onclick="setEventFreeColor('#ec4899')" class="w-8 h-8 rounded-full bg-pink-500 ring-2 ring-offset-1 ring-transparent hover:ring-pink-500 transition" data-freecolor="#ec4899"></button>
                    <button onclick="setEventFreeColor('#22c55e')" class="w-8 h-8 rounded-full bg-green-500 ring-2 ring-offset-1 ring-transparent hover:ring-green-500 transition" data-freecolor="#22c55e"></button>
                    <button onclick="setEventFreeColor('#f59e0b')" class="w-8 h-8 rounded-full bg-amber-500 ring-2 ring-offset-1 ring-transparent hover:ring-amber-500 transition" data-freecolor="#f59e0b"></button>
                    <button onclick="setEventFreeColor('#ef4444')" class="w-8 h-8 rounded-full bg-red-500 ring-2 ring-offset-1 ring-transparent hover:ring-red-500 transition" data-freecolor="#ef4444"></button>
                    <button onclick="setEventFreeColor('#06b6d4')" class="w-8 h-8 rounded-full bg-cyan-500 ring-2 ring-offset-1 ring-transparent hover:ring-cyan-500 transition" data-freecolor="#06b6d4"></button>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3 mb-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Heure de dÃ©but</label>
                    <input type="time" id="eventStartTime" class="w-full p-2 border rounded-lg" style="border-color:var(--border);">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Heure de fin</label>
                    <input type="time" id="eventEndTime" class="w-full p-2 border rounded-lg" style="border-color:var(--border);">
                </div>
            </div>

            <input type="text" id="eventLocation" placeholder="Salle (optionnel)" class="w-full p-3 border rounded-lg mb-3" style="border-color:var(--border);">
            <textarea id="eventNotes" placeholder="Notes (optionnel)" class="w-full p-3 border rounded-lg mb-5" rows="2" style="border-color:var(--border);"></textarea>

            <div class="flex gap-3">
                <button id="deleteEventBtn" onclick="deleteCurrentEvent()" class="hidden px-4 py-3 rounded-lg border font-medium text-red-500 hover:bg-red-50 transition" style="border-color:#fca5a5;">
                    <i class="fas fa-trash mr-1"></i> Supprimer
                </button>
                <button onclick="saveScheduleEvent()" class="flex-1 px-4 py-3 rounded-lg text-white font-medium" style="background:linear-gradient(135deg,var(--primary),var(--secondary));">
                    <i class="fas fa-check mr-2"></i>
                    <span id="saveEventBtnLabel">Ajouter au planning</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Import EDT AMU -->
    <div id="edtImportModal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold gradient-text">ğŸ›ï¸ Importer mon EDT AMU</h3>
                <button onclick="closeEdtImportModal()" class="text-2xl">&times;</button>
            </div>

            <div class="p-4 rounded-lg mb-5" style="background: #fff7ed; border: 1px solid #fed7aa;">
                <p class="text-sm font-medium mb-1" style="color: #c2410c;"><i class="fas fa-info-circle mr-2"></i>Comment Ã§a marche ?</p>
                <p class="text-xs opacity-80" style="color: #9a3412;">
                    Colle le lien iCal de ton EDT AMU (ADE) ci-dessous. Tu peux modifier les dates pour choisir la pÃ©riode Ã  importer. Les cours seront automatiquement ajoutÃ©s Ã  ton planning.
                </p>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">ğŸ”— Lien iCal ADE</label>
                <textarea id="edtUrlInput" rows="3" class="w-full p-3 border rounded-lg text-xs" style="border-color: var(--border); font-family: monospace;"
                    placeholder="https://ade-web-consult.univ-amu.fr/jsp/custom/modules/plannings/anonymous_cal.jsp?...">https://ade-web-consult.univ-amu.fr/jsp/custom/modules/plannings/anonymous_cal.jsp?projectId=8&resources=146872&calType=vcal&firstDate=2026-02-16&lastDate=2026-02-20</textarea>
            </div>

            <div class="grid grid-cols-2 gap-3 mb-5">
                <div>
                    <label class="block text-sm font-medium mb-2">ğŸ“… Date de dÃ©but</label>
                    <input type="date" id="edtFirstDate" class="w-full p-3 border rounded-lg" style="border-color: var(--border);">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">ğŸ“… Date de fin</label>
                    <input type="date" id="edtLastDate" class="w-full p-3 border rounded-lg" style="border-color: var(--border);">
                </div>
            </div>

            <div class="mb-5 p-3 rounded-lg text-sm" style="background: var(--border);">
                <label class="flex items-center gap-3 cursor-pointer">
                    <input type="checkbox" id="edtReplaceExisting" class="w-4 h-4">
                    <span>Remplacer les cours existants sur la pÃ©riode importÃ©e</span>
                </label>
            </div>

            <div id="edtModalStatus" class="hidden p-3 rounded-lg mb-4 text-sm font-medium"></div>

            <div class="flex gap-3">
                <button onclick="closeEdtImportModal()" class="flex-1 px-4 py-3 rounded-lg border font-medium" style="border-color: var(--border);">
                    Annuler
                </button>
                <button onclick="importEdtAmu()" class="flex-1 px-4 py-3 rounded-lg text-white font-medium" style="background: linear-gradient(135deg, #f97316, #ea580c);">
                    <i class="fas fa-file-import mr-2"></i> Importer
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Ã‰dition de Note -->
    <div id="editGradeModal" class="modal">
        <div class="modal-content" style="max-width:480px;">
            <div class="flex justify-between items-center mb-5">
                <h3 class="text-2xl font-bold gradient-text">âœï¸ Modifier la note</h3>
                <button onclick="closeEditGrade()" class="text-2xl">&times;</button>
            </div>

            <input type="hidden" id="editGradeId">
            
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">IntitulÃ©</label>
                <input type="text" id="editGradeLabel" placeholder="Ex: ContrÃ´le continu 1" class="w-full p-3 border rounded-lg" style="border-color: var(--border);">
            </div>

            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Note /20</label>
                    <input type="number" id="editGradeValue" min="0" max="20" step="0.01" placeholder="15.5" class="w-full p-3 border rounded-lg" style="border-color: var(--border);">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Coefficient</label>
                    <input type="number" id="editGradeCoef" min="0.1" max="10" step="0.1" placeholder="1" class="w-full p-3 border rounded-lg" style="border-color: var(--border);">
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="closeEditGrade()" class="flex-1 px-4 py-3 rounded-lg border font-medium" style="border-color: var(--border);">
                    Annuler
                </button>
                <button onclick="saveEditGrade()" class="flex-1 px-4 py-3 rounded-lg text-white font-medium" style="background: linear-gradient(135deg, var(--primary), var(--secondary));">
                    <i class="fas fa-save mr-2"></i> Enregistrer
                </button>
            </div>
        </div>
    </div>

    <!-- Floating Action Button -->
    <div class="floating-action" onclick="openQuickMenu()" title="Menu rapide">
        <i class="fas fa-magic text-2xl"></i>
    </div>

    <script>
        // ===== BASE DE DONNÃ‰ES =====
        const db = new Dexie("MyStudyAppUltimate");
        db.version(5).stores({
            courses: '++id, name, semester, color, ects',
            files: '++id, courseId, name, blob, category',
            grades: '++id, courseId, label, value, coef, date',
            schedule: 'id, content',
            scheduleEvents: '++id, courseId, day, startTime, endTime, location, notes, weekStart',
            tasks: '++id, title, status, priority, date, completed',
            settings: 'key, value'
        });

        let selectedCourseColor = '#3b82f6';
        let copiedScheduleCell = null;
        let currentWeekStart = getMonday(new Date());
        let selectedScheduleCell = null;

        // ===== DÃ‰TECTION ET CORRECTION DU ZOOM =====
        function checkAndFixZoom() {
            // DÃ©tecter si le viewport est trop petit
            const viewportWidth = window.innerWidth;
            const screenWidth = window.screen.width;
            
            console.log('ğŸ“ Dimensions:', {
                viewport: viewportWidth,
                screen: screenWidth,
                ratio: viewportWidth / screenWidth
            });
            
            // Si le viewport semble trop petit par rapport Ã  l'Ã©cran, c'est probablement un zoom
            if (viewportWidth < 900 && screenWidth > 1200) {
                console.warn('âš ï¸ Zoom dÃ©tectÃ© - tentative de correction');
                document.body.style.zoom = '1.0';
                document.documentElement.style.zoom = '1.0';
            }
        }
        
        // ExÃ©cuter au chargement et au redimensionnement
        window.addEventListener('load', checkAndFixZoom);
        window.addEventListener('resize', checkAndFixZoom);

        // ===== SETTINGS & THEME =====
        async function loadSettings() {
            const theme    = await getSetting('theme') || 'light';
            const userName = await getSetting('userName') || 'Champion';
            const avatar   = await getSetting('avatar') || 'ğŸ‘¨â€ğŸ“';

            setTheme(theme);
            document.getElementById('userName').value = userName;
            updateGreeting();

            // Radius
            const radius = await getSetting('borderRadius') || 'normal';
            setRadius(radius);

            // Horloge
            const showClockPref = await getSetting('showClock');
            if (showClockPref !== false) {
                setTimeout(() => toggleClock(true), 150);
            }
        }

        async function getSetting(key) {
            const setting = await db.settings.get(key);
            return setting ? setting.value : null;
        }

        async function setSetting(key, value) {
            await db.settings.put({ key, value });
        }

        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            setSetting('theme', theme);
            updateThemeSwatches(theme);
        }

        async function setAvatar(emoji) {
            await setSetting('avatar', emoji);
            updateGreeting();
            showNotification('Avatar mis Ã  jour ! ' + emoji);
        }

        async function updateGreeting() {
            const hour = new Date().getHours();
            const userName = await getSetting('userName') || 'Champion';
            const avatar = await getSetting('avatar') || 'ğŸ‘¨â€ğŸ“';
            
            let greeting = '';
            if (hour < 12) greeting = 'Bonjour';
            else if (hour < 18) greeting = 'Bon aprÃ¨s-midi';
            else greeting = 'Bonsoir';
            
            document.getElementById('greeting').innerHTML = `${avatar} ${greeting} ${userName} !`;
            
            // Citation motivante alÃ©atoire
            const quotes = [
                "La rÃ©ussite commence par un effort quotidien.",
                "Chaque jour est une nouvelle opportunitÃ©.",
                "Crois en toi et tout est possible !",
                "Le succÃ¨s est la somme de petits efforts rÃ©pÃ©tÃ©s.",
                "Tu es plus fort que tu ne le penses !",
                "L'Ã©chec est le fondement de la rÃ©ussite.",
                "Vise la lune, mÃªme si tu la rates, tu atterriras parmi les Ã©toiles.",
                "Le seul moyen d'Ã©chouer est d'abandonner."
            ];
            document.getElementById('motivational-quote').innerText = quotes[Math.floor(Math.random() * quotes.length)];
            const dateEl = document.getElementById('dash-date');
            if (dateEl) dateEl.textContent = new Date().toLocaleDateString('fr-FR', { weekday:'long', day:'numeric', month:'long' });
        }

        document.getElementById('userName').addEventListener('change', (e) => {
            setSetting('userName', e.target.value);
            updateGreeting();
        });

        // ===== NAVIGATION =====
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item-mobile').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            
            // Marquer l'item actif dans la nav desktop
            const navButtons = document.querySelectorAll('.nav-item');
            navButtons.forEach(btn => {
                if(btn.textContent.toLowerCase().includes(tabId === 'dashboard' ? 'dashboard' : 
                   tabId === 'courses' ? 'cours' : 
                   tabId === 'schedule' ? 'planning' : 
                   tabId === 'grades' ? 'notes' :
                   tabId === 'stats' ? 'stats' : 'tÃ¢ches')) {
                    btn.classList.add('active');
                }
            });

            // Marquer l'item actif dans la nav mobile
            const mobileButtons = document.querySelectorAll('.nav-item-mobile');
            mobileButtons.forEach(btn => {
                if(btn.textContent.toLowerCase().includes(tabId === 'dashboard' ? 'dashboard' : 
                   tabId === 'courses' ? 'cours' : 
                   tabId === 'schedule' ? 'planning' : 
                   tabId === 'grades' ? 'notes' :
                   tabId === 'stats' ? 'stats' : 'tÃ¢ches')) {
                    btn.classList.add('active');
                }
            });
            
            if (tabId === 'stats') renderCharts();
            if (tabId === 'dashboard') updateDashboard();
            if (tabId === 'tasks') renderTasks();
        }

        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            const icon = document.querySelector('#mobileMenuBtn i');
            
            if(menu.classList.contains('hidden')) {
                menu.classList.remove('hidden');
                icon.classList.remove('fa-bars');
                icon.classList.add('fa-times');
            } else {
                menu.classList.add('hidden');
                icon.classList.remove('fa-times');
                icon.classList.add('fa-bars');
            }
        }

        function closeMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            const icon = document.querySelector('#mobileMenuBtn i');
            menu.classList.add('hidden');
            icon.classList.remove('fa-times');
            icon.classList.add('fa-bars');
        }

        // ===== MODALS =====
        function openSettings() {
            document.getElementById('settingsModal').classList.add('active');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        function openCourseModal() {
            document.getElementById('courseModal').classList.add('active');
        }

        function closeCourseModal() {
            document.getElementById('courseModal').classList.remove('active');
        }

        function setCourseColor(color) {
            selectedCourseColor = color;
        }

        // ===== COURS =====
        async function addCourse() {
            const name = document.getElementById('courseNameInput').value;
            const semester = document.getElementById('courseSemesterInput').value;
            const ects = parseFloat(document.getElementById('courseEctsInput').value) || null;
            
            if(!name) return showNotification('âš ï¸ Nom manquant', 'warning');

            await db.courses.add({ name, semester, color: selectedCourseColor, ects });
            document.getElementById('courseNameInput').value = '';
            document.getElementById('courseEctsInput').value = '';
            selectedCourseColor = '#3b82f6';
            closeCourseModal();
            showNotification('âœ… Cours ajoutÃ© avec succÃ¨s !');
            await refreshUI();
            launchConfetti();
        }

        // CatÃ©gories de fichiers
        const FILE_CATEGORIES = [
            { id: 'cm',    label: 'CM',            icon: 'fa-chalkboard-teacher', color: '#3b82f6' },
            { id: 'td',    label: 'TD',             icon: 'fa-pencil-alt',         color: '#8b5cf6' },
            { id: 'tp',    label: 'TP',             icon: 'fa-flask',              color: '#06b6d4' },
            { id: 'fiche', label: 'Fiches',         icon: 'fa-sticky-note',        color: '#f59e0b' },
            { id: 'exam',  label: 'Examens',        icon: 'fa-graduation-cap',     color: '#ef4444' },
            { id: 'autre', label: 'Autre',          icon: 'fa-folder',             color: '#6b7280' },
        ];

        async function uploadFile(courseId, inputElement, category) {
            const file = inputElement.files[0];
            if (!file) return;
            const cat = category || 'autre';
            await db.files.add({ courseId, name: file.name, blob: file, category: cat });
            showNotification('ğŸ“„ Fichier ajoutÃ© !');
            await refreshUI();
        }

        async function deleteFile(id) {
            if(confirm('Supprimer ce fichier ?')) {
                await db.files.delete(id);
                showNotification('ğŸ—‘ï¸ Fichier supprimÃ©');
                await refreshUI();
            }
        }

        async function deleteCourse(id) {
            if(confirm('Supprimer ce cours et tous ses fichiers/notes ?')) {
                await db.courses.delete(id);
                await db.files.where('courseId').equals(id).delete();
                await db.grades.where('courseId').equals(id).delete();
                showNotification('ğŸ—‘ï¸ Cours supprimÃ©');
                await refreshUI();
            }
        }

        function filterCourses(filter) {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            document.querySelectorAll('.course-card').forEach(card => {
                if(filter === 'all' || card.dataset.semester === filter) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        async function renderCourses() {
            let courses = await db.courses.toArray();
            const container = document.getElementById('coursesList');
            const select = document.getElementById('gradeCourseSelect');

            container.innerHTML = '';
            select.innerHTML = '<option value="">Choisir une matiÃ¨re...</option>';

            // Tri selon sÃ©lection
            const sortVal = document.getElementById('coursesSortSelect')?.value || 'name';
            if (sortVal === 'name') {
                courses.sort((a, b) => a.name.localeCompare(b.name));
            } else if (sortVal === 'semester') {
                courses.sort((a, b) => a.semester.localeCompare(b.semester) || a.name.localeCompare(b.name));
            } else if (sortVal === 'avg') {
                const avgs = {};
                for (const c of courses) {
                    const g = await db.grades.where('courseId').equals(c.id).toArray();
                    avgs[c.id] = g.length > 0 ? g.reduce((a,b) => a + b.value*(b.coef||1),0) / g.reduce((a,b) => a+(b.coef||1),0) : -1;
                }
                courses.sort((a, b) => avgs[b.id] - avgs[a.id]);
            }

            // Compteur
            const countEl = document.getElementById('coursesCount');
            if (countEl) countEl.textContent = `${courses.length} cours au total`;

            const s1Courses = courses.filter(c => c.semester === 'S1');
            const s2Courses = courses.filter(c => c.semester === 'S2');

            const renderSemesterCourses = async (semesterCourses, semesterName) => {
                if(semesterCourses.length === 0) return;

                const semesterDiv = document.createElement('div');
                semesterDiv.className = 'col-span-full mb-4';
                semesterDiv.innerHTML = `
                    <div class="flex items-center gap-3 mb-4">
                        <h4 class="text-xl font-bold gradient-text">${semesterName}</h4>
                        <div class="flex-1 h-px" style="background: var(--border);"></div>
                        <span class="badge" style="background: var(--border); color: var(--text-main);">${semesterCourses.length} cours</span>
                    </div>
                `;
                container.appendChild(semesterDiv);

                for (const course of semesterCourses) {
                    const option = document.createElement('option');
                    option.value = course.id;
                    option.innerText = `${course.name} (${course.semester})`;
                    select.appendChild(option);

                    const files = await db.files.where('courseId').equals(course.id).toArray();
                    const grades = await db.grades.where('courseId').equals(course.id).toArray();
                    const avgGrade = grades.length > 0 ? (grades.reduce((a, b) => a + (b.value * (b.coef || 1)), 0) / grades.reduce((a, b) => a + (b.coef || 1), 0)).toFixed(2) : '--';

                    const div = document.createElement('div');
                    div.className = 'card rounded-lg p-5 hover:shadow-xl transition course-card';
                    div.dataset.semester = course.semester;
                    div.style.borderLeft = `4px solid ${course.color || '#3b82f6'}`;
                    
                    div.innerHTML = `
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex-1">
                                <h4 class="font-bold text-xl mb-2" style="color: ${course.color}">${course.name}</h4>
                                <div class="flex gap-2 flex-wrap">
                                    <span class="badge text-xs" style="background: ${course.color}; color: white;">${course.semester}</span>
                                    ${course.ects ? `<span class="badge text-xs" style="background: var(--secondary); color: white;">ğŸ“ ${course.ects} ECTS</span>` : ''}
                                    <span class="badge text-xs" style="background: var(--border); color: var(--text-main);">
                                        ğŸ“Š Moyenne: ${avgGrade}/20
                                    </span>
                                    <span class="badge text-xs" style="background: var(--border); color: var(--text-main);">
                                        ğŸ“ ${files.length} fichier${files.length > 1 ? 's' : ''}
                                    </span>
                                    <span class="badge text-xs" style="background: var(--border); color: var(--text-main);">
                                        ğŸ“ ${grades.length} note${grades.length > 1 ? 's' : ''}
                                    </span>
                                </div>
                            </div>
                            <button onclick="deleteCourse(${course.id})" class="text-red-500 hover:text-red-700 text-xl transition" title="Supprimer le cours">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        
                        <!-- Zone d'upload par catÃ©gorie -->
                        <div class="mb-3">
                            <p class="text-xs font-semibold uppercase opacity-50 mb-2">ğŸ“ Ajouter un fichier</p>
                            <div class="flex flex-wrap gap-2">
                                ${FILE_CATEGORIES.map(cat => `
                                    <label class="cursor-pointer flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-semibold text-white transition hover:opacity-80 active:scale-95"
                                        style="background:${cat.color};" title="Ajouter un fichier ${cat.label}">
                                        <i class="fas ${cat.icon}"></i>
                                        <span>${cat.label}</span>
                                        <input type="file" class="hidden" accept=".pdf,.jpg,.jpeg,.png,.docx,.doc,.ppt,.pptx"
                                            onchange="uploadFile(${course.id}, this, '${cat.id}')">
                                    </label>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Onglets fichiers par catÃ©gorie -->
                        <div class="card rounded-lg overflow-hidden">
                            <!-- Barre d'onglets -->
                            <div class="flex overflow-x-auto border-b" style="border-color:var(--border); scrollbar-width:none;">
                                <button onclick="switchFileTab(this, ${course.id}, 'all')"
                                    class="file-tab-btn flex-shrink-0 px-3 py-2 text-xs font-semibold border-b-2 transition whitespace-nowrap"
                                    style="border-color:var(--primary); color:var(--primary);"
                                    data-course="${course.id}" data-cat="all">
                                    Tous <span class="ml-1 opacity-60">(${files.length})</span>
                                </button>
                                ${FILE_CATEGORIES.map(cat => {
                                    const count = files.filter(f => (f.category||'autre') === cat.id).length;
                                    return `<button onclick="switchFileTab(this, ${course.id}, '${cat.id}')"
                                        class="file-tab-btn flex-shrink-0 px-3 py-2 text-xs font-medium border-b-2 border-transparent transition whitespace-nowrap hover:opacity-80"
                                        style="color:${cat.color};"
                                        data-course="${course.id}" data-cat="${cat.id}">
                                        <i class="fas ${cat.icon} mr-1"></i>${cat.label}
                                        ${count > 0 ? `<span class="ml-1 font-bold">${count}</span>` : ''}
                                    </button>`;
                                }).join('')}
                            </div>

                            <!-- Contenu des fichiers -->
                            <div class="p-3">
                                <div class="flex justify-between items-center mb-2">
                                    <span id="file-tab-label-${course.id}" class="text-xs font-bold uppercase opacity-50">Tous les fichiers</span>
                                    ${files.length > 0 ? `<button onclick="downloadAllFiles(${course.id}, '${course.name}')" class="text-xs hover:underline" style="color:${course.color};">â¬‡ Tout tÃ©lÃ©charger</button>` : ''}
                                </div>
                                <ul id="file-list-${course.id}" class="space-y-1.5 max-h-52 overflow-y-auto">
                                    ${files.length === 0
                                        ? '<li class="text-xs opacity-40 italic text-center py-4">Aucun fichier â€” clique sur une catÃ©gorie pour en ajouter</li>'
                                        : files.map(f => {
                                            const cat = FILE_CATEGORIES.find(c => c.id === (f.category||'autre')) || FILE_CATEGORIES[5];
                                            return `<li class="file-item flex items-center gap-2 text-sm p-2 rounded-lg transition hover:shadow" data-cat="${f.category||'autre'}" style="background:var(--border);">
                                                <span class="flex-shrink-0 w-6 h-6 rounded flex items-center justify-center text-white text-xs" style="background:${cat.color};">
                                                    <i class="fas ${cat.icon}"></i>
                                                </span>
                                                <a href="${URL.createObjectURL(f.blob)}" target="_blank" class="truncate flex-1 hover:underline font-medium text-xs" style="color:var(--primary);">
                                                    ${f.name}
                                                </a>
                                                <span class="text-xs font-bold px-1.5 py-0.5 rounded flex-shrink-0" style="background:${cat.color}20; color:${cat.color};">${cat.label}</span>
                                                <button onclick="deleteFile(${f.id})" class="flex-shrink-0 text-red-400 hover:text-red-600 transition text-xs">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </li>`;
                                        }).join('')
                                    }
                                </ul>
                            </div>
                        </div>
                    `;
                    container.appendChild(div);
                }
            };

            await renderSemesterCourses(s1Courses, 'ğŸ“˜ Semestre 1');
            await renderSemesterCourses(s2Courses, 'ğŸ“— Semestre 2');
            
            const fileCount = await db.files.count();
            document.getElementById('dash-files-count').innerText = fileCount;
        }

        // ===== ONGLETS FICHIERS PAR CATÃ‰GORIE =====
        function switchFileTab(btn, courseId, category) {
            // Mettre Ã  jour l'apparence des onglets
            document.querySelectorAll(`.file-tab-btn[data-course="${courseId}"]`).forEach(b => {
                const cat = FILE_CATEGORIES.find(c => c.id === b.dataset.cat);
                b.style.borderColor  = 'transparent';
                b.style.color        = cat ? cat.color : 'var(--text-main)';
                b.style.fontWeight   = '500';
            });

            // Activer l'onglet cliquÃ©
            const activeCat = FILE_CATEGORIES.find(c => c.id === category);
            btn.style.borderColor = activeCat ? activeCat.color : 'var(--primary)';
            btn.style.color       = activeCat ? activeCat.color : 'var(--primary)';
            btn.style.fontWeight  = '700';

            // Filtrer les fichiers
            const items = document.querySelectorAll(`#file-list-${courseId} .file-item`);
            items.forEach(item => {
                item.style.display = (category === 'all' || item.dataset.cat === category) ? '' : 'none';
            });

            // Mettre Ã  jour le label
            const label = document.getElementById(`file-tab-label-${courseId}`);
            if (label) {
                label.textContent = category === 'all'
                    ? 'Tous les fichiers'
                    : (activeCat ? `Fichiers â€” ${activeCat.label}` : category);
            }
        }

        async function downloadAllFiles(courseId, courseName) {
            const files = await db.files.where('courseId').equals(courseId).toArray();
            
            for(const file of files) {
                const url = URL.createObjectURL(file.blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = file.name;
                a.click();
                await new Promise(resolve => setTimeout(resolve, 200)); // DÃ©lai entre tÃ©lÃ©chargements
            }
            
            showNotification(`ğŸ“¥ ${files.length} fichier(s) de ${courseName} tÃ©lÃ©chargÃ©(s) !`);
        }

        // ===== NOTES =====
        async function addGrade() {
            const courseId = parseInt(document.getElementById('gradeCourseSelect').value);
            const value = parseFloat(document.getElementById('gradeValue').value);
            const coef = parseFloat(document.getElementById('gradeCoef').value) || 1;
            const label = document.getElementById('gradeLabel').value;
            const date = new Date().toISOString();

            if (!courseId || isNaN(value)) return showNotification('âš ï¸ Veuillez remplir les champs', 'warning');

            await db.grades.add({ courseId, value, coef, label, date });
            document.getElementById('gradeValue').value = '';
            document.getElementById('gradeLabel').value = '';
            document.getElementById('gradeCoef').value = '1';
            
            showNotification('ğŸ¯ Note enregistrÃ©e !');
            await refreshUI();
            
            if(value >= 15) launchConfetti();
        }

        async function renderGrades() {
            const courses = await db.courses.toArray();
            const container = document.getElementById('gradesList');
            container.innerHTML = '';
            
            let totalWeightedSum = 0;
            let totalCoef = 0;
            
            // Variables pour moyennes par semestre
            let s1WeightedSum = 0;
            let s1Coef = 0;
            let s2WeightedSum = 0;
            let s2Coef = 0;

            // Grouper par semestre
            const s1Courses = courses.filter(c => c.semester === 'S1');
            const s2Courses = courses.filter(c => c.semester === 'S2');

            const renderSemester = async (semesterCourses, semesterName, isS1) => {
                const semesterDiv = document.createElement('div');
                semesterDiv.className = 'mb-6';
                
                let semesterHtml = `
                    <div class="flex items-center gap-3 mb-4">
                        <h4 class="text-xl font-bold gradient-text">${semesterName}</h4>
                        <div class="flex-1 h-px" style="background: var(--border);"></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                `;

                let semesterTotal = 0;
                let semesterCoefTotal = 0;

                for (const course of semesterCourses) {
                    const grades = await db.grades.where('courseId').equals(course.id).toArray();
                    if (grades.length === 0) continue;

                    const weightedSum = grades.reduce((a, b) => a + (b.value * (b.coef || 1)), 0);
                    const coefSum = grades.reduce((a, b) => a + (b.coef || 1), 0);
                    const avg = (weightedSum / coefSum).toFixed(2);
                    
                    // Utiliser les ECTS comme coefficient du cours, sinon coefficient = 1
                    const courseCoef = course.ects || 1;
                    
                    totalWeightedSum += parseFloat(avg) * courseCoef;
                    totalCoef += courseCoef;
                    semesterTotal += parseFloat(avg) * courseCoef;
                    semesterCoefTotal += courseCoef;
                    
                    // Accumuler pour moyennes par semestre
                    if (isS1) {
                        s1WeightedSum += parseFloat(avg) * courseCoef;
                        s1Coef += courseCoef;
                    } else {
                        s2WeightedSum += parseFloat(avg) * courseCoef;
                        s2Coef += courseCoef;
                    }

                    // Calcul des stats
                    const maxGrade = Math.max(...grades.map(g => g.value));
                    const minGrade = Math.min(...grades.map(g => g.value));
                    const lastGrade = grades.sort((a, b) => new Date(b.date) - new Date(a.date))[0];

                    semesterHtml += `
                        <div class="card rounded-lg p-5 hover:shadow-xl transition" style="border-left: 4px solid ${course.color || '#3b82f6'};">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex-1">
                                    <h5 class="font-bold text-lg mb-1" style="color: ${course.color}">${course.name}</h5>
                                    <div class="flex gap-2 flex-wrap">
                                        <span class="badge text-xs" style="background: ${course.color}; color: white;">
                                            ${grades.length} note${grades.length > 1 ? 's' : ''}
                                        </span>
                                        ${course.ects ? `<span class="badge text-xs" style="background: var(--secondary); color: white;">ğŸ“ ${course.ects} ECTS</span>` : ''}
                                        <span class="badge text-xs" style="background: var(--border); color: var(--text-main);">
                                            ğŸ“Š Moy: ${avg}/20
                                        </span>
                                        ${avg >= 15 ? '<span class="badge text-xs" style="background: #22c55e; color: white;">ğŸŒŸ Excellent</span>' : 
                                          avg >= 12 ? '<span class="badge text-xs" style="background: #f59e0b; color: white;">ğŸ‘ Bien</span>' : 
                                          avg >= 10 ? '<span class="badge text-xs" style="background: #3b82f6; color: white;">âœ“ ValidÃ©</span>' : 
                                          '<span class="badge text-xs" style="background: #ef4444; color: white;">âš ï¸ Ã€ amÃ©liorer</span>'}
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-3xl font-bold ${avg < 10 ? 'text-red-500' : avg < 14 ? 'text-yellow-500' : 'text-green-600'}">${avg}</div>
                                    <div class="text-xs opacity-60">/20</div>
                                </div>
                            </div>
                            
                            <div class="progress-bar mb-3">
                                <div class="progress-fill" style="width: ${(avg/20)*100}%; background: ${course.color || 'var(--primary)'}"></div>
                            </div>

                            <div class="grid grid-cols-3 gap-2 mb-3 text-center">
                                <div class="p-2 rounded" style="background: var(--border);">
                                    <div class="text-xs opacity-60">Meilleure</div>
                                    <div class="font-bold text-green-600">${maxGrade}/20</div>
                                </div>
                                <div class="p-2 rounded" style="background: var(--border);">
                                    <div class="text-xs opacity-60">DerniÃ¨re</div>
                                    <div class="font-bold" style="color: ${course.color}">${lastGrade.value}/20</div>
                                </div>
                                <div class="p-2 rounded" style="background: var(--border);">
                                    <div class="text-xs opacity-60">Plus basse</div>
                                    <div class="font-bold text-red-600">${minGrade}/20</div>
                                </div>
                            </div>

                            <details class="cursor-pointer">
                                <summary class="font-medium text-sm mb-2 hover:opacity-70 transition">
                                    <i class="fas fa-chevron-down mr-2"></i>Voir toutes les notes (${grades.length})
                                </summary>
                                <ul class="space-y-2 mt-2 max-h-60 overflow-y-auto">
                                    ${grades.sort((a, b) => new Date(b.date) - new Date(a.date)).map(g => `
                                        <li class="flex justify-between items-center text-sm p-3 rounded transition hover:shadow" style="background: var(--border);">
                                            <div class="flex-1">
                                                <span class="font-medium">${g.label || 'Note'}</span>
                                                <div class="text-xs opacity-60 mt-1">
                                                    <i class="far fa-calendar mr-1"></i>${new Date(g.date).toLocaleDateString('fr-FR')}
                                                    ${g.coef > 1 ? `<span class="badge ml-2" style="background: ${course.color}; color: white; font-size: 0.6rem;">Coef. ${g.coef}</span>` : ''}
                                                </div>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <span class="font-mono font-bold text-lg ${g.value >= 15 ? 'text-green-600' : g.value >= 10 ? 'text-blue-600' : 'text-red-600'}">${g.value}/20</span>
                                                <button onclick="openEditGrade(${g.id})" class="text-blue-400 hover:text-blue-600 transition" title="Modifier">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button onclick="deleteGrade(${g.id})" class="text-red-300 hover:text-red-500 transition" title="Supprimer">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        </li>
                                    `).join('')}
                                </ul>
                            </details>
                        </div>
                    `;
                }

                semesterHtml += '</div>';

                if(semesterCoefTotal > 0) {
                    const semesterAvg = (semesterTotal / semesterCoefTotal).toFixed(2);
                    semesterHtml = `
                        <div class="flex items-center gap-3 mb-4">
                            <h4 class="text-xl font-bold gradient-text">${semesterName}</h4>
                            <div class="flex-1 h-px" style="background: var(--border);"></div>
                            <div class="text-right">
                                <div class="text-sm opacity-60">Moyenne ${semesterName}</div>
                                <div class="text-2xl font-bold ${semesterAvg >= 14 ? 'text-green-600' : semesterAvg >= 10 ? 'text-blue-600' : 'text-red-600'}">${semesterAvg}/20</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    ` + semesterHtml.split('</div>').slice(1).join('</div>');
                }

                semesterDiv.innerHTML = semesterHtml;
                container.appendChild(semesterDiv);
            };

            await renderSemester(s1Courses, 'ğŸ“˜ Semestre 1', true);
            await renderSemester(s2Courses, 'ğŸ“— Semestre 2', false);
            
            // Stocker les moyennes par semestre pour utilisation ultÃ©rieure
            window.semesterAverages = {
                s1: s1Coef > 0 ? (s1WeightedSum / s1Coef).toFixed(2) : "--",
                s2: s2Coef > 0 ? (s2WeightedSum / s2Coef).toFixed(2) : "--"
            };
            
            // Afficher la moyenne du semestre actuel par dÃ©faut
            updateDashboardAverage();
        }

        async function deleteGrade(id) {
            if(confirm('Supprimer cette note ?')) {
                await db.grades.delete(id);
                showNotification('ğŸ—‘ï¸ Note supprimÃ©e');
                await refreshUI();
            }
        }
        
        // Fonction pour ouvrir le modal d'Ã©dition de note
        async function openEditGrade(gradeId) {
            const grade = await db.grades.get(gradeId);
            if (!grade) return;
            
            document.getElementById('editGradeId').value = gradeId;
            document.getElementById('editGradeLabel').value = grade.label || '';
            document.getElementById('editGradeValue').value = grade.value;
            document.getElementById('editGradeCoef').value = grade.coef || 1;
            
            document.getElementById('editGradeModal').classList.add('active');
        }
        
        // Fonction pour fermer le modal d'Ã©dition de note
        function closeEditGrade() {
            document.getElementById('editGradeModal').classList.remove('active');
        }
        
        // Fonction pour sauvegarder les modifications de la note
        async function saveEditGrade() {
            const gradeId = parseInt(document.getElementById('editGradeId').value);
            const label = document.getElementById('editGradeLabel').value;
            const value = parseFloat(document.getElementById('editGradeValue').value);
            const coef = parseFloat(document.getElementById('editGradeCoef').value) || 1;
            
            if (isNaN(value) || value < 0 || value > 20) {
                return showNotification('âš ï¸ La note doit Ãªtre entre 0 et 20', 'warning');
            }
            
            await db.grades.update(gradeId, { label, value, coef });
            
            closeEditGrade();
            showNotification('âœ… Note modifiÃ©e !');
            await refreshUI();
        }
        
        // Fonction pour dÃ©terminer le semestre actuel (basÃ© sur le mois)
        function getCurrentSemester() {
            const now = new Date();
            const month = now.getMonth(); // 0 = janvier, 11 = dÃ©cembre
            
            // Semestre 1 : septembre (8) Ã  janvier (0)
            // Semestre 2 : fÃ©vrier (1) Ã  juin (5)
            // En Ã©tÃ© (juillet-aoÃ»t), on affiche le S2 qui vient de se terminer
            if (month >= 1 && month <= 7) {
                return 'S2';
            } else {
                return 'S1';
            }
        }
        
        // Fonction pour mettre Ã  jour la moyenne affichÃ©e selon le semestre sÃ©lectionnÃ©
        function updateDashboardAverage() {
            const selector = document.getElementById('semesterSelector');
            const selectedValue = selector ? selector.value : 'current';
            
            if (!window.semesterAverages) {
                window.semesterAverages = { s1: "--", s2: "--" };
            }
            
            let displayAvg;
            const currentSem = getCurrentSemester();
            
            if (selectedValue === 'current') {
                // Afficher le semestre actuel
                displayAvg = currentSem === 'S2' ? window.semesterAverages.s2 : window.semesterAverages.s1;
            } else {
                // Afficher le semestre prÃ©cÃ©dent
                displayAvg = currentSem === 'S2' ? window.semesterAverages.s1 : window.semesterAverages.s2;
            }
            
            document.getElementById('dash-global-avg').innerText = displayAvg + "/20";
            
            const avgProgress = displayAvg !== "--" ? (parseFloat(displayAvg) / 20) * 100 : 0;
            document.getElementById('avg-progress').style.width = avgProgress + '%';
        }

        async function saveAllGrades() {
            const grades = await db.grades.toArray();
            const courses = await db.courses.toArray();

            const data = {
                exportDate: new Date().toISOString(),
                courses: courses.map(c => ({
                    name: c.name,
                    semester: c.semester,
                    grades: grades.filter(g => g.courseId === c.id).map(g => ({
                        label: g.label,
                        value: g.value,
                        coef: g.coef,
                        date: g.date
                    }))
                }))
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `notes-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            showNotification('ğŸ’¾ Notes sauvegardÃ©es !');
        }

        // ===== PLANNING / AGENDA =====
        function getMonday(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function formatDate(date) {
            return date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });
        }

        function previousWeek() {
            currentWeekStart = new Date(currentWeekStart);
            currentWeekStart.setDate(currentWeekStart.getDate() - 7);
            initSchedule();
        }

        function currentWeek() {
            currentWeekStart = getMonday(new Date());
            initSchedule();
        }

        function nextWeek() {
            currentWeekStart = new Date(currentWeekStart);
            currentWeekStart.setDate(currentWeekStart.getDate() + 7);
            initSchedule();
        }

        async function initSchedule() {
            const showWeekend = await getSetting('showWeekend') || false;
            const scheduleStart = await getSetting('scheduleStart') || '08:00';
            const scheduleEnd   = await getSetting('scheduleEnd')   || '18:00';

            const startHour = parseInt(scheduleStart.split(':')[0]);
            const endHour   = parseInt(scheduleEnd.split(':')[0]);
            const hours = [];
            for (let h = startHour; h <= endHour; h++) {
                hours.push(`${h.toString().padStart(2,'0')}:00`);
            }

            const dayLabels = showWeekend
                ? ['Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi','Dimanche']
                : ['Lundi','Mardi','Mercredi','Jeudi','Vendredi'];

            const numDays = dayLabels.length;
            const numRows = hours.length; // une ligne par heure

            // â”€â”€ Affichage semaine â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const weekEnd = new Date(currentWeekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            document.getElementById('weekDisplay').innerText =
                `Semaine du ${formatDate(currentWeekStart)} au ${formatDate(weekEnd)}`;

            // â”€â”€ Grille : row 1 = headers, rows 2..N+1 = heures â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const grid = document.getElementById('scheduleGrid');
            grid.innerHTML = '';
            // Colonnes : 80px pour les heures + 1fr par jour
            grid.style.gridTemplateColumns = `80px repeat(${numDays}, 1fr)`;
            // Lignes : auto pour header + 70px par crÃ©neau horaire
            grid.style.gridTemplateRows = `auto repeat(${numRows}, 70px)`;

            // â”€â”€ En-tÃªtes (row 1) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // Cellule coin haut-gauche
            const cornerDiv = document.createElement('div');
            cornerDiv.className = 'schedule-header';
            cornerDiv.innerText = 'Heure';
            cornerDiv.style.gridRow = '1';
            cornerDiv.style.gridColumn = '1';
            grid.appendChild(cornerDiv);

            dayLabels.forEach((day, idx) => {
                const div = document.createElement('div');
                div.className = 'schedule-header';
                div.style.gridRow = '1';
                div.style.gridColumn = `${idx + 2}`;

                const dayDate = new Date(currentWeekStart);
                dayDate.setDate(dayDate.getDate() + idx);
                const isToday = dayDate.toDateString() === new Date().toDateString();

                div.innerHTML = `
                    <div class="text-xs opacity-80">${day}</div>
                    <div class="font-bold ${isToday ? 'text-yellow-300' : ''}">${dayDate.getDate()}</div>
                `;
                if (isToday) div.style.background = 'linear-gradient(135deg, var(--accent), var(--primary))';
                grid.appendChild(div);
            });

            // â”€â”€ Cellules heures + jours (rows 2..N+1) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const courses     = await db.courses.toArray();
            const weekStartStr = currentWeekStart.toISOString().split('T')[0];

            // PrÃ©-charger tous les events de la semaine en une seule requÃªte
            const allEvents = await db.scheduleEvents
                .where('weekStart').equals(weekStartStr)
                .toArray();

            // Ensemble des cellules dÃ©jÃ  couvertes par un span (col, row) â†’ true
            const coveredCells = new Set();

            for (let h = 0; h < hours.length; h++) {
                const gridRow = h + 2; // row CSS (header = 1, premier crÃ©neau = 2)

                // â”€â”€ Cellule heure â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                const timeDiv = document.createElement('div');
                timeDiv.className = 'p-2 text-center text-xs font-bold flex items-center justify-center';
                timeDiv.style.background   = 'var(--border)';
                timeDiv.style.gridRow      = `${gridRow}`;
                timeDiv.style.gridColumn   = '1';
                timeDiv.innerText = hours[h];
                grid.appendChild(timeDiv);

                // â”€â”€ Cellules jours â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                for (let d = 0; d < numDays; d++) {
                    const gridCol = d + 2;
                    const cellKey = `${gridCol}-${gridRow}`;

                    // Si cette cellule est dÃ©jÃ  couverte par un span â†’ on la saute
                    if (coveredCells.has(cellKey)) continue;

                    const cell = document.createElement('div');
                    cell.className = 'schedule-cell relative group';
                    cell.dataset.day  = d;
                    cell.dataset.hour = hours[h];
                    cell.style.gridRow    = `${gridRow}`;
                    cell.style.gridColumn = `${gridCol}`;

                    // Event qui dÃ©marre exactement Ã  cette heure/jour
                    const event = allEvents.find(e => e.day === d && e.startTime === hours[h]);

                    if (event) {
                        const course   = event.courseId ? courses.find(c => c.id === event.courseId) : null;
                        const duration = calculateDuration(event.startTime, event.endTime);

                        // RÃ©soudre nom et couleur (cours DB ou nom libre)
                        const displayName  = course ? course.name  : (event.freeName  || 'Cours');
                        const displayColor = course ? course.color : (event.freeColor || '#3b82f6');

                        if (duration > 0) {
                            cell.style.gridRow = `${gridRow} / span ${duration}`;

                            for (let s = 1; s < duration; s++) {
                                coveredCells.add(`${gridCol}-${gridRow + s}`);
                            }

                            // Extraire le type de cours depuis les notes (SUMMARY d'origine ADE)
                            const showType = document.getElementById('showCourseTypeToggle')?.checked !== false;
                            let courseType = '';
                            if (showType && event.notes) {
                                const typeMatch = event.notes.match(/-(\s*)(CM\d?|TD\d?|TP\d?|Cours|Exam)/i);
                                if (typeMatch) courseType = typeMatch[2].toUpperCase();
                            }

                            cell.innerHTML = `
                                <div class="p-2 rounded h-full cursor-pointer" style="background:${displayColor}25; border-left:3px solid ${displayColor};">
                                    <div class="flex justify-between items-start">
                                        <div class="font-bold text-sm leading-tight flex-1 min-w-0" style="color:${displayColor};">
                                            <span class="truncate block">${displayName}</span>
                                        </div>
                                        <div class="flex items-center gap-1 ml-1 flex-shrink-0">
                                            ${courseType ? `<span class="text-white text-xs rounded px-1 font-bold" style="background:${displayColor}; font-size:0.6rem;">${courseType}</span>` : ''}
                                            <button class="edit-event-btn opacity-0 group-hover:opacity-100 transition w-5 h-5 rounded text-xs flex items-center justify-center" style="background:${displayColor}; color:white;" title="Modifier">
                                                <i class="fas fa-pen" style="font-size:0.55rem;"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="text-xs opacity-70 mt-1">${event.startTime} â€“ ${event.endTime}</div>
                                    ${event.location ? `<div class="text-xs opacity-60 mt-0.5 truncate"><i class="fas fa-map-marker-alt mr-1"></i>${event.location}</div>` : ''}
                                </div>`;

                            // Clic sur le crayon â†’ Ã©dition
                            cell.querySelector('.edit-event-btn').addEventListener('click', (e) => {
                                e.stopPropagation();
                                openEditScheduleEvent(event);
                            });

                            // Clic sur la cellule entiÃ¨re â†’ Ã©dition aussi
                            cell.addEventListener('click', (e) => {
                                if (!e.target.closest('button')) openEditScheduleEvent(event);
                            });
                        }

                        // Suppression double-clic / long-press
                        let pressTimer;
                        cell.addEventListener('touchstart', () => {
                            pressTimer = setTimeout(async () => {
                                if (confirm('Supprimer ce cours ?')) {
                                    await db.scheduleEvents.delete(event.id);
                                    initSchedule();
                                    showNotification('ğŸ—‘ï¸ Cours supprimÃ©');
                                }
                            }, 800);
                        });
                        cell.addEventListener('touchend',  () => clearTimeout(pressTimer));
                        cell.addEventListener('touchmove', () => clearTimeout(pressTimer));
                        cell.ondblclick = async () => {
                            if (confirm('Supprimer ce cours ?')) {
                                await db.scheduleEvents.delete(event.id);
                                await initSchedule();
                                showNotification('ğŸ—‘ï¸ Cours supprimÃ©');
                            }
                        };
                    }

                    // Bouton + au survol
                    const addBtn = document.createElement('button');
                    addBtn.innerHTML = '<i class="fas fa-plus"></i>';
                    addBtn.className = 'absolute top-1 right-1 w-6 h-6 rounded-full text-xs opacity-0 group-hover:opacity-100 transition';
                    addBtn.style.background = 'var(--primary)';
                    addBtn.style.color = 'white';
                    addBtn.onclick = (e) => { e.stopPropagation(); openAddScheduleEvent(d, hours[h]); };
                    cell.appendChild(addBtn);

                    grid.appendChild(cell);
                }
            }
        }

        function calculateDuration(startTime, endTime) {
            const start = parseInt(startTime.split(':')[0]);
            const end = parseInt(endTime.split(':')[0]);
            return end - start;
        }

        // ===== IMPORT EDT AMU =====

        function openEdtImportModal() {
            // PrÃ©-remplir les dates avec la semaine courante
            const monday = new Date(currentWeekStart);
            const friday = new Date(currentWeekStart);
            friday.setDate(friday.getDate() + 4);
            document.getElementById('edtFirstDate').value = monday.toISOString().split('T')[0];
            document.getElementById('edtLastDate').value = friday.toISOString().split('T')[0];
            document.getElementById('edtModalStatus').classList.add('hidden');
            document.getElementById('edtImportModal').classList.add('active');
        }

        function closeEdtImportModal() {
            document.getElementById('edtImportModal').classList.remove('active');
        }

        function updateEdtUrlDates() {
            const first = document.getElementById('edtFirstDate').value;
            const last = document.getElementById('edtLastDate').value;
            if (!first || !last) return;
            let url = document.getElementById('edtUrlInput').value;
            url = url.replace(/firstDate=[^&]+/, `firstDate=${first}`);
            url = url.replace(/lastDate=[^&]+/, `lastDate=${last}`);
            document.getElementById('edtUrlInput').value = url;
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('edtFirstDate').addEventListener('change', updateEdtUrlDates);
            document.getElementById('edtLastDate').addEventListener('change', updateEdtUrlDates);
        });

        function parseIcal(icalText) {
            const events = [];

            // DÃ©plier les lignes continuÃ©es RFC 5545 (ligne suivante commence par espace/tab)
            const unfolded = icalText.replace(/\r\n([ \t])/g, '$1').replace(/\n([ \t])/g, '$1');
            const lines = unfolded.split(/\r\n|\n|\r/);

            let current = null;
            for (const line of lines) {
                if (line === 'BEGIN:VEVENT') {
                    current = {};
                } else if (line === 'END:VEVENT' && current) {
                    if (current.dtstart && current.dtend) events.push(current);
                    current = null;
                } else if (current) {
                    const colonIdx = line.indexOf(':');
                    if (colonIdx === -1) continue;
                    const propName = line.substring(0, colonIdx).split(';')[0].toUpperCase();
                    const value    = line.substring(colonIdx + 1);

                    if (propName === 'DTSTART') {
                        current.dtstart = parseIcalDate(value.trim());
                    } else if (propName === 'DTEND') {
                        current.dtend = parseIcalDate(value.trim());
                    } else if (propName === 'SUMMARY') {
                        current.summary = value.trim();
                    } else if (propName === 'LOCATION') {
                        current.location = value.trim();
                    } else if (propName === 'DESCRIPTION') {
                        // ADE encode les sauts de ligne en \n littÃ©ral
                        current.description = value
                            .replace(/\\n/g, '\n')
                            .replace(/\\,/g, ',')
                            .replace(/\\/g, '')
                            .trim();
                    }
                }
            }
            return events;
        }

        function parseIcalDate(str) {
            // Format: 20260217T080000Z ou 20260217T080000
            const s = str.replace('Z', '');
            const year = parseInt(s.substring(0, 4));
            const month = parseInt(s.substring(4, 6)) - 1;
            const day = parseInt(s.substring(6, 8));
            const hour = parseInt(s.substring(9, 11));
            const min = parseInt(s.substring(11, 13));
            // ADE renvoie en UTC, on convertit en heure locale (Europe/Paris = UTC+1 ou +2)
            const utcDate = new Date(Date.UTC(year, month, day, hour, min));
            return utcDate;
        }

        function padTwo(n) { return n.toString().padStart(2, '0'); }

        async function importEdtAmu() {
            let rawUrl = document.getElementById('edtUrlInput').value.trim();
            const replaceExisting = document.getElementById('edtReplaceExisting').checked;
            const statusDiv = document.getElementById('edtModalStatus');

            if (!rawUrl) {
                showEdtStatus('error', 'âš ï¸ Veuillez coller un lien iCal.');
                return;
            }

            // Mettre Ã  jour les dates dans l'URL depuis les champs
            const first = document.getElementById('edtFirstDate').value;
            const last = document.getElementById('edtLastDate').value;
            if (first) rawUrl = rawUrl.replace(/firstDate=[^&]+/, `firstDate=${first}`);
            if (last)  rawUrl = rawUrl.replace(/lastDate=[^&]+/, `lastDate=${last}`);

            showEdtStatus('loading', 'â³ RÃ©cupÃ©ration de l\'EDT en cours...');

            // Proxy CORS public pour contourner la restriction cross-origin
            const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(rawUrl)}`;

            let icalText;
            try {
                const resp = await fetch(proxyUrl);
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                icalText = await resp.text();
            } catch (e) {
                showEdtStatus('error', `âŒ Impossible de rÃ©cupÃ©rer l'EDT. VÃ©rifie ton lien ou ta connexion. (${e.message})`);
                return;
            }

            if (!icalText.includes('BEGIN:VCALENDAR')) {
                showEdtStatus('error', 'âŒ Le fichier rÃ©cupÃ©rÃ© ne semble pas Ãªtre un calendrier valide.');
                return;
            }

            showEdtStatus('loading', 'ğŸ“‹ Analyse des cours...');

            const events = parseIcal(icalText);
            if (events.length === 0) {
                showEdtStatus('warn', 'âš ï¸ Aucun cours trouvÃ© dans la pÃ©riode sÃ©lectionnÃ©e.');
                return;
            }

            // â”€â”€ Construire le courseMap : nom normalisÃ© â†’ id â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // On recharge la DB Ã  chaque import pour Ã©viter les doublons
            // mÃªme si on rÃ©-importe plusieurs semaines Ã  la suite.
            const normalize = s => s.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/\s+/g, ' ').trim();

            const courseMap = {}; // nom normalisÃ© â†’ id

            // Collecter tous les noms uniques de l'import
            const uniqueNames = {}; // nom normalisÃ© â†’ nom original (premiÃ¨re occurrence)
            for (const ev of events) {
                const raw  = cleanCourseName(ev.summary, ev.description);
                const key  = normalize(raw);
                if (!uniqueNames[key]) uniqueNames[key] = raw;
            }

            // Pour chaque nom unique, chercher ou crÃ©er le cours en DB
            const colors = ['#3b82f6','#8b5cf6','#ec4899','#22c55e','#f59e0b','#ef4444','#06b6d4','#f97316'];
            let colorIdx = 0;

            for (const [key, originalName] of Object.entries(uniqueNames)) {
                // Recharger les cours depuis la DB Ã  chaque itÃ©ration
                // pour prendre en compte ceux crÃ©Ã©s juste avant dans cette boucle
                const allCourses = await db.courses.toArray();
                const found = allCourses.find(c => normalize(c.name) === key);

                if (found) {
                    // Cours dÃ©jÃ  existant â†’ on rÃ©utilise son id, rien Ã  crÃ©er
                    courseMap[key] = found.id;
                } else {
                    // Nouveau cours â†’ on le crÃ©e une seule fois
                    const color = colors[colorIdx % colors.length];
                    colorIdx++;
                    const id = await db.courses.add({ name: originalName, semester: 'S2', color, emoji: 'ğŸ“' });
                    courseMap[key] = id;
                }
            }

            let imported = 0;
            let skipped = 0;

            for (const ev of events) {
                const name     = cleanCourseName(ev.summary, ev.description);
                const courseId = courseMap[normalize(name)];

                // Calculer lundi de la semaine de cet event
                const evMonday = getMonday(ev.dtstart);
                const weekStartStr = evMonday.toISOString().split('T')[0];
                
                // Jour de la semaine (0=lundi...4=vendredi)
                const dayOfWeek = ((ev.dtstart.getDay() + 6) % 7); // 0=lundi
                if (dayOfWeek > 4) { skipped++; continue; } // ignorer week-end
                
                const startH = `${padTwo(ev.dtstart.getHours())}:00`;
                const endH = `${padTwo(ev.dtend.getHours())}:00`;
                const location = ev.location || '';

                // Supprimer les existants si remplacement demandÃ©
                if (replaceExisting) {
                    const toDelete = await db.scheduleEvents
                        .where('weekStart').equals(weekStartStr)
                        .and(e => e.day === dayOfWeek && e.startTime === startH)
                        .toArray();
                    for (const d of toDelete) await db.scheduleEvents.delete(d.id);
                }

                await db.scheduleEvents.add({
                    courseId, day: dayOfWeek,
                    startTime: startH, endTime: endH,
                    location, notes: ev.description || '',
                    weekStart: weekStartStr
                });
                imported++;
            }

            await renderCourses();
            await initSchedule();
            await updateDashboard();

            showEdtStatus('success', `âœ… ${imported} cours importÃ©s avec succÃ¨s ! ${skipped > 0 ? `(${skipped} ignorÃ©s)` : ''}`);
            showNotification(`ğŸ“ EDT importÃ© : ${imported} cours ajoutÃ©s !`);

            // Fermer la modale aprÃ¨s 2s
            setTimeout(closeEdtImportModal, 2000);
        }

        function extractCourseNameFromSummary(summary) {
            // Format ADE AMU : "SLP2U07L - Biologie cellulaire - CM1"
            // ou avec prÃ©fixes : "**SLP2U23L - PPPE - TD", "*SLP2U07L - Biologie cellulaire - TD4"
            // ou codes doubles : "SLP2U21L/SOP2U02L - Thermochimie - CM1"
            // On veut toujours la partie MILIEU entre les tirets = le vrai nom de matiÃ¨re
            const cleaned = (summary || '').replace(/^\**/, '').trim();
            const parts = cleaned.split(/\s+-\s+/);
            if (parts.length >= 2) {
                return parts[1].trim();
            }
            return null;
        }

        function cleanCourseName(summary, description) {
            // PRIORITÃ‰ 1 : extraire le nom depuis le SUMMARY (format "CODE - NOM - TYPE")
            // C'est la source la plus fiable dans les fichiers ADE AMU
            const fromSummary = extractCourseNameFromSummary(summary);
            if (fromSummary && fromSummary.length > 0) {
                return fromSummary.substring(0, 80);
            }

            // PRIORITÃ‰ 2 : premiÃ¨re ligne non-junk de la DESCRIPTION
            if (description) {
                const lines = description
                    .split('\n')
                    .map(l => l.trim())
                    .filter(l => l && l.length > 3)
                    // Ignorer groupes, promos, enseignants, codes seuls
                    .filter(l => !/^G\s*[-â€“]?\s*\d+$/i.test(l))
                    .filter(l => !/^PROMO/i.test(l))
                    .filter(l => !/^(M\.|Mr|Mme|Dr|Pr|Prof)\s/i.test(l))
                    .filter(l => !/^[A-Z]{2,}\d[A-Z0-9]*(\/[A-Z]{2,}\d[A-Z0-9]*)?$/i.test(l));
                if (lines.length > 0) return lines[0].substring(0, 80);
            }

            // PRIORITÃ‰ 3 : SUMMARY brut en dernier recours
            return (summary || 'Cours').replace(/^\**/, '').replace(/\s+/g, ' ').trim().substring(0, 80);
        }

        function showEdtStatus(type, msg) {
            const div = document.getElementById('edtModalStatus');
            div.classList.remove('hidden');
            const styles = {
                loading: 'background: #eff6ff; border: 1px solid #bfdbfe; color: #1d4ed8;',
                success: 'background: #f0fdf4; border: 1px solid #bbf7d0; color: #15803d;',
                error:   'background: #fef2f2; border: 1px solid #fecaca; color: #dc2626;',
                warn:    'background: #fffbeb; border: 1px solid #fde68a; color: #d97706;'
            };
            div.style.cssText = styles[type] || styles.loading;
            div.innerHTML = msg;
        }

        function openScheduleSettings() {
            document.getElementById('scheduleSettingsModal').classList.add('active');
            renderCourseColorsList();
        }

        function closeScheduleSettings() {
            document.getElementById('scheduleSettingsModal').classList.remove('active');
        }

        async function renderCourseColorsList() {
            const courses = await db.courses.toArray();
            const container = document.getElementById('courseColorsList');
            
            container.innerHTML = courses.map(course => `
                <div class="flex items-center justify-between p-3 rounded-lg card">
                    <span class="font-medium">${course.name}</span>
                    <input type="color" value="${course.color || '#3b82f6'}" 
                           onchange="updateCourseColor(${course.id}, this.value)"
                           class="w-12 h-8 rounded cursor-pointer">
                </div>
            `).join('');
        }

        async function updateCourseColor(courseId, color) {
            await db.courses.update(courseId, { color });
            showNotification('ğŸ¨ Couleur mise Ã  jour !');
            await initSchedule();
        }

        async function applyScheduleSettings() {
            const startTime = document.getElementById('scheduleStartTime').value;
            const endTime = document.getElementById('scheduleEndTime').value;
            const showWeekend = document.getElementById('showWeekendToggle').checked;
            const compactView = document.getElementById('compactViewToggle').checked;

            await setSetting('scheduleStart', startTime);
            await setSetting('scheduleEnd', endTime);
            await setSetting('showWeekend', showWeekend);
            await setSetting('compactView', compactView);

            closeScheduleSettings();
            await initSchedule();
            showNotification('âœ… ParamÃ¨tres appliquÃ©s !');
        }

        // â”€â”€ Ã‰tat de la modale agenda â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let currentEditingEvent = null;   // null = ajout, objet = modification
        let eventFreeColor = '#3b82f6';
        let currentEventTab = 'pick';     // 'pick' | 'free'

        function switchEventTab(tab) {
            currentEventTab = tab;
            const isPick = tab === 'pick';
            document.getElementById('panelPickCourse').classList.toggle('hidden', !isPick);
            document.getElementById('panelFreeName').classList.toggle('hidden', isPick);
            document.getElementById('tabPickCourse').style.background = isPick ? 'var(--primary)' : 'var(--border)';
            document.getElementById('tabPickCourse').style.color    = isPick ? 'white' : 'var(--text-main)';
            document.getElementById('tabFreeName').style.background = !isPick ? 'var(--primary)' : 'var(--border)';
            document.getElementById('tabFreeName').style.color      = !isPick ? 'white' : 'var(--text-main)';
        }

        function setEventFreeColor(color) {
            eventFreeColor = color;
            document.querySelectorAll('[data-freecolor]').forEach(btn => {
                btn.style.outline = btn.dataset.freecolor === color ? `3px solid ${color}` : 'none';
            });
        }

        async function openAddScheduleEvent(day, hour) {
            currentEditingEvent = null;
            selectedScheduleCell = { day, hour };

            // Titre & boutons
            document.getElementById('scheduleModalTitle').textContent = 'â• Ajouter un cours';
            document.getElementById('saveEventBtnLabel').textContent  = 'Ajouter au planning';
            document.getElementById('deleteEventBtn').classList.add('hidden');

            // Heures
            document.getElementById('eventStartTime').value = hour;
            const endH = parseInt(hour.split(':')[0]) + 1;
            document.getElementById('eventEndTime').value = `${endH.toString().padStart(2,'0')}:00`;

            // Reset champs
            document.getElementById('eventLocation').value = '';
            document.getElementById('eventNotes').value    = '';
            document.getElementById('eventFreeName').value = '';
            setEventFreeColor('#3b82f6');
            switchEventTab('pick');

            await populateEventCourseSelect(null);
            document.getElementById('addScheduleEventModal').classList.add('active');
        }

        async function openEditScheduleEvent(event) {
            currentEditingEvent = event;
            selectedScheduleCell = { day: event.day, hour: event.startTime };

            // Titre & boutons
            document.getElementById('scheduleModalTitle').textContent = 'âœï¸ Modifier le cours';
            document.getElementById('saveEventBtnLabel').textContent  = 'Enregistrer';
            document.getElementById('deleteEventBtn').classList.remove('hidden');

            // Heures & infos
            document.getElementById('eventStartTime').value = event.startTime;
            document.getElementById('eventEndTime').value   = event.endTime;
            document.getElementById('eventLocation').value  = event.location || '';
            document.getElementById('eventNotes').value     = event.notes    || '';

            // RÃ©cupÃ©rer le cours liÃ©
            const course = await db.courses.get(event.courseId);

            if (course) {
                // Si le cours existe dans la DB â†’ onglet "Mes cours"
                switchEventTab('pick');
                await populateEventCourseSelect(event.courseId);
            } else {
                // Cours importÃ© sans correspondance â†’ onglet "Nom libre"
                switchEventTab('free');
                document.getElementById('eventFreeName').value = event.freeName || '';
                setEventFreeColor(event.freeColor || '#3b82f6');
                await populateEventCourseSelect(null);
            }

            document.getElementById('addScheduleEventModal').classList.add('active');
        }

        function closeAddScheduleEvent() {
            document.getElementById('addScheduleEventModal').classList.remove('active');
            selectedScheduleCell   = null;
            currentEditingEvent    = null;
        }

        async function populateEventCourseSelect(selectedId) {
            const courses = await db.courses.toArray();
            const select  = document.getElementById('eventCourseSelect');
            select.innerHTML = '<option value="">SÃ©lectionner une matiÃ¨re...</option>' +
                courses.map(c => `<option value="${c.id}" ${c.id === selectedId ? 'selected' : ''}>${c.name}</option>`).join('');
        }

        async function saveScheduleEvent() {
            const startTime = document.getElementById('eventStartTime').value;
            const endTime   = document.getElementById('eventEndTime').value;
            const location  = document.getElementById('eventLocation').value;
            const notes     = document.getElementById('eventNotes').value;

            let courseId  = null;
            let freeName  = null;
            let freeColor = null;

            if (currentEventTab === 'pick') {
                courseId = parseInt(document.getElementById('eventCourseSelect').value);
                if (!courseId) return showNotification('âš ï¸ SÃ©lectionne une matiÃ¨re', 'warning');
            } else {
                freeName  = document.getElementById('eventFreeName').value.trim();
                freeColor = eventFreeColor;
                if (!freeName) return showNotification('âš ï¸ Saisis un nom de cours', 'warning');
            }

            const weekStartStr = currentWeekStart.toISOString().split('T')[0];
            const day = selectedScheduleCell ? selectedScheduleCell.day :
                        currentEditingEvent  ? currentEditingEvent.day  : 0;

            const record = { courseId, freeName, freeColor, day, startTime, endTime, location, notes, weekStart: weekStartStr };

            if (currentEditingEvent) {
                await db.scheduleEvents.update(currentEditingEvent.id, record);
                showNotification('âœ… Cours mis Ã  jour !');
            } else {
                await db.scheduleEvents.add(record);
                showNotification('âœ… Cours ajoutÃ© Ã  l\'agenda !');
            }

            closeAddScheduleEvent();
            await initSchedule();
        }

        async function deleteCurrentEvent() {
            if (!currentEditingEvent) return;
            if (confirm('Supprimer ce cours du planning ?')) {
                await db.scheduleEvents.delete(currentEditingEvent.id);
                closeAddScheduleEvent();
                await initSchedule();
                showNotification('ğŸ—‘ï¸ Cours supprimÃ©');
            }
        }

        async function clearSchedule() {
            if(confirm('Effacer tout l\'emploi du temps de cette semaine ?')) {
                const weekStartStr = currentWeekStart.toISOString().split('T')[0];
                await db.scheduleEvents.where('weekStart').equals(weekStartStr).delete();
                await initSchedule();
                showNotification('ğŸ—‘ï¸ Planning effacÃ©');
            }
        }

        async function exportSchedule() {
            const weekStartStr = currentWeekStart.toISOString().split('T')[0];
            const events = await db.scheduleEvents.where('weekStart').equals(weekStartStr).toArray();
            const courses = await db.courses.toArray();

            let text = `MON AGENDA - Semaine du ${formatDate(currentWeekStart)}\n\n`;

            const days = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche'];
            
            days.forEach((dayName, dayIndex) => {
                const dayEvents = events.filter(e => e.day === dayIndex).sort((a, b) => a.startTime.localeCompare(b.startTime));
                
                if(dayEvents.length > 0) {
                    text += `\n=== ${dayName.toUpperCase()} ===\n`;
                    dayEvents.forEach(event => {
                        const course = courses.find(c => c.id === event.courseId);
                        if(course) {
                            text += `${event.startTime} - ${event.endTime} : ${course.name}`;
                            if(event.location) text += ` (${event.location})`;
                            if(event.notes) text += ` - ${event.notes}`;
                            text += '\n';
                        }
                    });
                }
            });

            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `agenda-${weekStartStr}.txt`;
            a.click();
            showNotification('ğŸ“¥ Agenda exportÃ© !');
        }

        async function updateTodaySchedule() {
            const dayIndex = new Date().getDay(); // 0=Dimanche, 1=Lundi, etc.
            const container = document.getElementById('today-schedule');
            
            if(dayIndex === 0 || dayIndex === 6) {
                container.innerHTML = '<p class="text-sm opacity-70">ğŸŒ´ C\'est le week-end ! Profite-en pour te reposer.</p>';
                return;
            }

            const weekStartStr = getMonday(new Date()).toISOString().split('T')[0];
            const events = await db.scheduleEvents
                .where('weekStart').equals(weekStartStr)
                .and(e => e.day === (dayIndex - 1))
                .toArray();

            events.sort((a, b) => a.startTime.localeCompare(b.startTime));

            const courses = await db.courses.toArray();

            let html = '';
            for(const event of events) {
                const course = courses.find(c => c.id === event.courseId);
                if(course) {
                    html += `
                        <div class="flex items-center gap-3 p-3 rounded-lg" style="background: ${course.color}20; border-left: 3px solid ${course.color};">
                            <span class="font-mono font-bold text-sm">${event.startTime}</span>
                            <div class="flex-1">
                                <div class="font-bold" style="color: ${course.color};">${course.name}</div>
                                ${event.location ? `<div class="text-xs opacity-70"><i class="fas fa-map-marker-alt mr-1"></i>${event.location}</div>` : ''}
                            </div>
                        </div>
                    `;
                }
            }
            
            container.innerHTML = html || '<p class="text-sm opacity-70">Aucun cours aujourd\'hui</p>';
        }

        // ===== TÃ‚CHES =====
        async function addTask() {
            const title = document.getElementById('taskInput').value;
            const priority = document.getElementById('taskPriority').value;
            const date = document.getElementById('taskDate').value;
            
            if(!title) return showNotification('âš ï¸ Titre manquant', 'warning');

            await db.tasks.add({
                title,
                priority,
                date,
                status: 'todo',
                completed: false
            });

            document.getElementById('taskInput').value = '';
            document.getElementById('taskDate').value = '';
            showNotification('âœ… TÃ¢che ajoutÃ©e !');
            await renderTasks();
            updateStreak();
        }

        async function renderTasks() {
            const tasks = await db.tasks.toArray();
            
            const todoContainer = document.getElementById('tasks-todo');
            const inprogressContainer = document.getElementById('tasks-inprogress');
            const doneContainer = document.getElementById('tasks-done');
            
            todoContainer.innerHTML = '';
            inprogressContainer.innerHTML = '';
            doneContainer.innerHTML = '';

            const containers = {
                'todo': todoContainer,
                'inprogress': inprogressContainer,
                'done': doneContainer
            };

            tasks.forEach(task => {
                const priorityColor = task.priority === 'high' ? 'red' : task.priority === 'medium' ? 'yellow' : 'green';
                const div = document.createElement('div');
                div.className = `card p-3 rounded-lg cursor-move ${task.completed ? 'opacity-50' : ''}`;
                div.draggable = true;
                div.ondragstart = (e) => e.dataTransfer.setData('taskId', task.id);
                
                div.innerHTML = `
                    <div class="flex items-start gap-2">
                        <input type="checkbox" ${task.completed ? 'checked' : ''} onchange="toggleTask(${task.id})" class="mt-1">
                        <div class="flex-1">
                            <p class="font-medium text-sm ${task.completed ? 'line-through' : ''}">${task.title}</p>
                            ${task.date ? `<p class="text-xs opacity-60 mt-1">ğŸ“… ${new Date(task.date).toLocaleDateString('fr-FR')}</p>` : ''}
                        </div>
                        <button onclick="deleteTask(${task.id})" class="text-red-300 hover:text-red-500">
                            <i class="fas fa-times text-xs"></i>
                        </button>
                    </div>
                `;
                
                containers[task.status].appendChild(div);
            });

            // Drag & Drop
            ['tasks-todo', 'tasks-inprogress', 'tasks-done'].forEach(id => {
                const container = document.getElementById(id);
                container.ondragover = (e) => e.preventDefault();
                container.ondrop = async (e) => {
                    e.preventDefault();
                    const taskId = parseInt(e.dataTransfer.getData('taskId'));
                    const newStatus = id.replace('tasks-', '');
                    await db.tasks.update(taskId, { status: newStatus });
                    await renderTasks();
                };
            });

            updateTaskStats();
        }

        async function toggleTask(id) {
            const task = await db.tasks.get(id);
            await db.tasks.update(id, { completed: !task.completed });
            await renderTasks();
            if(!task.completed) {
                showNotification('ğŸ‰ TÃ¢che complÃ©tÃ©e !');
                launchConfetti();
            }
        }

        async function deleteTask(id) {
            if(confirm('Supprimer cette tÃ¢che ?')) {
                await db.tasks.delete(id);
                showNotification('ğŸ—‘ï¸ TÃ¢che supprimÃ©e');
                await renderTasks();
            }
        }

        async function updateTaskStats() {
            const tasks = await db.tasks.toArray();
            const completed = tasks.filter(t => t.completed).length;
            const total = tasks.length;
            
            document.getElementById('tasks-completed').innerText = completed;
            document.getElementById('tasks-total').innerText = total;
        }

        // ===== STATISTIQUES =====
        let gradesChart, subjectsChart, progressChart;

        async function renderCharts() {
            const courses = await db.courses.toArray();
            const grades = await db.grades.toArray();

            // Chart 1: Ã‰volution des notes
            const ctx1 = document.getElementById('gradesChart');
            if(gradesChart) gradesChart.destroy();
            
            const sortedGrades = grades.sort((a, b) => new Date(a.date) - new Date(b.date));
            const labels = sortedGrades.map((g, i) => `Note ${i+1}`);
            const values = sortedGrades.map(g => g.value);

            gradesChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Notes',
                        data: values,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, max: 20 }
                    }
                }
            });

            // Chart 2: RÃ©partition par matiÃ¨re
            const ctx2 = document.getElementById('subjectsChart');
            if(subjectsChart) subjectsChart.destroy();
            
            const courseNames = [];
            const courseAvgs = [];
            const courseColors = [];

            for(const course of courses) {
                const cGrades = await db.grades.where('courseId').equals(course.id).toArray();
                if(cGrades.length > 0) {
                    const avg = cGrades.reduce((a, b) => a + (b.value * (b.coef || 1)), 0) / cGrades.reduce((a, b) => a + (b.coef || 1), 0);
                    courseNames.push(course.name);
                    courseAvgs.push(avg.toFixed(2));
                    courseColors.push(course.color || '#3b82f6');
                }
            }

            subjectsChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: courseNames,
                    datasets: [{
                        label: 'Moyenne',
                        data: courseAvgs,
                        backgroundColor: courseColors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, max: 20 }
                    }
                }
            });

            // Chart 3: Progression mensuelle (simulation)
            const ctx3 = document.getElementById('progressChart');
            if(progressChart) progressChart.destroy();

            progressChart = new Chart(ctx3, {
                type: 'line',
                data: {
                    labels: ['Jan', 'FÃ©v', 'Mar', 'Avr', 'Mai', 'Juin'],
                    datasets: [{
                        label: 'Moyenne mensuelle',
                        data: [12, 13.5, 14, 15, 14.5, 16],
                        borderColor: 'rgb(139, 92, 246)',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, max: 20 }
                    }
                }
            });

            // Insights
            renderInsights();
        }

        async function renderInsights() {
            const container = document.getElementById('insights');
            const courses = await db.courses.toArray();
            const grades = await db.grades.toArray();
            
            let insights = [];

            // Meilleure matiÃ¨re
            let bestCourse = null;
            let bestAvg = 0;
            for(const course of courses) {
                const cGrades = await db.grades.where('courseId').equals(course.id).toArray();
                if(cGrades.length > 0) {
                    const avg = cGrades.reduce((a, b) => a + (b.value * (b.coef || 1)), 0) / cGrades.reduce((a, b) => a + (b.coef || 1), 0);
                    if(avg > bestAvg) {
                        bestAvg = avg;
                        bestCourse = course.name;
                    }
                }
            }
            if(bestCourse) insights.push(`ğŸ† Ta meilleure matiÃ¨re : <strong>${bestCourse}</strong> (${bestAvg.toFixed(2)}/20)`);

            // Nombre total de notes
            insights.push(`ğŸ“Š Tu as <strong>${grades.length}</strong> notes enregistrÃ©es`);

            // Encouragement
            if(bestAvg >= 15) insights.push(`ğŸŒŸ Excellent travail ! Continue comme Ã§a !`);
            else if(bestAvg >= 12) insights.push(`ğŸ’ª Bon effort ! Tu peux encore mieux faire !`);
            else insights.push(`ğŸ“š Accroche-toi, la persÃ©vÃ©rance paie toujours !`);

            container.innerHTML = insights.map(i => `<p class="text-sm p-3 rounded-lg card">${i}</p>`).join('');
        }

        // ===== DASHBOARD =====
        async function updateDashboard() {
            await updateTodaySchedule();
            await updateStreak();
            await updateWeekSummary();
            updateSemesterProgress();
        }

        async function updateStreak() {
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Minuit du jour actuel
            const todayStr = today.toISOString().split('T')[0];
            
            // RÃ©cupÃ©rer ou crÃ©er le record de streak
            let streakData = await db.settings.get('streakData');
            
            if (!streakData) {
                // PremiÃ¨re visite - initialiser
                streakData = {
                    key: 'streakData',
                    value: {
                        currentStreak: 1,
                        lastVisit: todayStr,
                        longestStreak: 1
                    }
                };
                await db.settings.put(streakData);
                console.log('âœ… Streak initialisÃ©:', streakData.value);
            } else {
                const lastVisitStr = streakData.value.lastVisit;
                
                console.log('ğŸ“… Comparaison dates:', {
                    today: todayStr,
                    lastVisit: lastVisitStr,
                    areEqual: todayStr === lastVisitStr
                });
                
                // Comparer directement les chaÃ®nes de dates (YYYY-MM-DD)
                if (todayStr === lastVisitStr) {
                    // MÃªme jour - ne rien faire du tout
                    console.log('âœ… MÃªme jour - streak inchangÃ©:', streakData.value.currentStreak);
                } else {
                    // Calculer la diffÃ©rence en jours
                    const lastVisit = new Date(lastVisitStr);
                    lastVisit.setHours(0, 0, 0, 0);
                    const daysDiff = Math.floor((today - lastVisit) / (1000 * 60 * 60 * 24));
                    
                    console.log('ğŸ“Š DiffÃ©rence de jours:', daysDiff);
                    
                    if (daysDiff === 1) {
                        // Jour suivant - incrÃ©menter le streak
                        streakData.value.currentStreak++;
                        streakData.value.lastVisit = todayStr;
                        
                        console.log('ğŸ”¥ Streak incrÃ©mentÃ©:', streakData.value.currentStreak);
                        
                        // Mettre Ã  jour le record si nÃ©cessaire
                        if (streakData.value.currentStreak > streakData.value.longestStreak) {
                            streakData.value.longestStreak = streakData.value.currentStreak;
                        }
                        
                        await db.settings.put(streakData);
                        
                        // CÃ©lÃ©bration pour les milestones
                        if (streakData.value.currentStreak % 7 === 0) {
                            showNotification(`ğŸ”¥ ${streakData.value.currentStreak} jours de suite ! Continue comme Ã§a !`);
                            launchConfetti();
                        }
                    } else if (daysDiff > 1) {
                        // Plus d'un jour - streak cassÃ©, recommencer Ã  1
                        console.log('ğŸ’” Streak cassÃ© - retour Ã  1');
                        streakData.value.currentStreak = 1;
                        streakData.value.lastVisit = todayStr;
                        await db.settings.put(streakData);
                    } else {
                        // daysDiff < 1 (ne devrait pas arriver normalement)
                        console.warn('âš ï¸ Situation anormale - daysDiff:', daysDiff);
                        // On ne fait rien pour Ã©viter les bugs
                    }
                }
            }
            
            // Afficher le streak actuel et le record
            const currentStreakData = await db.settings.get('streakData');
            if (currentStreakData) {
                const streakCount = currentStreakData.value.currentStreak;
                const longestStreak = currentStreakData.value.longestStreak;
                
                console.log('ğŸ“Š Affichage streak:', {
                    current: streakCount,
                    record: longestStreak
                });
                
                document.getElementById('streak-count').innerText = streakCount;
                const recordEl = document.getElementById('streak-record');
                if (recordEl) {
                    recordEl.innerText = longestStreak;
                }
            } else {
                console.warn('âš ï¸ Aucune donnÃ©e de streak trouvÃ©e');
            }
        }
        
        // VÃ©rifier le streak Ã  minuit automatiquement
        function scheduleStreakCheck() {
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(0, 0, 1, 0); // 00:00:01 du lendemain
            
            const timeUntilMidnight = tomorrow - now;
            
            setTimeout(async () => {
                await updateStreak();
                scheduleStreakCheck(); // Reprogrammer pour le jour suivant
            }, timeUntilMidnight);
        }

        // ===== QUICK ACTIONS =====
        function quickAddCourse() {
            openCourseModal();
        }

        function quickAddGrade() {
            showTab('grades');
            document.querySelector('.nav-item:nth-child(4)').classList.add('active');
        }

        function quickAddTask() {
            showTab('tasks');
            document.querySelector('.nav-item:nth-child(6)').classList.add('active');
        }

        function openQuickMenu() {
            openSettings();
        }

        // ===== EXPORT/IMPORT =====
        async function exportAllData() {
            const data = {
                courses: await db.courses.toArray(),
                grades: await db.grades.toArray(),
                tasks: await db.tasks.toArray(),
                settings: await db.settings.toArray()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'mystudyspace-backup.json';
            a.click();
            showNotification('ğŸ’¾ DonnÃ©es exportÃ©es !');
        }

        function exportData() {
            exportAllData();
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                const text = await file.text();
                const data = JSON.parse(text);
                
                if(confirm('Importer ces donnÃ©es ? (Cela Ã©crasera vos donnÃ©es actuelles)')) {
                    await db.courses.clear();
                    await db.grades.clear();
                    await db.tasks.clear();
                    await db.settings.clear();
                    
                    await db.courses.bulkAdd(data.courses || []);
                    await db.grades.bulkAdd(data.grades || []);
                    await db.tasks.bulkAdd(data.tasks || []);
                    await db.settings.bulkAdd(data.settings || []);
                    
                    showNotification('âœ… DonnÃ©es importÃ©es !');
                    await refreshUI();
                    location.reload();
                }
            };
            input.click();
        }

        async function resetApp() {
            if(confirm('âš ï¸ ATTENTION : Cela supprimera TOUTES vos donnÃ©es. Continuer ?')) {
                if(confirm('Es-tu vraiment sÃ»r ? Cette action est irrÃ©versible.')) {
                    await db.delete();
                    location.reload();
                }
            }
        }

        // ===== NOTIFICATIONS & CONFETTI =====
        function showNotification(message, type = 'success') {
            const notif = document.createElement('div');
            notif.className = 'notification';
            notif.innerHTML = `<p class="text-sm font-medium">${message}</p>`;
            document.body.appendChild(notif);

            setTimeout(() => {
                notif.style.opacity = '0';
                setTimeout(() => notif.remove(), 300);
            }, 3000);
        }

        function launchConfetti() {
            const confettiToggle = document.getElementById('confettiToggle');
            if(!confettiToggle || !confettiToggle.checked) return;

            const colors = ['#3b82f6', '#8b5cf6', '#ec4899', '#22c55e', '#f59e0b'];
            for(let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + 'vw';
                    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                    document.body.appendChild(confetti);
                    setTimeout(() => confetti.remove(), 3000);
                }, i * 30);
            }
        }
        
        // ===== RESET STREAK =====
        async function resetStreak() {
            if(!confirm('âš ï¸ ÃŠtes-vous sÃ»r de vouloir rÃ©initialiser votre sÃ©rie de travail ? Cette action est irrÃ©versible.')) {
                return;
            }
            
            // Supprimer les donnÃ©es de streak
            await db.settings.delete('streakData');
            
            // RÃ©initialiser l'affichage
            document.getElementById('streak-count').innerText = '1';
            const recordEl = document.getElementById('streak-record');
            if (recordEl) {
                recordEl.innerText = '1';
            }
            
            // RecrÃ©er les donnÃ©es Ã  1
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayStr = today.toISOString().split('T')[0];
            
            const newStreakData = {
                key: 'streakData',
                value: {
                    currentStreak: 1,
                    lastVisit: todayStr,
                    longestStreak: 1
                }
            };
            await db.settings.put(newStreakData);
            
            showNotification('ğŸ”„ SÃ©rie de travail rÃ©initialisÃ©e !');
            console.log('âœ… Streak rÃ©initialisÃ©:', newStreakData.value);
        }

        // ===== SETTINGS TABS =====
        function switchSettingsTab(btn, panelId) {
            document.querySelectorAll('.settings-tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.settings-panel').forEach(p => p.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById(panelId).classList.add('active');
        }

        // ===== THÃˆME â€” mettre Ã  jour les swatches visuellement =====
        const THEME_NAMES = ['light','dark','midnight','nord','ocean','sunset','forest','rose'];
        function updateThemeSwatches(active) {
            THEME_NAMES.forEach(t => {
                const el = document.getElementById('swatch-' + t);
                if (el) el.classList.toggle('active', t === active);
            });
        }

        // ===== RAYON DES CARTES =====
        function setRadius(mode) {
            setSetting('borderRadius', mode);
            const map = { sharp: { sm:'4px', md:'6px', lg:'8px', xl:'10px' },
                          normal: { sm:'8px', md:'12px', lg:'16px', xl:'24px' },
                          round:  { sm:'12px', md:'20px', lg:'28px', xl:'36px' } };
            const r = map[mode] || map.normal;
            document.documentElement.style.setProperty('--radius-sm', r.sm);
            document.documentElement.style.setProperty('--radius-md', r.md);
            document.documentElement.style.setProperty('--radius-lg', r.lg);
            document.documentElement.style.setProperty('--radius-xl', r.xl);
            ['sharp','normal','round'].forEach(m => {
                const btn = document.getElementById('radius-' + m);
                if (btn) {
                    btn.style.background = m === mode ? 'var(--primary)' : '';
                    btn.style.color      = m === mode ? 'white' : '';
                    btn.style.borderColor = m === mode ? 'var(--primary)' : 'var(--border)';
                }
            });
        }

        // ===== HORLOGE TEMPS RÃ‰EL =====
        let clockInterval = null;
        function toggleClock(on) {
            setSetting('showClock', on);
            const el = document.getElementById('live-clock');
            if (!el) return;
            if (on) {
                el.style.display = '';
                clockInterval = setInterval(updateClock, 1000);
                updateClock();
            } else {
                el.style.display = 'none';
                clearInterval(clockInterval);
            }
        }
        function updateClock() {
            const el = document.getElementById('live-clock');
            if (!el) return;
            const now = new Date();
            el.textContent = now.toLocaleTimeString('fr-FR', { hour:'2-digit', minute:'2-digit', second:'2-digit' });
        }

        // ===== PATCH setTheme pour mettre Ã  jour les swatches =====
        const _origSetTheme = typeof setTheme === 'function' ? setTheme : null;

        // ===== SUPPRESSION EN MASSE DES COURS =====
        async function deleteAllCourses() {
            const courses = await db.courses.toArray();
            if (courses.length === 0) return showNotification('â„¹ï¸ Aucun cours Ã  supprimer');

            const confirmed = confirm(`âš ï¸ Supprimer les ${courses.length} cours et toutes leurs notes/fichiers ?

Cette action est irrÃ©versible.`);
            if (!confirmed) return;
            const doubleConfirm = confirm('â— DerniÃ¨re confirmation : vraiment tout supprimer ?');
            if (!doubleConfirm) return;

            for (const course of courses) {
                await db.grades.where('courseId').equals(course.id).delete();
                await db.files.where('courseId').equals(course.id).delete();
            }
            await db.courses.clear();
            await db.scheduleEvents.clear();
            showNotification('ğŸ—‘ï¸ Tous les cours supprimÃ©s');
            await refreshUI();
        }

        // ===== RECHERCHE COURS =====
        function searchCourses(query) {
            const q = query.toLowerCase().trim();
            document.querySelectorAll('.course-card').forEach(card => {
                const name = card.querySelector('h4')?.textContent?.toLowerCase() || '';
                card.style.display = (!q || name.includes(q)) ? '' : 'none';
            });
        }

        // ===== VUE GRILLE / LISTE =====
        let coursesViewMode = 'grid';
        function toggleCoursesView() {
            coursesViewMode = coursesViewMode === 'grid' ? 'list' : 'grid';
            const list = document.getElementById('coursesList');
            const btn  = document.getElementById('coursesViewBtn');
            if (coursesViewMode === 'list') {
                list.classList.remove('md:grid-cols-2');
                list.classList.add('grid-cols-1');
                btn.innerHTML = '<i class="fas fa-th-large"></i>';
            } else {
                list.classList.add('md:grid-cols-2');
                list.classList.remove('grid-cols-1');
                btn.innerHTML = '<i class="fas fa-list"></i>';
            }
        }

        // ===== COULEURS PERSONNALISÃ‰ES =====
        function applyCustomColor(type, value) {
            if (type === 'primary') {
                document.documentElement.style.setProperty('--primary', value);
                setSetting('customPrimary', value);
            } else {
                document.documentElement.style.setProperty('--accent', value);
                setSetting('customAccent', value);
            }
        }

        // ===== POLICE =====
        function applyFont(font) {
            document.body.style.fontFamily = font;
            setSetting('fontFamily', font);
        }

        // ===== DENSITÃ‰ =====
        function setDensity(mode) {
            setSetting('density', mode);
            const root = document.documentElement;
            ['compact', 'normal', 'comfortable'].forEach(m => {
                const btn = document.getElementById(`density-${m}`);
                if (btn) {
                    btn.style.background = m === mode ? 'var(--primary)' : '';
                    btn.style.color      = m === mode ? 'white' : '';
                    btn.style.borderColor = m === mode ? 'var(--primary)' : 'var(--border)';
                }
            });
            if (mode === 'compact') {
                root.style.setProperty('--spacing', '0.75rem');
                document.querySelectorAll('.p-6').forEach(el => el.classList.replace('p-6', 'p-4'));
                document.querySelectorAll('.p-5').forEach(el => el.classList.replace('p-5', 'p-3'));
            } else if (mode === 'comfortable') {
                root.style.setProperty('--spacing', '1.5rem');
            }
        }

        // ===== MODE FOCUS =====
        function toggleFocusMode(on) {
            setSetting('focusMode', on);
            document.querySelectorAll('.stat-card, .floating-action').forEach(el => {
                el.style.opacity = on ? '0' : '';
                el.style.pointerEvents = on ? 'none' : '';
            });
            showNotification(on ? 'ğŸ¯ Mode focus activÃ©' : 'ğŸ”“ Mode focus dÃ©sactivÃ©');
        }

        // ===== RACCOURCIS CLAVIER =====
        document.addEventListener('keydown', (e) => {
            if (!e.altKey) return;
            const tabs = ['dashboard','courses','schedule','grades','stats','tasks'];
            const idx = parseInt(e.key) - 1;
            if (idx >= 0 && idx < tabs.length) {
                e.preventDefault();
                showTab(tabs[idx]);
            }
        });

        // ===== RÃ‰SUMÃ‰ SEMAINE =====
        async function updateWeekSummary() {
            const container = document.getElementById('week-summary');
            if (!container) return;
            const weekStartStr = currentWeekStart.toISOString().split('T')[0];
            const events = await db.scheduleEvents.where('weekStart').equals(weekStartStr).toArray();
            const courses = await db.courses.toArray();

            if (events.length === 0) {
                container.innerHTML = '<p class="text-sm opacity-50 italic">Aucun cours cette semaine</p>';
                return;
            }

            const byDay = ['Lun','Mar','Mer','Jeu','Ven'];
            const grouped = {};
            for (const ev of events) {
                const label = byDay[ev.day] || '?';
                if (!grouped[label]) grouped[label] = [];
                const course = courses.find(c => c.id === ev.courseId);
                const name = course ? course.name : (ev.freeName || 'Cours');
                grouped[label].push({ name, startTime: ev.startTime, color: course?.color || ev.freeColor || '#3b82f6' });
            }

            container.innerHTML = Object.entries(grouped).map(([day, evts]) => `
                <div class="flex items-center gap-3 text-sm">
                    <span class="font-bold w-8 text-xs opacity-60">${day}</span>
                    <div class="flex flex-wrap gap-1">
                        ${evts.map(ev => `<span class="px-2 py-0.5 rounded text-xs text-white font-medium" style="background:${ev.color};">${ev.name.substring(0,15)}${ev.name.length>15?'â€¦':''}</span>`).join('')}
                    </div>
                </div>
            `).join('');
        }

        // ===== PROGRESSION SEMESTRE =====
        function updateSemesterProgress() {
            const now = new Date();
            // Semestre 2 typique : dÃ©but janvier, fin juin
            const semStart = new Date(now.getFullYear(), 0, 13);  // 13 jan
            const semEnd   = new Date(now.getFullYear(), 5, 30);  // 30 juin
            const total  = semEnd - semStart;
            const elapsed = Math.max(0, Math.min(now - semStart, total));
            const pct = Math.round((elapsed / total) * 100);

            const bar   = document.getElementById('semester-progress-bar');
            const label = document.getElementById('semester-percent');
            const startLbl = document.getElementById('semester-start-label');
            const endLbl   = document.getElementById('semester-end-label');
            if (bar) bar.style.width = pct + '%';
            if (label) label.textContent = pct + '%';
            if (startLbl) startLbl.textContent = semStart.toLocaleDateString('fr-FR', { day:'numeric', month:'short' });
            if (endLbl)   endLbl.textContent   = semEnd.toLocaleDateString('fr-FR', { day:'numeric', month:'short' });
        }

        // ===== CHARGEMENT DES PREFS VISUELLES =====
        async function loadVisualPrefs() {
            const customPrimary = await getSetting('customPrimary');
            const customAccent  = await getSetting('customAccent');
            const fontFamily    = await getSetting('fontFamily');
            const density       = await getSetting('density') || 'normal';

            if (customPrimary) {
                document.documentElement.style.setProperty('--primary', customPrimary);
                const el = document.getElementById('customPrimaryColor');
                if (el) el.value = customPrimary;
            }
            if (customAccent) {
                document.documentElement.style.setProperty('--accent', customAccent);
                const el = document.getElementById('customAccentColor');
                if (el) el.value = customAccent;
            }
            if (fontFamily) {
                document.body.style.fontFamily = fontFamily;
                const el = document.getElementById('fontSelect');
                if (el) el.value = fontFamily;
            }
            setDensity(density);
        }

        // ===== REFRESH UI =====
        async function refreshUI() {
            await renderCourses();
            await renderGrades();
            await renderTasks();
            await updateDashboard();
        }

        // ===== INIT =====
        (async () => {
            await loadSettings();
            await loadVisualPrefs();
            await initSchedule();
            await refreshUI();
            updateGreeting();
            
            // DÃ©marrer la vÃ©rification automatique du streak Ã  minuit
            scheduleStreakCheck();
            
            // Style des boutons filtres
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => {
                        b.style.background = 'var(--border)';
                        b.style.color = 'var(--text-main)';
                    });
                    this.style.background = 'var(--primary)';
                    this.style.color = 'white';
                });
            });
            
            // Active le premier filtre
            document.querySelector('.filter-btn').style.background = 'var(--primary)';
            document.querySelector('.filter-btn').style.color = 'white';
        })();
    </script>
</body>
</html>
