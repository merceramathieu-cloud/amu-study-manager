<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AMU Study Hub</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
/* ═══════════════════════════════════════════
   TOKENS & THEMES
═══════════════════════════════════════════ */
:root {
  --font-display: 'Syne', sans-serif;
  --font-body: 'DM Sans', sans-serif;
  --radius: 14px;
  --radius-sm: 8px;
  --radius-lg: 20px;
  --transition: 0.22s cubic-bezier(.4,0,.2,1);
}

/* THEME: Midnight (default) */
[data-theme="midnight"] {
  --bg: #090c14;
  --bg2: #0f1422;
  --bg3: #161d30;
  --surface: rgba(22,29,48,0.85);
  --surface2: rgba(30,40,65,0.7);
  --border: rgba(99,120,200,0.18);
  --border2: rgba(99,120,200,0.08);
  --accent: #5b8af5;
  --accent2: #a78bfa;
  --accent3: #38bdf8;
  --gold: #f4c05a;
  --text: #e8ecf8;
  --text2: #8a96b8;
  --text3: #4a5478;
  --danger: #f87171;
  --success: #4ade80;
  --warning: #fbbf24;
  --glow: rgba(91,138,245,0.25);
}

/* THEME: Aurora */
[data-theme="aurora"] {
  --bg: #050e12;
  --bg2: #081519;
  --bg3: #0d2028;
  --surface: rgba(8,21,25,0.9);
  --surface2: rgba(13,32,40,0.7);
  --border: rgba(32,201,172,0.2);
  --border2: rgba(32,201,172,0.08);
  --accent: #20c9ac;
  --accent2: #6ee7d4;
  --accent3: #38f6e8;
  --gold: #f0e14a;
  --text: #e0f8f4;
  --text2: #7ebfb5;
  --text3: #3a6b65;
  --danger: #ff6b8a;
  --success: #4ade80;
  --warning: #fbbf24;
  --glow: rgba(32,201,172,0.25);
}

/* THEME: Sunset */
[data-theme="sunset"] {
  --bg: #12080a;
  --bg2: #1c0d10;
  --bg3: #28121a;
  --surface: rgba(28,13,16,0.9);
  --surface2: rgba(40,18,26,0.7);
  --border: rgba(250,100,80,0.22);
  --border2: rgba(250,100,80,0.08);
  --accent: #fa6450;
  --accent2: #ff9a6c;
  --accent3: #ffd06c;
  --gold: #ffd06c;
  --text: #fdf0ec;
  --text2: #c08070;
  --text3: #6a3a30;
  --danger: #ff4040;
  --success: #4ade80;
  --warning: #ffd06c;
  --glow: rgba(250,100,80,0.25);
}

/* THEME: Forest */
[data-theme="forest"] {
  --bg: #080e09;
  --bg2: #0e1810;
  --bg3: #152218;
  --surface: rgba(14,24,16,0.9);
  --surface2: rgba(21,34,24,0.7);
  --border: rgba(74,200,100,0.2);
  --border2: rgba(74,200,100,0.08);
  --accent: #4ac864;
  --accent2: #8fe89a;
  --accent3: #b8f5a0;
  --gold: #e8c84a;
  --text: #eaf8ec;
  --text2: #7ab882;
  --text3: #3a6840;
  --danger: #ff6b6b;
  --success: #4ade80;
  --warning: #fbbf24;
  --glow: rgba(74,200,100,0.25);
}

/* THEME: Rose */
[data-theme="rose"] {
  --bg: #120810;
  --bg2: #1c1018;
  --bg3: #281520;
  --surface: rgba(28,16,24,0.9);
  --surface2: rgba(40,21,32,0.7);
  --border: rgba(240,100,160,0.22);
  --border2: rgba(240,100,160,0.08);
  --accent: #f064a0;
  --accent2: #f49ec8;
  --accent3: #ffd6eb;
  --gold: #f8d06c;
  --text: #fdf0f8;
  --text2: #c07898;
  --text3: #6a3050;
  --danger: #ff4040;
  --success: #4ade80;
  --warning: #ffd06c;
  --glow: rgba(240,100,160,0.25);
}

/* THEME: Arctic */
[data-theme="arctic"] {
  --bg: #f0f4fc;
  --bg2: #e4eaf8;
  --bg3: #d8e2f4;
  --surface: rgba(255,255,255,0.85);
  --surface2: rgba(240,244,252,0.8);
  --border: rgba(100,140,220,0.2);
  --border2: rgba(100,140,220,0.1);
  --accent: #4a7ef0;
  --accent2: #7c8ff8;
  --accent3: #38bdf8;
  --gold: #f0a020;
  --text: #1a2040;
  --text2: #5868a0;
  --text3: #9aaac8;
  --danger: #e85050;
  --success: #28a060;
  --warning: #d08020;
  --glow: rgba(74,126,240,0.2);
}

/* THEME: Obsidian */
[data-theme="obsidian"] {
  --bg: #0a0a0a;
  --bg2: #111111;
  --bg3: #1a1a1a;
  --surface: rgba(17,17,17,0.95);
  --surface2: rgba(26,26,26,0.8);
  --border: rgba(200,200,200,0.12);
  --border2: rgba(200,200,200,0.06);
  --accent: #e8e8e8;
  --accent2: #a0a0a0;
  --accent3: #606060;
  --gold: #d4a840;
  --text: #f0f0f0;
  --text2: #888888;
  --text3: #444444;
  --danger: #ff5555;
  --success: #55cc88;
  --warning: #ffaa33;
  --glow: rgba(200,200,200,0.1);
}

/* THEME: Galaxy */
[data-theme="galaxy"] {
  --bg: #06040e;
  --bg2: #0c0818;
  --bg3: #130d24;
  --surface: rgba(12,8,24,0.9);
  --surface2: rgba(19,13,36,0.8);
  --border: rgba(150,80,255,0.25);
  --border2: rgba(150,80,255,0.1);
  --accent: #9650ff;
  --accent2: #c880ff;
  --accent3: #ff80e8;
  --gold: #ffd060;
  --text: #f0eaff;
  --text2: #9080c0;
  --text3: #504070;
  --danger: #ff5080;
  --success: #50e8a0;
  --warning: #ffd060;
  --glow: rgba(150,80,255,0.3);
}

/* ═══════════════════════════════════════════
   LIGHT MODE OVERRIDES
   Applied when body has data-lightmode="true"
   These override bg/surface/text vars only,
   keeping the accent color of the current theme.
═══════════════════════════════════════════ */
[data-lightmode="true"] {
  --bg:      #f4f6fb;
  --bg2:     #eaecf4;
  --bg3:     #dde1ef;
  --surface: rgba(255,255,255,0.92);
  --surface2: rgba(240,242,252,0.85);
  --border:  rgba(80,100,180,0.15);
  --border2: rgba(80,100,180,0.07);
  --text:    #1a1e36;
  --text2:   #5a6080;
  --text3:   #9aa0c0;
  --glow:    rgba(80,100,200,0.12);
}

/* Light mode specifics */
[data-lightmode="true"] body::before { opacity: 0.15; }
[data-lightmode="true"] .auth-card { box-shadow: 0 20px 60px rgba(0,0,0,0.12), 0 0 0 1px var(--border); }
[data-lightmode="true"] .subject-card { box-shadow: 0 2px 12px rgba(0,0,0,0.06); }
[data-lightmode="true"] .week-grid { box-shadow: 0 2px 20px rgba(0,0,0,0.06); }
[data-lightmode="true"] #sidebar { box-shadow: 4px 0 20px rgba(0,0,0,0.08); }

.light-toggle-btn {
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: 8px;
  width: 32px; height: 32px;
  cursor: pointer;
  font-size: 16px;
  display: flex; align-items: center; justify-content: center;
  transition: var(--transition);
  flex-shrink: 0;
}
.light-toggle-btn:hover {
  border-color: var(--accent);
  transform: rotate(20deg) scale(1.1);
}

/* ═══════════════════════════════════════════
   BASE
═══════════════════════════════════════════ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html { font-size: 15px; }

body {
  font-family: var(--font-body);
  background: var(--bg);
  color: var(--text);
  height: 100vh;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

/* Noise texture overlay */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
  pointer-events: none;
  z-index: 0;
  opacity: 0.4;
}

/* ═══════════════════════════════════════════
   AUTH SCREEN
═══════════════════════════════════════════ */
#auth-screen {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg);
  z-index: 9999;
}

.auth-bg {
  position: absolute;
  inset: 0;
  overflow: hidden;
}

.auth-orb {
  position: absolute;
  border-radius: 50%;
  filter: blur(80px);
  opacity: 0.15;
  animation: float 8s ease-in-out infinite;
}

.auth-orb-1 {
  width: 500px; height: 500px;
  background: var(--accent);
  top: -100px; left: -100px;
}

.auth-orb-2 {
  width: 400px; height: 400px;
  background: var(--accent2);
  bottom: -80px; right: -80px;
  animation-delay: -4s;
}

@keyframes float {
  0%, 100% { transform: translate(0, 0) scale(1); }
  33% { transform: translate(20px, -20px) scale(1.05); }
  66% { transform: translate(-10px, 15px) scale(0.95); }
}

.auth-card {
  position: relative;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 24px;
  padding: 48px 44px;
  width: 420px;
  max-width: 95vw;
  backdrop-filter: blur(20px);
  box-shadow: 0 30px 80px rgba(0,0,0,0.4), 0 0 0 1px var(--border);
  animation: cardIn 0.5s cubic-bezier(.16,1,.3,1);
}

@keyframes cardIn {
  from { opacity: 0; transform: translateY(30px) scale(0.96); }
  to   { opacity: 1; transform: translateY(0) scale(1); }
}

.auth-logo {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 36px;
}

.auth-logo-dot {
  width: 14px; height: 14px;
  background: var(--accent);
  border-radius: 50%;
  box-shadow: 0 0 20px var(--accent);
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%,100% { box-shadow: 0 0 15px var(--accent); }
  50% { box-shadow: 0 0 30px var(--accent), 0 0 50px var(--glow); }
}

.auth-logo h1 {
  font-family: var(--font-display);
  font-size: 26px;
  font-weight: 800;
  letter-spacing: -0.5px;
}
.auth-logo h1 span { color: var(--accent); }

.auth-tabs {
  display: flex;
  background: var(--bg3);
  border-radius: var(--radius);
  padding: 4px;
  margin-bottom: 28px;
  gap: 4px;
}

.auth-tab {
  flex: 1;
  padding: 10px;
  background: none;
  border: none;
  border-radius: 10px;
  color: var(--text2);
  font-family: var(--font-body);
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  font-size: 14px;
}

.auth-tab.active {
  background: var(--accent);
  color: var(--bg);
}

.auth-form { display: flex; flex-direction: column; gap: 14px; }

.auth-form label {
  font-size: 12px;
  font-weight: 600;
  color: var(--text2);
  text-transform: uppercase;
  letter-spacing: 0.8px;
  margin-bottom: -8px;
}

.auth-input {
  width: 100%;
  padding: 14px 16px;
  background: var(--bg3);
  border: 1.5px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text);
  font-family: var(--font-body);
  font-size: 15px;
  transition: var(--transition);
}

.auth-input:focus {
  outline: none;
  border-color: var(--accent);
  background: var(--bg2);
  box-shadow: 0 0 0 4px var(--glow);
}

.auth-input::placeholder { color: var(--text3); }

.auth-emoji-grid {
  display: grid;
  grid-template-columns: repeat(8, 1fr);
  gap: 6px;
  margin-top: 4px;
}

.auth-emoji-opt {
  aspect-ratio: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 22px;
  border-radius: 8px;
  cursor: pointer;
  border: 2px solid transparent;
  transition: var(--transition);
  background: var(--bg3);
}

.auth-emoji-opt:hover { transform: scale(1.15); background: var(--bg2); }
.auth-emoji-opt.selected {
  border-color: var(--accent);
  background: var(--surface2);
  box-shadow: 0 0 12px var(--glow);
}

.auth-btn {
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  color: var(--bg);
  border: none;
  padding: 15px;
  border-radius: var(--radius);
  font-family: var(--font-display);
  font-weight: 700;
  font-size: 16px;
  cursor: pointer;
  transition: var(--transition);
  margin-top: 8px;
  letter-spacing: 0.3px;
}

.auth-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px var(--glow);
  filter: brightness(1.1);
}

.auth-error {
  color: var(--danger);
  font-size: 13px;
  text-align: center;
  padding: 10px;
  background: rgba(248,113,113,0.1);
  border-radius: var(--radius-sm);
  display: none;
}
.auth-error.show { display: block; }

/* ═══════════════════════════════════════════
   MAIN APP LAYOUT
═══════════════════════════════════════════ */
#app {
  display: flex;
  height: 100vh;
  overflow: hidden;
  position: relative;
  z-index: 1;
  display: none;
}

#app.visible { display: flex; }

/* ═══════════════════════════════════════════
   SIDEBAR
═══════════════════════════════════════════ */
#sidebar {
  width: 290px;
  min-width: 290px;
  background: var(--surface);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  backdrop-filter: blur(16px);
  box-shadow: 4px 0 30px rgba(0,0,0,0.3);
  z-index: 10;
  overflow: hidden;
}

.sidebar-header {
  padding: 24px 22px 18px;
  border-bottom: 1px solid var(--border2);
}

.logo-row {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 16px;
}

.logo-dot {
  width: 10px; height: 10px;
  background: var(--accent);
  border-radius: 50%;
  box-shadow: 0 0 12px var(--accent);
  animation: pulse 2s infinite;
  flex-shrink: 0;
}

.logo-text {
  font-family: var(--font-display);
  font-size: 19px;
  font-weight: 800;
  letter-spacing: -0.3px;
  flex: 1;
}

.logo-text span { color: var(--accent); }

/* User profile in sidebar */
.user-card {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  background: var(--bg3);
  border-radius: var(--radius);
  border: 1px solid var(--border2);
  cursor: pointer;
  transition: var(--transition);
}

.user-card:hover {
  border-color: var(--border);
  background: var(--bg2);
}

.user-avatar {
  width: 38px; height: 38px;
  border-radius: 10px;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  flex-shrink: 0;
}

.user-info { flex: 1; min-width: 0; }
.user-name {
  font-weight: 700;
  font-size: 14px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.user-sub {
  color: var(--text2);
  font-size: 12px;
  margin-top: 1px;
}

.logout-btn {
  background: none;
  border: none;
  color: var(--text3);
  cursor: pointer;
  font-size: 16px;
  padding: 4px;
  border-radius: 6px;
  transition: var(--transition);
}

.logout-btn:hover { color: var(--danger); background: rgba(248,113,113,0.1); }

/* Nav pills */
.sidebar-nav {
  display: flex;
  flex-direction: column;
  gap: 4px;
  padding: 16px 14px;
  border-bottom: 1px solid var(--border2);
}

.nav-pill {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 11px 14px;
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: var(--transition);
  font-weight: 500;
  font-size: 14px;
  color: var(--text2);
  border: none;
  background: none;
  width: 100%;
  text-align: left;
}

.nav-pill:hover { background: var(--bg3); color: var(--text); }
.nav-pill.active {
  background: linear-gradient(90deg, var(--glow), transparent);
  color: var(--accent);
  border-left: 2.5px solid var(--accent);
}

.nav-icon { font-size: 18px; width: 24px; text-align: center; }

/* Folder area */
.sidebar-section-title {
  padding: 14px 22px 8px;
  font-size: 11px;
  font-weight: 700;
  color: var(--text3);
  text-transform: uppercase;
  letter-spacing: 1.2px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.sidebar-add-btn {
  width: 22px; height: 22px;
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: 5px;
  color: var(--text2);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  transition: var(--transition);
}

.sidebar-add-btn:hover { border-color: var(--accent); color: var(--accent); }

#folder-list {
  flex: 1;
  overflow-y: auto;
  padding: 4px 14px;
}

.folder-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  border-radius: 10px;
  cursor: pointer;
  transition: var(--transition);
  color: var(--text2);
  font-size: 14px;
  font-weight: 500;
  position: relative;
  border: 1px solid transparent;
  margin-bottom: 3px;
}

.folder-item:hover { background: var(--bg3); color: var(--text); }
.folder-item.active {
  background: rgba(var(--accent-rgb, 91,138,245), 0.1);
  color: var(--accent);
  border-color: var(--border);
}

.folder-emoji-badge {
  font-size: 17px;
  width: 26px;
  text-align: center;
  flex-shrink: 0;
}

.folder-label { flex: 1; min-width: 0; }
.folder-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

.folder-pill {
  background: var(--bg2);
  color: var(--text3);
  padding: 2px 7px;
  border-radius: 8px;
  font-size: 11px;
  font-weight: 700;
}
.folder-item.active .folder-pill { background: var(--glow); color: var(--accent); }

.folder-del {
  opacity: 0;
  background: none;
  border: none;
  color: var(--danger);
  cursor: pointer;
  font-size: 16px;
  padding: 2px 5px;
  border-radius: 4px;
  transition: var(--transition);
}
.folder-item:hover .folder-del { opacity: 1; }
.folder-del:hover { background: rgba(248,113,113,0.15); }

/* Sidebar bottom */
.sidebar-bottom {
  padding: 14px;
  border-top: 1px solid var(--border2);
  display: flex;
  gap: 8px;
}

.sidebar-tool-btn {
  flex: 1;
  padding: 9px;
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text2);
  cursor: pointer;
  font-size: 16px;
  transition: var(--transition);
  display: flex;
  align-items: center;
  justify-content: center;
}

.sidebar-tool-btn:hover { border-color: var(--accent); color: var(--accent); transform: translateY(-1px); }

/* ═══════════════════════════════════════════
   MAIN PANEL
═══════════════════════════════════════════ */
#main {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  min-width: 0;
}

.main-top-bar {
  padding: 22px 40px 18px;
  border-bottom: 1px solid var(--border2);
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 20px;
  background: var(--surface);
  backdrop-filter: blur(12px);
  flex-shrink: 0;
}

.main-title {
  font-family: var(--font-display);
  font-size: 26px;
  font-weight: 800;
  letter-spacing: -0.5px;
  background: linear-gradient(90deg, var(--text), var(--text2));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.top-actions { display: flex; gap: 10px; align-items: center; flex-shrink: 0; }

.stat-chips {
  display: flex;
  gap: 8px;
  padding: 14px 40px;
  border-bottom: 1px solid var(--border2);
  flex-shrink: 0;
  background: var(--bg2);
  flex-wrap: wrap;
}

.chip {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 14px;
  background: var(--surface2);
  border: 1px solid var(--border2);
  border-radius: 30px;
  font-size: 13px;
  font-weight: 600;
  color: var(--text2);
  backdrop-filter: blur(8px);
}

.chip-val { color: var(--accent); font-family: var(--font-display); font-weight: 700; }

#view-container {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 30px 40px 60px;
}

/* ═══════════════════════════════════════════
   PAGES
═══════════════════════════════════════════ */
.page { display: none; }
.page.active { display: block; }

/* ═══════════════════════════════════════════
   SUBJECTS GRID
═══════════════════════════════════════════ */
.subjects-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
  gap: 22px;
  margin-top: 10px;
}

.subject-card {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  overflow: hidden;
  transition: var(--transition);
  backdrop-filter: blur(8px);
  box-shadow: 0 2px 12px rgba(0,0,0,0.15);
}

.subject-card:hover {
  border-color: var(--accent);
  transform: translateY(-4px);
  box-shadow: 0 12px 40px rgba(0,0,0,0.25), 0 0 0 1px var(--accent);
}

.card-color-bar {
  height: 5px;
  width: 100%;
}

.card-body { padding: 22px 22px 0; }

.card-title-row {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 10px;
  margin-bottom: 10px;
}

.card-title {
  font-family: var(--font-display);
  font-size: 18px;
  font-weight: 700;
  letter-spacing: -0.2px;
  line-height: 1.2;
}

.card-btns { display: flex; gap: 6px; flex-shrink: 0; }

.card-btn {
  width: 32px; height: 32px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
  background: var(--bg3);
  color: var(--text2);
  cursor: pointer;
  font-size: 14px;
  transition: var(--transition);
  display: flex; align-items: center; justify-content: center;
}
.card-btn:hover { border-color: var(--accent); color: var(--accent); }
.card-btn.danger:hover { border-color: var(--danger); color: var(--danger); }

.card-meta {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  margin-bottom: 14px;
  font-size: 12px;
  color: var(--text2);
}

.card-tag {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 3px 9px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 600;
}

.card-progress {
  padding: 0 22px 14px;
}

.prog-row {
  display: flex;
  justify-content: space-between;
  font-size: 12px;
  color: var(--text2);
  margin-bottom: 6px;
}

.prog-bar {
  height: 6px;
  background: var(--bg3);
  border-radius: 10px;
  overflow: hidden;
}

.prog-fill {
  height: 100%;
  border-radius: 10px;
  background: linear-gradient(90deg, var(--accent), var(--accent2));
  transition: width 0.4s ease;
}

.prog-slider {
  width: 100%;
  margin-top: 8px;
  accent-color: var(--accent);
  cursor: pointer;
}

/* ═══════════════════════════════════════════
   SUBJECT TABS (CM / TD / Partiel / Ressources)
═══════════════════════════════════════════ */
.subject-tabs-bar {
  display: flex;
  padding: 0 22px;
  gap: 4px;
  border-top: 1px solid var(--border2);
  background: var(--bg3);
  flex-wrap: wrap;
}

.subject-tab-btn {
  padding: 10px 14px;
  background: none;
  border: none;
  border-bottom: 2px solid transparent;
  color: var(--text2);
  cursor: pointer;
  font-size: 12px;
  font-weight: 600;
  transition: var(--transition);
  display: flex;
  align-items: center;
  gap: 6px;
  white-space: nowrap;
  font-family: var(--font-body);
}

.subject-tab-btn:hover { color: var(--accent); }
.subject-tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }

.subject-tab-count {
  background: var(--surface2);
  padding: 1px 6px;
  border-radius: 8px;
  font-size: 10px;
  color: var(--text3);
}
.subject-tab-btn.active .subject-tab-count {
  background: var(--glow);
  color: var(--accent);
}

.tab-files-panel {
  display: none;
  padding: 14px 22px 20px;
}
.tab-files-panel.active { display: block; }

.tab-upload-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 14px;
  background: var(--bg3);
  border: 1.5px dashed var(--border);
  border-radius: var(--radius-sm);
  color: var(--text2);
  cursor: pointer;
  font-size: 13px;
  font-weight: 500;
  transition: var(--transition);
  width: 100%;
  justify-content: center;
  margin-bottom: 12px;
}

.tab-upload-btn:hover { border-color: var(--accent); color: var(--accent); background: var(--glow); }

.tab-file-row {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 9px 12px;
  background: var(--surface2);
  border: 1px solid var(--border2);
  border-radius: var(--radius-sm);
  margin-bottom: 6px;
  transition: var(--transition);
  cursor: pointer;
}

.tab-file-row:hover { border-color: var(--accent); background: var(--glow); }

.tab-file-icon { font-size: 20px; flex-shrink: 0; }

.tab-file-info { flex: 1; min-width: 0; }
.tab-file-name {
  font-size: 13px;
  font-weight: 500;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.tab-file-meta { font-size: 11px; color: var(--text3); margin-top: 1px; }

.tab-file-del {
  background: none;
  border: none;
  color: var(--text3);
  cursor: pointer;
  padding: 4px;
  border-radius: 4px;
  transition: var(--transition);
  font-size: 15px;
}
.tab-file-del:hover { color: var(--danger); background: rgba(248,113,113,0.1); }

/* Notes section in card */
.card-notes-btn {
  margin: 0 22px 20px;
  padding: 10px 14px;
  background: rgba(var(--gold-rgb, 244,192,90), 0.06);
  border-left: 3px solid var(--gold);
  border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
  font-size: 13px;
  color: var(--text2);
  cursor: pointer;
  transition: var(--transition);
  border-top: none;
  border-right: none;
  border-bottom: none;
  width: calc(100% - 44px);
  text-align: left;
  font-family: var(--font-body);
}
.card-notes-btn:hover { background: rgba(244,192,90,0.12); color: var(--gold); }
.card-notes-btn.has-notes { color: var(--text); }

/* Priority dot */
.priority-dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  display: inline-block;
  margin-right: 4px;
}

/* ═══════════════════════════════════════════
   AGENDA PAGE
═══════════════════════════════════════════ */
.agenda-layout {
  display: grid;
  grid-template-columns: 1fr;
  gap: 28px;
}

/* ═══════════════════════════════════════════
   AGENDA — Emploi du temps
═══════════════════════════════════════════ */

/* Toolbar */
.agenda-toolbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 24px;
  flex-wrap: wrap;
  gap: 12px;
  flex-shrink: 0;
}
.agenda-title-row { display: flex; flex-direction: column; gap: 4px; }
.agenda-main-title {
  font-family: var(--font-display);
  font-size: 24px; font-weight: 800; letter-spacing: -0.5px;
  color: var(--text);
}
.agenda-subtitle { font-size: 12px; color: var(--text3); font-weight: 500; }

/* ── Timetable container ── */
.timetable-wrap {
  display: flex;
  flex-direction: column;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  overflow: hidden;
  flex-shrink: 0;
}

/* Header row: time gutter + 7 day columns */
.tt-header {
  display: grid;
  grid-template-columns: 52px repeat(7, 1fr);
  background: var(--bg3);
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  z-index: 10;
}

.tt-header-gutter {
  border-right: 1px solid var(--border2);
}

.tt-header-day {
  padding: 12px 6px;
  text-align: center;
  border-right: 1px solid var(--border2);
  cursor: pointer;
  transition: var(--transition);
}
.tt-header-day:last-child { border-right: none; }
.tt-header-day:hover { background: var(--glow); }

.tt-day-name {
  font-size: 10px;
  font-weight: 800;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text3);
}
.tt-day-add {
  font-size: 16px;
  margin-top: 4px;
  opacity: 0;
  transition: var(--transition);
}
.tt-header-day:hover .tt-day-add { opacity: 1; }

/* Body: scrollable */
.tt-body {
  display: grid;
  grid-template-columns: 52px repeat(7, 1fr);
  position: relative;
  overflow-y: auto;
  max-height: 520px;
}

/* Time gutter labels */
.tt-time-col {
  display: flex;
  flex-direction: column;
  border-right: 1px solid var(--border2);
}

.tt-hour-label {
  height: 60px;
  display: flex;
  align-items: flex-start;
  justify-content: flex-end;
  padding: 4px 8px 0 0;
  font-size: 10px;
  font-weight: 700;
  color: var(--text3);
  flex-shrink: 0;
  box-sizing: border-box;
}

/* Day columns */
.tt-day-col {
  position: relative;
  border-right: 1px solid var(--border2);
  cursor: pointer;
}
.tt-day-col:last-child { border-right: none; }

/* Hour lines inside day column */
.tt-hour-line {
  position: absolute;
  left: 0; right: 0;
  height: 60px;
  border-bottom: 1px solid var(--border2);
  box-sizing: border-box;
  transition: background var(--transition);
}
.tt-hour-line:hover { background: var(--glow); }

/* Half-hour dotted line */
.tt-half-line {
  position: absolute;
  left: 4px; right: 4px;
  height: 0;
  border-top: 1px dashed var(--border2);
  top: 30px;
  pointer-events: none;
}

/* ── Event blocks ── */
.tt-event {
  position: absolute;
  left: 3px;
  right: 3px;
  border-radius: 8px;
  padding: 5px 8px;
  font-size: 11px;
  font-weight: 700;
  line-height: 1.3;
  overflow: hidden;
  cursor: pointer;
  z-index: 5;
  transition: filter var(--transition), transform var(--transition), box-shadow var(--transition);
  display: flex;
  flex-direction: column;
  gap: 2px;
  min-height: 22px;
  box-sizing: border-box;
}
.tt-event:hover {
  filter: brightness(1.15);
  transform: translateX(1px) scaleX(0.98);
  box-shadow: 0 4px 16px rgba(0,0,0,0.3);
  z-index: 10;
}

.tt-event-title { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.tt-event-meta  { font-size: 10px; opacity: 0.75; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

/* Type colours — solid fills for readability */
.ev-CM      { background: rgba(91,138,245,0.85);  color: #fff; border-left: 3px solid #3a6ae8; }
.ev-TD      { background: rgba(74,200,100,0.85);   color: #fff; border-left: 3px solid #28a855; }
.ev-Partiel { background: rgba(248,113,113,0.9);   color: #fff; border-left: 3px solid #e03c3c; }
.ev-Other   { background: rgba(244,192,90,0.85);   color: #1a1000; border-left: 3px solid #d4a020; }

/* Delete X on hover */
.tt-event-del {
  position: absolute;
  top: 3px; right: 4px;
  font-size: 13px;
  line-height: 1;
  opacity: 0;
  background: rgba(0,0,0,0.35);
  border-radius: 50%;
  width: 16px; height: 16px;
  display: flex; align-items: center; justify-content: center;
  transition: opacity var(--transition);
  cursor: pointer;
  color: #fff;
  flex-shrink: 0;
}
.tt-event:hover .tt-event-del { opacity: 1; }

/* ── Event list below ── */
.ev-list-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 12px;
  margin-top: 24px;
}

.ev-day-col {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.ev-day-header {
  font-size: 11px;
  font-weight: 800;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  color: var(--text3);
  padding-bottom: 6px;
  border-bottom: 1px solid var(--border2);
  text-align: center;
}

.ev-pill {
  padding: 6px 10px;
  border-radius: var(--radius-sm);
  font-size: 11px;
  font-weight: 600;
  display: flex;
  flex-direction: column;
  gap: 2px;
  cursor: pointer;
  transition: var(--transition);
  border: none;
  text-align: left;
}
.ev-pill:hover { filter: brightness(0.85); transform: translateY(-1px); }
.ev-pill-time { font-size: 10px; opacity: 0.75; }
.ev-pill-title { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.ev-pill-empty { font-size: 11px; color: var(--text3); text-align: center; padding: 8px 0; }

/* Add event button */
.add-event-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 11px 20px;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  border: none;
  border-radius: var(--radius-sm);
  color: var(--bg);
  font-family: var(--font-display);
  font-weight: 700;
  font-size: 13px;
  cursor: pointer;
  transition: var(--transition);
}
.add-event-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px var(--glow); }

/* Color picker for events */
.ev-color-row {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}
.ev-color-swatch {
  width: 32px; height: 32px;
  border-radius: 50%;
  cursor: pointer;
  border: 3px solid transparent;
  transition: var(--transition);
  flex-shrink: 0;
}
.ev-color-swatch:hover { transform: scale(1.15); }
.ev-color-swatch.sel { border-color: #fff; box-shadow: 0 0 10px rgba(255,255,255,0.4); }

/* Current time line */
.tt-now-line {
  position: absolute;
  left: 0; right: 0;
  height: 2px;
  background: var(--danger);
  z-index: 20;
  pointer-events: none;
}
.tt-now-dot {
  position: absolute;
  left: -4px;
  top: -4px;
  width: 10px; height: 10px;
  background: var(--danger);
  border-radius: 50%;
}

/* Today column highlight */
.tt-day-col.today-col { background: rgba(var(--accent-raw, 91,138,245), 0.03); }
.tt-header-day.today-col .tt-day-name { color: var(--accent); }

/* Responsive */
@media (max-width: 860px) {
  .tt-header, .tt-body { grid-template-columns: 40px repeat(7,1fr); }
  .ev-list-grid { grid-template-columns: repeat(4, 1fr); }
  .tt-event-meta { display: none; }
}
@media (max-width: 600px) {
  .ev-list-grid { grid-template-columns: repeat(2, 1fr); }
  .tt-body { max-height: 380px; }
}


/* ═══════════════════════════════════════════
   MODAL
═══════════════════════════════════════════ */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  backdrop-filter: blur(6px);
  z-index: 500;
  display: none;
  align-items: center;
  justify-content: center;
}

.modal-overlay.show { display: flex; }

.modal-box {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 22px;
  padding: 32px;
  width: 500px;
  max-width: 95vw;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 25px 70px rgba(0,0,0,0.5);
  animation: modalIn 0.3s cubic-bezier(.16,1,.3,1);
}

@keyframes modalIn {
  from { opacity: 0; transform: translateY(-20px) scale(0.97); }
  to { opacity: 1; transform: none; }
}

.modal-title {
  font-family: var(--font-display);
  font-size: 20px;
  font-weight: 700;
  color: var(--accent);
  margin-bottom: 22px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.form-field { margin-bottom: 16px; }

.form-label {
  display: block;
  font-size: 11px;
  font-weight: 700;
  color: var(--text3);
  text-transform: uppercase;
  letter-spacing: 0.8px;
  margin-bottom: 7px;
}

.form-input, .form-select, .form-textarea {
  width: 100%;
  padding: 12px 14px;
  background: var(--bg3);
  border: 1.5px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text);
  font-family: var(--font-body);
  font-size: 14px;
  transition: var(--transition);
}

.form-input:focus, .form-select:focus, .form-textarea:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--glow);
}

.form-input::placeholder, .form-textarea::placeholder { color: var(--text3); }

.form-textarea {
  min-height: 80px;
  resize: vertical;
}

.form-select { appearance: none; cursor: pointer; }

/* Color picker */
.color-row {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.color-swatch {
  width: 36px; height: 36px;
  border-radius: 50%;
  cursor: pointer;
  border: 3px solid transparent;
  transition: var(--transition);
}

.color-swatch:hover { transform: scale(1.15); }
.color-swatch.sel { border-color: #fff; box-shadow: 0 0 12px rgba(255,255,255,0.4); }

/* Emoji grid in modal */
.emoji-grid {
  display: grid;
  grid-template-columns: repeat(10, 1fr);
  gap: 5px;
  max-height: 160px;
  overflow-y: auto;
}

.emoji-opt {
  aspect-ratio: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  border-radius: 6px;
  cursor: pointer;
  transition: var(--transition);
  border: 2px solid transparent;
  background: var(--bg3);
}

.emoji-opt:hover { transform: scale(1.2); background: var(--bg2); }
.emoji-opt.sel { border-color: var(--accent); background: var(--surface2); }

/* Modal footer */
.modal-footer {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
  margin-top: 24px;
}

.btn-cancel {
  padding: 11px 22px;
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text2);
  cursor: pointer;
  font-family: var(--font-body);
  font-weight: 600;
  transition: var(--transition);
}

.btn-cancel:hover { background: var(--bg2); color: var(--text); }

.btn-confirm {
  padding: 11px 24px;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  border: none;
  border-radius: var(--radius-sm);
  color: var(--bg);
  cursor: pointer;
  font-family: var(--font-display);
  font-weight: 700;
  font-size: 14px;
  transition: var(--transition);
}

.btn-confirm:hover { transform: translateY(-1px); box-shadow: 0 6px 20px var(--glow); }

/* ═══════════════════════════════════════════
   THEME PANEL
═══════════════════════════════════════════ */
.theme-panel {
  display: none;
  position: fixed;
  top: 0; right: 0;
  width: 320px;
  height: 100vh;
  background: var(--surface);
  border-left: 1px solid var(--border);
  z-index: 200;
  padding: 28px 24px;
  backdrop-filter: blur(16px);
  box-shadow: -10px 0 40px rgba(0,0,0,0.3);
  animation: slideInRight 0.3s cubic-bezier(.16,1,.3,1);
  overflow-y: auto;
}

.theme-panel.open { display: block; }

@keyframes slideInRight {
  from { transform: translateX(100%); }
  to { transform: translateX(0); }
}

.theme-panel-title {
  font-family: var(--font-display);
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 22px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  color: var(--accent);
}

.theme-close {
  background: none;
  border: none;
  color: var(--text2);
  font-size: 20px;
  cursor: pointer;
  padding: 4px;
  border-radius: 6px;
  transition: var(--transition);
}
.theme-close:hover { color: var(--text); background: var(--bg3); }

.theme-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-bottom: 24px;
}

.theme-card {
  padding: 14px;
  border-radius: var(--radius);
  cursor: pointer;
  transition: var(--transition);
  border: 2px solid transparent;
  position: relative;
  overflow: hidden;
}

.theme-card:hover { transform: scale(1.03); }
.theme-card.active { border-color: white; }
.theme-card.active::after {
  content: '✓';
  position: absolute;
  top: 8px; right: 10px;
  font-size: 14px;
  color: white;
  font-weight: 700;
}

.theme-preview-dots {
  display: flex;
  gap: 5px;
  margin-bottom: 10px;
}

.tpd {
  width: 12px; height: 12px;
  border-radius: 50%;
}

.theme-card-name {
  font-size: 13px;
  font-weight: 600;
  color: rgba(255,255,255,0.9);
}

/* ═══════════════════════════════════════════
   TOAST
═══════════════════════════════════════════ */
#toast-wrap {
  position: fixed;
  bottom: 24px;
  right: 24px;
  z-index: 9990;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.toast {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 14px 18px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  box-shadow: 0 8px 30px rgba(0,0,0,0.3);
  font-size: 14px;
  font-weight: 500;
  backdrop-filter: blur(16px);
  animation: toastIn 0.35s cubic-bezier(.16,1,.3,1);
  max-width: 320px;
}

@keyframes toastIn {
  from { transform: translateX(120%); opacity: 0; }
  to { transform: none; opacity: 1; }
}

.toast.success { border-left: 4px solid var(--success); }
.toast.error   { border-left: 4px solid var(--danger); }
.toast.info    { border-left: 4px solid var(--accent); }

/* ═══════════════════════════════════════════
   EMPTY STATE
═══════════════════════════════════════════ */
.empty-box {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 80px 40px;
  border: 2px dashed var(--border);
  border-radius: var(--radius-lg);
  text-align: center;
  color: var(--text2);
  margin-top: 20px;
}

.empty-box-icon { font-size: 56px; margin-bottom: 16px; opacity: 0.5; }
.empty-box h3 { font-family: var(--font-display); font-size: 20px; font-weight: 700; margin-bottom: 8px; color: var(--text); }
.empty-box p { font-size: 14px; color: var(--text2); }

/* Scrollbar */
::-webkit-scrollbar { width: 5px; height: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }
::-webkit-scrollbar-thumb:hover { background: var(--accent); }

/* Responsive */
@media (max-width: 900px) {
  #sidebar { width: 260px; min-width: 260px; }
  .subjects-grid { grid-template-columns: 1fr; }
  #view-container { padding: 20px; }
  .main-top-bar, .stat-chips { padding-left: 20px; padding-right: 20px; }
  .week-grid { grid-template-columns: 44px repeat(7,1fr); overflow-x: auto; }
}

@media (max-width: 700px) {
  body { overflow: auto; }
  #app { flex-direction: column; height: auto; overflow: auto; }
  #sidebar { width: 100%; min-width: unset; height: auto; max-height: 40vh; }
  #main { height: auto; overflow: visible; }
  #view-container { overflow: visible; }
}

/* Filter bar */
.filter-bar {
  display: flex;
  gap: 8px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.filter-chip {
  padding: 7px 14px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  color: var(--text2);
  cursor: pointer;
  transition: var(--transition);
}

.filter-chip:hover { color: var(--accent); border-color: var(--accent); }
.filter-chip.active { background: var(--glow); color: var(--accent); border-color: var(--accent); }

/* Action button */
.action-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 18px;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  border: none;
  border-radius: var(--radius-sm);
  color: var(--bg);
  font-family: var(--font-display);
  font-weight: 700;
  font-size: 13px;
  cursor: pointer;
  transition: var(--transition);
}

.action-btn:hover { transform: translateY(-1px); box-shadow: 0 5px 20px var(--glow); }

.action-btn-ghost {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 18px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text2);
  font-family: var(--font-body);
  font-weight: 600;
  font-size: 13px;
  cursor: pointer;
  transition: var(--transition);
}

.action-btn-ghost:hover { border-color: var(--accent); color: var(--accent); }

/* Section heading */
.section-heading {
  font-family: var(--font-display);
  font-size: 15px;
  font-weight: 700;
  color: var(--text2);
  text-transform: uppercase;
  letter-spacing: 0.8px;
  margin-bottom: 14px;
  margin-top: 24px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.section-heading::after {
  content: '';
  flex: 1;
  height: 1px;
  background: var(--border2);
}

input[type="file"] { display: none; }

/* ── ENT link in user card ── */
.user-ent-link {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  font-size: 11px;
  font-weight: 600;
  color: var(--accent);
  text-decoration: none;
  padding: 2px 8px;
  background: var(--glow);
  border-radius: 20px;
  border: 1px solid var(--accent);
  opacity: 0.85;
  transition: var(--transition);
  white-space: nowrap;
  margin-top: 3px;
}
.user-ent-link:hover { opacity: 1; transform: translateY(-1px); box-shadow: 0 3px 10px var(--glow); }

/* Nav badge (devoirs count) */
.nav-badge {
  margin-left: auto;
  background: var(--danger);
  color: #fff;
  font-size: 10px;
  font-weight: 800;
  min-width: 18px; height: 18px;
  border-radius: 20px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 0 5px;
}

/* ── Page header row (Notes / Devoirs) ── */
.page-header-row {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  margin-bottom: 24px;
  gap: 12px;
  flex-wrap: wrap;
}
.page-title {
  font-family: var(--font-display);
  font-size: 24px; font-weight: 800; letter-spacing: -0.5px;
}
.page-subtitle { font-size: 12px; color: var(--text3); margin-top: 4px; }

/* ══════════════════════════════
   NOTES PAGE
══════════════════════════════ */
.notes-filter-bar {
  display: flex;
  gap: 12px;
  align-items: center;
  flex-wrap: wrap;
  margin-bottom: 20px;
}
.notes-search {
  flex: 1;
  min-width: 200px;
  padding: 10px 14px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text);
  font-family: var(--font-body);
  font-size: 13px;
  outline: none;
  transition: var(--transition);
}
.notes-search:focus { border-color: var(--accent); }
.notes-cats { display: flex; gap: 6px; flex-wrap: wrap; }
.notes-cat-chip {
  padding: 5px 12px;
  border-radius: 20px;
  font-size: 12px; font-weight: 600;
  background: var(--surface2);
  border: 1px solid var(--border2);
  color: var(--text2);
  cursor: pointer;
  transition: var(--transition);
}
.notes-cat-chip:hover, .notes-cat-chip.active {
  background: var(--glow);
  border-color: var(--accent);
  color: var(--accent);
}

.notes-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 16px;
}

.note-card {
  background: var(--surface);
  border: 1px solid var(--border2);
  border-radius: var(--radius);
  padding: 18px 20px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  cursor: pointer;
  transition: var(--transition);
  position: relative;
  overflow: hidden;
}
.note-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 3px;
  background: var(--note-color, var(--accent));
}
.note-card:hover { border-color: var(--border); transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.15); }

.note-card-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 8px; }
.note-card-title { font-family: var(--font-display); font-size: 15px; font-weight: 700; line-height: 1.3; }
.note-card-del {
  background: none; border: none; color: var(--text3);
  cursor: pointer; font-size: 16px; padding: 2px 4px;
  border-radius: 4px; transition: var(--transition); flex-shrink: 0;
  opacity: 0;
}
.note-card:hover .note-card-del { opacity: 1; }
.note-card-del:hover { color: var(--danger); }

.note-card-cat {
  display: inline-block;
  font-size: 11px; font-weight: 700;
  padding: 2px 8px;
  border-radius: 20px;
  background: var(--glow);
  color: var(--accent);
  align-self: flex-start;
}
.note-card-body {
  font-size: 13px; color: var(--text2);
  line-height: 1.6;
  display: -webkit-box;
  -webkit-line-clamp: 4;
  -webkit-box-orient: vertical;
  overflow: hidden;
  white-space: pre-wrap;
}
.note-card-date { font-size: 11px; color: var(--text3); margin-top: auto; }
.notes-empty { text-align: center; color: var(--text3); padding: 60px 20px; font-size: 14px; }

/* Note color picker uses same ev-color-row + ev-color-swatch classes */

/* ══════════════════════════════
   DEVOIRS PAGE
══════════════════════════════ */
.devoirs-tabs {
  display: flex;
  gap: 4px;
  margin-bottom: 20px;
  background: var(--surface2);
  border-radius: var(--radius-sm);
  padding: 4px;
  width: fit-content;
}
.dv-tab {
  padding: 7px 18px;
  border-radius: 6px;
  font-size: 13px; font-weight: 600;
  border: none; cursor: pointer;
  background: transparent;
  color: var(--text2);
  transition: var(--transition);
}
.dv-tab.active { background: var(--bg3); color: var(--text); box-shadow: 0 1px 6px rgba(0,0,0,0.2); }

.devoirs-list { display: flex; flex-direction: column; gap: 10px; }

.devoir-card {
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 16px 20px;
  background: var(--surface);
  border: 1px solid var(--border2);
  border-radius: var(--radius);
  transition: var(--transition);
  position: relative;
  overflow: hidden;
}
.devoir-card::before {
  content: '';
  position: absolute;
  left: 0; top: 0; bottom: 0;
  width: 4px;
  background: var(--dv-color, var(--accent));
}
.devoir-card:hover { border-color: var(--border); box-shadow: 0 4px 16px rgba(0,0,0,0.1); }
.devoir-card.done { opacity: 0.5; }
.devoir-card.done .devoir-title { text-decoration: line-through; }

.dv-check {
  width: 22px; height: 22px; min-width: 22px;
  border-radius: 50%;
  border: 2px solid var(--border);
  background: none;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  font-size: 12px;
  transition: var(--transition);
}
.dv-check:hover { border-color: var(--success); background: rgba(74,222,128,0.15); }
.dv-check.checked { background: var(--success); border-color: var(--success); color: #fff; }

.devoir-info { flex: 1; display: flex; flex-direction: column; gap: 4px; }
.devoir-title { font-weight: 700; font-size: 14px; }
.devoir-meta { font-size: 12px; color: var(--text2); display: flex; gap: 10px; flex-wrap: wrap; }

.dv-deadline-badge {
  font-size: 12px; font-weight: 700;
  padding: 3px 10px;
  border-radius: 20px;
  white-space: nowrap;
}
.dv-deadline-badge.overdue  { background: rgba(248,113,113,0.18); color: var(--danger); }
.dv-deadline-badge.urgent   { background: rgba(251,191,36,0.18); color: var(--warning); }
.dv-deadline-badge.ok       { background: rgba(74,222,128,0.15); color: var(--success); }
.dv-deadline-badge.today    { background: rgba(248,113,113,0.25); color: var(--danger); animation: pulse 1.5s infinite; }

.dv-type-badge {
  font-size: 11px; font-weight: 700;
  padding: 3px 9px;
  border-radius: 20px;
  background: var(--surface2);
  color: var(--text2);
  border: 1px solid var(--border2);
}

.dv-del-btn {
  background: none; border: none; color: var(--text3);
  cursor: pointer; font-size: 18px; padding: 4px;
  transition: var(--transition); opacity: 0;
}
.devoir-card:hover .dv-del-btn { opacity: 1; }
.dv-del-btn:hover { color: var(--danger); }

.devoirs-empty { text-align: center; color: var(--text3); padding: 60px 20px; font-size: 14px; }

@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.6} }
</style>
</head>
<body data-theme="midnight">

<!-- ═══════════════ AUTH SCREEN ═══════════════ -->
<div id="auth-screen">
  <div class="auth-bg">
    <div class="auth-orb auth-orb-1"></div>
    <div class="auth-orb auth-orb-2"></div>
  </div>
  <div class="auth-card">
    <div class="auth-logo">
      <div class="auth-logo-dot"></div>
      <h1>AMU <span>STUDY HUB</span></h1>
    </div>
    <div class="auth-tabs">
      <button class="auth-tab active" onclick="switchAuthTab('login')">Connexion</button>
      <button class="auth-tab" onclick="switchAuthTab('register')">Créer un compte</button>
    </div>

    <!-- LOGIN -->
    <div id="auth-login" class="auth-form">
      <label>Identifiant</label>
      <input class="auth-input" id="login-username" type="text" placeholder="jean.dupont" autocomplete="username">
      <label>Mot de passe</label>
      <input class="auth-input" id="login-password" type="password" placeholder="••••••••" autocomplete="current-password">
      <div class="auth-error" id="login-error"></div>
      <button class="auth-btn" onclick="handleLogin()">Se connecter</button>
    </div>

    <!-- REGISTER -->
    <div id="auth-register" class="auth-form" style="display:none;">
      <label>Prénom & Nom</label>
      <input class="auth-input" id="reg-name" type="text" placeholder="Jean Dupont">
      <label>Identifiant</label>
      <input class="auth-input" id="reg-username" type="text" placeholder="jean.dupont">
      <label>Mot de passe</label>
      <input class="auth-input" id="reg-password" type="password" placeholder="Minimum 6 caractères">
      <label>Avatar</label>
      <div class="auth-emoji-grid" id="avatar-picker">
        🎓🧑‍🔬🧑‍💻👩‍🎨🦊🐙🌊🌿🔥⚡🌙🪐🧠🎯🚀💎🌺🦋🐬🦅
      </div>
      <div class="auth-error" id="reg-error"></div>
      <button class="auth-btn" onclick="handleRegister()">Créer mon compte</button>
    </div>
  </div>
</div>

<!-- ═══════════════ MAIN APP ═══════════════ -->
<div id="app">

  <!-- SIDEBAR -->
  <aside id="sidebar">
    <div class="sidebar-header">
      <div class="logo-row">
        <div class="logo-dot"></div>
        <div class="logo-text">AMU <span>STUDY</span></div>
        <button class="light-toggle-btn" id="light-toggle-btn" onclick="toggleLightMode()" title="Mode clair / sombre">🌙</button>
      </div>
      <div class="user-card">
        <div class="user-avatar" id="sidebar-avatar">🎓</div>
        <div class="user-info">
          <div class="user-name" id="sidebar-username">—</div>
          <a class="user-ent-link" href="https://ent.univ-amu.fr/" target="_blank" rel="noopener" title="Ouvrir l'ENT AMU">
            🎓 ENT AMU ↗
          </a>
        </div>
        <button class="logout-btn" onclick="logout(event)" title="Déconnexion">⏻</button>
      </div>
    </div>

    <div class="sidebar-nav">
      <button class="nav-pill active" data-page="courses" onclick="navTo('courses',this)">
        <span class="nav-icon">📚</span> Mes Cours
      </button>
      <button class="nav-pill" data-page="agenda" onclick="navTo('agenda',this)">
        <span class="nav-icon">📅</span> Agenda
      </button>
      <button class="nav-pill" data-page="notes" onclick="navTo('notes',this)">
        <span class="nav-icon">📝</span> Notes
      </button>
      <button class="nav-pill" data-page="devoirs" onclick="navTo('devoirs',this)">
        <span class="nav-icon">✅</span> Devoirs
        <span class="nav-badge" id="devoirs-badge" style="display:none">0</span>
      </button>
    </div>

    <div class="sidebar-section-title">
      Années / Semestres
      <button class="sidebar-add-btn" onclick="openModal('folder-modal')" title="Nouveau dossier">+</button>
    </div>

    <div id="folder-list"></div>

    <div class="sidebar-bottom">
      <button class="sidebar-tool-btn" onclick="openThemePanel()" title="Thèmes">🎨</button>
      <button class="sidebar-tool-btn" onclick="exportData()" title="Exporter">📤</button>
      <button class="sidebar-tool-btn" onclick="document.getElementById('import-input').click()" title="Importer">📥</button>
    </div>
  </aside>

  <!-- MAIN -->
  <div id="main">
    <div class="main-top-bar">
      <div class="main-title" id="main-title">Bienvenue 👋</div>
      <div class="top-actions">
        <button id="add-subject-btn" class="action-btn" style="display:none" onclick="openModal('subject-modal')">+ Matière</button>
      </div>
    </div>

    <div class="stat-chips" id="stat-chips" style="display:none">
      <div class="chip"><span>📚</span> <span class="chip-val" id="chip-subjects">0</span> matières</div>
      <div class="chip"><span>📄</span> <span class="chip-val" id="chip-files">0</span> documents</div>
      <div class="chip"><span>📈</span> <span class="chip-val" id="chip-progress">0%</span> progression</div>
      <div class="chip"><span>💾</span> <span class="chip-val" id="chip-size">0 MB</span></div>
    </div>

    <div id="view-container">

      <!-- PAGE: COURSES -->
      <div id="page-courses" class="page active">
        <div class="empty-box" id="courses-empty">
          <div class="empty-box-icon">🌊</div>
          <h3>Sélectionne un semestre</h3>
          <p>Choisis un dossier à gauche ou crée-en un nouveau</p>
        </div>
        <div id="subjects-grid" class="subjects-grid" style="display:none"></div>
      </div>

      <!-- PAGE: AGENDA -->
      <div id="page-agenda" class="page">

        <div class="agenda-toolbar">
          <div class="agenda-title-row">
            <span class="agenda-main-title">🗓️ Emploi du temps</span>
            <span class="agenda-subtitle">Semaine type · cliquer sur un créneau pour ajouter</span>
          </div>
          <button class="add-event-btn" onclick="openAddEventModal()">＋ Ajouter un cours</button>
        </div>

        <!-- Timetable -->
        <div class="timetable-wrap">
          <div class="tt-header" id="tt-header"></div>
          <div class="tt-body"  id="tt-body"></div>
        </div>

        <!-- Event list per day -->
        <div class="section-heading" style="margin-top:28px">📋 Récapitulatif</div>
        <div class="ev-list-grid" id="ev-list-grid"></div>

      </div>

      <!-- PAGE: NOTES -->
      <div id="page-notes" class="page">
        <div class="page-header-row">
          <div>
            <div class="page-title">📝 Notes</div>
            <div class="page-subtitle">Toutes tes notes en un seul endroit</div>
          </div>
          <button class="add-event-btn" onclick="openNoteModal()">＋ Nouvelle note</button>
        </div>

        <div class="notes-filter-bar">
          <input class="notes-search" id="notes-search" placeholder="🔍 Rechercher une note..." oninput="renderNotes()">
          <div class="notes-cats" id="notes-cats"></div>
        </div>

        <div id="notes-grid" class="notes-grid"></div>
      </div>

      <!-- PAGE: DEVOIRS -->
      <div id="page-devoirs" class="page">
        <div class="page-header-row">
          <div>
            <div class="page-title">✅ Devoirs à faire</div>
            <div class="page-subtitle">Ne rate plus aucune deadline</div>
          </div>
          <button class="add-event-btn" onclick="openDevoirModal()">＋ Ajouter un devoir</button>
        </div>

        <div class="devoirs-tabs">
          <button class="dv-tab active" onclick="switchDevoirsTab('todo',this)">À faire</button>
          <button class="dv-tab" onclick="switchDevoirsTab('done',this)">Terminés</button>
          <button class="dv-tab" onclick="switchDevoirsTab('all',this)">Tous</button>
        </div>

        <div id="devoirs-list" class="devoirs-list"></div>
      </div>

    </div>
  </div>
</div>

<!-- ═══════════════ THEME PANEL ═══════════════ -->
<div id="theme-panel" class="theme-panel">
  <div class="theme-panel-title">
    Thèmes
    <button class="theme-close" onclick="closeThemePanel()">×</button>
  </div>
  <div class="theme-grid" id="theme-grid"></div>
</div>

<!-- ═══════════════ MODALS ═══════════════ -->

<!-- Folder Modal -->
<div class="modal-overlay" id="folder-modal">
  <div class="modal-box">
    <div class="modal-title">📁 Nouveau Dossier</div>
    <div class="form-field">
      <label class="form-label">Nom *</label>
      <input class="form-input" id="fm-name" placeholder="ex: L2 — Semestre 3">
    </div>
    <div class="form-field">
      <label class="form-label">Emoji</label>
      <div class="emoji-grid" id="fm-emoji-grid"></div>
    </div>
    <div class="form-field">
      <label class="form-label">Description</label>
      <textarea class="form-textarea" id="fm-desc" placeholder="Optionnel"></textarea>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeModal('folder-modal')">Annuler</button>
      <button class="btn-confirm" onclick="createFolder()">Créer</button>
    </div>
  </div>
</div>

<!-- Subject Modal -->
<div class="modal-overlay" id="subject-modal">
  <div class="modal-box">
    <div class="modal-title">📚 Nouvelle Matière</div>
    <div class="form-field">
      <label class="form-label">Nom *</label>
      <input class="form-input" id="sm-name" placeholder="ex: Biologie Cellulaire">
    </div>
    <div class="form-field">
      <label class="form-label">Description</label>
      <textarea class="form-textarea" id="sm-desc" placeholder="Optionnel"></textarea>
    </div>
    <div class="form-field">
      <label class="form-label">Couleur</label>
      <div class="color-row" id="sm-colors"></div>
    </div>
    <div class="form-field">
      <label class="form-label">Priorité</label>
      <select class="form-select" id="sm-priority">
        <option value="low">🟢 Basse</option>
        <option value="medium" selected>🟡 Moyenne</option>
        <option value="high">🔴 Haute</option>
      </select>
    </div>
    <div class="form-field">
      <label class="form-label">Tags (virgule)</label>
      <input class="form-input" id="sm-tags" placeholder="Exam, TD, Notes...">
    </div>
    <div class="form-field">
      <label class="form-label">Date limite</label>
      <input class="form-input" id="sm-deadline" type="date">
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeModal('subject-modal')">Annuler</button>
      <button class="btn-confirm" onclick="createSubject()">Créer</button>
    </div>
  </div>
</div>

<!-- Notes Modal -->
<div class="modal-overlay" id="notes-modal">
  <div class="modal-box">
    <div class="modal-title">📝 Notes — <span id="notes-modal-name"></span></div>
    <div class="form-field">
      <textarea class="form-textarea" id="notes-textarea" style="min-height:200px" placeholder="Écris tes notes ici... (Markdown supporté)"></textarea>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeModal('notes-modal')">Fermer</button>
      <button class="btn-confirm" onclick="saveNotes()">Enregistrer</button>
    </div>
  </div>
</div>

<!-- Event Modal -->
<div class="modal-overlay" id="event-modal">
  <div class="modal-box">
    <div class="modal-title" id="ev-modal-title">➕ Nouveau cours</div>

    <div class="form-field">
      <label class="form-label">Intitulé *</label>
      <input class="form-input" id="ev-title" placeholder="ex: Biologie Cellulaire">
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div class="form-field">
        <label class="form-label">Type</label>
        <select class="form-select" id="ev-type">
          <option value="CM">🎤 CM</option>
          <option value="TD">✏️ TD</option>
          <option value="Partiel">📝 Partiel</option>
          <option value="Other">📌 Autre</option>
        </select>
      </div>
      <div class="form-field">
        <label class="form-label">Jour *</label>
        <select class="form-select" id="ev-day">
          <option value="0">Lundi</option>
          <option value="1">Mardi</option>
          <option value="2">Mercredi</option>
          <option value="3">Jeudi</option>
          <option value="4">Vendredi</option>
          <option value="5">Samedi</option>
          <option value="6">Dimanche</option>
        </select>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div class="form-field">
        <label class="form-label">Heure début *</label>
        <input class="form-input" id="ev-time" type="time" value="08:00">
      </div>
      <div class="form-field">
        <label class="form-label">Durée</label>
        <select class="form-select" id="ev-duration">
          <option value="0.5">30 min</option>
          <option value="1">1h</option>
          <option value="1.5">1h30</option>
          <option value="2" selected>2h</option>
          <option value="2.5">2h30</option>
          <option value="3">3h</option>
          <option value="4">4h</option>
        </select>
      </div>
    </div>

    <div class="form-field">
      <label class="form-label">Salle / Lieu</label>
      <input class="form-input" id="ev-room" placeholder="ex: Amphi Darwin, Salle 203">
    </div>

    <div class="form-field">
      <label class="form-label">Enseignant (optionnel)</label>
      <input class="form-input" id="ev-teacher" placeholder="ex: Prof. Martin">
    </div>

    <div class="form-field">
      <label class="form-label">Couleur personnalisée</label>
      <div class="ev-color-row" id="ev-color-row"></div>
    </div>

    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeModal('event-modal')">Annuler</button>
      <button class="btn-confirm" id="ev-submit-btn" onclick="createEvent()">Ajouter</button>
    </div>
  </div>
</div>

<!-- Note Modal -->
<div class="modal-overlay" id="note-modal">
  <div class="modal-box" style="width:580px">
    <div class="modal-title" id="note-modal-title">📝 Nouvelle note</div>
    <div class="form-field">
      <label class="form-label">Titre *</label>
      <input class="form-input" id="note-title" placeholder="ex: Cours de Bio — Mitose">
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div class="form-field">
        <label class="form-label">Matière / Catégorie</label>
        <input class="form-input" id="note-cat" placeholder="ex: Biologie, Maths...">
      </div>
      <div class="form-field">
        <label class="form-label">Couleur</label>
        <div class="ev-color-row" id="note-color-row"></div>
      </div>
    </div>
    <div class="form-field">
      <label class="form-label">Contenu *</label>
      <textarea class="form-textarea" id="note-content" style="min-height:160px" placeholder="Écris tes notes ici..."></textarea>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeModal('note-modal')">Annuler</button>
      <button class="btn-confirm" id="note-submit-btn" onclick="saveNote()">Enregistrer</button>
    </div>
  </div>
</div>

<!-- Devoir Modal -->
<div class="modal-overlay" id="devoir-modal">
  <div class="modal-box">
    <div class="modal-title" id="devoir-modal-title">📋 Nouveau devoir</div>
    <div class="form-field">
      <label class="form-label">Intitulé *</label>
      <input class="form-input" id="dv-title" placeholder="ex: DM Analyse — Série 4">
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div class="form-field">
        <label class="form-label">Matière</label>
        <input class="form-input" id="dv-subject" placeholder="ex: Maths, Physique...">
      </div>
      <div class="form-field">
        <label class="form-label">Type</label>
        <select class="form-select" id="dv-type">
          <option value="DM">📄 Devoir maison</option>
          <option value="DS">📝 Devoir sur table</option>
          <option value="Projet">🗂️ Projet</option>
          <option value="Exposé">🎤 Exposé</option>
          <option value="Lecture">📖 Lecture</option>
          <option value="Autre">📌 Autre</option>
        </select>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div class="form-field">
        <label class="form-label">Date limite *</label>
        <input class="form-input" id="dv-deadline" type="date">
      </div>
      <div class="form-field">
        <label class="form-label">Priorité</label>
        <select class="form-select" id="dv-priority">
          <option value="low">🟢 Basse</option>
          <option value="medium" selected>🟡 Moyenne</option>
          <option value="high">🔴 Haute</option>
        </select>
      </div>
    </div>
    <div class="form-field">
      <label class="form-label">Description (optionnel)</label>
      <textarea class="form-textarea" id="dv-desc" placeholder="Instructions, pages à lire..."></textarea>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeModal('devoir-modal')">Annuler</button>
      <button class="btn-confirm" id="dv-submit-btn" onclick="saveDevoir()">Ajouter</button>
    </div>
  </div>
</div>

<div id="toast-wrap"></div>
<input type="file" id="pdf-upload" multiple accept="application/pdf">
<input type="file" id="import-input" accept=".json">

<script>
// ═══════════════════════════════════════════════════════
// CONSTANTS
// ═══════════════════════════════════════════════════════
const DB_NAME = "AMU_HUB_DB";
const DB_VER = 2; // bumped to add notes + devoirs stores

const THEMES = [
  { id:"midnight", name:"Midnight",  bg:"#090c14", c1:"#5b8af5", c2:"#a78bfa", c3:"#0f1422" },
  { id:"aurora",   name:"Aurora",    bg:"#050e12", c1:"#20c9ac", c2:"#6ee7d4", c3:"#081519" },
  { id:"sunset",   name:"Sunset",    bg:"#12080a", c1:"#fa6450", c2:"#ff9a6c", c3:"#1c0d10" },
  { id:"forest",   name:"Forest",    bg:"#080e09", c1:"#4ac864", c2:"#8fe89a", c3:"#0e1810" },
  { id:"rose",     name:"Rose",      bg:"#120810", c1:"#f064a0", c2:"#f49ec8", c3:"#1c1018" },
  { id:"arctic",   name:"Arctique",  bg:"#f0f4fc", c1:"#4a7ef0", c2:"#7c8ff8", c3:"#e4eaf8" },
  { id:"obsidian", name:"Obsidienne",bg:"#0a0a0a", c1:"#e8e8e8", c2:"#a0a0a0", c3:"#111111" },
  { id:"galaxy",   name:"Galaxie",   bg:"#06040e", c1:"#9650ff", c2:"#c880ff", c3:"#0c0818" },
];

const COLORS = ["#5b8af5","#4ac864","#f87171","#f4c05a","#c880ff","#fa6450","#20c9ac","#f064a0","#38bdf8","#ff9a6c","#6ee7d4","#ffd060"];
const DAYS_FR = ["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"];
const MONTHS_FR = ["Jan","Fév","Mar","Avr","Mai","Jun","Jul","Aoû","Sep","Oct","Nov","Déc"];
const MONTHS_FULL = ["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"];

const FOLDER_EMOJIS = ["📁","📚","🎓","📖","✏️","🔬","💻","🧮","⚗️","🌍","🎯","📐","🏫","🔭","📊","🧬","🎵","🏛️","🖊️","📋"];
const AVATAR_EMOJIS = ["🎓","🧑‍🔬","🧑‍💻","👩‍🎨","🦊","🐙","🌊","🌿","🔥","⚡","🌙","🪐","🧠","🎯","🚀","💎","🌺","🦋","🐬","🦅"];

const SUBJECT_TABS = [
  { key:"CM",       label:"Cours Magistral", icon:"🎤" },
  { key:"TD",       label:"Travaux Dirigés", icon:"✏️" },
  { key:"Partiel",  label:"Partiels",        icon:"📝" },
  { key:"Ressources", label:"Ressources",    icon:"📎" },
];

// ═══════════════════════════════════════════════════════
// STATE
// ═══════════════════════════════════════════════════════
let db, currentUser = null, currentFolderId = null;
let editingNotesId = null, uploadTargetId = null, uploadTabKey = null;
let selectedColor = COLORS[0];
let selectedFolderEmoji = "📁";
let selectedAvatar = "🎓";
let currentFilter = "all";
// Notes state
let selectedNoteColor = null;
let editingNoteId = null;
let currentNotesCat = 'all';
// Devoirs state
let editingDevoirId = null;
let currentDevoirsTab = 'todo';

// ═══════════════════════════════════════════════════════
// DB INIT
// ═══════════════════════════════════════════════════════
async function initDB() {
  return new Promise((res, rej) => {
    const r = indexedDB.open(DB_NAME, DB_VER);
    r.onupgradeneeded = e => {
      const d = e.target.result;
      ['users','folders','subjects','files','events','notes','devoirs'].forEach(store => {
        if (!d.objectStoreNames.contains(store)) {
          const s = d.createObjectStore(store, { keyPath:'id', autoIncrement:true });
          if (store === 'folders')  s.createIndex('userId','userId',{unique:false});
          if (store === 'subjects') s.createIndex('folderId','folderId',{unique:false});
          if (store === 'files') {
            s.createIndex('subjectId','subjectId',{unique:false});
            s.createIndex('tabKey','tabKey',{unique:false});
          }
          if (store === 'events')  s.createIndex('userId','userId',{unique:false});
          if (store === 'notes')   s.createIndex('userId','userId',{unique:false});
          if (store === 'devoirs') s.createIndex('userId','userId',{unique:false});
        }
      });
    };
    r.onsuccess = e => { db = e.target.result; res(); };
    r.onerror = () => rej();
  });
}

function dbGet(store, id) {
  return new Promise((res, rej) => {
    try {
      const tx = db.transaction(store, 'readonly');
      const req = tx.objectStore(store).get(id);
      req.onsuccess = e => res(e.target.result);
      req.onerror   = e => rej(e.target.error);
    } catch(e) { rej(e); }
  });
}

function dbGetAll(store) {
  return new Promise((res, rej) => {
    try {
      const tx = db.transaction(store, 'readonly');
      const req = tx.objectStore(store).getAll();
      req.onsuccess = e => res(e.target.result);
      req.onerror   = e => rej(e.target.error);
    } catch(e) { rej(e); }
  });
}

function dbGetByIndex(store, idx, val) {
  // Use getAll + JS filter to avoid silent type-mismatch in IDB index queries
  // (e.g. storing userId as number 1 but querying with number 1 can still fail
  //  in some browsers if the key path was indexed as a different type)
  return new Promise((res, rej) => {
    try {
      const tx = db.transaction(store, 'readonly');
      const req = tx.objectStore(store).getAll();
      req.onsuccess = e => {
        const all = e.target.result || [];
        // Find the field name from the index name (they match in our schema)
        const filtered = all.filter(obj => String(obj[idx]) === String(val));
        res(filtered);
      };
      req.onerror = e => rej(e.target.error);
    } catch(e) { rej(e); }
  });
}

function dbAdd(store, obj) {
  return new Promise((res, rej) => {
    try {
      const tx = db.transaction(store, 'readwrite');
      const req = tx.objectStore(store).add(obj);
      let newId;
      req.onsuccess = e => { newId = e.target.result; };
      req.onerror   = e => rej(e.target.error);
      // Resolve ONLY when transaction is fully committed
      tx.oncomplete = () => res(newId);
      tx.onerror    = e => rej(e.target.error);
      tx.onabort    = e => rej(e.target.error);
    } catch(e) { rej(e); }
  });
}

function dbPut(store, obj) {
  return new Promise((res, rej) => {
    try {
      const tx = db.transaction(store, 'readwrite');
      const req = tx.objectStore(store).put(obj);
      req.onerror = e => rej(e.target.error);
      tx.oncomplete = () => res();
      tx.onerror    = e => rej(e.target.error);
      tx.onabort    = e => rej(e.target.error);
    } catch(e) { rej(e); }
  });
}

function dbDelete(store, id) {
  return new Promise((res, rej) => {
    try {
      const tx = db.transaction(store, 'readwrite');
      tx.objectStore(store).delete(id);
      tx.oncomplete = () => res();
      tx.onerror    = e => rej(e.target.error);
      tx.onabort    = e => rej(e.target.error);
    } catch(e) { rej(e); }
  });
}

// ═══════════════════════════════════════════════════════
// AUTH
// ═══════════════════════════════════════════════════════
function switchAuthTab(tab) {
  document.querySelectorAll('.auth-tab').forEach((t,i) => {
    t.classList.toggle('active', (i===0 && tab==='login') || (i===1 && tab==='register'));
  });
  document.getElementById('auth-login').style.display    = tab==='login'    ? 'flex' : 'none';
  document.getElementById('auth-register').style.display = tab==='register' ? 'flex' : 'none';
}

// Build avatar picker
(function buildAvatarPicker() {
  const grid = document.getElementById('avatar-picker');
  grid.innerHTML = '';
  AVATAR_EMOJIS.forEach(em => {
    const d = document.createElement('div');
    d.className = 'auth-emoji-opt' + (em === selectedAvatar ? ' selected' : '');
    d.textContent = em;
    d.onclick = () => {
      document.querySelectorAll('.auth-emoji-opt').forEach(x => x.classList.remove('selected'));
      d.classList.add('selected');
      selectedAvatar = em;
    };
    grid.appendChild(d);
  });
})();

async function handleLogin() {
  const username = document.getElementById('login-username').value.trim().toLowerCase();
  const password = document.getElementById('login-password').value;
  const errEl = document.getElementById('login-error');
  errEl.classList.remove('show');

  if (!username || !password) { errEl.textContent = "Remplis tous les champs."; errEl.classList.add('show'); return; }

  const users = await dbGetAll('users');
  const user = users.find(u => u.username === username);

  if (!user || user.password !== btoa(password)) {
    errEl.textContent = "Identifiant ou mot de passe incorrect.";
    errEl.classList.add('show');
    return;
  }

  loginSuccess(user);
}

async function handleRegister() {
  const name     = document.getElementById('reg-name').value.trim();
  const username = document.getElementById('reg-username').value.trim().toLowerCase().replace(/\s+/g,'.');
  const password = document.getElementById('reg-password').value;
  const errEl    = document.getElementById('reg-error');
  errEl.classList.remove('show');

  if (!name || !username || !password) { errEl.textContent = "Remplis tous les champs."; errEl.classList.add('show'); return; }
  if (password.length < 6) { errEl.textContent = "Mot de passe trop court (6 min)."; errEl.classList.add('show'); return; }

  const users = await dbGetAll('users');
  if (users.find(u => u.username === username)) {
    errEl.textContent = "Cet identifiant est déjà pris.";
    errEl.classList.add('show');
    return;
  }

  const id = await dbAdd('users', { name, username, password: btoa(password), avatar: selectedAvatar, theme: 'midnight', createdAt: new Date() });
  loginSuccess({ id, name, username, avatar: selectedAvatar, theme: 'midnight' });
}

async function loginSuccess(user) {
  currentUser = user;
  console.log('[AMU] Logged in as:', user.name, 'id:', user.id);
  document.getElementById('auth-screen').style.display = 'none';
  document.getElementById('app').classList.add('visible');
  document.getElementById('sidebar-username').textContent = user.name;
  document.getElementById('sidebar-avatar').textContent = user.avatar || '🎓';

  applyTheme(user.theme || 'midnight');
  buildThemeGrid();
  buildColorPicker();
  buildFolderEmojiGrid();
  buildEvColorPicker();
  buildNoteColorPicker();
  await loadFolders();
  updateGlobalStats();
  await renderAgenda();
  await renderDevoirs(); // update badge silently
  toast('Bienvenue ' + user.name + ' 👋', 'success');
}

function logout(e) {
  if (e) e.stopPropagation();
  currentUser = null;
  currentFolderId = null;
  document.getElementById('app').classList.remove('visible');
  document.getElementById('auth-screen').style.display = 'flex';
  document.getElementById('login-username').value = '';
  document.getElementById('login-password').value = '';
  document.getElementById('login-error').classList.remove('show');
}

// ═══════════════════════════════════════════════════════
// NAVIGATION
// ═══════════════════════════════════════════════════════
function navTo(page, btn) {
  document.querySelectorAll('.nav-pill').forEach(p => p.classList.remove('active'));
  if (btn) btn.classList.add('active');
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-' + page).classList.add('active');

  document.getElementById('stat-chips').style.display = 'none';
  document.getElementById('add-subject-btn').style.display = 'none';

  if (page === 'agenda') {
    document.getElementById('main-title').textContent = '📅 Agenda';
    renderAgenda();
  } else if (page === 'courses') {
    document.getElementById('main-title').textContent = currentFolderId ? document.getElementById('main-title').textContent : 'Mes Cours';
    document.getElementById('stat-chips').style.display = currentFolderId ? 'flex' : 'none';
    document.getElementById('add-subject-btn').style.display = currentFolderId ? 'flex' : 'none';
  } else if (page === 'notes') {
    document.getElementById('main-title').textContent = '📝 Notes';
    renderNotes();
  } else if (page === 'devoirs') {
    document.getElementById('main-title').textContent = '✅ Devoirs';
    renderDevoirs();
  }
}

// ═══════════════════════════════════════════════════════
// THEMES
// ═══════════════════════════════════════════════════════
function applyTheme(id) {
  document.body.setAttribute('data-theme', id);
  localStorage.setItem('amu-theme', id);
}

// Light / Dark mode
let isLightMode = localStorage.getItem('amu-lightmode') === 'true';

function toggleLightMode() {
  isLightMode = !isLightMode;
  applyLightMode();
  localStorage.setItem('amu-lightmode', isLightMode);
}

function applyLightMode() {
  document.body.setAttribute('data-lightmode', isLightMode ? 'true' : 'false');
  const btn = document.getElementById('light-toggle-btn');
  if (btn) btn.textContent = isLightMode ? '☀️' : '🌙';
  // Also update the auth screen background
  const authScreen = document.getElementById('auth-screen');
  if (authScreen) authScreen.style.background = isLightMode ? 'var(--bg)' : '';
}

function openThemePanel() {
  document.getElementById('theme-panel').classList.add('open');
}

function closeThemePanel() {
  document.getElementById('theme-panel').classList.remove('open');
}

function buildThemeGrid() {
  const grid = document.getElementById('theme-grid');
  const current = document.body.getAttribute('data-theme');
  grid.innerHTML = '';
  THEMES.forEach(t => {
    const card = document.createElement('div');
    card.className = 'theme-card' + (t.id === current ? ' active' : '');
    card.style.background = `linear-gradient(135deg, ${t.bg} 40%, ${t.c3})`;
    card.innerHTML = `
      <div class="theme-preview-dots">
        <div class="tpd" style="background:${t.c1}"></div>
        <div class="tpd" style="background:${t.c2}"></div>
        <div class="tpd" style="background:${t.bg};border:1px solid rgba(255,255,255,0.2)"></div>
      </div>
      <div class="theme-card-name">${t.name}</div>`;
    card.onclick = () => {
      applyTheme(t.id);
      buildThemeGrid();
      // Save to user
      if (currentUser) {
        dbGet('users', currentUser.id).then(u => { u.theme = t.id; dbPut('users',u); });
      }
      toast('Thème "' + t.name + '" appliqué', 'success');
    };
    grid.appendChild(card);
  });
}

// ═══════════════════════════════════════════════════════
// FOLDERS
// ═══════════════════════════════════════════════════════
function buildFolderEmojiGrid() {
  const grid = document.getElementById('fm-emoji-grid');
  grid.innerHTML = '';
  FOLDER_EMOJIS.forEach(em => {
    const d = document.createElement('div');
    d.className = 'emoji-opt' + (em === selectedFolderEmoji ? ' sel' : '');
    d.textContent = em;
    d.onclick = () => {
      grid.querySelectorAll('.emoji-opt').forEach(x => x.classList.remove('sel'));
      d.classList.add('sel');
      selectedFolderEmoji = em;
    };
    grid.appendChild(d);
  });
}

async function loadFolders() {
  if (!currentUser) return;
  const folders = await dbGetByIndex('folders','userId', currentUser.id);
  const list = document.getElementById('folder-list');
  list.innerHTML = '';

  if (!folders.length) {
    list.innerHTML = '<div style="padding:16px;color:var(--text3);font-size:13px;text-align:center;">Aucun dossier</div>';
    return;
  }

  for (const f of folders) {
    const subs = await dbGetByIndex('subjects','folderId', f.id);
    const div = document.createElement('div');
    div.className = 'folder-item' + (currentFolderId === f.id ? ' active' : '');
    div.innerHTML = `
      <div class="folder-emoji-badge">${f.emoji||'📁'}</div>
      <div class="folder-label"><div class="folder-name">${f.name}</div></div>
      <span class="folder-pill">${subs.length}</span>
      <button class="folder-del" onclick="deleteFolder(${f.id},event)" title="Supprimer">×</button>`;
    div.onclick = e => { if (e.target.tagName!=='BUTTON') selectFolder(f); };
    list.appendChild(div);
  }
}

async function createFolder() {
  const name = document.getElementById('fm-name').value.trim();
  if (!name) { toast('Le nom est requis','error'); return; }
  await dbAdd('folders',{ name, emoji: selectedFolderEmoji, desc: document.getElementById('fm-desc').value.trim(), userId: currentUser.id, createdAt: new Date() });
  closeModal('folder-modal');
  loadFolders();
  toast('Dossier créé','success');
}

async function deleteFolder(id, e) {
  e.stopPropagation();
  if (!confirm('Supprimer ce dossier et tout son contenu ?')) return;
  const subs = await dbGetByIndex('subjects','folderId',id);
  for (const s of subs) {
    const files = await dbGetByIndex('files','subjectId',s.id);
    for (const f of files) await dbDelete('files',f.id);
    await dbDelete('subjects',s.id);
  }
  await dbDelete('folders',id);
  if (currentFolderId === id) {
    currentFolderId = null;
    document.getElementById('courses-empty').style.display='flex';
    document.getElementById('subjects-grid').style.display='none';
    document.getElementById('stat-chips').style.display='none';
    document.getElementById('add-subject-btn').style.display='none';
  }
  loadFolders();
  updateGlobalStats();
  toast('Dossier supprimé','info');
}

async function selectFolder(folder) {
  currentFolderId = folder.id;
  document.getElementById('main-title').textContent = folder.emoji + ' ' + folder.name;
  document.getElementById('add-subject-btn').style.display = 'flex';
  document.getElementById('stat-chips').style.display = 'flex';
  document.getElementById('courses-empty').style.display = 'none';
  document.getElementById('subjects-grid').style.display = 'grid';
  loadFolders();
  loadSubjects();
  updateStats();

  // Go to courses page
  const courseBtn = document.querySelector('[data-page="courses"]');
  if (courseBtn) navTo('courses', courseBtn);
}

// ═══════════════════════════════════════════════════════
// SUBJECTS
// ═══════════════════════════════════════════════════════
function buildColorPicker() {
  const row = document.getElementById('sm-colors');
  row.innerHTML = '';
  COLORS.forEach(c => {
    const d = document.createElement('div');
    d.className = 'color-swatch' + (c === selectedColor ? ' sel' : '');
    d.style.background = c;
    d.onclick = () => { row.querySelectorAll('.color-swatch').forEach(x=>x.classList.remove('sel')); d.classList.add('sel'); selectedColor=c; };
    row.appendChild(d);
  });
}

async function createSubject() {
  if (!currentFolderId) return;
  const name = document.getElementById('sm-name').value.trim();
  if (!name) { toast('Nom requis','error'); return; }
  const tags = document.getElementById('sm-tags').value.split(',').map(t=>t.trim()).filter(Boolean);
  await dbAdd('subjects',{
    name, folderId: currentFolderId, color: selectedColor,
    desc: document.getElementById('sm-desc').value.trim(),
    priority: document.getElementById('sm-priority').value,
    deadline: document.getElementById('sm-deadline').value || null,
    tags, progress: 0, notes: '', createdAt: new Date()
  });
  closeModal('subject-modal');
  loadSubjects();
  updateStats();
  updateGlobalStats();
  toast('Matière créée','success');
}

async function deleteSubject(id, e) {
  e.stopPropagation();
  if (!confirm('Supprimer cette matière ?')) return;
  const files = await dbGetByIndex('files','subjectId',id);
  for (const f of files) await dbDelete('files',f.id);
  await dbDelete('subjects',id);
  loadSubjects();
  updateStats();
  updateGlobalStats();
  toast('Matière supprimée','info');
}

async function updateProgress(id, val) {
  const s = await dbGet('subjects',id);
  s.progress = parseInt(val);
  await dbPut('subjects',s);
  const fill = document.getElementById('prog-fill-'+id);
  const label = document.getElementById('prog-label-'+id);
  if (fill) fill.style.width = val + '%';
  if (label) label.textContent = val + '%';
  updateStats();
  loadFolders();
}

async function loadSubjects() {
  if (!currentFolderId) return;
  let subjects = await dbGetByIndex('subjects','folderId',currentFolderId);
  if (currentFilter !== 'all') subjects = applyFilter(subjects);
  subjects.sort((a,b) => a.name.localeCompare(b.name));
  const grid = document.getElementById('subjects-grid');
  grid.innerHTML = '';
  if (!subjects.length) {
    grid.innerHTML = '<div class="empty-box" style="grid-column:1/-1"><div class="empty-box-icon">📚</div><h3>Aucune matière</h3><p>Clique sur "+ Matière" pour commencer</p></div>';
    return;
  }
  for (const s of subjects) {
    const card = await buildSubjectCard(s);
    grid.appendChild(card);
  }
}

function applyFilter(subjects) {
  if (['high','medium','low'].includes(currentFilter)) return subjects.filter(s=>s.priority===currentFilter);
  if (currentFilter === 'done') return subjects.filter(s=>(s.progress||0)===100);
  if (currentFilter === 'wip')  return subjects.filter(s=>(s.progress||0)<100);
  return subjects;
}

async function buildSubjectCard(subject) {
  const card = document.createElement('div');
  card.className = 'subject-card';

  // Get file counts per tab
  const allFiles = await dbGetByIndex('files','subjectId',subject.id);
  const countByTab = {};
  SUBJECT_TABS.forEach(t => { countByTab[t.key] = allFiles.filter(f=>f.tabKey===t.key).length; });

  const deadlineHtml = subject.deadline ? getDeadlineBadge(subject.deadline) : '';
  const prioColor = { high:'#f87171', medium:'#fbbf24', low:'#4ade80' }[subject.priority] || '#fff';
  const tagsHtml = (subject.tags||[]).map(t=>`<span class="card-tag" style="background:${subject.color}22;color:${subject.color}">${t}</span>`).join('');
  const hasNotes = subject.notes && subject.notes.trim().length > 0;

  card.innerHTML = `
    <div class="card-color-bar" style="background:linear-gradient(90deg,${subject.color},${subject.color}88)"></div>
    <div class="card-body">
      <div class="card-title-row">
        <div class="subject-title-section">
          <div class="card-title">
            <span class="priority-dot" style="background:${prioColor}" title="Priorité ${subject.priority}"></span>
            ${subject.name}
          </div>
          ${subject.desc ? `<div style="font-size:13px;color:var(--text2);margin-top:4px;line-height:1.4">${subject.desc}</div>` : ''}
        </div>
        <div class="card-btns">
          <button class="card-btn" onclick="openNotesModal(${subject.id})" title="Notes">📝</button>
          <button class="card-btn danger" onclick="deleteSubject(${subject.id},event)" title="Supprimer">×</button>
        </div>
      </div>
      <div class="card-meta">
        <span>📄 <span id="file-count-${subject.id}">${allFiles.length}</span> docs</span>
        <span>📅 ${new Date(subject.createdAt).toLocaleDateString('fr-FR')}</span>
        ${deadlineHtml}
      </div>
      ${tagsHtml ? `<div class="card-meta" style="gap:6px;margin-bottom:8px">${tagsHtml}</div>` : ''}
    </div>
    <div class="card-progress">
      <div class="prog-row">
        <span>Progression</span>
        <span id="prog-label-${subject.id}">${subject.progress||0}%</span>
      </div>
      <div class="prog-bar">
        <div class="prog-fill" id="prog-fill-${subject.id}" style="width:${subject.progress||0}%"></div>
      </div>
      <input type="range" class="prog-slider" min="0" max="100" value="${subject.progress||0}"
        oninput="updateProgress(${subject.id},this.value)">
    </div>
    ${hasNotes
      ? `<button class="card-notes-btn has-notes" onclick="openNotesModal(${subject.id})">💡 Notes — cliquer pour voir</button>`
      : `<button class="card-notes-btn" onclick="openNotesModal(${subject.id})">✚ Ajouter des notes</button>`}
    <div class="subject-tabs-bar" id="stabs-${subject.id}"></div>
    <div id="spanel-${subject.id}"></div>`;

  // Build tabs
  const tabsBar = card.querySelector(`#stabs-${subject.id}`);
  const panelContainer = card.querySelector(`#spanel-${subject.id}`);

  SUBJECT_TABS.forEach((tab, idx) => {
    const btn = document.createElement('button');
    btn.className = 'subject-tab-btn' + (idx===0?' active':'');
    btn.innerHTML = `${tab.icon} ${tab.label} <span class="subject-tab-count">${countByTab[tab.key]||0}</span>`;
    btn.onclick = () => {
      tabsBar.querySelectorAll('.subject-tab-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      panelContainer.querySelectorAll('.tab-files-panel').forEach(p=>p.classList.remove('active'));
      document.getElementById(`tab-panel-${subject.id}-${tab.key}`).classList.add('active');
    };
    tabsBar.appendChild(btn);

    // Panel for each tab
    const panel = document.createElement('div');
    panel.className = 'tab-files-panel' + (idx===0?' active':'');
    panel.id = `tab-panel-${subject.id}-${tab.key}`;
    panel.innerHTML = `<button class="tab-upload-btn" onclick="triggerUpload(${subject.id},'${tab.key}')">📎 Ajouter un PDF dans ${tab.label}</button>
      <div id="files-${subject.id}-${tab.key}"></div>`;
    panelContainer.appendChild(panel);

    renderFilesInTab(subject.id, tab.key);
  });

  return card;
}

// ═══════════════════════════════════════════════════════
// NOTES
// ═══════════════════════════════════════════════════════
async function openNotesModal(subjectId) {
  editingNotesId = subjectId;
  const s = await dbGet('subjects',subjectId);
  document.getElementById('notes-modal-name').textContent = s.name;
  document.getElementById('notes-textarea').value = s.notes || '';
  openModal('notes-modal');
}

async function saveNotes() {
  if (!editingNotesId) return;
  const s = await dbGet('subjects',editingNotesId);
  s.notes = document.getElementById('notes-textarea').value.trim();
  await dbPut('subjects',s);
  closeModal('notes-modal');
  loadSubjects();
  toast('Notes enregistrées','success');
}

// ═══════════════════════════════════════════════════════
// FILES
// ═══════════════════════════════════════════════════════
function triggerUpload(subjectId, tabKey) {
  uploadTargetId = subjectId;
  uploadTabKey = tabKey;
  document.getElementById('pdf-upload').click();
}

document.getElementById('pdf-upload').addEventListener('change', async e => {
  const files = Array.from(e.target.files);
  if (!files.length || !uploadTargetId) return;
  for (const file of files) {
    const buf = await file.arrayBuffer();
    const blob = new Blob([buf],{type:'application/pdf'});
    await dbAdd('files',{ name:file.name, subjectId:uploadTargetId, tabKey:uploadTabKey||'Ressources', data:blob, size:file.size, uploadedAt:new Date() });
  }
  e.target.value='';
  renderFilesInTab(uploadTargetId, uploadTabKey);
  updateStats();
  updateGlobalStats();
  toast(`${files.length} fichier(s) ajouté(s)`,'success');
  // Update counts
  const allFiles = await dbGetByIndex('files','subjectId',uploadTargetId);
  const countEl = document.getElementById(`file-count-${uploadTargetId}`);
  if (countEl) countEl.textContent = allFiles.length;
  // Update tab count badge
  const tabCount = allFiles.filter(f=>f.tabKey===uploadTabKey).length;
  const tabsBar = document.getElementById(`stabs-${uploadTargetId}`);
  if (tabsBar) {
    const tabBtns = tabsBar.querySelectorAll('.subject-tab-btn');
    tabBtns.forEach(btn => {
      SUBJECT_TABS.forEach(t => {
        if (btn.textContent.includes(t.label)) {
          const cnt = allFiles.filter(f=>f.tabKey===t.key).length;
          const badge = btn.querySelector('.subject-tab-count');
          if (badge) badge.textContent = cnt;
        }
      });
    });
  }
});

async function renderFilesInTab(subjectId, tabKey) {
  const allFiles = await dbGetByIndex('files','subjectId',subjectId);
  const files = allFiles.filter(f=>f.tabKey===tabKey);
  const container = document.getElementById(`files-${subjectId}-${tabKey}`);
  if (!container) return;
  container.innerHTML = '';
  if (!files.length) {
    container.innerHTML = '<div style="text-align:center;padding:16px;color:var(--text3);font-size:13px">Aucun document</div>';
    return;
  }
  files.forEach(file => {
    const row = document.createElement('div');
    row.className = 'tab-file-row';
    const name = file.name.length > 32 ? file.name.slice(0,29)+'...' : file.name;
    const size = (file.size/1024).toFixed(1)+' KB';
    const date = new Date(file.uploadedAt).toLocaleDateString('fr-FR');
    row.innerHTML = `
      <div class="tab-file-icon">📄</div>
      <div class="tab-file-info">
        <div class="tab-file-name">${name}</div>
        <div class="tab-file-meta">${size} • ${date}</div>
      </div>
      <button class="tab-file-del" onclick="deleteFile(${file.id},${subjectId},'${tabKey}',event)" title="Supprimer">×</button>`;
    row.onclick = e => { if (e.target.tagName!=='BUTTON') openFile(file.id); };
    container.appendChild(row);
  });
}

async function openFile(fileId) {
  const f = await dbGet('files',fileId);
  if (f && f.data) {
    const url = URL.createObjectURL(f.data);
    window.open(url,'_blank');
  }
}

async function deleteFile(fileId, subjectId, tabKey, e) {
  e.stopPropagation();
  if (!confirm('Supprimer ce fichier ?')) return;
  await dbDelete('files',fileId);
  renderFilesInTab(subjectId,tabKey);
  updateStats();
  updateGlobalStats();
  toast('Fichier supprimé','info');
  const allFiles = await dbGetByIndex('files','subjectId',subjectId);
  const cnt = document.getElementById('file-count-'+subjectId);
  if (cnt) cnt.textContent = allFiles.length;
}

// ═══════════════════════════════════════════════════════
// STATS
// ═══════════════════════════════════════════════════════
async function updateStats() {
  if (!currentFolderId) return;
  const subjects = await dbGetByIndex('subjects','folderId',currentFolderId);
  document.getElementById('chip-subjects').textContent = subjects.length;
  let totalFiles = 0, totalSize = 0, totalProg = 0;
  for (const s of subjects) {
    const files = await dbGetByIndex('files','subjectId',s.id);
    totalFiles += files.length;
    files.forEach(f=>totalSize+=f.size||0);
    totalProg += s.progress||0;
  }
  document.getElementById('chip-files').textContent = totalFiles;
  document.getElementById('chip-size').textContent = (totalSize/1024/1024).toFixed(2)+' MB';
  document.getElementById('chip-progress').textContent = subjects.length ? Math.round(totalProg/subjects.length)+'%' : '0%';
}

async function updateGlobalStats() { /* can be extended */ }

// ═══════════════════════════════════════════════════════
// AGENDA
// ═══════════════════════════════════════════════════════
// AGENDA — Emploi du temps (grille temps réel)
// ═══════════════════════════════════════════════════════

const TT_START = 7;   // première heure affichée
const TT_END   = 21;  // dernière heure affichée
const TT_CELL  = 60;  // px par heure

// Couleurs disponibles pour les événements
const EV_COLORS = [
  null,          // null = auto selon le type
  '#5b8af5','#4ac864','#f87171','#f4c05a',
  '#c880ff','#fa6450','#20c9ac','#f064a0',
  '#38bdf8','#ff9a6c','#ffd060','#a0c080',
];
let selectedEvColor = null; // null = auto

function buildEvColorPicker() {
  const row = document.getElementById('ev-color-row');
  if (!row) return;
  row.innerHTML = '';
  EV_COLORS.forEach(c => {
    const s = document.createElement('div');
    s.className = 'ev-color-swatch' + (c === selectedEvColor ? ' sel' : '');
    s.style.background = c || 'var(--bg3)';
    s.style.border = c ? '3px solid transparent' : '2px dashed var(--border)';
    if (!c) s.textContent = '↺';
    s.style.display = 'flex';
    s.style.alignItems = 'center';
    s.style.justifyContent = 'center';
    s.style.fontSize = '14px';
    s.style.color = 'var(--text2)';
    s.onclick = () => {
      selectedEvColor = c;
      buildEvColorPicker();
    };
    row.appendChild(s);
  });
}

// Get event color (custom or type default)
function evBgColor(ev) {
  if (ev.color) return ev.color;
  const map = { CM:'#5b8af5', TD:'#4ac864', Partiel:'#f87171', Other:'#f4c05a' };
  return map[ev.type] || '#5b8af5';
}

function evTextColor(bg) {
  // Simple luminance check
  const r = parseInt(bg.slice(1,3),16), g = parseInt(bg.slice(3,5),16), b = parseInt(bg.slice(5,7),16);
  return (0.299*r + 0.587*g + 0.114*b) > 140 ? '#1a1a1a' : '#ffffff';
}

// Convert "HH:MM" to minutes from TT_START
function timeToOffset(timeStr) {
  if (!timeStr) return 0;
  const [h, m] = timeStr.split(':').map(Number);
  return ((h - TT_START) * 60 + (m || 0));
}

async function renderAgenda() {
  if (!currentUser) return;

  // Fetch & filter events
  let allEv = [];
  try { allEv = await dbGetAll('events'); } catch(e) { console.error(e); }
  const uid = String(currentUser.id);
  const events = allEv.filter(ev => String(ev.userId) === uid);
  console.log('[AMU] agenda: loaded', events.length, 'events for user', uid);

  // ── Build header ──────────────────────────────────────
  const header = document.getElementById('tt-header');
  header.innerHTML = '';

  // Today's weekday (Mon=0)
  const todayIdx = (() => { const d = new Date().getDay(); return d === 0 ? 6 : d - 1; })();

  // Gutter corner
  const corner = document.createElement('div');
  corner.className = 'tt-header-gutter';
  header.appendChild(corner);

  DAYS_FR.forEach((name, i) => {
    const col = document.createElement('div');
    col.className = 'tt-header-day' + (i === todayIdx ? ' today-col' : '');
    col.innerHTML = `<div class="tt-day-name">${name}</div><div class="tt-day-add">＋</div>`;
    col.onclick = () => {
      document.getElementById('ev-day').value = i;
      openAddEventModal(i);
    };
    header.appendChild(col);
  });

  // ── Build body ────────────────────────────────────────
  const body = document.getElementById('tt-body');
  body.innerHTML = '';

  const totalHours = TT_END - TT_START;
  const totalPx    = totalHours * TT_CELL;

  // Time gutter column
  const timeCol = document.createElement('div');
  timeCol.className = 'tt-time-col';
  for (let h = TT_START; h <= TT_END; h++) {
    const lbl = document.createElement('div');
    lbl.className = 'tt-hour-label';
    lbl.textContent = h < 10 ? `0${h}:00` : `${h}:00`;
    timeCol.appendChild(lbl);
  }
  body.appendChild(timeCol);

  // One column per day
  DAYS_FR.forEach((_, dayIdx) => {
    const col = document.createElement('div');
    col.className = 'tt-day-col' + (dayIdx === todayIdx ? ' today-col' : '');
    col.style.height = totalPx + 'px';

    // Hour lines + click handlers
    for (let h = TT_START; h < TT_END; h++) {
      const line = document.createElement('div');
      line.className = 'tt-hour-line';
      line.style.top = ((h - TT_START) * TT_CELL) + 'px';

      // Half-hour dashed line
      const half = document.createElement('div');
      half.className = 'tt-half-line';
      line.appendChild(half);

      const capturedH = h;
      line.onclick = (e) => {
        if (e.target.closest('.tt-event')) return;
        const rect = col.getBoundingClientRect();
        const clickY = e.clientY - rect.top;
        const minutesFromTop = Math.round(clickY / (TT_CELL / 60) / 30) * 30;
        const absMinutes = TT_START * 60 + minutesFromTop;
        const hh = Math.floor(absMinutes / 60);
        const mm = absMinutes % 60;
        const timeStr = `${String(Math.min(hh, TT_END - 1)).padStart(2,'0')}:${String(mm).padStart(2,'0')}`;
        openAddEventModal(dayIdx, timeStr);
      };
      col.appendChild(line);
    }

    // Place events
    const dayEvents = events.filter(ev => parseInt(ev.day, 10) === dayIdx);
    dayEvents.forEach(ev => {
      const offsetMin = timeToOffset(ev.time);
      const durationMin = (parseFloat(ev.duration) || 1) * 60;

      // Clamp to visible range
      if (offsetMin < 0 || offsetMin >= totalHours * 60) return;

      const top  = (offsetMin / 60) * TT_CELL;
      const height = Math.max((durationMin / 60) * TT_CELL - 4, 22);

      const bg   = evBgColor(ev);
      const fg   = evTextColor(bg);

      const evEl = document.createElement('div');
      evEl.className = 'tt-event';
      evEl.style.cssText = `top:${top + 2}px; height:${height}px; background:${bg}; color:${fg}; border-left:3px solid ${fg === '#ffffff' ? 'rgba(255,255,255,0.4)' : 'rgba(0,0,0,0.2)'};`;

      const meta = [ev.time];
      if (ev.duration) meta.push(`${ev.duration}h`);
      if (ev.room) meta.push(ev.room);
      if (ev.teacher) meta.push(ev.teacher);

      evEl.innerHTML = `
        <div class="tt-event-title">${ev.title}</div>
        <div class="tt-event-meta">${meta.join(' · ')}</div>
        <div class="tt-event-del" onclick="deleteEvent(${ev.id},event)">×</div>`;

      col.appendChild(evEl);
    });

    body.appendChild(col);
  });

  // Current time line (only if today is in view)
  if (todayIdx >= 0 && todayIdx < 7) {
    const now = new Date();
    const nowMin = now.getHours() * 60 + now.getMinutes();
    const startMin = TT_START * 60;
    const endMin   = TT_END   * 60;
    if (nowMin >= startMin && nowMin <= endMin) {
      const pct = (nowMin - startMin) / ((endMin - startMin));
      const topPx = pct * totalPx;
      // Find the today column (index todayIdx + 1 because first child is timeCol)
      const cols = body.children;
      if (cols[todayIdx + 1]) {
        const line = document.createElement('div');
        line.className = 'tt-now-line';
        line.style.top = topPx + 'px';
        line.innerHTML = '<div class="tt-now-dot"></div>';
        cols[todayIdx + 1].appendChild(line);
      }
    }
  }

  // Scroll to 8h by default
  body.scrollTop = (8 - TT_START) * TT_CELL;

  // ── Build list grid ───────────────────────────────────
  renderEvListGrid(events);
}

function renderEvListGrid(events) {
  const grid = document.getElementById('ev-list-grid');
  if (!grid) return;
  grid.innerHTML = '';

  DAYS_FR.forEach((dayName, dayIdx) => {
    const col = document.createElement('div');
    col.className = 'ev-day-col';
    col.innerHTML = `<div class="ev-day-header">${dayName.slice(0,3)}</div>`;

    const dayEvs = events
      .filter(ev => parseInt(ev.day,10) === dayIdx)
      .sort((a,b) => (a.time||'').localeCompare(b.time||''));

    if (!dayEvs.length) {
      col.innerHTML += `<div class="ev-pill-empty">—</div>`;
    } else {
      dayEvs.forEach(ev => {
        const bg = evBgColor(ev);
        const fg = evTextColor(bg);
        const pill = document.createElement('div');
        pill.className = 'ev-pill';
        pill.style.cssText = `background:${bg};color:${fg}`;
        pill.innerHTML = `
          <span class="ev-pill-time">${ev.time || ''}${ev.duration ? ` · ${ev.duration}h` : ''}</span>
          <span class="ev-pill-title">${ev.title}</span>`;
        pill.title = `${ev.type}${ev.room ? ' · ' + ev.room : ''}${ev.teacher ? ' · ' + ev.teacher : ''}`;
        pill.onclick = () => {
          if (confirm(`Supprimer "${ev.title}" ?`)) {
            dbDelete('events', ev.id).then(() => renderAgenda());
          }
        };
        col.appendChild(pill);
      });
    }
    grid.appendChild(col);
  });
}

function openAddEventModal(dayIdx = 0, timeStr = '08:00') {
  document.getElementById('ev-title').value = '';
  document.getElementById('ev-type').value = 'CM';
  document.getElementById('ev-day').value = String(dayIdx);
  document.getElementById('ev-time').value = timeStr;
  document.getElementById('ev-duration').value = '2';
  document.getElementById('ev-room').value = '';
  document.getElementById('ev-teacher').value = '';
  document.getElementById('ev-modal-title').textContent = '➕ Nouveau cours';
  document.getElementById('ev-submit-btn').textContent = 'Ajouter';
  selectedEvColor = null;
  buildEvColorPicker();
  openModal('event-modal');
}

async function createEvent() {
  const title = document.getElementById('ev-title').value.trim();
  const time  = document.getElementById('ev-time').value;

  if (!title) { toast('Titre requis', 'error'); return; }
  if (!time)  { toast('Heure requise', 'error'); return; }

  const evObj = {
    title,
    type:     document.getElementById('ev-type').value,
    day:      parseInt(document.getElementById('ev-day').value, 10),
    time,
    duration: parseFloat(document.getElementById('ev-duration').value),
    room:     document.getElementById('ev-room').value.trim(),
    teacher:  document.getElementById('ev-teacher').value.trim(),
    color:    selectedEvColor || null,
    userId:   currentUser.id,
    createdAt: new Date()
  };

  try {
    const newId = await dbAdd('events', evObj);
    console.log('[AMU] event saved id:', newId);
    closeModal('event-modal');
    await renderAgenda();
    toast(`"${title}" ajouté ✓`, 'success');
  } catch(err) {
    console.error('[AMU] createEvent:', err);
    toast('Erreur : ' + (err?.message || err), 'error');
  }
}

async function deleteEvent(id, e) {
  if (e) e.stopPropagation();
  if (!confirm('Supprimer ce cours ?')) return;
  await dbDelete('events', id);
  await renderAgenda();
  toast('Cours supprimé', 'info');
}

// ═══════════════════════════════════════════════════════
// NOTES
// ═══════════════════════════════════════════════════════
const NOTE_COLORS = ['#5b8af5','#4ac864','#f87171','#f4c05a','#c880ff','#fa6450','#20c9ac','#f064a0','#ffd060','#38bdf8'];

function buildNoteColorPicker() {
  const row = document.getElementById('note-color-row');
  if (!row) return;
  row.innerHTML = '';
  [null, ...NOTE_COLORS].forEach(c => {
    const s = document.createElement('div');
    s.className = 'ev-color-swatch' + (c === selectedNoteColor ? ' sel' : '');
    s.style.cssText = `background:${c||'var(--bg3)'};border:${c?'3px solid transparent':'2px dashed var(--border)'};display:flex;align-items:center;justify-content:center;font-size:13px;color:var(--text2)`;
    if (!c) s.textContent = '↺';
    s.onclick = () => { selectedNoteColor = c; buildNoteColorPicker(); };
    row.appendChild(s);
  });
}

function openNoteModal(noteId = null) {
  editingNoteId = noteId;
  selectedNoteColor = null;
  if (noteId) {
    dbGet('notes', noteId).then(n => {
      if (!n) return;
      document.getElementById('note-title').value   = n.title || '';
      document.getElementById('note-cat').value     = n.cat   || '';
      document.getElementById('note-content').value = n.content || '';
      selectedNoteColor = n.color || null;
      document.getElementById('note-modal-title').textContent = '✏️ Modifier la note';
      document.getElementById('note-submit-btn').textContent  = 'Enregistrer';
      buildNoteColorPicker();
      openModal('note-modal');
    });
  } else {
    document.getElementById('note-title').value   = '';
    document.getElementById('note-cat').value     = '';
    document.getElementById('note-content').value = '';
    document.getElementById('note-modal-title').textContent = '📝 Nouvelle note';
    document.getElementById('note-submit-btn').textContent  = 'Enregistrer';
    buildNoteColorPicker();
    openModal('note-modal');
  }
}

async function saveNote() {
  const title   = document.getElementById('note-title').value.trim();
  const content = document.getElementById('note-content').value.trim();
  if (!title)   { toast('Titre requis', 'error'); return; }
  if (!content) { toast('Contenu requis', 'error'); return; }

  const obj = {
    title,
    cat:     document.getElementById('note-cat').value.trim(),
    content,
    color:   selectedNoteColor || null,
    userId:  currentUser.id,
    updatedAt: new Date()
  };

  try {
    if (editingNoteId) {
      const existing = await dbGet('notes', editingNoteId);
      await dbPut('notes', { ...existing, ...obj, id: editingNoteId });
      toast('Note mise à jour ✓', 'success');
    } else {
      obj.createdAt = new Date();
      await dbAdd('notes', obj);
      toast('Note ajoutée ✓', 'success');
    }
    closeModal('note-modal');
    renderNotes();
  } catch(err) {
    toast('Erreur : ' + (err?.message||err), 'error');
  }
}

async function deleteNote(id, e) {
  e.stopPropagation();
  if (!confirm('Supprimer cette note ?')) return;
  await dbDelete('notes', id);
  renderNotes();
  toast('Note supprimée', 'info');
}

async function renderNotes() {
  const grid = document.getElementById('notes-grid');
  const catsEl = document.getElementById('notes-cats');
  if (!grid || !currentUser) return;

  const all = await dbGetAll('notes');
  const uid = String(currentUser.id);
  let notes = all.filter(n => String(n.userId) === uid)
                  .sort((a,b) => new Date(b.updatedAt||b.createdAt) - new Date(a.updatedAt||a.createdAt));

  // Build category chips
  const cats = [...new Set(notes.map(n => n.cat).filter(Boolean))];
  catsEl.innerHTML = `<div class="notes-cat-chip${currentNotesCat==='all'?' active':''}" onclick="setNotesCat('all',this)">Toutes</div>` +
    cats.map(c => `<div class="notes-cat-chip${currentNotesCat===c?' active':''}" onclick="setNotesCat('${c}',this)">${c}</div>`).join('');

  // Filter by cat
  if (currentNotesCat !== 'all') notes = notes.filter(n => n.cat === currentNotesCat);

  // Filter by search
  const q = (document.getElementById('notes-search')?.value || '').toLowerCase();
  if (q) notes = notes.filter(n => n.title.toLowerCase().includes(q) || n.content.toLowerCase().includes(q));

  if (!notes.length) {
    grid.innerHTML = `<div class="notes-empty">📭 Aucune note${q?' pour "'+q+'"':''}<br><span style="font-size:12px;opacity:0.6">Clique sur "Nouvelle note" pour commencer</span></div>`;
    return;
  }

  grid.innerHTML = '';
  notes.forEach(n => {
    const color = n.color || 'var(--accent)';
    const card = document.createElement('div');
    card.className = 'note-card';
    card.style.setProperty('--note-color', color);
    const d = new Date(n.updatedAt || n.createdAt);
    const dateStr = `${d.getDate()} ${MONTHS_FR[d.getMonth()]} ${d.getFullYear()}`;
    card.innerHTML = `
      <div class="note-card-header">
        <div class="note-card-title">${n.title}</div>
        <button class="note-card-del" onclick="deleteNote(${n.id},event)" title="Supprimer">✕</button>
      </div>
      ${n.cat ? `<span class="note-card-cat">${n.cat}</span>` : ''}
      <div class="note-card-body">${escHtml(n.content)}</div>
      <div class="note-card-date">Modifié le ${dateStr}</div>`;
    card.onclick = (e) => { if (!e.target.closest('.note-card-del')) openNoteModal(n.id); };
    grid.appendChild(card);
  });
}

function setNotesCat(cat, el) {
  currentNotesCat = cat;
  renderNotes();
}

function escHtml(str) {
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
}

// ═══════════════════════════════════════════════════════
// DEVOIRS
// ═══════════════════════════════════════════════════════
const DV_PRIORITY_COLOR = { high:'#f87171', medium:'#f4c05a', low:'#4ac864' };

function openDevoirModal(devoirId = null) {
  editingDevoirId = devoirId;
  if (devoirId) {
    dbGet('devoirs', devoirId).then(dv => {
      if (!dv) return;
      document.getElementById('dv-title').value    = dv.title || '';
      document.getElementById('dv-subject').value  = dv.subject || '';
      document.getElementById('dv-type').value     = dv.type || 'DM';
      document.getElementById('dv-deadline').value = dv.deadline || '';
      document.getElementById('dv-priority').value = dv.priority || 'medium';
      document.getElementById('dv-desc').value     = dv.desc || '';
      document.getElementById('devoir-modal-title').textContent = '✏️ Modifier le devoir';
      document.getElementById('dv-submit-btn').textContent = 'Enregistrer';
      openModal('devoir-modal');
    });
  } else {
    document.getElementById('dv-title').value    = '';
    document.getElementById('dv-subject').value  = '';
    document.getElementById('dv-type').value     = 'DM';
    document.getElementById('dv-deadline').value = '';
    document.getElementById('dv-priority').value = 'medium';
    document.getElementById('dv-desc').value     = '';
    document.getElementById('devoir-modal-title').textContent = '📋 Nouveau devoir';
    document.getElementById('dv-submit-btn').textContent = 'Ajouter';
    openModal('devoir-modal');
  }
}

async function saveDevoir() {
  const title    = document.getElementById('dv-title').value.trim();
  const deadline = document.getElementById('dv-deadline').value;
  if (!title)    { toast('Intitulé requis', 'error'); return; }
  if (!deadline) { toast('Date limite requise', 'error'); return; }

  const obj = {
    title,
    subject:  document.getElementById('dv-subject').value.trim(),
    type:     document.getElementById('dv-type').value,
    deadline,
    priority: document.getElementById('dv-priority').value,
    desc:     document.getElementById('dv-desc').value.trim(),
    done:     false,
    userId:   currentUser.id,
    updatedAt: new Date()
  };

  try {
    if (editingDevoirId) {
      const existing = await dbGet('devoirs', editingDevoirId);
      await dbPut('devoirs', { ...existing, ...obj, id: editingDevoirId, done: existing.done });
      toast('Devoir mis à jour ✓', 'success');
    } else {
      obj.createdAt = new Date();
      await dbAdd('devoirs', obj);
      toast('Devoir ajouté ✓', 'success');
    }
    closeModal('devoir-modal');
    renderDevoirs();
  } catch(err) {
    toast('Erreur : ' + (err?.message||err), 'error');
  }
}

async function toggleDevoir(id) {
  const dv = await dbGet('devoirs', id);
  if (!dv) return;
  await dbPut('devoirs', { ...dv, done: !dv.done, updatedAt: new Date() });
  renderDevoirs();
}

async function deleteDevoir(id, e) {
  e.stopPropagation();
  if (!confirm('Supprimer ce devoir ?')) return;
  await dbDelete('devoirs', id);
  renderDevoirs();
  toast('Devoir supprimé', 'info');
}

function switchDevoirsTab(tab, el) {
  currentDevoirsTab = tab;
  document.querySelectorAll('.dv-tab').forEach(t => t.classList.remove('active'));
  if (el) el.classList.add('active');
  renderDevoirs();
}

function deadlineBadge(dateStr, done) {
  if (!dateStr || done) return '';
  const now  = new Date(); now.setHours(0,0,0,0);
  const [y,m,d] = dateStr.split('-').map(Number);
  const due  = new Date(y, m-1, d);
  const diff = Math.round((due - now) / 86400000);
  if (diff < 0)  return `<span class="dv-deadline-badge overdue">⚠️ ${Math.abs(diff)}j de retard</span>`;
  if (diff === 0) return `<span class="dv-deadline-badge today">⏰ Aujourd'hui !</span>`;
  if (diff <= 3) return `<span class="dv-deadline-badge urgent">🔥 Dans ${diff}j</span>`;
  if (diff <= 7) return `<span class="dv-deadline-badge urgent">📅 Dans ${diff}j</span>`;
  return `<span class="dv-deadline-badge ok">📅 ${d}/${m}</span>`;
}

async function renderDevoirs() {
  const list = document.getElementById('devoirs-list');
  if (!list || !currentUser) return;

  const all = await dbGetAll('devoirs');
  const uid = String(currentUser.id);
  let devoirs = all.filter(dv => String(dv.userId) === uid);

  // Filter by tab
  if (currentDevoirsTab === 'todo')  devoirs = devoirs.filter(dv => !dv.done);
  if (currentDevoirsTab === 'done')  devoirs = devoirs.filter(dv => dv.done);

  // Sort: todo by deadline asc, done by updatedAt desc
  if (currentDevoirsTab !== 'done') {
    devoirs.sort((a,b) => {
      const pa = { high:0, medium:1, low:2 }[a.priority] ?? 1;
      const pb = { high:0, medium:1, low:2 }[b.priority] ?? 1;
      if (pa !== pb) return pa - pb;
      return (a.deadline||'').localeCompare(b.deadline||'');
    });
  } else {
    devoirs.sort((a,b) => new Date(b.updatedAt) - new Date(a.updatedAt));
  }

  // Update badge
  const todoCount = all.filter(dv => String(dv.userId) === uid && !dv.done).length;
  const badge = document.getElementById('devoirs-badge');
  if (badge) {
    badge.textContent = todoCount;
    badge.style.display = todoCount > 0 ? 'inline-flex' : 'none';
  }

  if (!devoirs.length) {
    const msg = currentDevoirsTab === 'done' ? '🎉 Aucun devoir terminé' :
                currentDevoirsTab === 'todo' ? '✨ Aucun devoir en attente !' : '📭 Aucun devoir';
    list.innerHTML = `<div class="devoirs-empty">${msg}</div>`;
    return;
  }

  list.innerHTML = '';
  devoirs.forEach(dv => {
    const pColor = DV_PRIORITY_COLOR[dv.priority] || '#5b8af5';
    const card = document.createElement('div');
    card.className = 'devoir-card' + (dv.done ? ' done' : '');
    card.style.setProperty('--dv-color', pColor);

    const [y,m,d] = (dv.deadline||'').split('-').map(Number);
    const dateLabel = dv.deadline ? `${d}/${m}/${y}` : '';

    card.innerHTML = `
      <div class="dv-check${dv.done?' checked':''}" onclick="toggleDevoir(${dv.id})" title="${dv.done?'Marquer comme à faire':'Marquer comme fait'}">${dv.done?'✓':''}</div>
      <div class="devoir-info">
        <div class="devoir-title">${dv.title}</div>
        <div class="devoir-meta">
          ${dv.subject ? `<span>📚 ${dv.subject}</span>` : ''}
          ${dv.type ? `<span class="dv-type-badge">${dv.type}</span>` : ''}
          ${dv.desc ? `<span>· ${dv.desc.slice(0,60)}${dv.desc.length>60?'…':''}</span>` : ''}
        </div>
      </div>
      ${deadlineBadge(dv.deadline, dv.done)}
      <button class="dv-del-btn" onclick="deleteDevoir(${dv.id},event)" title="Supprimer">✕</button>`;

    card.ondblclick = () => openDevoirModal(dv.id);
    list.appendChild(card);
  });
}

// ═══════════════════════════════════════════════════════
// DEADLINE BADGE
// ═══════════════════════════════════════════════════════
function getDeadlineBadge(deadline) {
  if (!deadline) return '';
  const diff = Math.ceil((new Date(deadline)-new Date())/(1000*60*60*24));
  const color = diff<0?'var(--danger)':diff<=7?'var(--danger)':diff<=30?'var(--warning)':'var(--success)';
  const label = diff<0?'Passé':diff===0?'Auj':diff+'j';
  return `<span style="color:${color};font-weight:700;font-size:12px">⏰ ${label}</span>`;
}

// ═══════════════════════════════════════════════════════
// MODAL HELPERS
// ═══════════════════════════════════════════════════════
function openModal(id) {
  document.getElementById(id).classList.add('show');
  // Auto focus first input
  const inp = document.querySelector(`#${id} .form-input, #${id} .auth-input`);
  if (inp) setTimeout(()=>inp.focus(),100);
}

function closeModal(id) {
  document.getElementById(id).classList.remove('show');
}

// Close modals by clicking overlay
document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', e => {
    if (e.target === overlay) overlay.classList.remove('show');
  });
});

// ═══════════════════════════════════════════════════════
// TOAST
// ═══════════════════════════════════════════════════════
const toastIcons = { success:'✅', error:'❌', info:'ℹ️', warning:'⚠️' };
function toast(msg, type='info') {
  const wrap = document.getElementById('toast-wrap');
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.innerHTML = `<span>${toastIcons[type]||''}</span><span>${msg}</span>`;
  wrap.appendChild(el);
  setTimeout(()=>{ el.style.animation='toastIn 0.35s reverse'; setTimeout(()=>el.remove(),350); }, 3200);
}

// ═══════════════════════════════════════════════════════
// EXPORT / IMPORT
// ═══════════════════════════════════════════════════════
async function exportData() {
  const folders = await dbGetByIndex('folders','userId',currentUser.id);
  const subjects = []; const events = await dbGetByIndex('events','userId',currentUser.id);
  for (const f of folders) {
    const subs = await dbGetByIndex('subjects','folderId',f.id);
    subjects.push(...subs);
  }
  const blob = new Blob([JSON.stringify({folders,subjects,events},null,2)],{type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `amu-export-${currentUser.username}-${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  toast('Données exportées (sans PDFs)','success');
}

document.getElementById('import-input').addEventListener('change', async e => {
  const file = e.target.files[0]; if (!file) return;
  try {
    const data = JSON.parse(await file.text());
    if (!confirm('Importer ? Les données actuelles seront conservées.')) return;
    for (const f of (data.folders||[])) { delete f.id; f.userId=currentUser.id; await dbAdd('folders',f); }
    for (const s of (data.subjects||[])) { delete s.id; await dbAdd('subjects',s); }
    for (const ev of (data.events||[])) { delete ev.id; ev.userId=currentUser.id; await dbAdd('events',ev); }
    loadFolders(); renderAgenda(); toast('Import réussi','success');
  } catch { toast('Fichier invalide','error'); }
  e.target.value='';
});

// ═══════════════════════════════════════════════════════
// KEYBOARD SHORTCUTS
// ═══════════════════════════════════════════════════════
document.addEventListener('keydown', e => {
  if ((e.ctrlKey||e.metaKey) && e.key==='n') {
    e.preventDefault();
    if (currentFolderId) openModal('subject-modal');
    else openModal('folder-modal');
  }
  if (e.key==='Escape') {
    document.querySelectorAll('.modal-overlay.show').forEach(m=>m.classList.remove('show'));
    closeThemePanel();
  }
});

// ═══════════════════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════════════════
(async () => {
  const saved = localStorage.getItem('amu-theme') || 'midnight';
  document.body.setAttribute('data-theme', saved);
  applyLightMode(); // apply saved light/dark mode
  await initDB();
  buildColorPicker();
  buildFolderEmojiGrid();
})();
</script>
</body>
</html>
