<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="theme-color" content="#6366f1">
    <meta name="description" content="AMU Pro â€” Espace Ã©tudiant Aix-Marseille UniversitÃ©">
    <title>AMU Pro ğŸš€</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,400;0,14..32,500;0,14..32,600;0,14..32,700;0,14..32,800;0,14..32,900&family=Syne:wght@700;800&family=JetBrains+Mono:wght@400;600&family=Outfit:wght@300;400;500;600;700;800;900&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,700;1,9..40,400&display=swap" rel="stylesheet">
    <!-- GSAP for premium animations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <style>
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           DESIGN SYSTEM â€” THÃˆMES
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        :root {
            --primary: #6366f1;
            --primary-light: #818cf8;
            --secondary: #8b5cf6;
            --accent: #ec4899;
            --bg-main: #f1f5f9;
            --bg-card: #ffffff;
            --bg-nav: rgba(255,255,255,0.85);
            --text-main: #0f172a;
            --text-soft: #64748b;
            --border: #e2e8f0;
            --shadow-sm: 0 1px 3px rgba(0,0,0,.06), 0 1px 2px rgba(0,0,0,.04);
            --shadow-md: 0 4px 16px rgba(0,0,0,.08);
            --shadow-lg: 0 12px 40px rgba(0,0,0,.12);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            /* Typographie */
            --font-sans: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
            --font-display: 'Syne', 'Inter', sans-serif;
            --font-mono: 'JetBrains Mono', 'Fira Code', monospace;
        }

        /* â”€â”€ ThÃ¨me sombre â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        [data-theme="dark"] {
            --primary: #818cf8;
            --primary-light: #a5b4fc;
            --secondary: #a78bfa;
            --accent: #f472b6;
            --bg-main: #0b0f1a;
            --bg-card: #141926;
            --bg-nav: rgba(14,18,31,0.92);
            --text-main: #e2e8f0;
            --text-soft: #94a3b8;
            --border: #1e2a3a;
            --shadow-sm: 0 1px 3px rgba(0,0,0,.3);
            --shadow-md: 0 4px 16px rgba(0,0,0,.4);
            --shadow-lg: 0 12px 40px rgba(0,0,0,.5);
        }
        [data-theme="dark"] input,
        [data-theme="dark"] select,
        [data-theme="dark"] textarea {
            background: #1e2a3a; color: #e2e8f0; border-color: #1e2a3a;
        }
        [data-theme="dark"] input::placeholder,
        [data-theme="dark"] textarea::placeholder { color: #475569; }
        [data-theme="dark"] option { background: #141926; color: #e2e8f0; }

        /* â”€â”€ ThÃ¨me OcÃ©an â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  */
        [data-theme="ocean"] {
            --primary: #0ea5e9; --primary-light: #38bdf8;
            --secondary: #06b6d4; --accent: #22d3ee;
            --bg-main: #f0f9ff; --bg-card: #ffffff;
            --bg-nav: rgba(255,255,255,0.9);
            --text-main: #0c4a6e; --text-soft: #0369a1; --border: #bae6fd;
        }
        /* â”€â”€ ThÃ¨me Coucher de soleil â”€ */
        [data-theme="sunset"] {
            --primary: #f97316; --primary-light: #fb923c;
            --secondary: #ef4444; --accent: #fbbf24;
            --bg-main: #fff7ed; --bg-card: #ffffff;
            --bg-nav: rgba(255,255,255,0.9);
            --text-main: #431407; --text-soft: #9a3412; --border: #fed7aa;
        }
        /* â”€â”€ ThÃ¨me ForÃªt â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        [data-theme="forest"] {
            --primary: #22c55e; --primary-light: #4ade80;
            --secondary: #10b981; --accent: #84cc16;
            --bg-main: #f0fdf4; --bg-card: #ffffff;
            --bg-nav: rgba(255,255,255,0.9);
            --text-main: #052e16; --text-soft: #166534; --border: #bbf7d0;
        }
        /* â”€â”€ ThÃ¨me Minuit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        [data-theme="midnight"] {
            --primary: #c084fc; --primary-light: #d8b4fe;
            --secondary: #e879f9; --accent: #67e8f9;
            --bg-main: #04020f; --bg-card: #0d0820;
            --bg-nav: rgba(4,2,15,0.95);
            --text-main: #f0e6ff; --text-soft: #a78bfa; --border: #1e1040;
            --shadow-sm: 0 1px 3px rgba(100,0,200,.2);
            --shadow-md: 0 4px 16px rgba(100,0,200,.3);
        }
        [data-theme="midnight"] input,
        [data-theme="midnight"] select,
        [data-theme="midnight"] textarea {
            background: #1e1040; color: #f0e6ff; border-color: #1e1040;
        }
        /* â”€â”€ ThÃ¨me RosÃ© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        [data-theme="rose"] {
            --primary: #f43f5e; --primary-light: #fb7185;
            --secondary: #e11d48; --accent: #fb923c;
            --bg-main: #fff1f2; --bg-card: #ffffff;
            --bg-nav: rgba(255,255,255,0.9);
            --text-main: #4c0519; --text-soft: #9f1239; --border: #fecdd3;
        }
        /* â”€â”€ ThÃ¨me Nord â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        [data-theme="nord"] {
            --primary: #88c0d0; --primary-light: #8fbcbb;
            --secondary: #81a1c1; --accent: #a3be8c;
            --bg-main: #2e3440; --bg-card: #3b4252;
            --bg-nav: rgba(46,52,64,0.95);
            --text-main: #eceff4; --text-soft: #d8dee9; --border: #434c5e;
            --shadow-sm: 0 1px 3px rgba(0,0,0,.3);
            --shadow-md: 0 4px 16px rgba(0,0,0,.4);
        }
        [data-theme="nord"] input,
        [data-theme="nord"] select,
        [data-theme="nord"] textarea {
            background: #434c5e; color: #eceff4; border-color: #4c566a;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           THÃˆMES SUPER-HÃ‰ROS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        /* â”€â”€ Spider-Man ğŸ•·ï¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        [data-theme="spiderman"] {
            --primary: #e23636; --primary-light: #ff5252;
            --secondary: #0d47a1; --accent: #ffffff;
            --bg-main: #1a1a1a; --bg-card: #2d2d2d;
            --bg-nav: rgba(226,54,54,0.95);
            --text-main: #ffffff; --text-soft: #b0b0b0; --border: #3d3d3d;
            --shadow-sm: 0 1px 3px rgba(226,54,54,.3);
            --shadow-md: 0 4px 16px rgba(226,54,54,.4);
        }
        [data-theme="spiderman"] input,
        [data-theme="spiderman"] select,
        [data-theme="spiderman"] textarea {
            background: #3d3d3d; color: #ffffff; border-color: #e23636;
        }

        /* â”€â”€ Batman ğŸ¦‡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        [data-theme="batman"] {
            --primary: #ffd700; --primary-light: #ffe44d;
            --secondary: #1a1a1a; --accent: #ffd700;
            --bg-main: #0a0a0a; --bg-card: #1a1a1a;
            --bg-nav: rgba(26,26,26,0.98);
            --text-main: #ffffff; --text-soft: #888888; --border: #2d2d2d;
            --shadow-sm: 0 1px 3px rgba(255,215,0,.2);
            --shadow-md: 0 4px 16px rgba(255,215,0,.3);
            --shadow-lg: 0 12px 40px rgba(255,215,0,.4);
        }
        [data-theme="batman"] input,
        [data-theme="batman"] select,
        [data-theme="batman"] textarea {
            background: #2d2d2d; color: #ffffff; border-color: #ffd700;
        }

        /* â”€â”€ Iron Man ğŸ¤– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        [data-theme="ironman"] {
            --primary: #dc143c; --primary-light: #ff1744;
            --secondary: #ffd700; --accent: #c0c0c0;
            --bg-main: #1a0000; --bg-card: #2d0a0a;
            --bg-nav: rgba(220,20,60,0.95);
            --text-main: #ffffff; --text-soft: #ffb3b3; --border: #4d1a1a;
            --shadow-sm: 0 1px 3px rgba(220,20,60,.3);
            --shadow-md: 0 4px 16px rgba(220,20,60,.4);
        }
        [data-theme="ironman"] input,
        [data-theme="ironman"] select,
        [data-theme="ironman"] textarea {
            background: #4d1a1a; color: #ffffff; border-color: #dc143c;
        }

        /* â”€â”€ Hulk ğŸ’ª â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        [data-theme="hulk"] {
            --primary: #00ff00; --primary-light: #4dff4d;
            --secondary: #9933ff; --accent: #ffffff;
            --bg-main: #0a1a0a; --bg-card: #1a2d1a;
            --bg-nav: rgba(0,255,0,0.15);
            --text-main: #00ff00; --text-soft: #66ff66; --border: #2d4d2d;
            --shadow-sm: 0 1px 3px rgba(0,255,0,.3);
            --shadow-md: 0 4px 16px rgba(0,255,0,.4);
        }
        [data-theme="hulk"] input,
        [data-theme="hulk"] select,
        [data-theme="hulk"] textarea {
            background: #2d4d2d; color: #00ff00; border-color: #00ff00;
        }

        /* â”€â”€ Captain America ğŸ›¡ï¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        [data-theme="captain"] {
            --primary: #0d47a1; --primary-light: #1976d2;
            --secondary: #c62828; --accent: #ffffff;
            --bg-main: #e3f2fd; --bg-card: #ffffff;
            --bg-nav: rgba(13,71,161,0.9);
            --text-main: #0d47a1; --text-soft: #1976d2; --border: #90caf9;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           THÃˆMES MÃ‰TALLIQUES
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        /* â”€â”€ Chrome ğŸ”˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        [data-theme="chrome"] {
            --primary: #c0c0c0; --primary-light: #e0e0e0;
            --secondary: #808080; --accent: #ffffff;
            --bg-main: #1a1a1a; --bg-card: #2d2d2d;
            --bg-nav: rgba(192,192,192,0.15);
            --text-main: #ffffff; --text-soft: #c0c0c0; --border: #404040;
            --shadow-sm: 0 1px 3px rgba(192,192,192,.2);
            --shadow-md: 0 4px 16px rgba(192,192,192,.3);
        }
        [data-theme="chrome"] input,
        [data-theme="chrome"] select,
        [data-theme="chrome"] textarea {
            background: #404040; color: #ffffff; border-color: #808080;
        }

        /* â”€â”€ Or ğŸ¥‡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        [data-theme="gold"] {
            --primary: #ffd700; --primary-light: #ffed4e;
            --secondary: #ff8c00; --accent: #ffffff;
            --bg-main: #1a1506; --bg-card: #2d2410;
            --bg-nav: rgba(255,215,0,0.15);
            --text-main: #ffd700; --text-soft: #ffed4e; --border: #4d3810;
            --shadow-sm: 0 1px 3px rgba(255,215,0,.3);
            --shadow-md: 0 4px 16px rgba(255,215,0,.4);
        }
        [data-theme="gold"] input,
        [data-theme="gold"] select,
        [data-theme="gold"] textarea {
            background: #4d3810; color: #ffd700; border-color: #ffd700;
        }

        /* â”€â”€ Cuivre ğŸŸ  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        [data-theme="copper"] {
            --primary: #b87333; --primary-light: #d4935b;
            --secondary: #8b4513; --accent: #cd853f;
            --bg-main: #1a0f08; --bg-card: #2d1810;
            --bg-nav: rgba(184,115,51,0.15);
            --text-main: #d4935b; --text-soft: #b87333; --border: #4d2810;
            --shadow-sm: 0 1px 3px rgba(184,115,51,.3);
            --shadow-md: 0 4px 16px rgba(184,115,51,.4);
        }
        [data-theme="copper"] input,
        [data-theme="copper"] select,
        [data-theme="copper"] textarea {
            background: #4d2810; color: #d4935b; border-color: #b87333;
        }

        /* â”€â”€ Acier ğŸ”© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        [data-theme="steel"] {
            --primary: #b0c4de; --primary-light: #d3e0f0;
            --secondary: #708090; --accent: #f0f8ff;
            --bg-main: #0f1419; --bg-card: #1a2128;
            --bg-nav: rgba(176,196,222,0.12);
            --text-main: #e0e8f0; --text-soft: #b0c4de; --border: #2d3a47;
            --shadow-sm: 0 1px 3px rgba(176,196,222,.2);
            --shadow-md: 0 4px 16px rgba(176,196,222,.3);
        }
        [data-theme="steel"] input,
        [data-theme="steel"] select,
        [data-theme="steel"] textarea {
            background: #2d3a47; color: #e0e8f0; border-color: #708090;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           THÃˆMES SPÃ‰CIAUX
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        /* â”€â”€ Matrix ğŸŸ¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        [data-theme="matrix"] {
            --primary: #00ff41; --primary-light: #39ff6f;
            --secondary: #008f11; --accent: #00ff41;
            --bg-main: #000000; --bg-card: #0a0a0a;
            --bg-nav: rgba(0,255,65,0.05);
            --text-main: #00ff41; --text-soft: #008f11; --border: #003b00;
            --shadow-sm: 0 1px 3px rgba(0,255,65,.3);
            --shadow-md: 0 4px 16px rgba(0,255,65,.4);
        }
        [data-theme="matrix"] input,
        [data-theme="matrix"] select,
        [data-theme="matrix"] textarea {
            background: #0a0a0a; color: #00ff41; border-color: #008f11;
        }

        /* â”€â”€ Neon ğŸ’¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        [data-theme="neon"] {
            --primary: #ff00ff; --primary-light: #ff4dff;
            --secondary: #00ffff; --accent: #ffff00;
            --bg-main: #0a0014; --bg-card: #1a0028;
            --bg-nav: rgba(255,0,255,0.1);
            --text-main: #ff00ff; --text-soft: #ff4dff; --border: #330066;
            --shadow-sm: 0 1px 3px rgba(255,0,255,.4);
            --shadow-md: 0 4px 16px rgba(255,0,255,.5);
        }
        [data-theme="neon"] input,
        [data-theme="neon"] select,
        [data-theme="neon"] textarea {
            background: #1a0028; color: #ff00ff; border-color: #ff00ff;
        }

        /* â”€â”€ Cyberpunk ğŸŒ† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        [data-theme="cyberpunk"] {
            --primary: #ff0080; --primary-light: #ff4da6;
            --secondary: #00d4ff; --accent: #ffff00;
            --bg-main: #0d0221; --bg-card: #1a0440;
            --bg-nav: rgba(255,0,128,0.15);
            --text-main: #ff0080; --text-soft: #ff4da6; --border: #2d0850;
            --shadow-sm: 0 1px 3px rgba(255,0,128,.3);
            --shadow-md: 0 4px 16px rgba(255,0,128,.4);
        }
        [data-theme="cyberpunk"] input,
        [data-theme="cyberpunk"] select,
        [data-theme="cyberpunk"] textarea {
            background: #2d0850; color: #ff0080; border-color: #ff0080;
        }

        /* â”€â”€ Retro ğŸ“¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        [data-theme="retro"] {
            --primary: #ff6b35; --primary-light: #ff8c5a;
            --secondary: #f7931e; --accent: #fdc02f;
            --bg-main: #f4e8c1; --bg-card: #ffffff;
            --bg-nav: rgba(255,107,53,0.1);
            --text-main: #2c1810; --text-soft: #8b4513; --border: #e6d5b8;
        }

        /* â”€â”€ Galaxy ğŸŒŒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        [data-theme="galaxy"] {
            --primary: #9d4edd; --primary-light: #c77dff;
            --secondary: #7209b7; --accent: #f72585;
            --bg-main: #10002b; --bg-card: #240046;
            --bg-nav: rgba(157,78,221,0.15);
            --text-main: #e0aaff; --text-soft: #c77dff; --border: #3c096c;
            --shadow-sm: 0 1px 3px rgba(157,78,221,.3);
            --shadow-md: 0 4px 16px rgba(157,78,221,.4);
        }
        [data-theme="galaxy"] input,
        [data-theme="galaxy"] select,
        [data-theme="galaxy"] textarea {
            background: #3c096c; color: #e0aaff; border-color: #9d4edd;
        }

        /* â”€â”€ Lava ğŸŒ‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        [data-theme="lava"] {
            --primary: #ff4500; --primary-light: #ff6347;
            --secondary: #dc143c; --accent: #ffa500;
            --bg-main: #1a0000; --bg-card: #2d0a00;
            --bg-nav: rgba(255,69,0,0.15);
            --text-main: #ff4500; --text-soft: #ff6347; --border: #4d1400;
            --shadow-sm: 0 1px 3px rgba(255,69,0,.3);
            --shadow-md: 0 4px 16px rgba(255,69,0,.4);
        }
        [data-theme="lava"] input,
        [data-theme="lava"] select,
        [data-theme="lava"] textarea {
            background: #4d1400; color: #ff4500; border-color: #ff4500;
        }

        /* â”€â”€ Ice ğŸ§Š â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        [data-theme="ice"] {
            --primary: #00bfff; --primary-light: #4dd2ff;
            --secondary: #87ceeb; --accent: #b0e0e6;
            --bg-main: #0a1a2e; --bg-card: #16213e;
            --bg-nav: rgba(0,191,255,0.12);
            --text-main: #e6f7ff; --text-soft: #87ceeb; --border: #1f4068;
            --shadow-sm: 0 1px 3px rgba(0,191,255,.3);
            --shadow-md: 0 4px 16px rgba(0,191,255,.4);
        }
        [data-theme="ice"] input,
        [data-theme="ice"] select,
        [data-theme="ice"] textarea {
            background: #1f4068; color: #e6f7ff; border-color: #00bfff;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           BASE
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        *, *::before, *::after { box-sizing: border-box; }
        
        html {
            min-width: 320px;
            overflow-x: hidden;
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg-main);
            color: var(--text-main);
            transition: background 0.4s ease, color 0.4s ease;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
            min-width: 320px;
            overflow-x: hidden;
        }

        input, select, textarea {
            background: var(--bg-card);
            color: var(--text-main);
            transition: border-color .2s, box-shadow .2s;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary) 25%, transparent);
            border-color: var(--primary) !important;
        }
        input::placeholder, textarea::placeholder { color: var(--text-soft); opacity: .7; }

        /* Scrollbars stylisÃ©es */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 99px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           NAVIGATION
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        nav.card {
            background: var(--bg-nav) !important;
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid var(--border) !important;
            border-radius: 0 !important;
            box-shadow: var(--shadow-sm) !important;
        }

        .nav-item {
            position: relative;
            padding: 6px 12px;
            border-radius: var(--radius-sm);
            font-size: 0.82rem;
            font-weight: 600;
            color: var(--text-soft);
            transition: color .2s, background .2s;
            border-bottom: none !important;
            white-space: nowrap;
        }
        .nav-item:hover { color: var(--primary); background: color-mix(in srgb, var(--primary) 8%, transparent); }
        .nav-item.active {
            color: var(--primary);
            background: color-mix(in srgb, var(--primary) 12%, transparent);
            border-bottom: none !important;
        }
        .nav-item.active::after {
            content: '';
            position: absolute;
            bottom: -2px; left: 20%; right: 20%;
            height: 2px;
            background: var(--primary);
            border-radius: 99px;
        }

        /* â”€â”€ Boutons de la nav (ENT, Mail, Settings) â”€â”€â”€ */
        .nav-pill {
            display: flex; align-items: center; gap: 6px;
            padding: 6px 14px;
            border-radius: var(--radius-md);
            font-size: 0.82rem; font-weight: 700;
            transition: all .2s; cursor: pointer;
            border: none;
        }
        .nav-pill:hover { filter: brightness(1.1); transform: translateY(-1px); box-shadow: var(--shadow-md); }
        .nav-pill:active { transform: translateY(0); }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           CARDS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            transition: transform .3s ease, box-shadow .3s ease;
        }
        @media (hover: hover) {
            .card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        }

        /* â”€â”€ Stat cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .stat-card {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: var(--radius-lg);
            padding: 20px;
            position: relative; overflow: hidden;
            box-shadow: var(--shadow-md);
        }
        .stat-card::before {
            content: '';
            position: absolute; top: -30%; right: -10%;
            width: 120px; height: 120px;
            background: rgba(255,255,255,.1);
            border-radius: 50%;
        }
        .stat-card::after {
            content: '';
            position: absolute; bottom: -40%; right: 10%;
            width: 80px; height: 80px;
            background: rgba(255,255,255,.07);
            border-radius: 50%;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           BOUTONS PRIMAIRES
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .btn-primary {
            display: inline-flex; align-items: center; gap: 8px;
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white; font-weight: 700; font-size: 0.875rem;
            border: none; border-radius: var(--radius-md);
            cursor: pointer; transition: all .2s;
            box-shadow: 0 2px 8px color-mix(in srgb, var(--primary) 40%, transparent);
        }
        .btn-primary:hover { filter: brightness(1.1); transform: translateY(-1px); box-shadow: 0 6px 20px color-mix(in srgb, var(--primary) 40%, transparent); }
        .btn-primary:active { transform: translateY(0); filter: brightness(0.98); }

        .btn-ghost {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 8px 16px;
            background: transparent; border: 1.5px solid var(--border);
            color: var(--text-main); font-weight: 600; font-size: 0.82rem;
            border-radius: var(--radius-md); cursor: pointer; transition: all .2s;
        }
        .btn-ghost:hover { border-color: var(--primary); color: var(--primary); background: color-mix(in srgb, var(--primary) 6%, transparent); }

        .btn-danger {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 8px 16px;
            background: transparent; border: 1.5px solid #fca5a5;
            color: #ef4444; font-weight: 600; font-size: 0.82rem;
            border-radius: var(--radius-md); cursor: pointer; transition: all .2s;
        }
        .btn-danger:hover { background: #fef2f2; border-color: #ef4444; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           FILTER BUTTONS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .filter-btn {
            padding: 6px 16px; border-radius: 99px;
            font-size: 0.8rem; font-weight: 600;
            border: 1.5px solid var(--border);
            color: var(--text-soft);
            background: transparent;
            cursor: pointer; transition: all .2s;
        }
        .filter-btn:hover { border-color: var(--primary); color: var(--primary); }
        .filter-btn.active {
            background: var(--primary); color: white;
            border-color: var(--primary);
            box-shadow: 0 2px 8px color-mix(in srgb, var(--primary) 40%, transparent);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           BADGES
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .badge {
            display: inline-flex; align-items: center;
            padding: 3px 10px;
            border-radius: 99px;
            font-size: 0.72rem; font-weight: 700;
            letter-spacing: .02em;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           PLANNING / SCHEDULE
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .schedule-grid {
            display: grid;
            background: var(--border);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }
        .schedule-grid > * { outline: 1px solid var(--border); }

        .schedule-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 12px 8px;
            font-weight: 700; font-size: 0.8rem;
            text-align: center;
        }
        .schedule-cell {
            background: var(--bg-card);
            min-height: 70px; padding: 8px;
            font-size: 0.82rem;
            transition: background .15s;
            position: relative;
        }
        .schedule-cell:hover { background: color-mix(in srgb, var(--primary) 4%, var(--bg-card)); }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           PROGRESS BARS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .progress-bar {
            background: color-mix(in srgb, var(--primary) 15%, transparent);
            border-radius: 99px; overflow: hidden; height: 7px;
        }
        .progress-fill {
            background: linear-gradient(90deg, var(--primary), var(--accent));
            height: 100%; transition: width .6s cubic-bezier(.4,0,.2,1);
            border-radius: 99px;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           MODALS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .modal {
            display: none; position: fixed;
            inset: 0;
            background: rgba(0,0,0,.45);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center; justify-content: center;
            padding: 16px;
        }
        .modal.active { display: flex; animation: fadeIn .25s ease; }
        .modal-content {
            background: var(--bg-card);
            padding: 28px;
            border-radius: var(--radius-xl);
            max-width: 600px; width: 100%;
            max-height: 88vh; overflow-y: auto;
            color: var(--text-main);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           GRADIENT TEXT
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .gradient-text {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* â”€â”€ Logo AMU Pro â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .amu-logo {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            cursor: default;
        }
        .amu-logo-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 60%, var(--accent) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            box-shadow: 0 4px 12px color-mix(in srgb, var(--primary) 40%, transparent),
                        inset 0 1px 0 rgba(255,255,255,0.25);
            position: relative;
            overflow: hidden;
        }
        .amu-logo-icon::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, transparent 60%);
            border-radius: inherit;
        }
        .amu-logo-icon svg {
            width: 20px;
            height: 20px;
            position: relative;
            z-index: 1;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2));
        }
        .amu-logo-text {
            display: flex;
            flex-direction: column;
            line-height: 1;
        }
        .amu-logo-name {
            font-family: 'Syne', 'Inter', sans-serif;
            font-size: 1.05rem;
            font-weight: 800;
            letter-spacing: -0.02em;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .amu-logo-sub {
            font-family: 'Inter', sans-serif;
            font-size: 0.58rem;
            font-weight: 600;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            color: var(--text-soft);
            -webkit-text-fill-color: var(--text-soft);
            margin-top: 1px;
        }

        /* â”€â”€ Headings avec Syne â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        h1, h2 {
            font-family: 'Syne', 'Inter', sans-serif;
            letter-spacing: -0.03em;
        }
        h3, h4 {
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        /* â”€â”€ Code / mono â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        code, .mono {
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            font-size: 0.88em;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           NOTIFICATIONS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .notification {
            position: fixed; top: 72px; right: 16px;
            background: var(--bg-card);
            padding: 14px 20px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            border-left: 3px solid var(--primary);
            z-index: 2000;
            animation: notifIn .3s cubic-bezier(.34,1.56,.64,1);
            font-weight: 600; font-size: 0.875rem;
            max-width: 320px;
        }
        @keyframes notifIn {
            from { opacity: 0; transform: translateX(20px) scale(.95); }
            to   { opacity: 1; transform: translateX(0) scale(1); }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           FLOATING ACTION BUTTON
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .floating-action {
            position: fixed; bottom: 28px; right: 28px;
            width: 56px; height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            box-shadow: 0 8px 24px color-mix(in srgb, var(--primary) 50%, transparent);
            transition: all .3s cubic-bezier(.34,1.56,.64,1);
            z-index: 100; border: none;
        }
        .floating-action:hover { transform: scale(1.12) rotate(90deg); box-shadow: 0 12px 32px color-mix(in srgb, var(--primary) 60%, transparent); }
        .floating-action:active { transform: scale(0.95); }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           EMOJI PICKER
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .emoji-picker { display: grid; grid-template-columns: repeat(8,1fr); gap: 6px; max-height: 200px; overflow-y: auto; }
        .emoji-btn { font-size: 1.4rem; cursor: pointer; padding: 6px; border-radius: var(--radius-sm); transition: all .15s; text-align: center; }
        .emoji-btn:hover { background: var(--border); transform: scale(1.2); }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           SYSTÃˆME DE SUCCÃˆS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .achievement-card {
            transition: all 0.3s ease;
        }
        .achievement-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }
        .grayscale {
            filter: grayscale(100%);
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ANIMATIONS DE FOND
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .floating-emoji {
            position: fixed;
            font-size: 2rem;
            opacity: 0.15;
            pointer-events: none;
            z-index: 1;
            animation: float 20s infinite ease-in-out;
        }
        
        @keyframes float {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 0.15;
            }
            90% {
                opacity: 0.15;
            }
            100% {
                transform: translateY(-100px) rotate(360deg);
                opacity: 0;
            }
        }
        
        @keyframes floatSlow {
            0% {
                transform: translateY(100vh) translateX(0) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 0.12;
            }
            50% {
                transform: translateY(50vh) translateX(30px) rotate(180deg);
            }
            90% {
                opacity: 0.12;
            }
            100% {
                transform: translateY(-100px) translateX(-30px) rotate(360deg);
                opacity: 0;
            }
        }
        
        @keyframes floatMedium {
            0% {
                transform: translateY(100vh) translateX(0) rotate(0deg) scale(1);
                opacity: 0;
            }
            10% {
                opacity: 0.15;
            }
            50% {
                transform: translateY(50vh) translateX(-20px) rotate(180deg) scale(1.2);
            }
            90% {
                opacity: 0.15;
            }
            100% {
                transform: translateY(-100px) translateX(20px) rotate(360deg) scale(1);
                opacity: 0;
            }
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ANIMATIONS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn .3s ease; }

        @keyframes fadeIn { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }
        @keyframes slideIn { from { transform:translateX(-100%); opacity:0; } to { transform:translateX(0); opacity:1; } }
        @keyframes pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.08)} }

        .streak-flame { animation: pulse 1.2s ease infinite; }
        .confetti { position:fixed; width:9px; height:9px; background:var(--primary); animation:fall 3s linear; border-radius: 2px; }
        @keyframes fall { to { transform:translateY(100vh) rotate(360deg); opacity:0; } }

        /* â”€â”€ Animations au chargement des cartes â”€â”€â”€ */
        .course-card { animation: fadeIn .3s ease both; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           RESPONSIVE â€” MOBILE PORTRAIT
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        @media (max-width: 640px) {
            body { font-size: 14px; }
            .modal-content { padding: 20px; border-radius: var(--radius-lg); }
            .notification { right: 10px; left: 10px; top: 68px; }
            .floating-action { bottom: 16px; right: 16px; width: 52px; height: 52px; }
            h2, h3 { font-size: 1.2rem !important; }
            h4 { font-size: 0.95rem !important; }
            .stat-card .text-4xl { font-size: 1.9rem !important; }
            .badge:not(:first-child):not(:nth-child(2)) { display: none; }
            .space-y-6 > * + * { margin-top: 0.875rem !important; }
            .p-6 { padding: 1rem !important; }
            .p-5 { padding: 0.875rem !important; }
            .schedule-grid { font-size: 0.68rem; grid-template-columns: 52px repeat(5, minmax(90px,1fr)) !important; }
            .schedule-header { padding: 8px 4px; font-size: 0.68rem; }
            .schedule-cell { min-height: 60px; padding: 4px; font-size: 0.65rem; }
            input[type="file"] { font-size: 0.72rem; }
        }

        /* â”€ Mobile paysage â”€â”€â”€ */
        @media (max-height: 480px) and (orientation: landscape) {
            .modal-content { max-height: 96vh; }
            .stat-card { padding: 12px 16px; }
            .stat-card .text-4xl { font-size: 1.6rem !important; }
        }

        /* â”€ Tablette portrait â”€â”€â”€ */
        @media (min-width: 641px) and (max-width: 1024px) {
            .schedule-grid { grid-template-columns: 64px repeat(5,1fr) !important; }
            .stat-card .text-4xl { font-size: 2.4rem !important; }
            .modal-content { max-width: 78%; }
        }

        /* â”€ Tablette paysage â”€â”€â”€ */
        @media (min-width: 768px) and (max-width: 1024px) and (orientation: landscape) {
            .grid.md\:grid-cols-4 { grid-template-columns: repeat(4,1fr) !important; }
        }

        /* â”€ Desktop large â”€â”€â”€ */
        @media (min-width: 1280px) {
            .schedule-grid { min-width: 960px; }
            .overflow-y-auto { scrollbar-width: thin; scrollbar-color: var(--primary) var(--border); }
        }
        @media (min-width: 1536px) { .max-w-7xl { max-width: 90rem; } }

        /* â”€ Touch devices â”€â”€â”€ */
        @media (hover: none) and (pointer: coarse) {
            button, .nav-item, .filter-btn, .nav-pill { min-height: 42px; }
            .card:hover { transform: none; box-shadow: var(--shadow-sm); }
            .schedule-cell:hover { background: var(--bg-card); }
            input[type="checkbox"] { width: 20px; height: 20px; }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           SETTINGS PANEL CUSTOM
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .theme-swatch {
            border-radius: var(--radius-md);
            cursor: pointer; overflow: hidden;
            border: 2px solid transparent;
            transition: all .2s;
            aspect-ratio: 4/3;
        }
        .theme-swatch:hover { transform: scale(1.04); box-shadow: var(--shadow-md); }
        .theme-swatch.active { border-color: var(--primary); box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary) 30%, transparent); }

        /* Settings tabs */
        .settings-tab-btn {
            flex: 1; padding: 8px 4px;
            font-size: 0.75rem; font-weight: 700;
            border: none; background: transparent;
            color: var(--text-soft);
            border-bottom: 2px solid transparent;
            cursor: pointer; transition: all .2s;
        }
        .settings-tab-btn.active { color: var(--primary); border-color: var(--primary); }

        .settings-panel { display: none; }
        .settings-panel.active { display: block; animation: fadeIn .2s ease; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           NAV MOBILE â€” bottom bar
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .nav-item-mobile {
            transition: all .2s;
            border-radius: var(--radius-sm);
        }
        .nav-item-mobile.active {
            background: var(--primary) !important;
            color: white !important; font-weight: 700;
        }
        .nav-item-mobile:hover { background: var(--border) !important; }
        [data-theme="dark"] .nav-item-mobile:hover { background: #1e2a3a !important; }

        /* â”€ Quick action cards â”€â”€â”€ */
        .quick-action-card {
            display: flex; flex-direction: column; align-items: center;
            padding: 16px 8px; border-radius: var(--radius-md);
            border: 1.5px dashed var(--border);
            background: transparent;
            cursor: pointer; transition: all .2s;
            color: var(--text-main);
        }
        .quick-action-card:hover {
            border-style: solid;
            background: color-mix(in srgb, var(--primary) 5%, transparent);
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }
        .quick-action-card:active { transform: translateY(0); }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ†• AURORA BACKGROUND EFFECT
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .aurora-bg {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }
        .aurora-blob {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.12;
            animation: auroraMove 18s ease-in-out infinite;
        }
        .aurora-blob:nth-child(1) {
            width: 600px; height: 600px;
            background: radial-gradient(circle, var(--primary), transparent);
            top: -200px; left: -150px;
            animation-delay: 0s;
        }
        .aurora-blob:nth-child(2) {
            width: 500px; height: 500px;
            background: radial-gradient(circle, var(--secondary), transparent);
            top: 30%; right: -100px;
            animation-delay: -6s;
        }
        .aurora-blob:nth-child(3) {
            width: 400px; height: 400px;
            background: radial-gradient(circle, var(--accent), transparent);
            bottom: -100px; left: 30%;
            animation-delay: -12s;
        }
        @keyframes auroraMove {
            0%, 100% { transform: translate(0,0) scale(1); }
            25% { transform: translate(60px,-40px) scale(1.05); }
            50% { transform: translate(-40px,60px) scale(0.95); }
            75% { transform: translate(-60px,-20px) scale(1.08); }
        }
        [data-theme="dark"] .aurora-blob,
        [data-theme="midnight"] .aurora-blob,
        [data-theme="matrix"] .aurora-blob,
        [data-theme="neon"] .aurora-blob,
        [data-theme="cyberpunk"] .aurora-blob,
        [data-theme="galaxy"] .aurora-blob { opacity: 0.08; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ†• GLASSMORPHISM CARDS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .glass-card {
            background: color-mix(in srgb, var(--bg-card) 70%, transparent) !important;
            backdrop-filter: blur(16px) saturate(160%);
            -webkit-backdrop-filter: blur(16px) saturate(160%);
            border: 1px solid color-mix(in srgb, var(--border) 60%, transparent) !important;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ†• POMODORO TIMER
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .pomodoro-ring {
            transform: rotate(-90deg);
            transform-origin: center;
        }
        #pom-ring {
            transform: rotate(-90deg);
            transform-origin: 60px 60px;
        }
        .pomodoro-ring-bg {
            fill: none;
            stroke: var(--border);
            stroke-width: 8;
        }
        .pomodoro-ring-fill {
            fill: none;
            stroke: var(--primary);
            stroke-width: 8;
            stroke-linecap: round;
            stroke-dasharray: 339.29;
            stroke-dashoffset: 0;
            transition: stroke-dashoffset 1s linear;
            filter: drop-shadow(0 0 6px var(--primary));
        }
        .pomodoro-pulsing {
            animation: pomPulse 2s ease-in-out infinite;
        }
        @keyframes pomPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ†• FOCUS MODE OVERLAY
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #focus-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(8px);
        }
        #focus-overlay.active {
            display: flex;
            animation: fadeIn 0.5s ease;
        }
        .focus-card {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            padding: 48px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 30px 80px rgba(0,0,0,0.4);
            border: 1px solid var(--border);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ†• HABIT TRACKER
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .habit-day {
            width: 32px; height: 32px;
            border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.65rem; font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            border: 1.5px solid var(--border);
        }
        .habit-day.done {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
            box-shadow: 0 2px 8px color-mix(in srgb, var(--primary) 40%, transparent);
        }
        .habit-day:hover { transform: scale(1.1); }
        .habit-day.today { border-color: var(--accent); }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ†• NOTE RAPIDE / STICKY NOTES
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .sticky-note {
            border-radius: var(--radius-md);
            padding: 16px;
            position: relative;
            min-height: 120px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.12), 4px 4px 0 rgba(0,0,0,0.06);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .sticky-note:hover {
            transform: translateY(-3px) rotate(0deg);
            box-shadow: 0 8px 20px rgba(0,0,0,0.18), 4px 4px 0 rgba(0,0,0,0.08);
        }
        .sticky-note textarea {
            background: transparent !important;
            border: none !important;
            resize: none;
            font-family: var(--font-sans);
            font-size: 0.9rem;
            line-height: 1.6;
            width: 100%;
            outline: none !important;
            box-shadow: none !important;
            color: rgba(0,0,0,0.75) !important;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ†• GRADE PREDICTION / SIMULATEUR
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .simulator-slider {
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            background: var(--border);
            border-radius: 99px;
            outline: none;
            cursor: pointer;
        }
        .simulator-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px; height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            cursor: pointer;
            box-shadow: 0 2px 8px color-mix(in srgb, var(--primary) 40%, transparent);
            border: 2px solid white;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ†• PROGRESS RING
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .progress-ring-container {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .progress-ring {
            transform: rotate(-90deg);
        }
        .progress-ring-track {
            fill: none;
            stroke: var(--border);
        }
        .progress-ring-fill {
            fill: none;
            stroke-linecap: round;
            transition: stroke-dashoffset 1.2s cubic-bezier(0.4,0,0.2,1);
        }
        .progress-ring-text {
            position: absolute;
            text-align: center;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ†• COUNTDOWN EXAMS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .exam-countdown-card {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: var(--radius-lg);
            padding: 20px;
            color: white;
            position: relative;
            overflow: hidden;
        }
        .exam-countdown-card::before {
            content: '';
            position: absolute;
            top: -50%; right: -20%;
            width: 200px; height: 200px;
            background: rgba(255,255,255,0.07);
            border-radius: 50%;
        }
        .exam-digit {
            background: rgba(255,255,255,0.15);
            border-radius: var(--radius-sm);
            padding: 8px 12px;
            font-family: var(--font-mono);
            font-size: 1.5rem;
            font-weight: 700;
            min-width: 48px;
            text-align: center;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ†• WEATHER WIDGET
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .weather-widget {
            background: linear-gradient(135deg, #0ea5e9, #06b6d4);
            border-radius: var(--radius-lg);
            padding: 20px;
            color: white;
            position: relative;
            overflow: hidden;
        }
        .weather-widget::after {
            content: 'â˜ï¸';
            position: absolute;
            font-size: 5rem;
            opacity: 0.15;
            right: 10px; top: 10px;
            animation: cloudFloat 6s ease-in-out infinite;
        }
        @keyframes cloudFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ†• SEARCH COMMAND PALETTE
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #command-palette {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            z-index: 9998;
            display: none;
            align-items: flex-start;
            justify-content: center;
            padding-top: 15vh;
            backdrop-filter: blur(4px);
        }
        #command-palette.active { display: flex; animation: fadeIn 0.2s ease; }
        .command-palette-box {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            width: 100%;
            max-width: 600px;
            overflow: hidden;
            box-shadow: 0 30px 80px rgba(0,0,0,0.4);
            border: 1px solid var(--border);
        }
        .command-palette-input {
            width: 100%;
            padding: 18px 20px;
            border: none !important;
            outline: none !important;
            box-shadow: none !important;
            font-size: 1.1rem;
            background: transparent !important;
            color: var(--text-main) !important;
            border-bottom: 1px solid var(--border) !important;
        }
        .command-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            cursor: pointer;
            transition: background 0.15s;
        }
        .command-item:hover, .command-item.selected {
            background: color-mix(in srgb, var(--primary) 8%, transparent);
        }
        .command-icon {
            width: 36px; height: 36px;
            border-radius: var(--radius-sm);
            display: flex; align-items: center; justify-content: center;
            font-size: 1rem;
            background: color-mix(in srgb, var(--primary) 12%, transparent);
            color: var(--primary);
            flex-shrink: 0;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ†• TOAST NOTIFICATIONS (enhanced)
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .toast-container {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9997;
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
            pointer-events: none;
        }
        .toast {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 12px 20px;
            font-weight: 600;
            font-size: 0.875rem;
            box-shadow: 0 8px 24px rgba(0,0,0,0.18);
            animation: toastIn 0.4s cubic-bezier(0.34,1.56,0.64,1) both;
            max-width: 400px;
            text-align: center;
            pointer-events: auto;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .toast.toast-success { border-left: 4px solid #22c55e; }
        .toast.toast-warning { border-left: 4px solid #f59e0b; }
        .toast.toast-error { border-left: 4px solid #ef4444; }
        .toast.toast-info { border-left: 4px solid var(--primary); }
        .toast.toast-out { animation: toastOut 0.3s ease forwards; }
        @keyframes toastIn {
            from { opacity: 0; transform: translateY(20px) scale(0.9); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes toastOut {
            from { opacity: 1; transform: translateY(0) scale(1); }
            to { opacity: 0; transform: translateY(-10px) scale(0.95); }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ†• PARTICLE CANVAS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #particle-canvas {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 0;
            opacity: 0.4;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ†• SHIMMER LOADING
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .shimmer {
            background: linear-gradient(
                90deg,
                var(--border) 0%,
                color-mix(in srgb, var(--border) 50%, var(--bg-card)) 50%,
                var(--border) 100%
            );
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ†• ENHANCED NAV with morphing
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        nav.card.scrolled {
            box-shadow: 0 8px 32px rgba(0,0,0,0.12) !important;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ†• XP POP ANIMATION
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .xp-pop {
            position: fixed;
            font-size: 1.1rem;
            font-weight: 800;
            color: var(--primary);
            pointer-events: none;
            z-index: 9999;
            animation: xpFloat 1.5s ease forwards;
            text-shadow: 0 2px 8px color-mix(in srgb, var(--primary) 30%, transparent);
        }
        @keyframes xpFloat {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            80% { opacity: 1; transform: translateY(-80px) scale(1.2); }
            100% { opacity: 0; transform: translateY(-100px) scale(0.8); }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ†• RIPPLE EFFECT
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .ripple-btn {
            position: relative;
            overflow: hidden;
        }
        .ripple-btn .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transform: scale(0);
            animation: rippleAnim 0.6s linear;
            pointer-events: none;
        }
        @keyframes rippleAnim {
            to { transform: scale(4); opacity: 0; }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ†• GRADIENT BORDERS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .gradient-border {
            background: var(--bg-card);
            border: 2px solid transparent;
            background-clip: padding-box;
            position: relative;
        }
        .gradient-border::before {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: inherit;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            z-index: -1;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ†• HERO SECTION DASHBOARD
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .hero-greeting {
            position: relative;
            overflow: hidden;
        }
        .hero-greeting::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg,
                color-mix(in srgb, var(--primary) 8%, transparent),
                color-mix(in srgb, var(--accent) 5%, transparent)
            );
            border-radius: inherit;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ†• CHART ENHANCEMENTS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .chart-container {
            position: relative;
        }
        .chart-legend-dot {
            width: 10px; height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ†• KEYBOARD SHORTCUT BADGE
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        kbd {
            display: inline-flex;
            align-items: center;
            padding: 2px 6px;
            background: var(--border);
            border-radius: 4px;
            font-family: var(--font-mono);
            font-size: 0.7rem;
            font-weight: 600;
            border: 1px solid color-mix(in srgb, var(--border) 70%, var(--text-soft));
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ†• LEVEL UP CELEBRATION
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #levelup-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.4s ease;
        }
        #levelup-overlay.active { display: flex; }
        .levelup-card {
            background: linear-gradient(135deg, var(--primary), var(--secondary), var(--accent));
            border-radius: var(--radius-xl);
            padding: 48px;
            text-align: center;
            color: white;
            max-width: 400px;
            width: 90%;
            animation: levelUpPop 0.6s cubic-bezier(0.34,1.56,0.64,1);
        }
        @keyframes levelUpPop {
            from { transform: scale(0.3) rotate(-10deg); opacity: 0; }
            to { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        .star-burst {
            animation: starBurst 0.5s ease-out both;
        }
        @keyframes starBurst {
            from { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.3); }
            to { transform: scale(1); opacity: 1; }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ†• ENHANCED MOBILE BOTTOM BAR
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        @media (max-width: 1024px) {
            .mobile-bottom-bar {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: var(--bg-nav);
                backdrop-filter: blur(20px) saturate(180%);
                -webkit-backdrop-filter: blur(20px) saturate(180%);
                border-top: 1px solid var(--border);
                padding: 8px 0;
                z-index: 200;
                display: flex;
                justify-content: space-around;
                align-items: center;
            }
            .mobile-tab-btn {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 2px;
                padding: 6px 12px;
                border-radius: var(--radius-sm);
                font-size: 0.6rem;
                font-weight: 600;
                color: var(--text-soft);
                background: transparent;
                border: none;
                cursor: pointer;
                transition: all 0.2s;
                min-width: 48px;
            }
            .mobile-tab-btn i { font-size: 1.1rem; }
            .mobile-tab-btn.active {
                color: var(--primary);
            }
            .mobile-tab-btn.active i {
                animation: bounce 0.4s cubic-bezier(0.34,1.56,0.64,1);
            }
            @keyframes bounce {
                from { transform: scale(0.7); }
                to { transform: scale(1); }
            }
            main { padding-bottom: 80px !important; }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ†• SCROLLBAR PROGRESS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #scroll-progress {
            position: fixed;
            top: 0; left: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            z-index: 9999;
            width: 0%;
            transition: width 0.1s linear;
            box-shadow: 0 0 8px var(--primary);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ†• MOTIVATIONAL BANNER
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .motivation-ticker {
            overflow: hidden;
            white-space: nowrap;
        }
        .motivation-ticker-inner {
            display: inline-block;
            animation: ticker 30s linear infinite;
        }
        @keyframes ticker {
            from { transform: translateX(100%); }
            to { transform: translateX(-100%); }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ†• STAT CARD ENHANCEMENTS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .stat-card-v2 {
            border-radius: var(--radius-lg);
            padding: 24px;
            position: relative;
            overflow: hidden;
            color: white;
            box-shadow: var(--shadow-md);
        }
        .stat-card-v2 .bg-icon {
            position: absolute;
            right: -10px; top: 50%;
            transform: translateY(-50%);
            font-size: 6rem;
            opacity: 0.12;
        }
        .stat-card-v2 .value {
            font-size: 2.5rem;
            font-weight: 800;
            font-family: var(--font-display);
            letter-spacing: -0.04em;
            line-height: 1;
        }
        .stat-card-v2 .trend {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 0.75rem;
            font-weight: 700;
            background: rgba(255,255,255,0.2);
            padding: 3px 8px;
            border-radius: 99px;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ†• DARK MODE TOGGLE ANIMATION
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .theme-toggle-sun-moon {
            width: 44px; height: 24px;
            background: var(--border);
            border-radius: 99px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
            border: none;
        }
        .theme-toggle-sun-moon::after {
            content: 'â˜€ï¸';
            position: absolute;
            top: 2px; left: 2px;
            width: 20px; height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s cubic-bezier(0.34,1.56,0.64,1);
            font-size: 0.65rem;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        [data-theme="dark"] .theme-toggle-sun-moon,
        [data-theme="midnight"] .theme-toggle-sun-moon {
            background: var(--primary);
        }
        [data-theme="dark"] .theme-toggle-sun-moon::after,
        [data-theme="midnight"] .theme-toggle-sun-moon::after {
            content: 'ğŸŒ™';
            transform: translateX(20px);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ†• ENHANCED FOOTER
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .footer-wave {
            position: relative;
            margin-top: 4rem;
        }
        .footer-wave::before {
            content: '';
            display: block;
            height: 60px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            clip-path: polygon(0 50%, 100% 0, 100% 100%, 0 100%);
            margin-bottom: -1px;
        }
    </style>
</head>
<body>
    <!-- Scroll Progress Bar -->
    <div id="scroll-progress"></div>

    <!-- Aurora Background -->
    <div class="aurora-bg">
        <div class="aurora-blob"></div>
        <div class="aurora-blob"></div>
        <div class="aurora-blob"></div>
    </div>

    <!-- Particle Canvas -->
    <canvas id="particle-canvas"></canvas>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Command Palette (Ctrl+K) -->
    <div id="command-palette" onclick="if(event.target===this)closeCommandPalette()">
        <div class="command-palette-box">
            <input class="command-palette-input" id="command-input" 
                   placeholder="ğŸ” Rechercher... (cours, tÃ¢ches, notes, actions)" 
                   oninput="filterCommands(this.value)"
                   onkeydown="handleCommandKey(event)">
            <div id="command-list" style="max-height:320px; overflow-y:auto; padding:8px 0;"></div>
            <div style="padding:8px 16px; font-size:0.72rem; opacity:0.5; border-top:1px solid var(--border); display:flex; gap:16px;">
                <span>â†‘â†“ Naviguer</span><span>â†µ Ouvrir</span><span>Esc Fermer</span>
            </div>
        </div>
    </div>

    <!-- Level Up Overlay -->
    <div id="levelup-overlay" onclick="document.getElementById('levelup-overlay').classList.remove('active')">
        <div class="levelup-card" onclick="event.stopPropagation()">
            <div class="star-burst text-5xl mb-4">â­</div>
            <h2 class="text-3xl font-bold mb-2">NIVEAU <span id="levelup-num">2</span> !</h2>
            <p class="text-lg opacity-90 mb-1">Tu es maintenant</p>
            <p class="text-2xl font-bold mb-6" id="levelup-title">ğŸ“ Ã‰tudiant</p>
            <div class="text-6xl mb-4">ğŸ‰</div>
            <button onclick="document.getElementById('levelup-overlay').classList.remove('active')" 
                    class="px-8 py-3 rounded-xl font-bold text-lg"
                    style="background:rgba(255,255,255,0.25); border:2px solid rgba(255,255,255,0.5);">
                Continuer ğŸš€
            </button>
        </div>
    </div>

    <!-- Conteneur pour les Ã©mojis flottants -->
    <div id="floating-emojis-container"></div>

    <!-- Navigation Premium -->
    <nav class="card sticky top-0 z-50 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center space-x-4">
                    <div class="amu-logo" title="AMU Pro â€” DÃ©veloppÃ© par Mathieu Mercera">
                        <div class="amu-logo-icon">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 3L3 8.5V15.5L12 21L21 15.5V8.5L12 3Z" stroke="white" stroke-width="1.8" stroke-linejoin="round"/>
                                <path d="M12 3V21M3 8.5L21 8.5" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
                                <circle cx="12" cy="12" r="2.5" fill="white" opacity="0.9"/>
                            </svg>
                        </div>
                        <div class="amu-logo-text hidden sm:flex">
                            <span class="amu-logo-name">AMU Pro</span>
                            <span class="amu-logo-sub">Espace Ã‰tudiant</span>
                        </div>
                    </div>

                </div>
                
                <!-- Navigation Desktop -->
                <div class="hidden lg:flex space-x-6 items-center">
                    <button onclick="showTab('dashboard')" class="nav-item active px-3 py-2 text-sm font-medium hover:text-blue-600">
                        <i class="fas fa-home mr-1"></i> Dashboard
                    </button>
                    <button onclick="showTab('courses')" class="nav-item px-3 py-2 text-sm font-medium hover:text-blue-600">
                        <i class="fas fa-book mr-1"></i> Cours
                    </button>
                    <button onclick="showTab('schedule')" class="nav-item px-3 py-2 text-sm font-medium hover:text-blue-600">
                        <i class="fas fa-calendar mr-1"></i> Planning
                    </button>
                    <button onclick="showTab('grades')" class="nav-item px-3 py-2 text-sm font-medium hover:text-blue-600">
                        <i class="fas fa-chart-line mr-1"></i> Notes
                    </button>
                    <button onclick="showTab('stats')" class="nav-item px-3 py-2 text-sm font-medium hover:text-blue-600">
                        <i class="fas fa-chart-bar mr-1"></i> Stats
                    </button>
                    <button onclick="showTab('tasks')" class="nav-item px-3 py-2 text-sm font-medium hover:text-blue-600">
                        <i class="fas fa-tasks mr-1"></i> TÃ¢ches
                    </button>
                    <button onclick="showTab('achievements')" class="nav-item px-3 py-2 text-sm font-medium hover:text-blue-600">
                        <i class="fas fa-trophy mr-1"></i> SuccÃ¨s
                    </button>
                    <a href="https://ent.univ-amu.fr/" target="_blank" rel="noopener noreferrer"
                       class="nav-pill" style="background:linear-gradient(135deg,var(--primary),var(--secondary)); color:white;"
                       title="ENT AMU">
                        <i class="fas fa-university"></i>
                        <span class="hidden xl:inline">ENT</span>
                    </a>
                    <a href="https://outlook.cloud.microsoft/mail/?realm=etu.univ-amu.fr" target="_blank" rel="noopener noreferrer"
                       class="nav-pill" style="background:linear-gradient(135deg,#0078d4,#106ebe); color:white;"
                       title="Mails AMU">
                        <i class="fas fa-envelope"></i>
                        <span class="hidden xl:inline">Mails</span>
                    </a>

                        <i class="fas fa-sliders-h"></i>
                    </button>
                </div>

                <!-- Navigation Mobile -->
                <div class="flex lg:hidden items-center gap-2">
                    <a href="https://ent.univ-amu.fr/" target="_blank" rel="noopener noreferrer"
                       class="nav-pill" style="background:linear-gradient(135deg,var(--primary),var(--secondary)); color:white;" title="ENT">
                        <i class="fas fa-university text-sm"></i>
                    </a>
                    <a href="https://outlook.cloud.microsoft/mail/?realm=etu.univ-amu.fr" target="_blank" rel="noopener noreferrer"
                       class="nav-pill" style="background:linear-gradient(135deg,#0078d4,#106ebe); color:white;" title="Mails">
                        <i class="fas fa-envelope text-sm"></i>
                    </a>
                    <button onclick="openSettings()" class="nav-pill btn-ghost" title="ParamÃ¨tres">
                        <i class="fas fa-sliders-h text-sm"></i>
                    </button>
                    <button onclick="toggleMobileMenu()" class="px-3 py-2 text-sm font-medium hover:text-blue-600" id="mobileMenuBtn">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                </div>
            </div>

            <!-- Menu Mobile DÃ©roulant -->
            <div id="mobileMenu" class="lg:hidden hidden border-t pt-2 pb-3" style="border-color: var(--border);">
                <div class="flex flex-col space-y-1">
                    <button onclick="showTab('dashboard'); closeMobileMenu()" class="nav-item-mobile active px-3 py-3 text-sm font-medium text-left hover:bg-gray-50 rounded">
                        <i class="fas fa-home mr-2 w-5"></i> Dashboard
                    </button>
                    <button onclick="showTab('courses'); closeMobileMenu()" class="nav-item-mobile px-3 py-3 text-sm font-medium text-left hover:bg-gray-50 rounded">
                        <i class="fas fa-book mr-2 w-5"></i> Cours
                    </button>
                    <button onclick="showTab('schedule'); closeMobileMenu()" class="nav-item-mobile px-3 py-3 text-sm font-medium text-left hover:bg-gray-50 rounded">
                        <i class="fas fa-calendar mr-2 w-5"></i> Planning
                    </button>
                    <button onclick="showTab('grades'); closeMobileMenu()" class="nav-item-mobile px-3 py-3 text-sm font-medium text-left hover:bg-gray-50 rounded">
                        <i class="fas fa-chart-line mr-2 w-5"></i> Notes
                    </button>
                    <button onclick="showTab('stats'); closeMobileMenu()" class="nav-item-mobile px-3 py-3 text-sm font-medium text-left hover:bg-gray-50 rounded">
                        <i class="fas fa-chart-bar mr-2 w-5"></i> Stats
                    </button>
                    <button onclick="showTab('tasks'); closeMobileMenu()" class="nav-item-mobile px-3 py-3 text-sm font-medium text-left hover:bg-gray-50 rounded">
                        <i class="fas fa-tasks mr-2 w-5"></i> TÃ¢ches
                    </button>
                    <button onclick="showTab('achievements'); closeMobileMenu()" class="nav-item-mobile px-3 py-3 text-sm font-medium text-left hover:bg-gray-50 rounded">
                        <i class="fas fa-trophy mr-2 w-5"></i> SuccÃ¨s
                    </button>
                    <a href="https://ent.univ-amu.fr/" target="_blank" rel="noopener noreferrer"
                       class="nav-item-mobile px-3 py-3 text-sm font-medium text-left rounded flex items-center"
                       style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; margin-top: 4px;">
                        <i class="fas fa-university mr-2 w-5"></i> ENT AMU
                        <i class="fas fa-external-link-alt ml-auto text-xs opacity-70"></i>
                    </a>
                    <a href="https://outlook.cloud.microsoft/mail/?realm=etu.univ-amu.fr" target="_blank" rel="noopener noreferrer"
                       class="nav-item-mobile px-3 py-3 text-sm font-medium text-left rounded flex items-center"
                       style="background: linear-gradient(135deg, #0078d4, #106ebe); color: white; margin-top: 4px;">
                        <i class="fas fa-envelope mr-2 w-5"></i> Mails AMU
                        <i class="fas fa-external-link-alt ml-auto text-xs opacity-70"></i>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8" style="width: 100%;">

        <!-- DASHBOARD ULTIMATE -->
        <div id="dashboard" class="tab-content active space-y-6">
            
            <!-- Greeting personnalisÃ© -->
            <div class="card rounded-lg p-6 shadow-lg hero-greeting">
                <div class="flex justify-between items-start flex-wrap gap-4">
                    <div>
                        <h2 class="text-3xl font-bold mb-1" id="greeting">ğŸ‘‹ Salut champion !</h2>
                        <p class="text-sm opacity-60" id="motivational-quote">La rÃ©ussite commence par un effort quotidien.</p>
                    </div>
                    <div class="flex gap-4 flex-wrap">
                        <!-- Horloge -->
                        <div class="text-right flex-shrink-0">
                            <div id="live-clock" class="font-mono font-bold text-2xl" style="color:var(--primary); letter-spacing:.05em;">--:--:--</div>
                            <div class="text-xs opacity-50" id="dash-date"></div>
                        </div>
                        <!-- Compteur prochain cours -->
                        <div id="next-class-mini-widget" class="text-right flex-shrink-0" style="display: none;">
                            <div class="text-xs opacity-60 mb-1">Prochain cours</div>
                            <div id="next-class-mini-countdown" class="font-mono font-bold text-xl" style="color:var(--secondary); letter-spacing:.05em;">--:--</div>
                            <div class="text-xs opacity-50" id="next-class-mini-name">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ğŸ†• MOTIVATIONAL TICKER -->
            <div class="card rounded-lg overflow-hidden" style="border-color:var(--primary);">
                <div class="motivation-ticker py-2 px-4" style="background: linear-gradient(135deg, var(--primary), var(--secondary));">
                    <div class="motivation-ticker-inner text-white font-bold text-sm">
                        &nbsp;&nbsp;&nbsp;ğŸš€ La rÃ©ussite n'est pas finale, l'Ã©chec n'est pas fatal : c'est le courage de continuer qui compte.
                        &nbsp;&nbsp;&nbsp;â€¢&nbsp;&nbsp;&nbsp;
                        ğŸ’ª Chaque expert a d'abord Ã©tÃ© un dÃ©butant.
                        &nbsp;&nbsp;&nbsp;â€¢&nbsp;&nbsp;&nbsp;
                        âœ¨ Ton seul concurrent, c'est qui tu Ã©tais hier.
                        &nbsp;&nbsp;&nbsp;â€¢&nbsp;&nbsp;&nbsp;
                        ğŸ¯ Les rÃªves ne fonctionnent que si toi tu travailles.
                        &nbsp;&nbsp;&nbsp;â€¢&nbsp;&nbsp;&nbsp;
                        ğŸŒŸ Il n'y a pas d'ascenseur vers le succÃ¨s, il faut prendre les escaliers.
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    </div>
                </div>
            </div>

            <!-- Widget Prochain Cours -->
            <div id="next-class-widget" class="card rounded-lg p-6 shadow-lg" style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; display: none;">
                <div class="flex items-center justify-between flex-wrap gap-4">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 rounded-full bg-white bg-opacity-20 flex items-center justify-center text-3xl">
                            ğŸ“š
                        </div>
                        <div>
                            <p class="text-sm opacity-90 mb-1">Prochain cours</p>
                            <h3 class="text-2xl font-bold mb-1" id="next-class-name">-</h3>
                            <p class="text-sm opacity-80" id="next-class-location">-</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm opacity-90 mb-1">Dans</div>
                        <div id="next-class-countdown" class="font-mono font-bold text-3xl">--:--</div>
                        <div class="text-xs opacity-80 mt-1" id="next-class-time">-</div>
                    </div>
                </div>
            </div>

            <!-- Message quand pas de cours -->
            <div id="no-next-class" class="card rounded-lg p-6 shadow-lg" style="background: linear-gradient(135deg, #10b981, #059669); color: white; display: none;">
                <div class="flex items-center gap-4">
                    <div class="text-5xl">ğŸ‰</div>
                    <div>
                        <h3 class="text-xl font-bold mb-1">Aucun cours prÃ©vu aujourd'hui !</h3>
                        <p class="text-sm opacity-90">Profitez de votre journÃ©e libre ou rÃ©visez Ã  votre rythme ğŸ“–</p>
                    </div>
                </div>
            </div>

            <!-- Stats rapides -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="stat-card">
                    <div class="flex items-center justify-between mb-2">
                        <div>
                            <p class="text-sm opacity-80">Moyenne GÃ©nÃ©rale</p>
                            <p class="text-4xl font-bold mt-2" id="dash-global-avg">--/20</p>
                        </div>
                        <i class="fas fa-trophy text-5xl opacity-20"></i>
                    </div>
                    <div class="flex items-center gap-2 mb-2">
                        <select id="semesterSelector" onchange="updateDashboardAverage()" 
                            class="text-xs px-2 py-1 rounded border" 
                            style="border-color: var(--border); font-weight: 600;">
                            <option value="current">ğŸ“— Semestre actuel</option>
                            <option value="previous">ğŸ“˜ Semestre prÃ©cÃ©dent</option>
                        </select>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="avg-progress" style="width: 0%"></div>
                    </div>
                </div>

                <div class="stat-card" style="background: linear-gradient(135deg, #22c55e, #16a34a);">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm opacity-80">Fichiers stockÃ©s</p>
                            <p class="text-4xl font-bold mt-2" id="dash-files-count">0</p>
                        </div>
                        <i class="fas fa-file-alt text-5xl opacity-20"></i>
                    </div>
                </div>

                <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm opacity-80">SÃ©rie de travail</p>
                            <p class="text-4xl font-bold mt-2"><span id="streak-count">1</span> <i class="fas fa-fire streak-flame"></i></p>
                            <p class="text-xs opacity-70 mt-1">Record : <span id="streak-record">1</span> jours ğŸ†</p>
                        </div>
                        <i class="fas fa-bolt text-5xl opacity-20"></i>
                    </div>
                </div>

                <div class="stat-card" style="background: linear-gradient(135deg, #ec4899, #db2777);">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm opacity-80">TÃ¢ches complÃ©tÃ©es</p>
                            <p class="text-4xl font-bold mt-2"><span id="tasks-completed">0</span>/<span id="tasks-total">0</span></p>
                        </div>
                        <i class="fas fa-check-circle text-5xl opacity-20"></i>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card rounded-lg p-6 shadow-lg">
                <h3 class="text-xl font-bold mb-4">âš¡ Actions rapides</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4">
                    <button onclick="quickAddCourse()" class="p-3 md:p-4 rounded-lg border-2 border-dashed hover:border-solid transition" style="border-color: var(--primary);">
                        <i class="fas fa-plus-circle text-2xl md:text-3xl mb-2" style="color: var(--primary);"></i>
                        <p class="text-xs md:text-sm font-medium">Nouveau cours</p>
                    </button>
                    <button onclick="quickAddGrade()" class="p-3 md:p-4 rounded-lg border-2 border-dashed hover:border-solid transition" style="border-color: var(--secondary);">
                        <i class="fas fa-star text-2xl md:text-3xl mb-2" style="color: var(--secondary);"></i>
                        <p class="text-xs md:text-sm font-medium">Ajouter note</p>
                    </button>
                    <button onclick="quickAddTask()" class="p-3 md:p-4 rounded-lg border-2 border-dashed hover:border-solid transition" style="border-color: var(--accent);">
                        <i class="fas fa-clipboard-list text-2xl md:text-3xl mb-2" style="color: var(--accent);"></i>
                        <p class="text-xs md:text-sm font-medium">Nouvelle tÃ¢che</p>
                    </button>
                    <button onclick="exportData()" class="p-3 md:p-4 rounded-lg border-2 border-dashed hover:border-solid transition" style="border-color: #22c55e;">
                        <i class="fas fa-download text-2xl md:text-3xl mb-2" style="color: #22c55e;"></i>
                        <p class="text-xs md:text-sm font-medium">Exporter donnÃ©es</p>
                    </button>
                </div>
            </div>

            <!-- Prochain cours + semaine -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="card rounded-lg p-6 shadow-lg">
                    <h3 class="text-xl font-bold mb-4">ğŸ“… Aujourd'hui</h3>
                    <div id="today-schedule" class="space-y-2">
                        <p class="text-sm opacity-70">Chargement du planning...</p>
                    </div>
                </div>
                <div class="card rounded-lg p-6 shadow-lg">
                    <h3 class="text-xl font-bold mb-4">ğŸ“Š Cette semaine</h3>
                    <div id="week-summary" class="space-y-2">
                        <p class="text-sm opacity-70">Chargement...</p>
                    </div>
                </div>
            </div>

            <!-- Progression du semestre -->
            <div class="card rounded-lg p-6 shadow-lg">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-xl font-bold">ğŸ—“ï¸ Progression du semestre</h3>
                    <span id="semester-percent" class="text-sm font-bold" style="color:var(--primary);">--</span>
                </div>
                <div class="progress-bar mb-2">
                    <div class="progress-fill" id="semester-progress-bar" style="width:0%"></div>
                </div>
                <div class="flex justify-between text-xs opacity-50">
                    <span id="semester-start-label">DÃ©but</span>
                    <span id="semester-end-label">Fin</span>
                </div>
            </div>
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                 ğŸ†• NOUVELLE RANGÃ‰E : POMODORO + MÃ‰TÃ‰O + NOTES
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                
                <!-- POMODORO TIMER -->
                <div class="card p-5 glass-card">
                    <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                        ğŸ… Pomodoro
                        <span class="text-xs font-normal opacity-50 ml-auto">Focus Session</span>
                    </h3>
                    <div class="flex flex-col items-center">
                        <div class="pomodoro-pulsing mb-4" id="pomodoro-pulse-wrapper" style="position:relative; display:inline-block;">
                            <svg width="120" height="120" viewBox="0 0 120 120">
                                <circle class="pomodoro-ring-bg" cx="60" cy="60" r="54"/>
                                <circle class="pomodoro-ring-fill" id="pom-ring" cx="60" cy="60" r="54" 
                                    style="stroke-dasharray:339.29; stroke-dashoffset:0;"/>
                            </svg>
                            <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); text-align:center;">
                                <div id="pom-time" class="font-mono font-bold text-2xl" style="color:var(--primary);">25:00</div>
                                <div id="pom-mode" class="text-xs opacity-60 mt-1">Travail</div>
                            </div>
                        </div>
                        <div style="position:relative; margin-top:-32px;"><!-- spacer --></div>
                        <div class="flex gap-2 mt-2">
                            <button onclick="pomodoroToggle()" id="pom-btn" class="btn-primary px-5 py-2 ripple-btn">
                                <i class="fas fa-play" id="pom-btn-icon"></i>
                                <span id="pom-btn-label">DÃ©marrer</span>
                            </button>
                            <button onclick="pomodoroReset()" class="btn-ghost px-4 py-2">
                                <i class="fas fa-redo-alt"></i>
                            </button>
                            <button onclick="pomodoroSkip()" class="btn-ghost px-4 py-2" title="Passer au suivant">
                                <i class="fas fa-step-forward"></i>
                            </button>
                        </div>
                        <div class="flex gap-3 mt-3 text-xs opacity-60">
                            <span>Sessions : <strong id="pom-sessions" style="color:var(--primary);">0</strong></span>
                            <span>Pause dans : <strong id="pom-until-break" style="color:var(--secondary);">4 sessions</strong></span>
                        </div>
                    </div>
                </div>

                <!-- MÃ‰TÃ‰O & LIEU (Marseille) -->
                <div class="card p-5 glass-card" style="background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 50%, #075985 100%); color:white; border:none;">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-lg font-bold">ğŸ“ Marseille</h3>
                            <p class="text-sm opacity-80">Aix-Marseille UniversitÃ©</p>
                        </div>
                        <div class="text-5xl" id="weather-icon">â˜€ï¸</div>
                    </div>
                    <div class="text-5xl font-bold mb-1" id="weather-temp" style="font-family:var(--font-display);">--Â°</div>
                    <div class="text-sm opacity-80 mb-3" id="weather-desc">Chargement...</div>
                    <div class="flex gap-4 text-xs">
                        <span><i class="fas fa-wind mr-1"></i><span id="weather-wind">--</span> km/h</span>
                        <span><i class="fas fa-tint mr-1"></i><span id="weather-humidity">--</span>%</span>
                        <span><i class="fas fa-eye mr-1"></i><span id="weather-feels">--</span>Â°</span>
                    </div>
                    <div class="mt-3 pt-3 border-t border-white border-opacity-20 grid grid-cols-4 gap-1 text-center text-xs" id="weather-forecast">
                        <!-- forecast injected by JS -->
                    </div>
                </div>

                <!-- NOTES RAPIDES (Sticky) -->
                <div class="card p-5 glass-card">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-lg font-bold flex items-center gap-2">ğŸ“ Notes Rapides</h3>
                        <button onclick="addStickyNote()" class="btn-primary px-3 py-1.5 text-xs ripple-btn">
                            <i class="fas fa-plus"></i> Ajouter
                        </button>
                    </div>
                    <div id="sticky-notes-container" class="space-y-2 max-h-48 overflow-y-auto">
                        <p class="text-xs opacity-50 italic text-center py-4">Clique sur + pour ajouter une note ğŸ“Œ</p>
                    </div>
                </div>

            </div>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                 ğŸ†• HABITUDES QUOTIDIENNES
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div class="card p-5 glass-card">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold flex items-center gap-2">
                        âœ… Habitudes Quotidiennes
                        <span class="text-xs font-normal opacity-50">Cette semaine</span>
                    </h3>
                    <button onclick="openHabitModal()" class="btn-primary text-sm px-4 py-2 ripple-btn">
                        <i class="fas fa-plus mr-1"></i> Nouvelle habitude
                    </button>
                </div>
                <div id="habits-container">
                    <div class="grid grid-cols-1 gap-3" id="habits-list">
                        <p class="text-sm opacity-50 italic text-center py-4">Aucune habitude. Commence dÃ¨s aujourd'hui ! ğŸ’ª</p>
                    </div>
                </div>
                <div class="mt-4 p-3 rounded-xl flex items-center gap-3" style="background:var(--border);">
                    <div class="flex-1">
                        <div class="text-xs opacity-60 mb-1">Taux de rÃ©ussite aujourd'hui</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="habits-progress-fill" style="width:0%"></div>
                        </div>
                    </div>
                    <div class="text-xl font-bold" style="color:var(--primary);" id="habits-progress-text">0%</div>
                </div>
            </div>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                 ğŸ†• COMPTE Ã€ REBOURS EXAMENS
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div class="card p-5 glass-card">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold flex items-center gap-2">â³ Compte Ã  rebours Examens</h3>
                    <button onclick="openExamModal()" class="btn-primary text-sm px-4 py-2 ripple-btn">
                        <i class="fas fa-plus mr-1"></i> Ajouter
                    </button>
                </div>
                <div id="exam-countdowns" class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <p class="text-sm opacity-50 italic col-span-full text-center py-4">Aucun examen planifiÃ© ğŸ‰</p>
                </div>
            </div>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                 ğŸ†• SIMULATEUR DE NOTES
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div class="card p-5 glass-card">
                <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                    ğŸ§® Simulateur de Moyenne
                    <span class="text-xs font-normal opacity-50">Anticipe tes rÃ©sultats</span>
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <p class="text-sm opacity-70 mb-4">Si tu obtiens cette note au prochain contrÃ´le :</p>
                        <div class="flex items-center gap-4 mb-4">
                            <input type="range" min="0" max="20" step="0.5" value="15" 
                                   class="simulator-slider flex-1" id="sim-grade-slider"
                                   oninput="updateSimulator()">
                            <div class="text-2xl font-bold w-16 text-center" 
                                 style="color:var(--primary); font-family:var(--font-mono);" id="sim-grade-display">15</div>
                        </div>
                        <div class="flex items-center gap-3 mb-4">
                            <label class="text-sm font-medium">Coefficient :</label>
                            <input type="number" min="0.5" max="5" step="0.5" value="1" 
                                   class="w-20 p-2 border rounded-lg text-center font-bold" 
                                   style="border-color:var(--border);"
                                   id="sim-coef" oninput="updateSimulator()">
                        </div>
                        <div class="flex items-center gap-3">
                            <label class="text-sm font-medium">Pour la matiÃ¨re :</label>
                            <select id="sim-course" class="flex-1 p-2 border rounded-lg text-sm" 
                                    style="border-color:var(--border);" onchange="updateSimulator()">
                                <option value="">Toutes matiÃ¨res</option>
                            </select>
                        </div>
                    </div>
                    <div class="card p-5 flex flex-col justify-center text-center" 
                         style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color:white;">
                        <div class="text-sm opacity-90 mb-1">Ta nouvelle moyenne serait</div>
                        <div class="text-5xl font-bold mb-2" style="font-family:var(--font-display);" id="sim-result">--</div>
                        <div class="text-sm opacity-80 mb-3">/20</div>
                        <div class="text-xs opacity-90 p-2 rounded-lg" style="background:rgba(255,255,255,0.2);" id="sim-comment">
                            SÃ©lectionne une matiÃ¨re pour simuler
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- COURS & FICHIERS AMÃ‰LIORÃ‰S -->
        <div id="courses" class="tab-content space-y-6">
            <div class="card shadow-lg rounded-lg p-6">
                <!-- Barre titre + actions -->
                <div class="flex flex-wrap justify-between items-center gap-3 mb-5">
                    <h3 class="text-2xl font-bold gradient-text">ğŸ“š Mes MatiÃ¨res</h3>
                    <div class="flex flex-wrap gap-2">
                        <!-- Recherche -->
                        <div class="relative hidden sm:block">
                            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-xs opacity-40"></i>
                            <input type="text" id="courseSearch" placeholder="Rechercher..." oninput="searchCourses(this.value)"
                                class="pl-8 pr-3 py-2 text-sm border rounded-lg" style="border-color:var(--border); width:160px;">
                        </div>
                        <!-- Vue grille/liste -->
                        <button onclick="toggleCoursesView()" id="coursesViewBtn" title="Changer la vue"
                            class="px-3 py-2 rounded-lg border text-sm" style="border-color:var(--border);">
                            <i class="fas fa-th-large"></i>
                        </button>
                        <!-- Supprimer tous -->
                        <button onclick="deleteAllCourses()" title="Supprimer tous les cours"
                            class="px-3 py-2 rounded-lg border text-sm text-red-500 hover:bg-red-50 transition" style="border-color:#fca5a5;">
                            <i class="fas fa-trash-alt mr-1"></i><span class="hidden sm:inline">Tout supprimer</span>
                        </button>
                        <!-- Trier -->
                        <select id="coursesSortSelect" onchange="renderCourses()" class="px-3 py-2 text-sm border rounded-lg" style="border-color:var(--border);">
                            <option value="name">Trier : Aâ†’Z</option>
                            <option value="avg">Trier : Moyenne</option>
                            <option value="semester">Trier : Semestre</option>
                        </select>
                        <!-- Nouveau cours -->
                        <button onclick="openCourseModal()" class="px-4 py-2 rounded-lg font-medium text-white text-sm" style="background: linear-gradient(135deg, var(--primary), var(--secondary));">
                            <i class="fas fa-plus mr-1"></i> Nouveau
                        </button>
                    </div>
                </div>

                <!-- Recherche mobile -->
                <div class="sm:hidden mb-4">
                    <div class="relative">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-xs opacity-40"></i>
                        <input type="text" placeholder="Rechercher un cours..." oninput="searchCourses(this.value)"
                            class="w-full pl-8 pr-3 py-2 text-sm border rounded-lg" style="border-color:var(--border);">
                    </div>
                </div>

                <!-- Filtres semestre -->
                <div class="flex gap-2 mb-5 flex-wrap">
                    <button onclick="filterCourses('all')" class="filter-btn active px-3 py-1.5 rounded-lg transition text-sm" data-filter="all">Tous</button>
                    <button onclick="filterCourses('S1')" class="filter-btn px-3 py-1.5 rounded-lg transition text-sm" data-filter="S1">ğŸ“˜ S1</button>
                    <button onclick="filterCourses('S2')" class="filter-btn px-3 py-1.5 rounded-lg transition text-sm" data-filter="S2">ğŸ“— S2</button>
                </div>

                <!-- Compteur -->
                <div id="coursesCount" class="text-xs opacity-50 mb-4"></div>

                <div id="coursesList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </div>
        </div>

        <!-- AGENDA HEBDOMADAIRE -->
        <div id="schedule" class="tab-content">
            <div class="card shadow-lg rounded-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold gradient-text hidden md:block">ğŸ“… Mon Agenda Hebdomadaire</h3>
                    <h3 class="text-xl font-bold gradient-text md:hidden">ğŸ“… Agenda</h3>
                    <div class="flex gap-2 flex-wrap">
                        <div class="flex gap-1">
                            <button onclick="previousWeek()" class="px-3 py-2 rounded-lg border hover:bg-gray-100" title="Semaine prÃ©cÃ©dente">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button onclick="currentWeek()" class="px-3 py-2 rounded-lg border hover:bg-blue-50 text-sm md:text-base" style="color: var(--primary);">
                                <span class="hidden md:inline">Aujourd'hui</span>
                                <i class="fas fa-home md:hidden"></i>
                            </button>
                            <button onclick="nextWeek()" class="px-3 py-2 rounded-lg border hover:bg-gray-100" title="Semaine suivante">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <button onclick="openScheduleSettings()" class="px-3 py-2 rounded-lg border hover:bg-purple-50 hidden md:block">
                            <i class="fas fa-palette mr-2"></i> Personnaliser
                        </button>
                        <button onclick="openScheduleSettings()" class="px-3 py-2 rounded-lg border hover:bg-purple-50 md:hidden" title="Personnaliser">
                            <i class="fas fa-palette"></i>
                        </button>
                        <button onclick="clearSchedule()" class="px-3 py-2 rounded-lg border hover:bg-red-50 text-red-600 hidden md:block">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button onclick="exportSchedule()" class="px-3 py-2 rounded-lg hidden md:block" style="background: var(--primary); color: white;">
                            <i class="fas fa-download mr-2"></i> Exporter
                        </button>
                        <button onclick="exportSchedule()" class="px-3 py-2 rounded-lg md:hidden" style="background: var(--primary); color: white;" title="Exporter">
                            <i class="fas fa-download"></i>
                        </button>
                        <button onclick="openEdtImportModal()" class="px-3 py-2 rounded-lg hidden md:block font-medium" style="background: linear-gradient(135deg, #f97316, #ea580c); color: white;">
                            <i class="fas fa-university mr-2"></i> EDT AMU
                        </button>
                        <button onclick="openEdtImportModal()" class="px-3 py-2 rounded-lg md:hidden" style="background: linear-gradient(135deg, #f97316, #ea580c); color: white;" title="Importer EDT AMU">
                            <i class="fas fa-university"></i>
                        </button>
                    </div>
                </div>
                
                <div class="mb-4 p-4 rounded-lg" style="background: var(--border);">
                    <p class="font-bold text-lg mb-2" id="weekDisplay">Semaine du ...</p>
                    <p class="text-sm opacity-70">
                        ğŸ’¡ <strong>Astuce :</strong> 
                        <span class="hidden md:inline">Clique sur une case pour ajouter/modifier un cours. Double-clique pour supprimer.</span>
                        <span class="md:hidden">Appuie sur + pour ajouter un cours. Appui long pour supprimer.</span>
                        <span class="md:hidden block mt-1">ğŸ‘‰ Fais dÃ©filer horizontalement pour voir tous les jours</span>
                    </p>
                </div>

                <!-- Bandeau statut import EDT -->
                <div id="edtImportStatus" class="hidden mb-4 p-3 rounded-lg flex items-center gap-3 text-sm font-medium" style="background: #fff7ed; border: 1px solid #fed7aa; color: #c2410c;">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span id="edtImportStatusText">Importation en cours...</span>
                </div>
                
                <div class="overflow-x-auto pb-4" style="-webkit-overflow-scrolling: touch;">
                    <div class="schedule-grid" id="scheduleGrid" style="min-width: 900px;"></div>
                </div>
            </div>
        </div>

        <!-- NOTES & ANALYSES -->
        <div id="grades" class="tab-content">
            <div class="card shadow-lg rounded-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold gradient-text">ğŸ¯ Mes Notes</h3>
                    <button onclick="saveAllGrades()" class="px-6 py-3 rounded-lg text-white font-medium" style="background: linear-gradient(135deg, #22c55e, #16a34a);">
                        <i class="fas fa-save mr-2"></i> Sauvegarder tout
                    </button>
                </div>
                
                <div class="card p-4 mb-6">
                    <h4 class="font-bold mb-3">â• Ajouter une note</h4>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <select id="gradeCourseSelect" class="p-3 border rounded-lg" style="border-color: var(--border);">
                            <option>Choisir une matiÃ¨re...</option>
                        </select>
                        <input type="number" id="gradeValue" placeholder="Note /20" min="0" max="20" step="0.25" class="p-3 border rounded-lg" style="border-color: var(--border);">
                        <input type="number" id="gradeCoef" placeholder="Coefficient" min="0.5" max="10" step="0.5" value="1" class="p-3 border rounded-lg" style="border-color: var(--border);">
                        <input type="text" id="gradeLabel" placeholder="IntitulÃ© (ex: Partiel)" class="p-3 border rounded-lg" style="border-color: var(--border);">
                    </div>
                    <button onclick="addGrade()" class="w-full mt-4 px-6 py-3 rounded-lg text-white font-medium" style="background: linear-gradient(135deg, #22c55e, #16a34a);">
                        <i class="fas fa-check mr-2"></i> Enregistrer la note
                    </button>
                </div>

                <!-- Affichage par matiÃ¨re -->
                <div id="gradesList" class="space-y-6"></div>
            </div>
        </div>

        <!-- STATISTIQUES AVANCÃ‰ES -->
        <div id="stats" class="tab-content space-y-6">
            <div class="card shadow-lg rounded-lg p-6">
                <h3 class="text-2xl font-bold gradient-text mb-6">ğŸ“Š Statistiques & Analyses</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card p-4">
                        <h4 class="font-bold mb-4">Ã‰volution de ta moyenne</h4>
                        <canvas id="gradesChart"></canvas>
                    </div>
                    
                    <div class="card p-4">
                        <h4 class="font-bold mb-4">RÃ©partition par matiÃ¨re</h4>
                        <canvas id="subjectsChart"></canvas>
                    </div>
                    
                    <div class="card p-4">
                        <h4 class="font-bold mb-4">Progression mensuelle</h4>
                        <canvas id="progressChart"></canvas>
                    </div>
                    
                    <div class="card p-4">
                        <h4 class="font-bold mb-4">Insights personnalisÃ©s</h4>
                        <div id="insights" class="space-y-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- GESTIONNAIRE DE TÃ‚CHES -->
        <div id="tasks" class="tab-content space-y-6">
            <div class="card shadow-lg rounded-lg p-6">
                <h3 class="text-2xl font-bold gradient-text mb-6">âœ… Mes TÃ¢ches</h3>
                
                <div class="card p-4 mb-6">
                    <div class="flex gap-4">
                        <input type="text" id="taskInput" placeholder="Nouvelle tÃ¢che..." class="flex-1 p-3 border rounded-lg" style="border-color: var(--border);">
                        <select id="taskPriority" class="p-3 border rounded-lg" style="border-color: var(--border);">
                            <option value="low">ğŸŸ¢ Faible</option>
                            <option value="medium" selected>ğŸŸ¡ Moyenne</option>
                            <option value="high">ğŸ”´ Haute</option>
                        </select>
                        <input type="date" id="taskDate" class="p-3 border rounded-lg" style="border-color: var(--border);">
                        <button onclick="addTask()" class="px-6 py-3 rounded-lg text-white font-medium" style="background: var(--primary);">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="card p-4">
                        <h4 class="font-bold mb-3 flex items-center"><span class="w-3 h-3 rounded-full bg-yellow-400 mr-2"></span> Ã€ faire</h4>
                        <div id="tasks-todo" class="space-y-2"></div>
                    </div>
                    <div class="card p-4">
                        <h4 class="font-bold mb-3 flex items-center"><span class="w-3 h-3 rounded-full bg-blue-400 mr-2"></span> En cours</h4>
                        <div id="tasks-inprogress" class="space-y-2"></div>
                    </div>
                    <div class="card p-4">
                        <h4 class="font-bold mb-3 flex items-center"><span class="w-3 h-3 rounded-full bg-green-400 mr-2"></span> TerminÃ©</h4>
                        <div id="tasks-done" class="space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===================== SUCCÃˆS ===================== -->
        <div id="achievements" class="tab-content space-y-6">
            <div class="card shadow-lg rounded-lg p-6">
                <h3 class="text-3xl font-bold gradient-text mb-2">ğŸ† SuccÃ¨s</h3>
                <p class="text-sm opacity-60 mb-6">DÃ©bloquez des rÃ©compenses !</p>
                
                <!-- Progression XP et Niveau -->
                <div class="card p-6 mb-6" style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white;">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-sm opacity-90">Niveau actuel</p>
                            <p class="text-5xl font-bold" id="user-level">1</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm opacity-90">ExpÃ©rience</p>
                            <p class="text-3xl font-bold"><span id="user-xp">0</span> XP</p>
                        </div>
                    </div>
                    <div class="bg-white bg-opacity-20 rounded-full h-3 overflow-hidden mb-2">
                        <div id="xp-progress-bar" class="bg-white h-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <p class="text-xs text-center opacity-90"><span id="xp-needed">100</span> XP pour le niveau suivant</p>
                    
                    <!-- Titre actuel -->
                    <div class="mt-4 pt-4 border-t border-white border-opacity-20">
                        <p class="text-sm opacity-90 mb-1">Votre titre</p>
                        <p class="text-2xl font-bold" id="current-title">ğŸ“ Ã‰tudiant</p>
                    </div>
                </div>

                <!-- Grille des succÃ¨s -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6" id="achievements-grid">
                    <!-- Les succÃ¨s seront gÃ©nÃ©rÃ©s dynamiquement -->
                </div>

                <!-- Parcours des titres -->
                <div class="card p-6">
                    <h3 class="text-2xl font-bold gradient-text mb-4">ğŸ–ï¸ Parcours des Titres</h3>
                    <p class="text-sm opacity-60 mb-6">Voici tous les titres que vous pouvez dÃ©bloquer en montant de niveau !</p>
                    
                    <div class="space-y-3" id="titles-progression">
                        <!-- Les titres seront gÃ©nÃ©rÃ©s dynamiquement -->
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- ğŸ†• MOBILE BOTTOM BAR -->
    <div class="mobile-bottom-bar lg:hidden" id="mobile-bottom-bar">
        <button class="mobile-tab-btn active" onclick="showTab('dashboard');setMobileActive(this)" data-tab="dashboard">
            <i class="fas fa-home"></i>
            <span>Accueil</span>
        </button>
        <button class="mobile-tab-btn" onclick="showTab('courses');setMobileActive(this)" data-tab="courses">
            <i class="fas fa-book"></i>
            <span>Cours</span>
        </button>
        <button class="mobile-tab-btn" onclick="showTab('schedule');setMobileActive(this)" data-tab="schedule">
            <i class="fas fa-calendar"></i>
            <span>Planning</span>
        </button>
        <button class="mobile-tab-btn" onclick="showTab('grades');setMobileActive(this)" data-tab="grades">
            <i class="fas fa-star"></i>
            <span>Notes</span>
        </button>
        <button class="mobile-tab-btn" onclick="showTab('tasks');setMobileActive(this)" data-tab="tasks">
            <i class="fas fa-check-circle"></i>
            <span>TÃ¢ches</span>
        </button>
        <button class="mobile-tab-btn" onclick="openSettings()" data-tab="settings">
            <i class="fas fa-sliders-h"></i>
            <span>Plus</span>
        </button>
    </div>

    <!-- ğŸ†• HABIT MODAL -->
    <div id="habitModal" class="modal">
        <div class="modal-content" style="max-width:480px;">
            <div class="flex justify-between items-center mb-5">
                <h3 class="text-2xl font-bold gradient-text">âœ… Nouvelle Habitude</h3>
                <button onclick="closeHabitModal()" class="btn-ghost" style="padding:6px 10px;">&times;</button>
            </div>
            <input type="text" id="habit-name-input" placeholder="ex: Lire 30 min, RÃ©viser, Sport..." 
                   class="w-full p-3 border rounded-xl mb-4" style="border-color:var(--border);">
            <p class="text-xs font-semibold uppercase opacity-50 mb-2">Emoji</p>
            <div class="flex gap-2 mb-5 flex-wrap">
                <button onclick="setHabitEmoji('ğŸ“š')" class="emoji-btn">ğŸ“š</button>
                <button onclick="setHabitEmoji('ğŸ’ª')" class="emoji-btn">ğŸ’ª</button>
                <button onclick="setHabitEmoji('ğŸƒ')" class="emoji-btn">ğŸƒ</button>
                <button onclick="setHabitEmoji('ğŸ¥—')" class="emoji-btn">ğŸ¥—</button>
                <button onclick="setHabitEmoji('ğŸ˜´')" class="emoji-btn">ğŸ˜´</button>
                <button onclick="setHabitEmoji('ğŸ¯')" class="emoji-btn">ğŸ¯</button>
                <button onclick="setHabitEmoji('ğŸµ')" class="emoji-btn">ğŸµ</button>
                <button onclick="setHabitEmoji('ğŸ’§')" class="emoji-btn">ğŸ’§</button>
                <button onclick="setHabitEmoji('ğŸ“–')" class="emoji-btn">ğŸ“–</button>
                <button onclick="setHabitEmoji('ğŸ§˜')" class="emoji-btn">ğŸ§˜</button>
            </div>
            <button onclick="saveHabit()" class="btn-primary w-full justify-center ripple-btn">
                <i class="fas fa-check mr-2"></i> CrÃ©er l'habitude
            </button>
        </div>
    </div>

    <!-- ğŸ†• EXAM COUNTDOWN MODAL -->
    <div id="examModal" class="modal">
        <div class="modal-content" style="max-width:480px;">
            <div class="flex justify-between items-center mb-5">
                <h3 class="text-2xl font-bold gradient-text">â³ Ajouter un Examen</h3>
                <button onclick="closeExamModal()" class="btn-ghost" style="padding:6px 10px;">&times;</button>
            </div>
            <input type="text" id="exam-name-input" placeholder="Nom de l'examen (ex: Partiel Maths)" 
                   class="w-full p-3 border rounded-xl mb-4" style="border-color:var(--border);">
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">ğŸ“… Date de l'examen</label>
                <input type="date" id="exam-date-input" class="w-full p-3 border rounded-xl" style="border-color:var(--border);">
            </div>
            <div class="mb-5">
                <label class="block text-sm font-medium mb-2">ğŸ¨ Couleur</label>
                <div class="flex gap-2">
                    <button onclick="setExamColor('#6366f1')" class="w-8 h-8 rounded-full" style="background:#6366f1;" data-examcolor="#6366f1"></button>
                    <button onclick="setExamColor('#ef4444')" class="w-8 h-8 rounded-full" style="background:#ef4444;" data-examcolor="#ef4444"></button>
                    <button onclick="setExamColor('#f59e0b')" class="w-8 h-8 rounded-full" style="background:#f59e0b;" data-examcolor="#f59e0b"></button>
                    <button onclick="setExamColor('#22c55e')" class="w-8 h-8 rounded-full" style="background:#22c55e;" data-examcolor="#22c55e"></button>
                    <button onclick="setExamColor('#0ea5e9')" class="w-8 h-8 rounded-full" style="background:#0ea5e9;" data-examcolor="#0ea5e9"></button>
                    <button onclick="setExamColor('#ec4899')" class="w-8 h-8 rounded-full" style="background:#ec4899;" data-examcolor="#ec4899"></button>
                </div>
            </div>
            <button onclick="saveExam()" class="btn-primary w-full justify-center ripple-btn">
                <i class="fas fa-plus mr-2"></i> Ajouter l'examen
            </button>
        </div>
    </div>

    <!-- ğŸ†• ENHANCED FOOTER -->
    <footer class="footer-wave mt-8 pb-20 lg:pb-8" style="position:relative; z-index:2;">
        <div style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color:white; padding: 40px 0 20px;">
            <div class="max-w-7xl mx-auto px-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-8">
                    <!-- Branding -->
                    <div>
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-10 h-10 rounded-xl flex items-center justify-center"
                                 style="background:rgba(255,255,255,0.2);">
                                <span class="text-xl">ğŸ“</span>
                            </div>
                            <div>
                                <div class="font-bold text-lg" style="font-family:var(--font-display);">AMU Pro</div>
                                <div class="text-xs opacity-70">Espace Ã‰tudiant</div>
                            </div>
                        </div>
                        <p class="text-sm opacity-80">Ton espace acadÃ©mique tout-en-un pour Aix-Marseille UniversitÃ©.</p>
                    </div>
                    <!-- Quick Links -->
                    <div>
                        <h4 class="font-bold mb-3 text-sm uppercase tracking-wider opacity-80">Liens Utiles</h4>
                        <div class="space-y-2">
                            <a href="https://ent.univ-amu.fr/" target="_blank" class="flex items-center gap-2 text-sm opacity-80 hover:opacity-100 transition">
                                <i class="fas fa-university w-4"></i> ENT AMU
                            </a>
                            <a href="https://outlook.cloud.microsoft/mail/?realm=etu.univ-amu.fr" target="_blank" class="flex items-center gap-2 text-sm opacity-80 hover:opacity-100 transition">
                                <i class="fas fa-envelope w-4"></i> Mails Ã©tudiants
                            </a>
                            <a href="https://www.univ-amu.fr/" target="_blank" class="flex items-center gap-2 text-sm opacity-80 hover:opacity-100 transition">
                                <i class="fas fa-globe w-4"></i> Site officiel AMU
                            </a>
                        </div>
                    </div>
                    <!-- Stats App -->
                    <div>
                        <h4 class="font-bold mb-3 text-sm uppercase tracking-wider opacity-80">Raccourcis Clavier</h4>
                        <div class="grid grid-cols-2 gap-1 text-xs">
                            <span class="opacity-80"><kbd style="background:rgba(255,255,255,0.2); border-color:rgba(255,255,255,0.3);">Ctrl+K</kbd> Recherche</span>
                            <span class="opacity-80"><kbd style="background:rgba(255,255,255,0.2); border-color:rgba(255,255,255,0.3);">Alt+1-7</kbd> Onglets</span>
                            <span class="opacity-80"><kbd style="background:rgba(255,255,255,0.2); border-color:rgba(255,255,255,0.3);">Esc</kbd> Fermer</span>
                            <span class="opacity-80"><kbd style="background:rgba(255,255,255,0.2); border-color:rgba(255,255,255,0.3);">Alt+D</kbd> ThÃ¨me sombre</span>
                        </div>
                    </div>
                </div>
                <div class="border-t border-white border-opacity-20 pt-6 flex flex-col md:flex-row justify-between items-center gap-3">
                    <div class="flex items-center gap-2 text-sm">
                        <span class="opacity-70">DÃ©veloppÃ© avec</span>
                        <span class="text-red-300 animate-pulse">â¤ï¸</span>
                        <span class="opacity-70">par</span>
                        <span class="font-bold">Mathieu Mercera</span>
                        <span class="opacity-50">â€¢ AMU Pro Â© 2026</span>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="openCommandPalette()" class="px-4 py-2 rounded-xl text-sm font-medium transition hover:bg-white hover:text-gray-900"
                                style="background:rgba(255,255,255,0.15); border:1px solid rgba(255,255,255,0.3);">
                            <i class="fas fa-search mr-2"></i>Recherche rapide
                        </button>
                        <button onclick="exportAllData()" class="px-4 py-2 rounded-xl text-sm font-medium transition hover:bg-white hover:text-gray-900"
                                style="background:rgba(255,255,255,0.15); border:1px solid rgba(255,255,255,0.3);">
                            <i class="fas fa-download mr-2"></i>Exporter
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- Modal ParamÃ¨tres -->
    <div id="settingsModal" class="modal">
        <div class="modal-content" style="max-width:580px;">
            <div class="flex justify-between items-center mb-5">
                <h3 class="text-2xl font-bold gradient-text">âš™ï¸ ParamÃ¨tres</h3>
                <button onclick="closeSettings()" class="btn-ghost" style="padding:6px 10px; font-size:1.1rem;">&times;</button>
            </div>

            <!-- Onglets settings -->
            <div class="flex border-b mb-5" style="border-color:var(--border);">
                <button class="settings-tab-btn active" onclick="switchSettingsTab(this,'tab-theme')">ğŸ¨ ThÃ¨me</button>
                <button class="settings-tab-btn" onclick="switchSettingsTab(this,'tab-profile')">ğŸ‘¤ Profil</button>
                <button class="settings-tab-btn" onclick="switchSettingsTab(this,'tab-display')">ğŸ–¥ï¸ Affichage</button>
                <button class="settings-tab-btn" onclick="switchSettingsTab(this,'tab-options')">ğŸ¯ Options</button>
                <button class="settings-tab-btn" onclick="switchSettingsTab(this,'tab-data')">ğŸ’¾ DonnÃ©es</button>
            </div>

            <!-- TAB THÃˆME -->
            <div id="tab-theme" class="settings-panel active" style="max-height: 500px; overflow-y: auto;">
                <p class="text-xs font-semibold uppercase opacity-50 mb-3">ğŸ¨ ThÃ¨mes Classiques</p>
                <div class="grid grid-cols-4 gap-3 mb-5">
                    <button onclick="setTheme('light')" class="theme-swatch" id="swatch-light">
                        <div class="h-full w-full" style="background:linear-gradient(135deg,#6366f1,#ec4899);"></div>
                        <p class="text-xs font-semibold text-center mt-1" style="color:var(--text-main);">Indigo</p>
                    </button>
                    <button onclick="setTheme('dark')" class="theme-swatch" id="swatch-dark">
                        <div class="h-full w-full" style="background:linear-gradient(135deg,#818cf8,#a78bfa); position:relative;">
                            <div style="position:absolute;inset:0;background:rgba(0,0,0,.55);"></div>
                        </div>
                        <p class="text-xs font-semibold text-center mt-1" style="color:var(--text-main);">Sombre</p>
                    </button>
                    <button onclick="setTheme('midnight')" class="theme-swatch" id="swatch-midnight">
                        <div class="h-full w-full" style="background:linear-gradient(135deg,#c084fc,#67e8f9); position:relative;">
                            <div style="position:absolute;inset:0;background:rgba(4,2,15,.7);"></div>
                        </div>
                        <p class="text-xs font-semibold text-center mt-1" style="color:var(--text-main);">Minuit</p>
                    </button>
                    <button onclick="setTheme('nord')" class="theme-swatch" id="swatch-nord">
                        <div class="h-full w-full" style="background:linear-gradient(135deg,#88c0d0,#a3be8c); position:relative;">
                            <div style="position:absolute;inset:0;background:rgba(46,52,64,.6);"></div>
                        </div>
                        <p class="text-xs font-semibold text-center mt-1" style="color:var(--text-main);">Nord</p>
                    </button>
                    <button onclick="setTheme('ocean')" class="theme-swatch" id="swatch-ocean">
                        <div class="h-full w-full" style="background:linear-gradient(135deg,#0ea5e9,#22d3ee);"></div>
                        <p class="text-xs font-semibold text-center mt-1" style="color:var(--text-main);">OcÃ©an</p>
                    </button>
                    <button onclick="setTheme('sunset')" class="theme-swatch" id="swatch-sunset">
                        <div class="h-full w-full" style="background:linear-gradient(135deg,#f97316,#ef4444);"></div>
                        <p class="text-xs font-semibold text-center mt-1" style="color:var(--text-main);">Sunset</p>
                    </button>
                    <button onclick="setTheme('forest')" class="theme-swatch" id="swatch-forest">
                        <div class="h-full w-full" style="background:linear-gradient(135deg,#22c55e,#84cc16);"></div>
                        <p class="text-xs font-semibold text-center mt-1" style="color:var(--text-main);">ForÃªt</p>
                    </button>
                    <button onclick="setTheme('rose')" class="theme-swatch" id="swatch-rose">
                        <div class="h-full w-full" style="background:linear-gradient(135deg,#f43f5e,#fb923c);"></div>
                        <p class="text-xs font-semibold text-center mt-1" style="color:var(--text-main);">RosÃ©</p>
                    </button>
                </div>

                <p class="text-xs font-semibold uppercase opacity-50 mb-3">ğŸ¦¸ ThÃ¨mes Super-HÃ©ros</p>
                <div class="grid grid-cols-4 gap-3 mb-5">
                    <button onclick="setTheme('spiderman')" class="theme-swatch" id="swatch-spiderman">
                        <div class="h-full w-full" style="background:linear-gradient(135deg,#e23636,#0d47a1); position:relative;">
                            <div style="position:absolute;inset:0;background:rgba(0,0,0,.3);"></div>
                        </div>
                        <p class="text-xs font-semibold text-center mt-1" style="color:var(--text-main);">Spider-Man ğŸ•·ï¸</p>
                    </button>
                    <button onclick="setTheme('batman')" class="theme-swatch" id="swatch-batman">
                        <div class="h-full w-full" style="background:linear-gradient(135deg,#ffd700,#1a1a1a); position:relative;">
                            <div style="position:absolute;inset:0;background:rgba(0,0,0,.7);"></div>
                        </div>
                        <p class="text-xs font-semibold text-center mt-1" style="color:var(--text-main);">Batman ğŸ¦‡</p>
                    </button>
                    <button onclick="setTheme('ironman')" class="theme-swatch" id="swatch-ironman">
                        <div class="h-full w-full" style="background:linear-gradient(135deg,#dc143c,#ffd700); position:relative;">
                            <div style="position:absolute;inset:0;background:rgba(0,0,0,.4);"></div>
                        </div>
                        <p class="text-xs font-semibold text-center mt-1" style="color:var(--text-main);">Iron Man ğŸ¤–</p>
                    </button>
                    <button onclick="setTheme('hulk')" class="theme-swatch" id="swatch-hulk">
                        <div class="h-full w-full" style="background:linear-gradient(135deg,#00ff00,#9933ff); position:relative;">
                            <div style="position:absolute;inset:0;background:rgba(0,0,0,.5);"></div>
                        </div>
                        <p class="text-xs font-semibold text-center mt-1" style="color:var(--text-main);">Hulk ğŸ’ª</p>
                    </button>
                    <button onclick="setTheme('captain')" class="theme-swatch" id="swatch-captain">
                        <div class="h-full w-full" style="background:linear-gradient(135deg,#0d47a1,#c62828);"></div>
                        <p class="text-xs font-semibold text-center mt-1" style="color:var(--text-main);">Captain ğŸ›¡ï¸</p>
                    </button>
                </div>

                <p class="text-xs font-semibold uppercase opacity-50 mb-3">âš™ï¸ ThÃ¨mes MÃ©talliques</p>
                <div class="grid grid-cols-4 gap-3 mb-5">
                    <button onclick="setTheme('chrome')" class="theme-swatch" id="swatch-chrome">
                        <div class="h-full w-full" style="background:linear-gradient(135deg,#c0c0c0,#808080); position:relative;">
                            <div style="position:absolute;inset:0;background:rgba(0,0,0,.5);"></div>
                        </div>
                        <p class="text-xs font-semibold text-center mt-1" style="color:var(--text-main);">Chrome ğŸ”˜</p>
                    </button>
                    <button onclick="setTheme('gold')" class="theme-swatch" id="swatch-gold">
                        <div class="h-full w-full" style="background:linear-gradient(135deg,#ffd700,#ff8c00); position:relative;">
                            <div style="position:absolute;inset:0;background:rgba(0,0,0,.3);"></div>
                        </div>
                        <p class="text-xs font-semibold text-center mt-1" style="color:var(--text-main);">Or ğŸ¥‡</p>
                    </button>
                    <button onclick="setTheme('copper')" class="theme-swatch" id="swatch-copper">
                        <div class="h-full w-full" style="background:linear-gradient(135deg,#b87333,#8b4513); position:relative;">
                            <div style="position:absolute;inset:0;background:rgba(0,0,0,.3);"></div>
                        </div>
                        <p class="text-xs font-semibold text-center mt-1" style="color:var(--text-main);">Cuivre ğŸŸ </p>
                    </button>
                    <button onclick="setTheme('steel')" class="theme-swatch" id="swatch-steel">
                        <div class="h-full w-full" style="background:linear-gradient(135deg,#b0c4de,#708090); position:relative;">
                            <div style="position:absolute;inset:0;background:rgba(0,0,0,.4);"></div>
                        </div>
                        <p class="text-xs font-semibold text-center mt-1" style="color:var(--text-main);">Acier ğŸ”©</p>
                    </button>
                </div>

                <p class="text-xs font-semibold uppercase opacity-50 mb-3">âœ¨ ThÃ¨mes SpÃ©ciaux</p>
                <div class="grid grid-cols-4 gap-3 mb-5">
                    <button onclick="setTheme('matrix')" class="theme-swatch" id="swatch-matrix">
                        <div class="h-full w-full" style="background:linear-gradient(135deg,#00ff41,#008f11); position:relative;">
                            <div style="position:absolute;inset:0;background:rgba(0,0,0,.8);"></div>
                        </div>
                        <p class="text-xs font-semibold text-center mt-1" style="color:var(--text-main);">Matrix ğŸŸ¢</p>
                    </button>
                    <button onclick="setTheme('neon')" class="theme-swatch" id="swatch-neon">
                        <div class="h-full w-full" style="background:linear-gradient(135deg,#ff00ff,#00ffff); position:relative;">
                            <div style="position:absolute;inset:0;background:rgba(0,0,0,.6);"></div>
                        </div>
                        <p class="text-xs font-semibold text-center mt-1" style="color:var(--text-main);">Neon ğŸ’¡</p>
                    </button>
                    <button onclick="setTheme('cyberpunk')" class="theme-swatch" id="swatch-cyberpunk">
                        <div class="h-full w-full" style="background:linear-gradient(135deg,#ff0080,#00d4ff); position:relative;">
                            <div style="position:absolute;inset:0;background:rgba(0,0,0,.5);"></div>
                        </div>
                        <p class="text-xs font-semibold text-center mt-1" style="color:var(--text-main);">Cyberpunk ğŸŒ†</p>
                    </button>
                    <button onclick="setTheme('retro')" class="theme-swatch" id="swatch-retro">
                        <div class="h-full w-full" style="background:linear-gradient(135deg,#ff6b35,#fdc02f);"></div>
                        <p class="text-xs font-semibold text-center mt-1" style="color:var(--text-main);">Retro ğŸ“¼</p>
                    </button>
                    <button onclick="setTheme('galaxy')" class="theme-swatch" id="swatch-galaxy">
                        <div class="h-full w-full" style="background:linear-gradient(135deg,#9d4edd,#f72585); position:relative;">
                            <div style="position:absolute;inset:0;background:rgba(0,0,0,.5);"></div>
                        </div>
                        <p class="text-xs font-semibold text-center mt-1" style="color:var(--text-main);">Galaxy ğŸŒŒ</p>
                    </button>
                    <button onclick="setTheme('lava')" class="theme-swatch" id="swatch-lava">
                        <div class="h-full w-full" style="background:linear-gradient(135deg,#ff4500,#dc143c); position:relative;">
                            <div style="position:absolute;inset:0;background:rgba(0,0,0,.4);"></div>
                        </div>
                        <p class="text-xs font-semibold text-center mt-1" style="color:var(--text-main);">Lava ğŸŒ‹</p>
                    </button>
                    <button onclick="setTheme('ice')" class="theme-swatch" id="swatch-ice">
                        <div class="h-full w-full" style="background:linear-gradient(135deg,#00bfff,#87ceeb); position:relative;">
                            <div style="position:absolute;inset:0;background:rgba(0,0,0,.4);"></div>
                        </div>
                        <p class="text-xs font-semibold text-center mt-1" style="color:var(--text-main);">Ice ğŸ§Š</p>
                    </button>
                </div>

                <p class="text-xs font-semibold uppercase opacity-50 mb-3">ğŸ¨ Couleurs personnalisÃ©es</p>
                <div class="grid grid-cols-2 gap-3">
                    <label class="flex items-center gap-3 p-3 rounded-xl cursor-pointer card">
                        <input type="color" id="customPrimaryColor" value="#6366f1" onchange="applyCustomColor('primary', this.value)" class="w-9 h-9 rounded-lg cursor-pointer border-0 flex-shrink-0">
                        <div><p class="text-sm font-semibold">Primaire</p><p class="text-xs opacity-50">Boutons, liens actifs</p></div>
                    </label>
                    <label class="flex items-center gap-3 p-3 rounded-xl cursor-pointer card">
                        <input type="color" id="customAccentColor" value="#ec4899" onchange="applyCustomColor('accent', this.value)" class="w-9 h-9 rounded-lg cursor-pointer border-0 flex-shrink-0">
                        <div><p class="text-sm font-semibold">Accent</p><p class="text-xs opacity-50">DÃ©gradÃ©s, highlights</p></div>
                    </label>
                </div>
            </div>

            <!-- TAB PROFIL -->
            <div id="tab-profile" class="settings-panel">
                <input type="text" id="userName" placeholder="Ton prÃ©nom" class="w-full p-3 border rounded-xl mb-4 text-sm font-medium" style="border-color: var(--border);">
                <p class="text-xs font-semibold uppercase opacity-50 mb-3">Choisis ton avatar</p>
                <div class="emoji-picker">
                    <span class="emoji-btn" onclick="setAvatar('ğŸ‘¨â€ğŸ“')">ğŸ‘¨â€ğŸ“</span><span class="emoji-btn" onclick="setAvatar('ğŸ‘©â€ğŸ“')">ğŸ‘©â€ğŸ“</span>
                    <span class="emoji-btn" onclick="setAvatar('ğŸ¦¸â€â™‚ï¸')">ğŸ¦¸â€â™‚ï¸</span><span class="emoji-btn" onclick="setAvatar('ğŸ¦¸â€â™€ï¸')">ğŸ¦¸â€â™€ï¸</span>
                    <span class="emoji-btn" onclick="setAvatar('ğŸ§™â€â™‚ï¸')">ğŸ§™â€â™‚ï¸</span><span class="emoji-btn" onclick="setAvatar('ğŸ§™â€â™€ï¸')">ğŸ§™â€â™€ï¸</span>
                    <span class="emoji-btn" onclick="setAvatar('ğŸ±')">ğŸ±</span><span class="emoji-btn" onclick="setAvatar('ğŸ¶')">ğŸ¶</span>
                    <span class="emoji-btn" onclick="setAvatar('ğŸ¦Š')">ğŸ¦Š</span><span class="emoji-btn" onclick="setAvatar('ğŸ¼')">ğŸ¼</span>
                    <span class="emoji-btn" onclick="setAvatar('ğŸ¦')">ğŸ¦</span><span class="emoji-btn" onclick="setAvatar('ğŸ¯')">ğŸ¯</span>
                    <span class="emoji-btn" onclick="setAvatar('ğŸš€')">ğŸš€</span><span class="emoji-btn" onclick="setAvatar('âš¡')">âš¡</span>
                    <span class="emoji-btn" onclick="setAvatar('ğŸ”¥')">ğŸ”¥</span><span class="emoji-btn" onclick="setAvatar('ğŸ’')">ğŸ’</span>
                    <span class="emoji-btn" onclick="setAvatar('ğŸµ')">ğŸµ</span><span class="emoji-btn" onclick="setAvatar('ğŸŒ™')">ğŸŒ™</span>
                    <span class="emoji-btn" onclick="setAvatar('ğŸŒˆ')">ğŸŒˆ</span><span class="emoji-btn" onclick="setAvatar('ğŸ€')">ğŸ€</span>
                </div>
                <button onclick="saveSettings()" class="btn-primary w-full mt-5">
                    <i class="fas fa-save"></i> Sauvegarder le profil
                </button>
            </div>

            <!-- TAB AFFICHAGE -->
            <div id="tab-display" class="settings-panel">
                <div class="mb-4">
                    <p class="text-xs font-semibold uppercase opacity-50 mb-2">Police</p>
                    <select id="fontSelect" onchange="applyFont(this.value)" class="w-full p-2.5 border rounded-xl text-sm font-medium" style="border-color:var(--border);">
                        <option value="'Inter', sans-serif" selected>Inter (dÃ©faut)</option>
                        <option value="'Plus Jakarta Sans', sans-serif">Plus Jakarta Sans</option>
                        <option value="'Poppins', sans-serif">Poppins</option>
                        <option value="'Roboto', sans-serif">Roboto</option>
                        <option value="'Nunito', sans-serif">Nunito</option>
                        <option value="monospace">Monospace</option>
                    </select>
                </div>
                <div class="mb-4">
                    <p class="text-xs font-semibold uppercase opacity-50 mb-2">DensitÃ©</p>
                    <div class="flex gap-2">
                        <button onclick="setDensity('compact')" id="density-compact" class="flex-1 py-2.5 text-xs rounded-xl border font-semibold transition" style="border-color:var(--border);">Compact</button>
                        <button onclick="setDensity('normal')" id="density-normal" class="flex-1 py-2.5 text-xs rounded-xl border font-semibold transition" style="background:var(--primary);color:white;border-color:var(--primary);">Normal</button>
                        <button onclick="setDensity('comfortable')" id="density-comfortable" class="flex-1 py-2.5 text-xs rounded-xl border font-semibold transition" style="border-color:var(--border);">Large</button>
                    </div>
                </div>
                <div>
                    <p class="text-xs font-semibold uppercase opacity-50 mb-2">Rayon des cartes</p>
                    <div class="flex gap-2">
                        <button onclick="setRadius('sharp')" class="flex-1 py-2.5 text-xs rounded border font-semibold" style="border-color:var(--border);" id="radius-sharp">CarrÃ©</button>
                        <button onclick="setRadius('normal')" class="flex-1 py-2.5 text-xs rounded-xl border font-semibold" style="background:var(--primary);color:white;border-color:var(--primary);" id="radius-normal">Normal</button>
                        <button onclick="setRadius('round')" class="flex-1 py-2.5 text-xs rounded-2xl border font-semibold" style="border-color:var(--border);" id="radius-round">Arrondi</button>
                    </div>
                </div>
                <div class="mt-4">
                    <p class="text-xs font-semibold uppercase opacity-50 mb-2">Raccourcis clavier</p>
                    <div class="grid grid-cols-2 gap-1.5 text-xs">
                        <div class="p-2 rounded-lg font-medium" style="background:var(--border);"><kbd class="font-mono">Alt+1</kbd> Dashboard</div>
                        <div class="p-2 rounded-lg font-medium" style="background:var(--border);"><kbd class="font-mono">Alt+2</kbd> Cours</div>
                        <div class="p-2 rounded-lg font-medium" style="background:var(--border);"><kbd class="font-mono">Alt+3</kbd> Planning</div>
                        <div class="p-2 rounded-lg font-medium" style="background:var(--border);"><kbd class="font-mono">Alt+4</kbd> Notes</div>
                        <div class="p-2 rounded-lg font-medium" style="background:var(--border);"><kbd class="font-mono">Alt+5</kbd> Stats</div>
                        <div class="p-2 rounded-lg font-medium" style="background:var(--border);"><kbd class="font-mono">Alt+6</kbd> TÃ¢ches</div>
                    </div>
                </div>
            </div>

            <!-- TAB OPTIONS -->
            <div id="tab-options" class="settings-panel">
                <div class="space-y-2">
                    <label class="flex items-center justify-between p-3 rounded-xl card cursor-pointer">
                        <div><span class="font-semibold text-sm">Animations</span><p class="text-xs opacity-50">Transitions et effets</p></div>
                        <input type="checkbox" id="animationsToggle" checked class="w-5 h-5">
                    </label>
                    <label class="flex items-center justify-between p-3 rounded-xl card cursor-pointer">
                        <div><span class="font-semibold text-sm">Notifications</span><p class="text-xs opacity-50">Confirmations d'actions</p></div>
                        <input type="checkbox" id="notificationsToggle" checked class="w-5 h-5">
                    </label>
                    <label class="flex items-center justify-between p-3 rounded-xl card cursor-pointer">
                        <div><span class="font-semibold text-sm">Confettis ğŸ‰</span><p class="text-xs opacity-50">CÃ©lÃ©bration des bonnes notes</p></div>
                        <input type="checkbox" id="confettiToggle" checked class="w-5 h-5">
                    </label>
                    <label class="flex items-center justify-between p-3 rounded-xl card cursor-pointer">
                        <div><span class="font-semibold text-sm">Badge CM/TD/TP</span><p class="text-xs opacity-50">Type de cours sur le planning</p></div>
                        <input type="checkbox" id="showCourseTypeToggle" checked class="w-5 h-5">
                    </label>
                    <label class="flex items-center justify-between p-3 rounded-xl card cursor-pointer">
                        <div><span class="font-semibold text-sm">Mode focus ğŸ¯</span><p class="text-xs opacity-50">Interface Ã©purÃ©e</p></div>
                        <input type="checkbox" id="focusModeToggle" class="w-5 h-5" onchange="toggleFocusMode(this.checked)">
                    </label>
                    <label class="flex items-center justify-between p-3 rounded-xl card cursor-pointer">
                        <div><span class="font-semibold text-sm">Horloge en temps rÃ©el</span><p class="text-xs opacity-50">AffichÃ©e sur le dashboard</p></div>
                        <input type="checkbox" id="clockToggle" checked class="w-5 h-5" onchange="toggleClock(this.checked)">
                    </label>
                    
                    <div class="h-px my-3" style="background:var(--border);"></div>
                    
                    <button onclick="resetStreak()" class="btn-ghost w-full justify-center" style="border-color:#fed7aa; color:#f97316;">
                        <i class="fas fa-redo-alt"></i> RÃ©initialiser la sÃ©rie de travail
                    </button>
                </div>
            </div>

            <!-- TAB DONNÃ‰ES -->
            <div id="tab-data" class="settings-panel">
                <div class="space-y-2.5">
                    <button onclick="exportAllData()" class="btn-ghost w-full justify-center">
                        <i class="fas fa-download" style="color:#22c55e;"></i> Exporter toutes les donnÃ©es
                    </button>
                    <button onclick="importData()" class="btn-ghost w-full justify-center">
                        <i class="fas fa-upload" style="color:#3b82f6;"></i> Importer des donnÃ©es
                    </button>
                    <div class="h-px my-1" style="background:var(--border);"></div>
                    <button onclick="deleteAllCourses()" class="btn-ghost w-full justify-center" style="border-color:#fed7aa; color:#f97316;">
                        <i class="fas fa-trash-alt"></i> Supprimer tous les cours
                    </button>
                    <button onclick="resetApp()" class="btn-danger w-full justify-center">
                        <i class="fas fa-exclamation-triangle"></i> RÃ©initialiser l'application
                    </button>
                </div>
                <div class="mt-4 p-3 rounded-xl text-xs text-center" style="background:var(--border);">
                    <p class="opacity-50 mb-2">Toutes les donnÃ©es sont stockÃ©es localement dans ton navigateur.</p>
                    <div class="mt-3 pt-3" style="border-top: 1px solid var(--border);">
                        <p class="text-xs opacity-70 mb-1">DÃ©veloppÃ© par</p>
                        <p class="font-bold gradient-text">Mathieu Mercera</p>
                        <p class="text-xs opacity-50 mt-1">AMU Pro Â© 2026</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Nouveau Cours -->
    <div id="courseModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold gradient-text">â• Nouveau Cours</h3>
                <button onclick="closeCourseModal()" class="text-2xl">&times;</button>
            </div>
            
            <input type="text" id="courseNameInput" placeholder="Nom de la matiÃ¨re" class="w-full p-3 border rounded-lg mb-4" style="border-color: var(--border);">
            
            <select id="courseSemesterInput" class="w-full p-3 border rounded-lg mb-4" style="border-color: var(--border);">
                <option value="S1">Semestre 1</option>
                <option value="S2">Semestre 2</option>
            </select>
            
            <input type="number" id="courseEctsInput" placeholder="CrÃ©dits ECTS (optionnel)" min="0" max="30" step="0.5" class="w-full p-3 border rounded-lg mb-4" style="border-color: var(--border);">
            
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Couleur de la matiÃ¨re (pour l'agenda)</label>
                <div class="flex gap-2">
                    <button onclick="setCourseColor('#3b82f6')" class="w-10 h-10 rounded-full bg-blue-500 border-2 border-transparent hover:border-gray-800"></button>
                    <button onclick="setCourseColor('#8b5cf6')" class="w-10 h-10 rounded-full bg-purple-500 border-2 border-transparent hover:border-gray-800"></button>
                    <button onclick="setCourseColor('#ec4899')" class="w-10 h-10 rounded-full bg-pink-500 border-2 border-transparent hover:border-gray-800"></button>
                    <button onclick="setCourseColor('#22c55e')" class="w-10 h-10 rounded-full bg-green-500 border-2 border-transparent hover:border-gray-800"></button>
                    <button onclick="setCourseColor('#f59e0b')" class="w-10 h-10 rounded-full bg-amber-500 border-2 border-transparent hover:border-gray-800"></button>
                    <button onclick="setCourseColor('#ef4444')" class="w-10 h-10 rounded-full bg-red-500 border-2 border-transparent hover:border-gray-800"></button>
                    <button onclick="setCourseColor('#06b6d4')" class="w-10 h-10 rounded-full bg-cyan-500 border-2 border-transparent hover:border-gray-800"></button>
                </div>
            </div>
            
            <button onclick="addCourse()" class="w-full px-6 py-3 rounded-lg text-white font-medium" style="background: linear-gradient(135deg, var(--primary), var(--secondary));">
                <i class="fas fa-check mr-2"></i> CrÃ©er le cours
            </button>
        </div>
    </div>

    <!-- Modal Personnalisation Agenda -->
    <div id="scheduleSettingsModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold gradient-text">ğŸ¨ Personnaliser l'Agenda</h3>
                <button onclick="closeScheduleSettings()" class="text-2xl">&times;</button>
            </div>
            
            <div class="mb-6">
                <h4 class="font-bold mb-3">Horaires personnalisÃ©s</h4>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm mb-1">Heure de dÃ©but</label>
                        <input type="time" id="scheduleStartTime" value="08:00" class="w-full p-2 border rounded-lg" style="border-color: var(--border);">
                    </div>
                    <div>
                        <label class="block text-sm mb-1">Heure de fin</label>
                        <input type="time" id="scheduleEndTime" value="18:00" class="w-full p-2 border rounded-lg" style="border-color: var(--border);">
                    </div>
                </div>
            </div>

            <div class="mb-6">
                <h4 class="font-bold mb-3">Couleurs par matiÃ¨re</h4>
                <p class="text-sm opacity-70 mb-3">Choisis une couleur pour chaque cours dans l'agenda</p>
                <div id="courseColorsList" class="space-y-2"></div>
            </div>

            <div class="mb-6">
                <h4 class="font-bold mb-3">Affichage</h4>
                <label class="flex items-center justify-between mb-3 p-3 rounded-lg card cursor-pointer">
                    <span>Afficher le week-end</span>
                    <input type="checkbox" id="showWeekendToggle" class="w-5 h-5">
                </label>
                <label class="flex items-center justify-between mb-3 p-3 rounded-lg card cursor-pointer">
                    <span>Vue compacte</span>
                    <input type="checkbox" id="compactViewToggle" class="w-5 h-5">
                </label>
            </div>

            <button onclick="applyScheduleSettings()" class="w-full px-6 py-3 rounded-lg text-white font-medium" style="background: linear-gradient(135deg, var(--primary), var(--secondary));">
                <i class="fas fa-save mr-2"></i> Appliquer les paramÃ¨tres
            </button>
        </div>
    </div>

    <!-- Modal Ajouter / Modifier Cours Ã  l'Agenda -->
    <div id="addScheduleEventModal" class="modal">
        <div class="modal-content" style="max-width:520px;">
            <div class="flex justify-between items-center mb-5">
                <h3 id="scheduleModalTitle" class="text-2xl font-bold gradient-text">â• Ajouter un cours</h3>
                <button onclick="closeAddScheduleEvent()" class="text-2xl">&times;</button>
            </div>

            <!-- Onglets : Choisir depuis mes cours / Nom libre -->
            <div class="flex rounded-lg overflow-hidden border mb-5" style="border-color:var(--border);">
                <button id="tabPickCourse" onclick="switchEventTab('pick')"
                    class="flex-1 py-2 text-sm font-medium transition"
                    style="background:var(--primary);color:white;">
                    <i class="fas fa-book mr-1"></i> Mes cours
                </button>
                <button id="tabFreeName" onclick="switchEventTab('free')"
                    class="flex-1 py-2 text-sm font-medium transition"
                    style="background:var(--border);color:var(--text-main);">
                    <i class="fas fa-pen mr-1"></i> Nom libre
                </button>
            </div>

            <!-- Panneau : SÃ©lection depuis mes cours -->
            <div id="panelPickCourse">
                <label class="block text-sm font-medium mb-2">MatiÃ¨re</label>
                <select id="eventCourseSelect" class="w-full p-3 border rounded-lg mb-4" style="border-color:var(--border);">
                    <option value="">SÃ©lectionner une matiÃ¨re...</option>
                </select>
            </div>

            <!-- Panneau : Nom libre -->
            <div id="panelFreeName" class="hidden">
                <label class="block text-sm font-medium mb-2">Nom du cours</label>
                <input type="text" id="eventFreeName" placeholder="ex: SLP2U09L" class="w-full p-3 border rounded-lg mb-3" style="border-color:var(--border);">
                <label class="block text-sm font-medium mb-2">Couleur</label>
                <div class="flex gap-2 mb-4">
                    <button onclick="setEventFreeColor('#3b82f6')" class="w-8 h-8 rounded-full bg-blue-500 ring-2 ring-offset-1 ring-transparent hover:ring-blue-500 transition" data-freecolor="#3b82f6"></button>
                    <button onclick="setEventFreeColor('#8b5cf6')" class="w-8 h-8 rounded-full bg-purple-500 ring-2 ring-offset-1 ring-transparent hover:ring-purple-500 transition" data-freecolor="#8b5cf6"></button>
                    <button onclick="setEventFreeColor('#ec4899')" class="w-8 h-8 rounded-full bg-pink-500 ring-2 ring-offset-1 ring-transparent hover:ring-pink-500 transition" data-freecolor="#ec4899"></button>
                    <button onclick="setEventFreeColor('#22c55e')" class="w-8 h-8 rounded-full bg-green-500 ring-2 ring-offset-1 ring-transparent hover:ring-green-500 transition" data-freecolor="#22c55e"></button>
                    <button onclick="setEventFreeColor('#f59e0b')" class="w-8 h-8 rounded-full bg-amber-500 ring-2 ring-offset-1 ring-transparent hover:ring-amber-500 transition" data-freecolor="#f59e0b"></button>
                    <button onclick="setEventFreeColor('#ef4444')" class="w-8 h-8 rounded-full bg-red-500 ring-2 ring-offset-1 ring-transparent hover:ring-red-500 transition" data-freecolor="#ef4444"></button>
                    <button onclick="setEventFreeColor('#06b6d4')" class="w-8 h-8 rounded-full bg-cyan-500 ring-2 ring-offset-1 ring-transparent hover:ring-cyan-500 transition" data-freecolor="#06b6d4"></button>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3 mb-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Heure de dÃ©but</label>
                    <input type="time" id="eventStartTime" class="w-full p-2 border rounded-lg" style="border-color:var(--border);">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Heure de fin</label>
                    <input type="time" id="eventEndTime" class="w-full p-2 border rounded-lg" style="border-color:var(--border);">
                </div>
            </div>

            <input type="text" id="eventLocation" placeholder="Salle (optionnel)" class="w-full p-3 border rounded-lg mb-3" style="border-color:var(--border);">
            <textarea id="eventNotes" placeholder="Notes (optionnel)" class="w-full p-3 border rounded-lg mb-5" rows="2" style="border-color:var(--border);"></textarea>

            <div class="flex gap-3">
                <button id="deleteEventBtn" onclick="deleteCurrentEvent()" class="hidden px-4 py-3 rounded-lg border font-medium text-red-500 hover:bg-red-50 transition" style="border-color:#fca5a5;">
                    <i class="fas fa-trash mr-1"></i> Supprimer
                </button>
                <button onclick="saveScheduleEvent()" class="flex-1 px-4 py-3 rounded-lg text-white font-medium" style="background:linear-gradient(135deg,var(--primary),var(--secondary));">
                    <i class="fas fa-check mr-2"></i>
                    <span id="saveEventBtnLabel">Ajouter au planning</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Import EDT AMU -->
    <div id="edtImportModal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold gradient-text">ğŸ›ï¸ Importer mon EDT AMU</h3>
                <button onclick="closeEdtImportModal()" class="text-2xl">&times;</button>
            </div>

            <div class="p-4 rounded-lg mb-5" style="background: #fff7ed; border: 1px solid #fed7aa;">
                <p class="text-sm font-medium mb-1" style="color: #c2410c;"><i class="fas fa-info-circle mr-2"></i>Comment Ã§a marche ?</p>
                <p class="text-xs opacity-80" style="color: #9a3412;">
                    Colle le lien iCal de ton EDT AMU (ADE) ci-dessous. Tu peux modifier les dates pour choisir la pÃ©riode Ã  importer. Les cours seront automatiquement ajoutÃ©s Ã  ton planning.
                </p>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">ğŸ”— Lien iCal ADE</label>
                <textarea id="edtUrlInput" rows="3" class="w-full p-3 border rounded-lg text-xs" style="border-color: var(--border); font-family: monospace;"
                    placeholder="https://ade-web-consult.univ-amu.fr/jsp/custom/modules/plannings/anonymous_cal.jsp?...">https://ade-web-consult.univ-amu.fr/jsp/custom/modules/plannings/anonymous_cal.jsp?projectId=8&resources=146872&calType=vcal&firstDate=2026-02-16&lastDate=2026-02-20</textarea>
            </div>

            <div class="grid grid-cols-2 gap-3 mb-5">
                <div>
                    <label class="block text-sm font-medium mb-2">ğŸ“… Date de dÃ©but</label>
                    <input type="date" id="edtFirstDate" class="w-full p-3 border rounded-lg" style="border-color: var(--border);">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">ğŸ“… Date de fin</label>
                    <input type="date" id="edtLastDate" class="w-full p-3 border rounded-lg" style="border-color: var(--border);">
                </div>
            </div>

            <div class="mb-5 p-3 rounded-lg text-sm" style="background: var(--border);">
                <label class="flex items-center gap-3 cursor-pointer">
                    <input type="checkbox" id="edtReplaceExisting" class="w-4 h-4">
                    <span>Remplacer les cours existants sur la pÃ©riode importÃ©e</span>
                </label>
            </div>

            <div id="edtModalStatus" class="hidden p-3 rounded-lg mb-4 text-sm font-medium"></div>

            <div class="flex gap-3">
                <button onclick="closeEdtImportModal()" class="flex-1 px-4 py-3 rounded-lg border font-medium" style="border-color: var(--border);">
                    Annuler
                </button>
                <button onclick="importEdtAmu()" class="flex-1 px-4 py-3 rounded-lg text-white font-medium" style="background: linear-gradient(135deg, #f97316, #ea580c);">
                    <i class="fas fa-file-import mr-2"></i> Importer
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Ã‰dition de Note -->
    <div id="editGradeModal" class="modal">
        <div class="modal-content" style="max-width:480px;">
            <div class="flex justify-between items-center mb-5">
                <h3 class="text-2xl font-bold gradient-text">âœï¸ Modifier la note</h3>
                <button onclick="closeEditGrade()" class="text-2xl">&times;</button>
            </div>

            <input type="hidden" id="editGradeId">
            
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">IntitulÃ©</label>
                <input type="text" id="editGradeLabel" placeholder="Ex: ContrÃ´le continu 1" class="w-full p-3 border rounded-lg" style="border-color: var(--border);">
            </div>

            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Note /20</label>
                    <input type="number" id="editGradeValue" min="0" max="20" step="0.01" placeholder="15.5" class="w-full p-3 border rounded-lg" style="border-color: var(--border);">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Coefficient</label>
                    <input type="number" id="editGradeCoef" min="0.1" max="10" step="0.1" placeholder="1" class="w-full p-3 border rounded-lg" style="border-color: var(--border);">
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="closeEditGrade()" class="flex-1 px-4 py-3 rounded-lg border font-medium" style="border-color: var(--border);">
                    Annuler
                </button>
                <button onclick="saveEditGrade()" class="flex-1 px-4 py-3 rounded-lg text-white font-medium" style="background: linear-gradient(135deg, var(--primary), var(--secondary));">
                    <i class="fas fa-save mr-2"></i> Enregistrer
                </button>
            </div>
        </div>
    </div>

    <!-- Floating Action Button -->
    <div class="floating-action" onclick="openQuickMenu()" title="Menu rapide">
        <i class="fas fa-magic text-2xl"></i>
    </div>

    <script>
        // ===== BASE DE DONNÃ‰ES =====
        const db = new Dexie("MyStudyAppUltimate");
        db.version(5).stores({
            courses: '++id, name, semester, color, ects',
            files: '++id, courseId, name, blob, category',
            grades: '++id, courseId, label, value, coef, date',
            schedule: 'id, content',
            scheduleEvents: '++id, courseId, day, startTime, endTime, location, notes, weekStart',
            tasks: '++id, title, status, priority, date, completed',
            settings: 'key, value'
        });


        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ†• TOAST NOTIFICATIONS (early init)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function showToast(msg, type = 'info', duration = 3500) {
            const container = document.getElementById('toast-container');
            if (!container) return;
            const toast = document.createElement('div');
            const icons = { success:'âœ…', warning:'âš ï¸', error:'âŒ', info:'â„¹ï¸' };
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `<span>${icons[type] || 'â„¹ï¸'}</span><span>${msg}</span>`;
            container.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('toast-out');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        let selectedCourseColor = '#3b82f6';
        let copiedScheduleCell = null;
        let currentWeekStart = getMonday(new Date());
        let selectedScheduleCell = null;

        // ===== DÃ‰TECTION ET CORRECTION DU ZOOM =====
        function checkAndFixZoom() {
            // DÃ©tecter si le viewport est trop petit
            const viewportWidth = window.innerWidth;
            const screenWidth = window.screen.width;
            
            console.log('ğŸ“ Dimensions:', {
                viewport: viewportWidth,
                screen: screenWidth,
                ratio: viewportWidth / screenWidth
            });
            
            // Si le viewport semble trop petit par rapport Ã  l'Ã©cran, c'est probablement un zoom
            if (viewportWidth < 900 && screenWidth > 1200) {
                console.warn('âš ï¸ Zoom dÃ©tectÃ© - tentative de correction');
                document.body.style.zoom = '1.0';
                document.documentElement.style.zoom = '1.0';
            }
        }
        
        // ExÃ©cuter au chargement et au redimensionnement
        window.addEventListener('load', checkAndFixZoom);
        window.addEventListener('resize', checkAndFixZoom);

        // ===== SETTINGS & THEME =====
        async function loadSettings() {
            const theme    = await getSetting('theme') || 'light';
            const userName = await getSetting('userName') || 'Champion';
            const avatar   = await getSetting('avatar') || 'ğŸ‘¨â€ğŸ“';

            setTheme(theme);
            document.getElementById('userName').value = userName;
            updateGreeting();

            // Radius
            const radius = await getSetting('borderRadius') || 'normal';
            setRadius(radius);

            // Horloge
            const showClockPref = await getSetting('showClock');
            if (showClockPref !== false) {
                setTimeout(() => toggleClock(true), 150);
            }
        }

        async function getSetting(key) {
            const setting = await db.settings.get(key);
            return setting ? setting.value : null;
        }

        async function setSetting(key, value) {
            await db.settings.put({ key, value });
        }

        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            setSetting('theme', theme);
            updateThemeSwatches(theme);
            // Update dark toggle icon if it exists
            try { updateDarkToggleIcon(); } catch(e) {}
        }

        async function setAvatar(emoji) {
            await setSetting('avatar', emoji);
            updateGreeting();
            showNotification('Avatar mis Ã  jour ! ' + emoji);
        }

        async function updateGreeting() {
            const hour = new Date().getHours();
            const userName = await getSetting('userName') || 'Champion';
            const avatar = await getSetting('avatar') || 'ğŸ‘¨â€ğŸ“';
            const userTitle = await getUserTitle();
            
            let greeting = '';
            if (hour < 12) greeting = 'Bonjour';
            else if (hour < 18) greeting = 'Bon aprÃ¨s-midi';
            else greeting = 'Bonsoir';
            
            document.getElementById('greeting').innerHTML = `${avatar} ${greeting} <span class="gradient-text">${userName}</span>, ${userTitle} !`;
            
            // Citation motivante alÃ©atoire
            const quotes = [
                "La rÃ©ussite commence par un effort quotidien.",
                "Chaque jour est une nouvelle opportunitÃ©.",
                "Crois en toi et tout est possible !",
                "Le succÃ¨s est la somme de petits efforts rÃ©pÃ©tÃ©s.",
                "Tu es plus fort que tu ne le penses !",
                "L'Ã©chec est le fondement de la rÃ©ussite.",
                "Vise la lune, mÃªme si tu la rates, tu atterriras parmi les Ã©toiles.",
                "Le seul moyen d'Ã©chouer est d'abandonner."
            ];
            document.getElementById('motivational-quote').innerText = quotes[Math.floor(Math.random() * quotes.length)];
            const dateEl = document.getElementById('dash-date');
            if (dateEl) dateEl.textContent = new Date().toLocaleDateString('fr-FR', { weekday:'long', day:'numeric', month:'long' });
        }

        document.getElementById('userName').addEventListener('change', (e) => {
            setSetting('userName', e.target.value);
            updateGreeting();
        });

        // ===== ANIMATIONS DE FOND AVEC Ã‰MOJIS =====
        const EMOJI_SETS = {
            dashboard: ['ğŸ“š', 'âœï¸', 'ğŸ“–', 'ğŸ“', 'ğŸ’¡', 'â­', 'ğŸš€', 'ğŸ’ª', 'ğŸ”¥', 'âœ¨'],
            courses: ['ğŸ“š', 'ğŸ“•', 'ğŸ“—', 'ğŸ“˜', 'ğŸ“™', 'ğŸ““', 'ğŸ“”', 'ğŸ“–', 'ğŸ“„', 'ğŸ“ƒ'],
            schedule: ['ğŸ“…', 'ğŸ—“ï¸', 'â°', 'â±ï¸', 'âŒš', 'ğŸ•', 'ğŸ•‘', 'ğŸ•’', 'ğŸ“†', 'â²ï¸'],
            grades: ['â­', 'ğŸŒŸ', 'âœ¨', 'ğŸ†', 'ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', 'ğŸ’¯', 'ğŸ“Š', 'ğŸ“ˆ'],
            stats: ['ğŸ“Š', 'ğŸ“ˆ', 'ğŸ“‰', 'ğŸ’¹', 'ğŸ¯', 'ğŸ“', 'ğŸ“', 'ğŸ§®', 'ğŸ’¼', 'ğŸ“‹'],
            tasks: ['âœ…', 'âœ“', 'â˜‘ï¸', 'âœ”ï¸', 'ğŸ“', 'ğŸ“Œ', 'ğŸ“', 'ğŸ¯', 'ğŸ”–', 'ğŸ’ª'],
            achievements: ['ğŸ†', 'ğŸ¥‡', 'ğŸ–ï¸', 'ğŸ‘‘', 'ğŸ’', 'â­', 'ğŸŒŸ', 'âœ¨', 'ğŸ”¥', 'ğŸ’ª']
        };

        let currentEmojis = [];
        let emojiInterval = null;

        function createFloatingEmoji(emoji) {
            const emojiEl = document.createElement('div');
            emojiEl.className = 'floating-emoji';
            emojiEl.textContent = emoji;
            
            // Position alÃ©atoire horizontale
            emojiEl.style.left = Math.random() * 100 + '%';
            
            // Variation de taille
            const size = 1.5 + Math.random() * 1.5; // Entre 1.5rem et 3rem
            emojiEl.style.fontSize = size + 'rem';
            
            // Variation d'animation
            const animations = ['float', 'floatSlow', 'floatMedium'];
            const randomAnimation = animations[Math.floor(Math.random() * animations.length)];
            emojiEl.style.animationName = randomAnimation;
            
            // DurÃ©e alÃ©atoire
            const duration = 15 + Math.random() * 15; // Entre 15s et 30s
            emojiEl.style.animationDuration = duration + 's';
            
            // DÃ©lai alÃ©atoire
            const delay = Math.random() * 5;
            emojiEl.style.animationDelay = delay + 's';
            
            return emojiEl;
        }

        function startFloatingEmojis(tabId) {
            // Nettoyer les Ã©mojis existants
            stopFloatingEmojis();
            
            const container = document.getElementById('floating-emojis-container');
            if (!container) return;
            
            const emojis = EMOJI_SETS[tabId] || EMOJI_SETS.dashboard;
            
            // CrÃ©er 8-12 Ã©mojis
            const count = 8 + Math.floor(Math.random() * 5);
            for (let i = 0; i < count; i++) {
                const randomEmoji = emojis[Math.floor(Math.random() * emojis.length)];
                const emojiEl = createFloatingEmoji(randomEmoji);
                container.appendChild(emojiEl);
                currentEmojis.push(emojiEl);
            }
            
            // Ajouter pÃ©riodiquement de nouveaux Ã©mojis (tous les 5-8 secondes)
            emojiInterval = setInterval(() => {
                if (currentEmojis.length < 15) {
                    const randomEmoji = emojis[Math.floor(Math.random() * emojis.length)];
                    const emojiEl = createFloatingEmoji(randomEmoji);
                    container.appendChild(emojiEl);
                    currentEmojis.push(emojiEl);
                    
                    // Supprimer aprÃ¨s l'animation
                    setTimeout(() => {
                        if (emojiEl.parentNode) {
                            emojiEl.remove();
                            currentEmojis = currentEmojis.filter(e => e !== emojiEl);
                        }
                    }, 30000); // 30 secondes max
                }
            }, 5000 + Math.random() * 3000);
        }

        function stopFloatingEmojis() {
            const container = document.getElementById('floating-emojis-container');
            if (container) {
                container.innerHTML = '';
            }
            currentEmojis = [];
            if (emojiInterval) {
                clearInterval(emojiInterval);
                emojiInterval = null;
            }
        }

        // ===== NAVIGATION =====
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item-mobile').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            
            // Marquer l'item actif dans la nav desktop
            const navButtons = document.querySelectorAll('.nav-item');
            navButtons.forEach(btn => {
                if(btn.textContent.toLowerCase().includes(tabId === 'dashboard' ? 'dashboard' : 
                   tabId === 'courses' ? 'cours' : 
                   tabId === 'schedule' ? 'planning' : 
                   tabId === 'grades' ? 'notes' :
                   tabId === 'stats' ? 'stats' : 
                   tabId === 'achievements' ? 'succÃ¨s' : 'tÃ¢ches')) {
                    btn.classList.add('active');
                }
            });

            // Marquer l'item actif dans la nav mobile
            const mobileButtons = document.querySelectorAll('.nav-item-mobile');
            mobileButtons.forEach(btn => {
                if(btn.textContent.toLowerCase().includes(tabId === 'dashboard' ? 'dashboard' : 
                   tabId === 'courses' ? 'cours' : 
                   tabId === 'schedule' ? 'planning' : 
                   tabId === 'grades' ? 'notes' :
                   tabId === 'stats' ? 'stats' : 
                   tabId === 'achievements' ? 'succÃ¨s' : 'tÃ¢ches')) {
                    btn.classList.add('active');
                }
            });
            
            if (tabId === 'stats') renderCharts();
            if (tabId === 'dashboard') updateDashboard();
            if (tabId === 'tasks') renderTasks();
            
            // DÃ©marrer les animations d'Ã©mojis pour cet onglet
            startFloatingEmojis(tabId);
        }

        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            const icon = document.querySelector('#mobileMenuBtn i');
            
            if(menu.classList.contains('hidden')) {
                menu.classList.remove('hidden');
                icon.classList.remove('fa-bars');
                icon.classList.add('fa-times');
            } else {
                menu.classList.add('hidden');
                icon.classList.remove('fa-times');
                icon.classList.add('fa-bars');
            }
        }

        function closeMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            const icon = document.querySelector('#mobileMenuBtn i');
            menu.classList.add('hidden');
            icon.classList.remove('fa-times');
            icon.classList.add('fa-bars');
        }

        // ===== MODALS =====
        function openSettings() {
            document.getElementById('settingsModal').classList.add('active');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        function openCourseModal() {
            document.getElementById('courseModal').classList.add('active');
        }

        function closeCourseModal() {
            document.getElementById('courseModal').classList.remove('active');
        }

        function setCourseColor(color) {
            selectedCourseColor = color;
        }

        // ===== COURS =====
        async function addCourse() {
            const name = document.getElementById('courseNameInput').value;
            const semester = document.getElementById('courseSemesterInput').value;
            const ects = parseFloat(document.getElementById('courseEctsInput').value) || null;
            
            if(!name) return showNotification('âš ï¸ Nom manquant', 'warning');

            await db.courses.add({ name, semester, color: selectedCourseColor, ects });
            document.getElementById('courseNameInput').value = '';
            document.getElementById('courseEctsInput').value = '';
            selectedCourseColor = '#3b82f6';
            closeCourseModal();
            showNotification('âœ… Cours ajoutÃ© avec succÃ¨s !');
            await refreshUI();
            launchConfetti();
            await checkAndUpdateAchievements(); // VÃ©rifier les succÃ¨s
        }

        // CatÃ©gories de fichiers
        const FILE_CATEGORIES = [
            { id: 'cm',    label: 'CM',            icon: 'fa-chalkboard-teacher', color: '#3b82f6' },
            { id: 'td',    label: 'TD',             icon: 'fa-pencil-alt',         color: '#8b5cf6' },
            { id: 'tp',    label: 'TP',             icon: 'fa-flask',              color: '#06b6d4' },
            { id: 'fiche', label: 'Fiches',         icon: 'fa-sticky-note',        color: '#f59e0b' },
            { id: 'exam',  label: 'Examens',        icon: 'fa-graduation-cap',     color: '#ef4444' },
            { id: 'autre', label: 'Autre',          icon: 'fa-folder',             color: '#6b7280' },
        ];

        async function uploadFile(courseId, inputElement, category) {
            const file = inputElement.files[0];
            if (!file) return;
            const cat = category || 'autre';
            await db.files.add({ courseId, name: file.name, blob: file, category: cat });
            showNotification('ğŸ“„ Fichier ajoutÃ© !');
            await refreshUI();
            await checkAndUpdateAchievements(); // VÃ©rifier les succÃ¨s
        }

        async function deleteFile(id) {
            if(confirm('Supprimer ce fichier ?')) {
                await db.files.delete(id);
                showNotification('ğŸ—‘ï¸ Fichier supprimÃ©');
                await refreshUI();
            }
        }

        async function deleteCourse(id) {
            if(confirm('Supprimer ce cours et tous ses fichiers/notes ?')) {
                await db.courses.delete(id);
                await db.files.where('courseId').equals(id).delete();
                await db.grades.where('courseId').equals(id).delete();
                showNotification('ğŸ—‘ï¸ Cours supprimÃ©');
                await refreshUI();
            }
        }

        function filterCourses(filter) {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            document.querySelectorAll('.course-card').forEach(card => {
                if(filter === 'all' || card.dataset.semester === filter) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        async function renderCourses() {
            let courses = await db.courses.toArray();
            const container = document.getElementById('coursesList');
            const select = document.getElementById('gradeCourseSelect');

            container.innerHTML = '';
            select.innerHTML = '<option value="">Choisir une matiÃ¨re...</option>';

            // Tri selon sÃ©lection
            const sortVal = document.getElementById('coursesSortSelect')?.value || 'name';
            if (sortVal === 'name') {
                courses.sort((a, b) => a.name.localeCompare(b.name));
            } else if (sortVal === 'semester') {
                courses.sort((a, b) => a.semester.localeCompare(b.semester) || a.name.localeCompare(b.name));
            } else if (sortVal === 'avg') {
                const avgs = {};
                for (const c of courses) {
                    const g = await db.grades.where('courseId').equals(c.id).toArray();
                    avgs[c.id] = g.length > 0 ? g.reduce((a,b) => a + b.value*(b.coef||1),0) / g.reduce((a,b) => a+(b.coef||1),0) : -1;
                }
                courses.sort((a, b) => avgs[b.id] - avgs[a.id]);
            }

            // Compteur
            const countEl = document.getElementById('coursesCount');
            if (countEl) countEl.textContent = `${courses.length} cours au total`;

            const s1Courses = courses.filter(c => c.semester === 'S1');
            const s2Courses = courses.filter(c => c.semester === 'S2');

            const renderSemesterCourses = async (semesterCourses, semesterName) => {
                if(semesterCourses.length === 0) return;

                const semesterDiv = document.createElement('div');
                semesterDiv.className = 'col-span-full mb-4';
                semesterDiv.innerHTML = `
                    <div class="flex items-center gap-3 mb-4">
                        <h4 class="text-xl font-bold gradient-text">${semesterName}</h4>
                        <div class="flex-1 h-px" style="background: var(--border);"></div>
                        <span class="badge" style="background: var(--border); color: var(--text-main);">${semesterCourses.length} cours</span>
                    </div>
                `;
                container.appendChild(semesterDiv);

                for (const course of semesterCourses) {
                    const option = document.createElement('option');
                    option.value = course.id;
                    option.innerText = `${course.name} (${course.semester})`;
                    select.appendChild(option);

                    const files = await db.files.where('courseId').equals(course.id).toArray();
                    const grades = await db.grades.where('courseId').equals(course.id).toArray();
                    const avgGrade = grades.length > 0 ? (grades.reduce((a, b) => a + (b.value * (b.coef || 1)), 0) / grades.reduce((a, b) => a + (b.coef || 1), 0)).toFixed(2) : '--';

                    const div = document.createElement('div');
                    div.className = 'card rounded-lg p-5 hover:shadow-xl transition course-card';
                    div.dataset.semester = course.semester;
                    div.style.borderLeft = `4px solid ${course.color || '#3b82f6'}`;
                    
                    div.innerHTML = `
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex-1">
                                <h4 class="font-bold text-xl mb-2" style="color: ${course.color}">${course.name}</h4>
                                <div class="flex gap-2 flex-wrap">
                                    <span class="badge text-xs" style="background: ${course.color}; color: white;">${course.semester}</span>
                                    ${course.ects ? `<span class="badge text-xs" style="background: var(--secondary); color: white;">ğŸ“ ${course.ects} ECTS</span>` : ''}
                                    <span class="badge text-xs" style="background: var(--border); color: var(--text-main);">
                                        ğŸ“Š Moyenne: ${avgGrade}/20
                                    </span>
                                    <span class="badge text-xs" style="background: var(--border); color: var(--text-main);">
                                        ğŸ“ ${files.length} fichier${files.length > 1 ? 's' : ''}
                                    </span>
                                    <span class="badge text-xs" style="background: var(--border); color: var(--text-main);">
                                        ğŸ“ ${grades.length} note${grades.length > 1 ? 's' : ''}
                                    </span>
                                </div>
                            </div>
                            <button onclick="deleteCourse(${course.id})" class="text-red-500 hover:text-red-700 text-xl transition" title="Supprimer le cours">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        
                        <!-- Zone d'upload par catÃ©gorie -->
                        <div class="mb-3">
                            <p class="text-xs font-semibold uppercase opacity-50 mb-2">ğŸ“ Ajouter un fichier</p>
                            <div class="flex flex-wrap gap-2">
                                ${FILE_CATEGORIES.map(cat => `
                                    <label class="cursor-pointer flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-semibold text-white transition hover:opacity-80 active:scale-95"
                                        style="background:${cat.color};" title="Ajouter un fichier ${cat.label}">
                                        <i class="fas ${cat.icon}"></i>
                                        <span>${cat.label}</span>
                                        <input type="file" class="hidden" accept=".pdf,.jpg,.jpeg,.png,.docx,.doc,.ppt,.pptx"
                                            onchange="uploadFile(${course.id}, this, '${cat.id}')">
                                    </label>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Onglets fichiers par catÃ©gorie -->
                        <div class="card rounded-lg overflow-hidden">
                            <!-- Barre d'onglets -->
                            <div class="flex overflow-x-auto border-b" style="border-color:var(--border); scrollbar-width:none;">
                                <button onclick="switchFileTab(this, ${course.id}, 'all')"
                                    class="file-tab-btn flex-shrink-0 px-3 py-2 text-xs font-semibold border-b-2 transition whitespace-nowrap"
                                    style="border-color:var(--primary); color:var(--primary);"
                                    data-course="${course.id}" data-cat="all">
                                    Tous <span class="ml-1 opacity-60">(${files.length})</span>
                                </button>
                                ${FILE_CATEGORIES.map(cat => {
                                    const count = files.filter(f => (f.category||'autre') === cat.id).length;
                                    return `<button onclick="switchFileTab(this, ${course.id}, '${cat.id}')"
                                        class="file-tab-btn flex-shrink-0 px-3 py-2 text-xs font-medium border-b-2 border-transparent transition whitespace-nowrap hover:opacity-80"
                                        style="color:${cat.color};"
                                        data-course="${course.id}" data-cat="${cat.id}">
                                        <i class="fas ${cat.icon} mr-1"></i>${cat.label}
                                        ${count > 0 ? `<span class="ml-1 font-bold">${count}</span>` : ''}
                                    </button>`;
                                }).join('')}
                            </div>

                            <!-- Contenu des fichiers -->
                            <div class="p-3">
                                <div class="flex justify-between items-center mb-2">
                                    <span id="file-tab-label-${course.id}" class="text-xs font-bold uppercase opacity-50">Tous les fichiers</span>
                                    ${files.length > 0 ? `<button onclick="downloadAllFiles(${course.id}, '${course.name}')" class="text-xs hover:underline" style="color:${course.color};">â¬‡ Tout tÃ©lÃ©charger</button>` : ''}
                                </div>
                                <ul id="file-list-${course.id}" class="space-y-1.5 max-h-52 overflow-y-auto">
                                    ${files.length === 0
                                        ? '<li class="text-xs opacity-40 italic text-center py-4">Aucun fichier â€” clique sur une catÃ©gorie pour en ajouter</li>'
                                        : files.map(f => {
                                            const cat = FILE_CATEGORIES.find(c => c.id === (f.category||'autre')) || FILE_CATEGORIES[5];
                                            return `<li class="file-item flex items-center gap-2 text-sm p-2 rounded-lg transition hover:shadow" data-cat="${f.category||'autre'}" style="background:var(--border);">
                                                <span class="flex-shrink-0 w-6 h-6 rounded flex items-center justify-center text-white text-xs" style="background:${cat.color};">
                                                    <i class="fas ${cat.icon}"></i>
                                                </span>
                                                <a href="${URL.createObjectURL(f.blob)}" target="_blank" class="truncate flex-1 hover:underline font-medium text-xs" style="color:var(--primary);">
                                                    ${f.name}
                                                </a>
                                                <span class="text-xs font-bold px-1.5 py-0.5 rounded flex-shrink-0" style="background:${cat.color}20; color:${cat.color};">${cat.label}</span>
                                                <button onclick="deleteFile(${f.id})" class="flex-shrink-0 text-red-400 hover:text-red-600 transition text-xs">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </li>`;
                                        }).join('')
                                    }
                                </ul>
                            </div>
                        </div>
                    `;
                    container.appendChild(div);
                }
            };

            await renderSemesterCourses(s1Courses, 'ğŸ“˜ Semestre 1');
            await renderSemesterCourses(s2Courses, 'ğŸ“— Semestre 2');
            
            const fileCount = await db.files.count();
            document.getElementById('dash-files-count').innerText = fileCount;
        }

        // ===== ONGLETS FICHIERS PAR CATÃ‰GORIE =====
        function switchFileTab(btn, courseId, category) {
            // Mettre Ã  jour l'apparence des onglets
            document.querySelectorAll(`.file-tab-btn[data-course="${courseId}"]`).forEach(b => {
                const cat = FILE_CATEGORIES.find(c => c.id === b.dataset.cat);
                b.style.borderColor  = 'transparent';
                b.style.color        = cat ? cat.color : 'var(--text-main)';
                b.style.fontWeight   = '500';
            });

            // Activer l'onglet cliquÃ©
            const activeCat = FILE_CATEGORIES.find(c => c.id === category);
            btn.style.borderColor = activeCat ? activeCat.color : 'var(--primary)';
            btn.style.color       = activeCat ? activeCat.color : 'var(--primary)';
            btn.style.fontWeight  = '700';

            // Filtrer les fichiers
            const items = document.querySelectorAll(`#file-list-${courseId} .file-item`);
            items.forEach(item => {
                item.style.display = (category === 'all' || item.dataset.cat === category) ? '' : 'none';
            });

            // Mettre Ã  jour le label
            const label = document.getElementById(`file-tab-label-${courseId}`);
            if (label) {
                label.textContent = category === 'all'
                    ? 'Tous les fichiers'
                    : (activeCat ? `Fichiers â€” ${activeCat.label}` : category);
            }
        }

        async function downloadAllFiles(courseId, courseName) {
            const files = await db.files.where('courseId').equals(courseId).toArray();
            
            for(const file of files) {
                const url = URL.createObjectURL(file.blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = file.name;
                a.click();
                await new Promise(resolve => setTimeout(resolve, 200)); // DÃ©lai entre tÃ©lÃ©chargements
            }
            
            showNotification(`ğŸ“¥ ${files.length} fichier(s) de ${courseName} tÃ©lÃ©chargÃ©(s) !`);
        }

        // ===== NOTES =====
        async function addGrade() {
            const courseId = parseInt(document.getElementById('gradeCourseSelect').value);
            const value = parseFloat(document.getElementById('gradeValue').value);
            const coef = parseFloat(document.getElementById('gradeCoef').value) || 1;
            const label = document.getElementById('gradeLabel').value;
            const date = new Date().toISOString();

            if (!courseId || isNaN(value)) return showNotification('âš ï¸ Veuillez remplir les champs', 'warning');

            await db.grades.add({ courseId, value, coef, label, date });
            document.getElementById('gradeValue').value = '';
            document.getElementById('gradeLabel').value = '';
            document.getElementById('gradeCoef').value = '1';
            
            showNotification('ğŸ¯ Note enregistrÃ©e !');
            await refreshUI();
            await checkAndUpdateAchievements(); // VÃ©rifier les succÃ¨s
            
            if(value >= 15) launchConfetti();
        }

        async function renderGrades() {
            const courses = await db.courses.toArray();
            const container = document.getElementById('gradesList');
            container.innerHTML = '';
            
            let totalWeightedSum = 0;
            let totalCoef = 0;
            
            // Variables pour moyennes par semestre
            let s1WeightedSum = 0;
            let s1Coef = 0;
            let s2WeightedSum = 0;
            let s2Coef = 0;

            // Grouper par semestre
            const s1Courses = courses.filter(c => c.semester === 'S1');
            const s2Courses = courses.filter(c => c.semester === 'S2');

            const renderSemester = async (semesterCourses, semesterName, isS1) => {
                const semesterDiv = document.createElement('div');
                semesterDiv.className = 'mb-6';
                
                let semesterHtml = `
                    <div class="flex items-center gap-3 mb-4">
                        <h4 class="text-xl font-bold gradient-text">${semesterName}</h4>
                        <div class="flex-1 h-px" style="background: var(--border);"></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                `;

                let semesterTotal = 0;
                let semesterCoefTotal = 0;

                for (const course of semesterCourses) {
                    const grades = await db.grades.where('courseId').equals(course.id).toArray();
                    if (grades.length === 0) continue;

                    const weightedSum = grades.reduce((a, b) => a + (b.value * (b.coef || 1)), 0);
                    const coefSum = grades.reduce((a, b) => a + (b.coef || 1), 0);
                    const avg = (weightedSum / coefSum).toFixed(2);
                    
                    // Utiliser les ECTS comme coefficient du cours, sinon coefficient = 1
                    const courseCoef = course.ects || 1;
                    
                    totalWeightedSum += parseFloat(avg) * courseCoef;
                    totalCoef += courseCoef;
                    semesterTotal += parseFloat(avg) * courseCoef;
                    semesterCoefTotal += courseCoef;
                    
                    // Accumuler pour moyennes par semestre
                    if (isS1) {
                        s1WeightedSum += parseFloat(avg) * courseCoef;
                        s1Coef += courseCoef;
                    } else {
                        s2WeightedSum += parseFloat(avg) * courseCoef;
                        s2Coef += courseCoef;
                    }

                    // Calcul des stats
                    const maxGrade = Math.max(...grades.map(g => g.value));
                    const minGrade = Math.min(...grades.map(g => g.value));
                    const lastGrade = grades.sort((a, b) => new Date(b.date) - new Date(a.date))[0];

                    semesterHtml += `
                        <div class="card rounded-lg p-5 hover:shadow-xl transition" style="border-left: 4px solid ${course.color || '#3b82f6'};">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex-1">
                                    <h5 class="font-bold text-lg mb-1" style="color: ${course.color}">${course.name}</h5>
                                    <div class="flex gap-2 flex-wrap">
                                        <span class="badge text-xs" style="background: ${course.color}; color: white;">
                                            ${grades.length} note${grades.length > 1 ? 's' : ''}
                                        </span>
                                        ${course.ects ? `<span class="badge text-xs" style="background: var(--secondary); color: white;">ğŸ“ ${course.ects} ECTS</span>` : ''}
                                        <span class="badge text-xs" style="background: var(--border); color: var(--text-main);">
                                            ğŸ“Š Moy: ${avg}/20
                                        </span>
                                        ${avg >= 15 ? '<span class="badge text-xs" style="background: #22c55e; color: white;">ğŸŒŸ Excellent</span>' : 
                                          avg >= 12 ? '<span class="badge text-xs" style="background: #f59e0b; color: white;">ğŸ‘ Bien</span>' : 
                                          avg >= 10 ? '<span class="badge text-xs" style="background: #3b82f6; color: white;">âœ“ ValidÃ©</span>' : 
                                          '<span class="badge text-xs" style="background: #ef4444; color: white;">âš ï¸ Ã€ amÃ©liorer</span>'}
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-3xl font-bold ${avg < 10 ? 'text-red-500' : avg < 14 ? 'text-yellow-500' : 'text-green-600'}">${avg}</div>
                                    <div class="text-xs opacity-60">/20</div>
                                </div>
                            </div>
                            
                            <div class="progress-bar mb-3">
                                <div class="progress-fill" style="width: ${(avg/20)*100}%; background: ${course.color || 'var(--primary)'}"></div>
                            </div>

                            <div class="grid grid-cols-3 gap-2 mb-3 text-center">
                                <div class="p-2 rounded" style="background: var(--border);">
                                    <div class="text-xs opacity-60">Meilleure</div>
                                    <div class="font-bold text-green-600">${maxGrade}/20</div>
                                </div>
                                <div class="p-2 rounded" style="background: var(--border);">
                                    <div class="text-xs opacity-60">DerniÃ¨re</div>
                                    <div class="font-bold" style="color: ${course.color}">${lastGrade.value}/20</div>
                                </div>
                                <div class="p-2 rounded" style="background: var(--border);">
                                    <div class="text-xs opacity-60">Plus basse</div>
                                    <div class="font-bold text-red-600">${minGrade}/20</div>
                                </div>
                            </div>

                            <details class="cursor-pointer">
                                <summary class="font-medium text-sm mb-2 hover:opacity-70 transition">
                                    <i class="fas fa-chevron-down mr-2"></i>Voir toutes les notes (${grades.length})
                                </summary>
                                <ul class="space-y-2 mt-2 max-h-60 overflow-y-auto">
                                    ${grades.sort((a, b) => new Date(b.date) - new Date(a.date)).map(g => `
                                        <li class="flex justify-between items-center text-sm p-3 rounded transition hover:shadow" style="background: var(--border);">
                                            <div class="flex-1">
                                                <span class="font-medium">${g.label || 'Note'}</span>
                                                <div class="text-xs opacity-60 mt-1">
                                                    <i class="far fa-calendar mr-1"></i>${new Date(g.date).toLocaleDateString('fr-FR')}
                                                    ${g.coef > 1 ? `<span class="badge ml-2" style="background: ${course.color}; color: white; font-size: 0.6rem;">Coef. ${g.coef}</span>` : ''}
                                                </div>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <span class="font-mono font-bold text-lg ${g.value >= 15 ? 'text-green-600' : g.value >= 10 ? 'text-blue-600' : 'text-red-600'}">${g.value}/20</span>
                                                <button onclick="openEditGrade(${g.id})" class="text-blue-400 hover:text-blue-600 transition" title="Modifier">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button onclick="deleteGrade(${g.id})" class="text-red-300 hover:text-red-500 transition" title="Supprimer">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        </li>
                                    `).join('')}
                                </ul>
                            </details>
                        </div>
                    `;
                }

                semesterHtml += '</div>';

                if(semesterCoefTotal > 0) {
                    const semesterAvg = (semesterTotal / semesterCoefTotal).toFixed(2);
                    semesterHtml = `
                        <div class="flex items-center gap-3 mb-4">
                            <h4 class="text-xl font-bold gradient-text">${semesterName}</h4>
                            <div class="flex-1 h-px" style="background: var(--border);"></div>
                            <div class="text-right">
                                <div class="text-sm opacity-60">Moyenne ${semesterName}</div>
                                <div class="text-2xl font-bold ${semesterAvg >= 14 ? 'text-green-600' : semesterAvg >= 10 ? 'text-blue-600' : 'text-red-600'}">${semesterAvg}/20</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    ` + semesterHtml.split('</div>').slice(1).join('</div>');
                }

                semesterDiv.innerHTML = semesterHtml;
                container.appendChild(semesterDiv);
            };

            await renderSemester(s1Courses, 'ğŸ“˜ Semestre 1', true);
            await renderSemester(s2Courses, 'ğŸ“— Semestre 2', false);
            
            // Stocker les moyennes par semestre pour utilisation ultÃ©rieure
            window.semesterAverages = {
                s1: s1Coef > 0 ? (s1WeightedSum / s1Coef).toFixed(2) : "--",
                s2: s2Coef > 0 ? (s2WeightedSum / s2Coef).toFixed(2) : "--"
            };
            
            // Afficher la moyenne du semestre actuel par dÃ©faut
            updateDashboardAverage();
        }

        async function deleteGrade(id) {
            if(confirm('Supprimer cette note ?')) {
                await db.grades.delete(id);
                showNotification('ğŸ—‘ï¸ Note supprimÃ©e');
                await refreshUI();
            }
        }
        
        // Fonction pour ouvrir le modal d'Ã©dition de note
        async function openEditGrade(gradeId) {
            const grade = await db.grades.get(gradeId);
            if (!grade) return;
            
            document.getElementById('editGradeId').value = gradeId;
            document.getElementById('editGradeLabel').value = grade.label || '';
            document.getElementById('editGradeValue').value = grade.value;
            document.getElementById('editGradeCoef').value = grade.coef || 1;
            
            document.getElementById('editGradeModal').classList.add('active');
        }
        
        // Fonction pour fermer le modal d'Ã©dition de note
        function closeEditGrade() {
            document.getElementById('editGradeModal').classList.remove('active');
        }
        
        // Fonction pour sauvegarder les modifications de la note
        async function saveEditGrade() {
            const gradeId = parseInt(document.getElementById('editGradeId').value);
            const label = document.getElementById('editGradeLabel').value;
            const value = parseFloat(document.getElementById('editGradeValue').value);
            const coef = parseFloat(document.getElementById('editGradeCoef').value) || 1;
            
            if (isNaN(value) || value < 0 || value > 20) {
                return showNotification('âš ï¸ La note doit Ãªtre entre 0 et 20', 'warning');
            }
            
            await db.grades.update(gradeId, { label, value, coef });
            
            closeEditGrade();
            showNotification('âœ… Note modifiÃ©e !');
            await refreshUI();
        }
        
        // Fonction pour dÃ©terminer le semestre actuel (basÃ© sur le mois)
        function getCurrentSemester() {
            const now = new Date();
            const month = now.getMonth(); // 0 = janvier, 11 = dÃ©cembre
            
            // Semestre 1 : septembre (8) Ã  janvier (0)
            // Semestre 2 : fÃ©vrier (1) Ã  juin (5)
            // En Ã©tÃ© (juillet-aoÃ»t), on affiche le S2 qui vient de se terminer
            if (month >= 1 && month <= 7) {
                return 'S2';
            } else {
                return 'S1';
            }
        }
        
        // Fonction pour mettre Ã  jour la moyenne affichÃ©e selon le semestre sÃ©lectionnÃ©
        function updateDashboardAverage() {
            const selector = document.getElementById('semesterSelector');
            const selectedValue = selector ? selector.value : 'current';
            
            if (!window.semesterAverages) {
                window.semesterAverages = { s1: "--", s2: "--" };
            }
            
            let displayAvg;
            const currentSem = getCurrentSemester();
            
            if (selectedValue === 'current') {
                // Afficher le semestre actuel
                displayAvg = currentSem === 'S2' ? window.semesterAverages.s2 : window.semesterAverages.s1;
            } else {
                // Afficher le semestre prÃ©cÃ©dent
                displayAvg = currentSem === 'S2' ? window.semesterAverages.s1 : window.semesterAverages.s2;
            }
            
            document.getElementById('dash-global-avg').innerText = displayAvg + "/20";
            
            const avgProgress = displayAvg !== "--" ? (parseFloat(displayAvg) / 20) * 100 : 0;
            document.getElementById('avg-progress').style.width = avgProgress + '%';
        }

        async function saveAllGrades() {
            const grades = await db.grades.toArray();
            const courses = await db.courses.toArray();

            const data = {
                exportDate: new Date().toISOString(),
                courses: courses.map(c => ({
                    name: c.name,
                    semester: c.semester,
                    grades: grades.filter(g => g.courseId === c.id).map(g => ({
                        label: g.label,
                        value: g.value,
                        coef: g.coef,
                        date: g.date
                    }))
                }))
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `notes-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            showNotification('ğŸ’¾ Notes sauvegardÃ©es !');
        }

        // ===== PLANNING / AGENDA =====
        function getMonday(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function formatDate(date) {
            return date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });
        }

        function previousWeek() {
            currentWeekStart = new Date(currentWeekStart);
            currentWeekStart.setDate(currentWeekStart.getDate() - 7);
            initSchedule();
        }

        function currentWeek() {
            currentWeekStart = getMonday(new Date());
            initSchedule();
        }

        function nextWeek() {
            currentWeekStart = new Date(currentWeekStart);
            currentWeekStart.setDate(currentWeekStart.getDate() + 7);
            initSchedule();
        }

        async function initSchedule() {
            const showWeekend = await getSetting('showWeekend') || false;
            const scheduleStart = await getSetting('scheduleStart') || '08:00';
            const scheduleEnd   = await getSetting('scheduleEnd')   || '18:00';

            const startHour = parseInt(scheduleStart.split(':')[0]);
            const endHour   = parseInt(scheduleEnd.split(':')[0]);
            const hours = [];
            for (let h = startHour; h <= endHour; h++) {
                hours.push(`${h.toString().padStart(2,'0')}:00`);
            }

            const dayLabels = showWeekend
                ? ['Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi','Dimanche']
                : ['Lundi','Mardi','Mercredi','Jeudi','Vendredi'];

            const numDays = dayLabels.length;
            const numRows = hours.length; // une ligne par heure

            // â”€â”€ Affichage semaine â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const weekEnd = new Date(currentWeekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            document.getElementById('weekDisplay').innerText =
                `Semaine du ${formatDate(currentWeekStart)} au ${formatDate(weekEnd)}`;

            // â”€â”€ Grille : row 1 = headers, rows 2..N+1 = heures â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const grid = document.getElementById('scheduleGrid');
            grid.innerHTML = '';
            // Colonnes : 80px pour les heures + 1fr par jour
            grid.style.gridTemplateColumns = `80px repeat(${numDays}, 1fr)`;
            // Lignes : auto pour header + 70px par crÃ©neau horaire
            grid.style.gridTemplateRows = `auto repeat(${numRows}, 70px)`;

            // â”€â”€ En-tÃªtes (row 1) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // Cellule coin haut-gauche
            const cornerDiv = document.createElement('div');
            cornerDiv.className = 'schedule-header';
            cornerDiv.innerText = 'Heure';
            cornerDiv.style.gridRow = '1';
            cornerDiv.style.gridColumn = '1';
            grid.appendChild(cornerDiv);

            dayLabels.forEach((day, idx) => {
                const div = document.createElement('div');
                div.className = 'schedule-header';
                div.style.gridRow = '1';
                div.style.gridColumn = `${idx + 2}`;

                const dayDate = new Date(currentWeekStart);
                dayDate.setDate(dayDate.getDate() + idx);
                const isToday = dayDate.toDateString() === new Date().toDateString();

                div.innerHTML = `
                    <div class="text-xs opacity-80">${day}</div>
                    <div class="font-bold ${isToday ? 'text-yellow-300' : ''}">${dayDate.getDate()}</div>
                `;
                if (isToday) div.style.background = 'linear-gradient(135deg, var(--accent), var(--primary))';
                grid.appendChild(div);
            });

            // â”€â”€ Cellules heures + jours (rows 2..N+1) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const courses     = await db.courses.toArray();
            const weekStartStr = currentWeekStart.toISOString().split('T')[0];

            // PrÃ©-charger tous les events de la semaine en une seule requÃªte
            const allEvents = await db.scheduleEvents
                .where('weekStart').equals(weekStartStr)
                .toArray();

            // Ensemble des cellules dÃ©jÃ  couvertes par un span (col, row) â†’ true
            const coveredCells = new Set();

            for (let h = 0; h < hours.length; h++) {
                const gridRow = h + 2; // row CSS (header = 1, premier crÃ©neau = 2)

                // â”€â”€ Cellule heure â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                const timeDiv = document.createElement('div');
                timeDiv.className = 'p-2 text-center text-xs font-bold flex items-center justify-center';
                timeDiv.style.background   = 'var(--border)';
                timeDiv.style.gridRow      = `${gridRow}`;
                timeDiv.style.gridColumn   = '1';
                timeDiv.innerText = hours[h];
                grid.appendChild(timeDiv);

                // â”€â”€ Cellules jours â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                for (let d = 0; d < numDays; d++) {
                    const gridCol = d + 2;
                    const cellKey = `${gridCol}-${gridRow}`;

                    // Si cette cellule est dÃ©jÃ  couverte par un span â†’ on la saute
                    if (coveredCells.has(cellKey)) continue;

                    const cell = document.createElement('div');
                    cell.className = 'schedule-cell relative group';
                    cell.dataset.day  = d;
                    cell.dataset.hour = hours[h];
                    cell.style.gridRow    = `${gridRow}`;
                    cell.style.gridColumn = `${gridCol}`;

                    // Event qui dÃ©marre exactement Ã  cette heure/jour
                    const event = allEvents.find(e => e.day === d && e.startTime === hours[h]);

                    if (event) {
                        const course   = event.courseId ? courses.find(c => c.id === event.courseId) : null;
                        const duration = calculateDuration(event.startTime, event.endTime);

                        // RÃ©soudre nom et couleur (cours DB ou nom libre)
                        const displayName  = course ? course.name  : (event.freeName  || 'Cours');
                        const displayColor = course ? course.color : (event.freeColor || '#3b82f6');

                        if (duration > 0) {
                            cell.style.gridRow = `${gridRow} / span ${duration}`;

                            for (let s = 1; s < duration; s++) {
                                coveredCells.add(`${gridCol}-${gridRow + s}`);
                            }

                            // Extraire le type de cours depuis les notes (SUMMARY d'origine ADE)
                            const showType = document.getElementById('showCourseTypeToggle')?.checked !== false;
                            let courseType = '';
                            if (showType && event.notes) {
                                const typeMatch = event.notes.match(/-(\s*)(CM\d?|TD\d?|TP\d?|Cours|Exam)/i);
                                if (typeMatch) courseType = typeMatch[2].toUpperCase();
                            }

                            cell.innerHTML = `
                                <div class="p-2 rounded h-full cursor-pointer" style="background:${displayColor}25; border-left:3px solid ${displayColor};">
                                    <div class="flex justify-between items-start">
                                        <div class="font-bold text-sm leading-tight flex-1 min-w-0" style="color:${displayColor};">
                                            <span class="truncate block">${displayName}</span>
                                        </div>
                                        <div class="flex items-center gap-1 ml-1 flex-shrink-0">
                                            ${courseType ? `<span class="text-white text-xs rounded px-1 font-bold" style="background:${displayColor}; font-size:0.6rem;">${courseType}</span>` : ''}
                                            <button class="edit-event-btn opacity-0 group-hover:opacity-100 transition w-5 h-5 rounded text-xs flex items-center justify-center" style="background:${displayColor}; color:white;" title="Modifier">
                                                <i class="fas fa-pen" style="font-size:0.55rem;"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="text-xs opacity-70 mt-1">${event.startTime} â€“ ${event.endTime}</div>
                                    ${event.location ? `<div class="text-xs opacity-60 mt-0.5 truncate"><i class="fas fa-map-marker-alt mr-1"></i>${event.location}</div>` : ''}
                                </div>`;

                            // Clic sur le crayon â†’ Ã©dition
                            cell.querySelector('.edit-event-btn').addEventListener('click', (e) => {
                                e.stopPropagation();
                                openEditScheduleEvent(event);
                            });

                            // Clic sur la cellule entiÃ¨re â†’ Ã©dition aussi
                            cell.addEventListener('click', (e) => {
                                if (!e.target.closest('button')) openEditScheduleEvent(event);
                            });
                        }

                        // Suppression double-clic / long-press
                        let pressTimer;
                        cell.addEventListener('touchstart', () => {
                            pressTimer = setTimeout(async () => {
                                if (confirm('Supprimer ce cours ?')) {
                                    await db.scheduleEvents.delete(event.id);
                                    initSchedule();
                                    showNotification('ğŸ—‘ï¸ Cours supprimÃ©');
                                }
                            }, 800);
                        });
                        cell.addEventListener('touchend',  () => clearTimeout(pressTimer));
                        cell.addEventListener('touchmove', () => clearTimeout(pressTimer));
                        cell.ondblclick = async () => {
                            if (confirm('Supprimer ce cours ?')) {
                                await db.scheduleEvents.delete(event.id);
                                await initSchedule();
                                showNotification('ğŸ—‘ï¸ Cours supprimÃ©');
                            }
                        };
                    }

                    // Bouton + au survol
                    const addBtn = document.createElement('button');
                    addBtn.innerHTML = '<i class="fas fa-plus"></i>';
                    addBtn.className = 'absolute top-1 right-1 w-6 h-6 rounded-full text-xs opacity-0 group-hover:opacity-100 transition';
                    addBtn.style.background = 'var(--primary)';
                    addBtn.style.color = 'white';
                    addBtn.onclick = (e) => { e.stopPropagation(); openAddScheduleEvent(d, hours[h]); };
                    cell.appendChild(addBtn);

                    grid.appendChild(cell);
                }
            }
        }

        function calculateDuration(startTime, endTime) {
            const start = parseInt(startTime.split(':')[0]);
            const end = parseInt(endTime.split(':')[0]);
            return end - start;
        }

        // ===== IMPORT EDT AMU =====

        function openEdtImportModal() {
            // PrÃ©-remplir les dates avec la semaine courante
            const monday = new Date(currentWeekStart);
            const friday = new Date(currentWeekStart);
            friday.setDate(friday.getDate() + 4);
            document.getElementById('edtFirstDate').value = monday.toISOString().split('T')[0];
            document.getElementById('edtLastDate').value = friday.toISOString().split('T')[0];
            document.getElementById('edtModalStatus').classList.add('hidden');
            document.getElementById('edtImportModal').classList.add('active');
        }

        function closeEdtImportModal() {
            document.getElementById('edtImportModal').classList.remove('active');
        }

        function updateEdtUrlDates() {
            const first = document.getElementById('edtFirstDate').value;
            const last = document.getElementById('edtLastDate').value;
            if (!first || !last) return;
            let url = document.getElementById('edtUrlInput').value;
            url = url.replace(/firstDate=[^&]+/, `firstDate=${first}`);
            url = url.replace(/lastDate=[^&]+/, `lastDate=${last}`);
            document.getElementById('edtUrlInput').value = url;
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('edtFirstDate').addEventListener('change', updateEdtUrlDates);
            document.getElementById('edtLastDate').addEventListener('change', updateEdtUrlDates);
        });

        function parseIcal(icalText) {
            const events = [];

            // DÃ©plier les lignes continuÃ©es RFC 5545 (ligne suivante commence par espace/tab)
            const unfolded = icalText.replace(/\r\n([ \t])/g, '$1').replace(/\n([ \t])/g, '$1');
            const lines = unfolded.split(/\r\n|\n|\r/);

            let current = null;
            for (const line of lines) {
                if (line === 'BEGIN:VEVENT') {
                    current = {};
                } else if (line === 'END:VEVENT' && current) {
                    if (current.dtstart && current.dtend) events.push(current);
                    current = null;
                } else if (current) {
                    const colonIdx = line.indexOf(':');
                    if (colonIdx === -1) continue;
                    const propName = line.substring(0, colonIdx).split(';')[0].toUpperCase();
                    const value    = line.substring(colonIdx + 1);

                    if (propName === 'DTSTART') {
                        current.dtstart = parseIcalDate(value.trim());
                    } else if (propName === 'DTEND') {
                        current.dtend = parseIcalDate(value.trim());
                    } else if (propName === 'SUMMARY') {
                        current.summary = value.trim();
                    } else if (propName === 'LOCATION') {
                        current.location = value.trim();
                    } else if (propName === 'DESCRIPTION') {
                        // ADE encode les sauts de ligne en \n littÃ©ral
                        current.description = value
                            .replace(/\\n/g, '\n')
                            .replace(/\\,/g, ',')
                            .replace(/\\/g, '')
                            .trim();
                    }
                }
            }
            return events;
        }

        function parseIcalDate(str) {
            // Format: 20260217T080000Z ou 20260217T080000
            const s = str.replace('Z', '');
            const year = parseInt(s.substring(0, 4));
            const month = parseInt(s.substring(4, 6)) - 1;
            const day = parseInt(s.substring(6, 8));
            const hour = parseInt(s.substring(9, 11));
            const min = parseInt(s.substring(11, 13));
            // ADE renvoie en UTC, on convertit en heure locale (Europe/Paris = UTC+1 ou +2)
            const utcDate = new Date(Date.UTC(year, month, day, hour, min));
            return utcDate;
        }

        function padTwo(n) { return n.toString().padStart(2, '0'); }

        async function importEdtAmu() {
            let rawUrl = document.getElementById('edtUrlInput').value.trim();
            const replaceExisting = document.getElementById('edtReplaceExisting').checked;
            const statusDiv = document.getElementById('edtModalStatus');

            if (!rawUrl) {
                showEdtStatus('error', 'âš ï¸ Veuillez coller un lien iCal.');
                return;
            }

            // Mettre Ã  jour les dates dans l'URL depuis les champs
            const first = document.getElementById('edtFirstDate').value;
            const last = document.getElementById('edtLastDate').value;
            if (first) rawUrl = rawUrl.replace(/firstDate=[^&]+/, `firstDate=${first}`);
            if (last)  rawUrl = rawUrl.replace(/lastDate=[^&]+/, `lastDate=${last}`);

            showEdtStatus('loading', 'â³ RÃ©cupÃ©ration de l\'EDT en cours...');

            // Proxy CORS public pour contourner la restriction cross-origin
            const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(rawUrl)}`;

            let icalText;
            try {
                const resp = await fetch(proxyUrl);
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                icalText = await resp.text();
            } catch (e) {
                showEdtStatus('error', `âŒ Impossible de rÃ©cupÃ©rer l'EDT. VÃ©rifie ton lien ou ta connexion. (${e.message})`);
                return;
            }

            if (!icalText.includes('BEGIN:VCALENDAR')) {
                showEdtStatus('error', 'âŒ Le fichier rÃ©cupÃ©rÃ© ne semble pas Ãªtre un calendrier valide.');
                return;
            }

            showEdtStatus('loading', 'ğŸ“‹ Analyse des cours...');

            const events = parseIcal(icalText);
            if (events.length === 0) {
                showEdtStatus('warn', 'âš ï¸ Aucun cours trouvÃ© dans la pÃ©riode sÃ©lectionnÃ©e.');
                return;
            }

            // â”€â”€ Construire le courseMap : nom normalisÃ© â†’ id â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // On recharge la DB Ã  chaque import pour Ã©viter les doublons
            // mÃªme si on rÃ©-importe plusieurs semaines Ã  la suite.
            const normalize = s => s.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/\s+/g, ' ').trim();

            const courseMap = {}; // nom normalisÃ© â†’ id

            // Collecter tous les noms uniques de l'import
            const uniqueNames = {}; // nom normalisÃ© â†’ nom original (premiÃ¨re occurrence)
            for (const ev of events) {
                const raw  = cleanCourseName(ev.summary, ev.description);
                const key  = normalize(raw);
                if (!uniqueNames[key]) uniqueNames[key] = raw;
            }

            // Pour chaque nom unique, chercher ou crÃ©er le cours en DB
            const colors = ['#3b82f6','#8b5cf6','#ec4899','#22c55e','#f59e0b','#ef4444','#06b6d4','#f97316'];
            let colorIdx = 0;

            for (const [key, originalName] of Object.entries(uniqueNames)) {
                // Recharger les cours depuis la DB Ã  chaque itÃ©ration
                // pour prendre en compte ceux crÃ©Ã©s juste avant dans cette boucle
                const allCourses = await db.courses.toArray();
                const found = allCourses.find(c => normalize(c.name) === key);

                if (found) {
                    // Cours dÃ©jÃ  existant â†’ on rÃ©utilise son id, rien Ã  crÃ©er
                    courseMap[key] = found.id;
                } else {
                    // Nouveau cours â†’ on le crÃ©e une seule fois
                    const color = colors[colorIdx % colors.length];
                    colorIdx++;
                    const id = await db.courses.add({ name: originalName, semester: 'S2', color, emoji: 'ğŸ“' });
                    courseMap[key] = id;
                }
            }

            let imported = 0;
            let skipped = 0;

            for (const ev of events) {
                const name     = cleanCourseName(ev.summary, ev.description);
                const courseId = courseMap[normalize(name)];

                // Calculer lundi de la semaine de cet event
                const evMonday = getMonday(ev.dtstart);
                const weekStartStr = evMonday.toISOString().split('T')[0];
                
                // Jour de la semaine (0=lundi...4=vendredi)
                const dayOfWeek = ((ev.dtstart.getDay() + 6) % 7); // 0=lundi
                if (dayOfWeek > 4) { skipped++; continue; } // ignorer week-end
                
                const startH = `${padTwo(ev.dtstart.getHours())}:00`;
                const endH = `${padTwo(ev.dtend.getHours())}:00`;
                const location = ev.location || '';

                // Supprimer les existants si remplacement demandÃ©
                if (replaceExisting) {
                    const toDelete = await db.scheduleEvents
                        .where('weekStart').equals(weekStartStr)
                        .and(e => e.day === dayOfWeek && e.startTime === startH)
                        .toArray();
                    for (const d of toDelete) await db.scheduleEvents.delete(d.id);
                }

                await db.scheduleEvents.add({
                    courseId, day: dayOfWeek,
                    startTime: startH, endTime: endH,
                    location, notes: ev.description || '',
                    weekStart: weekStartStr
                });
                imported++;
            }

            await renderCourses();
            await initSchedule();
            await updateDashboard();

            showEdtStatus('success', `âœ… ${imported} cours importÃ©s avec succÃ¨s ! ${skipped > 0 ? `(${skipped} ignorÃ©s)` : ''}`);
            showNotification(`ğŸ“ EDT importÃ© : ${imported} cours ajoutÃ©s !`);

            // Fermer la modale aprÃ¨s 2s
            setTimeout(closeEdtImportModal, 2000);
        }

        function extractCourseNameFromSummary(summary) {
            // Format ADE AMU : "SLP2U07L - Biologie cellulaire - CM1"
            // ou avec prÃ©fixes : "**SLP2U23L - PPPE - TD", "*SLP2U07L - Biologie cellulaire - TD4"
            // ou codes doubles : "SLP2U21L/SOP2U02L - Thermochimie - CM1"
            // On veut toujours la partie MILIEU entre les tirets = le vrai nom de matiÃ¨re
            const cleaned = (summary || '').replace(/^\**/, '').trim();
            const parts = cleaned.split(/\s+-\s+/);
            if (parts.length >= 2) {
                return parts[1].trim();
            }
            return null;
        }

        function cleanCourseName(summary, description) {
            // PRIORITÃ‰ 1 : extraire le nom depuis le SUMMARY (format "CODE - NOM - TYPE")
            // C'est la source la plus fiable dans les fichiers ADE AMU
            const fromSummary = extractCourseNameFromSummary(summary);
            if (fromSummary && fromSummary.length > 0) {
                return fromSummary.substring(0, 80);
            }

            // PRIORITÃ‰ 2 : premiÃ¨re ligne non-junk de la DESCRIPTION
            if (description) {
                const lines = description
                    .split('\n')
                    .map(l => l.trim())
                    .filter(l => l && l.length > 3)
                    // Ignorer groupes, promos, enseignants, codes seuls
                    .filter(l => !/^G\s*[-â€“]?\s*\d+$/i.test(l))
                    .filter(l => !/^PROMO/i.test(l))
                    .filter(l => !/^(M\.|Mr|Mme|Dr|Pr|Prof)\s/i.test(l))
                    .filter(l => !/^[A-Z]{2,}\d[A-Z0-9]*(\/[A-Z]{2,}\d[A-Z0-9]*)?$/i.test(l));
                if (lines.length > 0) return lines[0].substring(0, 80);
            }

            // PRIORITÃ‰ 3 : SUMMARY brut en dernier recours
            return (summary || 'Cours').replace(/^\**/, '').replace(/\s+/g, ' ').trim().substring(0, 80);
        }

        function showEdtStatus(type, msg) {
            const div = document.getElementById('edtModalStatus');
            div.classList.remove('hidden');
            const styles = {
                loading: 'background: #eff6ff; border: 1px solid #bfdbfe; color: #1d4ed8;',
                success: 'background: #f0fdf4; border: 1px solid #bbf7d0; color: #15803d;',
                error:   'background: #fef2f2; border: 1px solid #fecaca; color: #dc2626;',
                warn:    'background: #fffbeb; border: 1px solid #fde68a; color: #d97706;'
            };
            div.style.cssText = styles[type] || styles.loading;
            div.innerHTML = msg;
        }

        function openScheduleSettings() {
            document.getElementById('scheduleSettingsModal').classList.add('active');
            renderCourseColorsList();
        }

        function closeScheduleSettings() {
            document.getElementById('scheduleSettingsModal').classList.remove('active');
        }

        async function renderCourseColorsList() {
            const courses = await db.courses.toArray();
            const container = document.getElementById('courseColorsList');
            
            container.innerHTML = courses.map(course => `
                <div class="flex items-center justify-between p-3 rounded-lg card">
                    <span class="font-medium">${course.name}</span>
                    <input type="color" value="${course.color || '#3b82f6'}" 
                           onchange="updateCourseColor(${course.id}, this.value)"
                           class="w-12 h-8 rounded cursor-pointer">
                </div>
            `).join('');
        }

        async function updateCourseColor(courseId, color) {
            await db.courses.update(courseId, { color });
            showNotification('ğŸ¨ Couleur mise Ã  jour !');
            await initSchedule();
        }

        async function applyScheduleSettings() {
            const startTime = document.getElementById('scheduleStartTime').value;
            const endTime = document.getElementById('scheduleEndTime').value;
            const showWeekend = document.getElementById('showWeekendToggle').checked;
            const compactView = document.getElementById('compactViewToggle').checked;

            await setSetting('scheduleStart', startTime);
            await setSetting('scheduleEnd', endTime);
            await setSetting('showWeekend', showWeekend);
            await setSetting('compactView', compactView);

            closeScheduleSettings();
            await initSchedule();
            showNotification('âœ… ParamÃ¨tres appliquÃ©s !');
        }

        // â”€â”€ Ã‰tat de la modale agenda â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let currentEditingEvent = null;   // null = ajout, objet = modification
        let eventFreeColor = '#3b82f6';
        let currentEventTab = 'pick';     // 'pick' | 'free'

        function switchEventTab(tab) {
            currentEventTab = tab;
            const isPick = tab === 'pick';
            document.getElementById('panelPickCourse').classList.toggle('hidden', !isPick);
            document.getElementById('panelFreeName').classList.toggle('hidden', isPick);
            document.getElementById('tabPickCourse').style.background = isPick ? 'var(--primary)' : 'var(--border)';
            document.getElementById('tabPickCourse').style.color    = isPick ? 'white' : 'var(--text-main)';
            document.getElementById('tabFreeName').style.background = !isPick ? 'var(--primary)' : 'var(--border)';
            document.getElementById('tabFreeName').style.color      = !isPick ? 'white' : 'var(--text-main)';
        }

        function setEventFreeColor(color) {
            eventFreeColor = color;
            document.querySelectorAll('[data-freecolor]').forEach(btn => {
                btn.style.outline = btn.dataset.freecolor === color ? `3px solid ${color}` : 'none';
            });
        }

        async function openAddScheduleEvent(day, hour) {
            currentEditingEvent = null;
            selectedScheduleCell = { day, hour };

            // Titre & boutons
            document.getElementById('scheduleModalTitle').textContent = 'â• Ajouter un cours';
            document.getElementById('saveEventBtnLabel').textContent  = 'Ajouter au planning';
            document.getElementById('deleteEventBtn').classList.add('hidden');

            // Heures
            document.getElementById('eventStartTime').value = hour;
            const endH = parseInt(hour.split(':')[0]) + 1;
            document.getElementById('eventEndTime').value = `${endH.toString().padStart(2,'0')}:00`;

            // Reset champs
            document.getElementById('eventLocation').value = '';
            document.getElementById('eventNotes').value    = '';
            document.getElementById('eventFreeName').value = '';
            setEventFreeColor('#3b82f6');
            switchEventTab('pick');

            await populateEventCourseSelect(null);
            document.getElementById('addScheduleEventModal').classList.add('active');
        }

        async function openEditScheduleEvent(event) {
            currentEditingEvent = event;
            selectedScheduleCell = { day: event.day, hour: event.startTime };

            // Titre & boutons
            document.getElementById('scheduleModalTitle').textContent = 'âœï¸ Modifier le cours';
            document.getElementById('saveEventBtnLabel').textContent  = 'Enregistrer';
            document.getElementById('deleteEventBtn').classList.remove('hidden');

            // Heures & infos
            document.getElementById('eventStartTime').value = event.startTime;
            document.getElementById('eventEndTime').value   = event.endTime;
            document.getElementById('eventLocation').value  = event.location || '';
            document.getElementById('eventNotes').value     = event.notes    || '';

            // RÃ©cupÃ©rer le cours liÃ©
            const course = await db.courses.get(event.courseId);

            if (course) {
                // Si le cours existe dans la DB â†’ onglet "Mes cours"
                switchEventTab('pick');
                await populateEventCourseSelect(event.courseId);
            } else {
                // Cours importÃ© sans correspondance â†’ onglet "Nom libre"
                switchEventTab('free');
                document.getElementById('eventFreeName').value = event.freeName || '';
                setEventFreeColor(event.freeColor || '#3b82f6');
                await populateEventCourseSelect(null);
            }

            document.getElementById('addScheduleEventModal').classList.add('active');
        }

        function closeAddScheduleEvent() {
            document.getElementById('addScheduleEventModal').classList.remove('active');
            selectedScheduleCell   = null;
            currentEditingEvent    = null;
        }

        async function populateEventCourseSelect(selectedId) {
            const courses = await db.courses.toArray();
            const select  = document.getElementById('eventCourseSelect');
            select.innerHTML = '<option value="">SÃ©lectionner une matiÃ¨re...</option>' +
                courses.map(c => `<option value="${c.id}" ${c.id === selectedId ? 'selected' : ''}>${c.name}</option>`).join('');
        }

        async function saveScheduleEvent() {
            const startTime = document.getElementById('eventStartTime').value;
            const endTime   = document.getElementById('eventEndTime').value;
            const location  = document.getElementById('eventLocation').value;
            const notes     = document.getElementById('eventNotes').value;

            let courseId  = null;
            let freeName  = null;
            let freeColor = null;

            if (currentEventTab === 'pick') {
                courseId = parseInt(document.getElementById('eventCourseSelect').value);
                if (!courseId) return showNotification('âš ï¸ SÃ©lectionne une matiÃ¨re', 'warning');
            } else {
                freeName  = document.getElementById('eventFreeName').value.trim();
                freeColor = eventFreeColor;
                if (!freeName) return showNotification('âš ï¸ Saisis un nom de cours', 'warning');
            }

            const weekStartStr = currentWeekStart.toISOString().split('T')[0];
            const day = selectedScheduleCell ? selectedScheduleCell.day :
                        currentEditingEvent  ? currentEditingEvent.day  : 0;

            const record = { courseId, freeName, freeColor, day, startTime, endTime, location, notes, weekStart: weekStartStr };

            if (currentEditingEvent) {
                await db.scheduleEvents.update(currentEditingEvent.id, record);
                showNotification('âœ… Cours mis Ã  jour !');
            } else {
                await db.scheduleEvents.add(record);
                showNotification('âœ… Cours ajoutÃ© Ã  l\'agenda !');
            }

            closeAddScheduleEvent();
            await initSchedule();
        }

        async function deleteCurrentEvent() {
            if (!currentEditingEvent) return;
            if (confirm('Supprimer ce cours du planning ?')) {
                await db.scheduleEvents.delete(currentEditingEvent.id);
                closeAddScheduleEvent();
                await initSchedule();
                showNotification('ğŸ—‘ï¸ Cours supprimÃ©');
            }
        }

        async function clearSchedule() {
            if(confirm('Effacer tout l\'emploi du temps de cette semaine ?')) {
                const weekStartStr = currentWeekStart.toISOString().split('T')[0];
                await db.scheduleEvents.where('weekStart').equals(weekStartStr).delete();
                await initSchedule();
                showNotification('ğŸ—‘ï¸ Planning effacÃ©');
            }
        }

        async function exportSchedule() {
            const weekStartStr = currentWeekStart.toISOString().split('T')[0];
            const events = await db.scheduleEvents.where('weekStart').equals(weekStartStr).toArray();
            const courses = await db.courses.toArray();

            let text = `MON AGENDA - Semaine du ${formatDate(currentWeekStart)}\n\n`;

            const days = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche'];
            
            days.forEach((dayName, dayIndex) => {
                const dayEvents = events.filter(e => e.day === dayIndex).sort((a, b) => a.startTime.localeCompare(b.startTime));
                
                if(dayEvents.length > 0) {
                    text += `\n=== ${dayName.toUpperCase()} ===\n`;
                    dayEvents.forEach(event => {
                        const course = courses.find(c => c.id === event.courseId);
                        if(course) {
                            text += `${event.startTime} - ${event.endTime} : ${course.name}`;
                            if(event.location) text += ` (${event.location})`;
                            if(event.notes) text += ` - ${event.notes}`;
                            text += '\n';
                        }
                    });
                }
            });

            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `agenda-${weekStartStr}.txt`;
            a.click();
            showNotification('ğŸ“¥ Agenda exportÃ© !');
        }

        async function updateTodaySchedule() {
            const dayIndex = new Date().getDay(); // 0=Dimanche, 1=Lundi, etc.
            const container = document.getElementById('today-schedule');
            
            if(dayIndex === 0 || dayIndex === 6) {
                container.innerHTML = '<p class="text-sm opacity-70">ğŸŒ´ C\'est le week-end ! Profite-en pour te reposer.</p>';
                return;
            }

            const weekStartStr = getMonday(new Date()).toISOString().split('T')[0];
            const events = await db.scheduleEvents
                .where('weekStart').equals(weekStartStr)
                .and(e => e.day === (dayIndex - 1))
                .toArray();

            events.sort((a, b) => a.startTime.localeCompare(b.startTime));

            const courses = await db.courses.toArray();

            let html = '';
            for(const event of events) {
                const course = courses.find(c => c.id === event.courseId);
                if(course) {
                    html += `
                        <div class="flex items-center gap-3 p-3 rounded-lg" style="background: ${course.color}20; border-left: 3px solid ${course.color};">
                            <span class="font-mono font-bold text-sm">${event.startTime}</span>
                            <div class="flex-1">
                                <div class="font-bold" style="color: ${course.color};">${course.name}</div>
                                ${event.location ? `<div class="text-xs opacity-70"><i class="fas fa-map-marker-alt mr-1"></i>${event.location}</div>` : ''}
                            </div>
                        </div>
                    `;
                }
            }
            
            container.innerHTML = html || '<p class="text-sm opacity-70">Aucun cours aujourd\'hui</p>';
        }

        // ===== TÃ‚CHES =====
        async function addTask() {
            const title = document.getElementById('taskInput').value;
            const priority = document.getElementById('taskPriority').value;
            const date = document.getElementById('taskDate').value;
            
            if(!title) return showNotification('âš ï¸ Titre manquant', 'warning');

            await db.tasks.add({
                title,
                priority,
                date,
                status: 'todo',
                completed: false
            });

            document.getElementById('taskInput').value = '';
            document.getElementById('taskDate').value = '';
            showNotification('âœ… TÃ¢che ajoutÃ©e !');
            await renderTasks();
            updateStreak();
            await checkAndUpdateAchievements(); // VÃ©rifier les succÃ¨s
        }

        async function renderTasks() {
            const tasks = await db.tasks.toArray();
            
            const todoContainer = document.getElementById('tasks-todo');
            const inprogressContainer = document.getElementById('tasks-inprogress');
            const doneContainer = document.getElementById('tasks-done');
            
            todoContainer.innerHTML = '';
            inprogressContainer.innerHTML = '';
            doneContainer.innerHTML = '';

            const containers = {
                'todo': todoContainer,
                'inprogress': inprogressContainer,
                'done': doneContainer
            };

            tasks.forEach(task => {
                const priorityColor = task.priority === 'high' ? 'red' : task.priority === 'medium' ? 'yellow' : 'green';
                const div = document.createElement('div');
                div.className = `card p-3 rounded-lg cursor-move ${task.completed ? 'opacity-50' : ''}`;
                div.draggable = true;
                div.ondragstart = (e) => e.dataTransfer.setData('taskId', task.id);
                
                div.innerHTML = `
                    <div class="flex items-start gap-2">
                        <input type="checkbox" ${task.completed ? 'checked' : ''} onchange="toggleTask(${task.id})" class="mt-1">
                        <div class="flex-1">
                            <p class="font-medium text-sm ${task.completed ? 'line-through' : ''}">${task.title}</p>
                            ${task.date ? `<p class="text-xs opacity-60 mt-1">ğŸ“… ${new Date(task.date).toLocaleDateString('fr-FR')}</p>` : ''}
                        </div>
                        <button onclick="deleteTask(${task.id})" class="text-red-300 hover:text-red-500">
                            <i class="fas fa-times text-xs"></i>
                        </button>
                    </div>
                `;
                
                containers[task.status].appendChild(div);
            });

            // Drag & Drop
            ['tasks-todo', 'tasks-inprogress', 'tasks-done'].forEach(id => {
                const container = document.getElementById(id);
                container.ondragover = (e) => e.preventDefault();
                container.ondrop = async (e) => {
                    e.preventDefault();
                    const taskId = parseInt(e.dataTransfer.getData('taskId'));
                    const newStatus = id.replace('tasks-', '');
                    await db.tasks.update(taskId, { status: newStatus });
                    await renderTasks();
                    await checkAndUpdateAchievements(); // VÃ©rifier les succÃ¨s
                };
            });

            updateTaskStats();
        }

        async function toggleTask(id) {
            const task = await db.tasks.get(id);
            await db.tasks.update(id, { completed: !task.completed });
            await renderTasks();
            if(!task.completed) {
                showNotification('ğŸ‰ TÃ¢che complÃ©tÃ©e !');
                launchConfetti();
                await checkAndUpdateAchievements(); // VÃ©rifier les succÃ¨s
            }
        }

        async function deleteTask(id) {
            if(confirm('Supprimer cette tÃ¢che ?')) {
                await db.tasks.delete(id);
                showNotification('ğŸ—‘ï¸ TÃ¢che supprimÃ©e');
                await renderTasks();
            }
        }

        async function updateTaskStats() {
            const tasks = await db.tasks.toArray();
            const completed = tasks.filter(t => t.completed).length;
            const total = tasks.length;
            
            document.getElementById('tasks-completed').innerText = completed;
            document.getElementById('tasks-total').innerText = total;
        }

        // ===== STATISTIQUES =====
        let gradesChart, subjectsChart, progressChart;

        async function renderCharts() {
            const courses = await db.courses.toArray();
            const grades = await db.grades.toArray();

            // Chart 1: Ã‰volution des notes
            const ctx1 = document.getElementById('gradesChart');
            if(gradesChart) gradesChart.destroy();
            
            const sortedGrades = grades.sort((a, b) => new Date(a.date) - new Date(b.date));
            const labels = sortedGrades.map((g, i) => `Note ${i+1}`);
            const values = sortedGrades.map(g => g.value);

            gradesChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Notes',
                        data: values,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, max: 20 }
                    }
                }
            });

            // Chart 2: RÃ©partition par matiÃ¨re
            const ctx2 = document.getElementById('subjectsChart');
            if(subjectsChart) subjectsChart.destroy();
            
            const courseNames = [];
            const courseAvgs = [];
            const courseColors = [];

            for(const course of courses) {
                const cGrades = await db.grades.where('courseId').equals(course.id).toArray();
                if(cGrades.length > 0) {
                    const avg = cGrades.reduce((a, b) => a + (b.value * (b.coef || 1)), 0) / cGrades.reduce((a, b) => a + (b.coef || 1), 0);
                    courseNames.push(course.name);
                    courseAvgs.push(avg.toFixed(2));
                    courseColors.push(course.color || '#3b82f6');
                }
            }

            subjectsChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: courseNames,
                    datasets: [{
                        label: 'Moyenne',
                        data: courseAvgs,
                        backgroundColor: courseColors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, max: 20 }
                    }
                }
            });

            // Chart 3: Progression mensuelle (simulation)
            const ctx3 = document.getElementById('progressChart');
            if(progressChart) progressChart.destroy();

            progressChart = new Chart(ctx3, {
                type: 'line',
                data: {
                    labels: ['Jan', 'FÃ©v', 'Mar', 'Avr', 'Mai', 'Juin'],
                    datasets: [{
                        label: 'Moyenne mensuelle',
                        data: [12, 13.5, 14, 15, 14.5, 16],
                        borderColor: 'rgb(139, 92, 246)',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, max: 20 }
                    }
                }
            });

            // Insights
            renderInsights();
        }

        async function renderInsights() {
            const container = document.getElementById('insights');
            const courses = await db.courses.toArray();
            const grades = await db.grades.toArray();
            
            let insights = [];

            // Meilleure matiÃ¨re
            let bestCourse = null;
            let bestAvg = 0;
            for(const course of courses) {
                const cGrades = await db.grades.where('courseId').equals(course.id).toArray();
                if(cGrades.length > 0) {
                    const avg = cGrades.reduce((a, b) => a + (b.value * (b.coef || 1)), 0) / cGrades.reduce((a, b) => a + (b.coef || 1), 0);
                    if(avg > bestAvg) {
                        bestAvg = avg;
                        bestCourse = course.name;
                    }
                }
            }
            if(bestCourse) insights.push(`ğŸ† Ta meilleure matiÃ¨re : <strong>${bestCourse}</strong> (${bestAvg.toFixed(2)}/20)`);

            // Nombre total de notes
            insights.push(`ğŸ“Š Tu as <strong>${grades.length}</strong> notes enregistrÃ©es`);

            // Encouragement
            if(bestAvg >= 15) insights.push(`ğŸŒŸ Excellent travail ! Continue comme Ã§a !`);
            else if(bestAvg >= 12) insights.push(`ğŸ’ª Bon effort ! Tu peux encore mieux faire !`);
            else insights.push(`ğŸ“š Accroche-toi, la persÃ©vÃ©rance paie toujours !`);

            container.innerHTML = insights.map(i => `<p class="text-sm p-3 rounded-lg card">${i}</p>`).join('');
        }

        // ===== DASHBOARD =====
        // ===== PROCHAIN COURS =====
        let nextClassInterval = null;

        async function updateNextClass() {
            const now = new Date();
            const currentDay = now.getDay(); // 0 = dimanche, 1 = lundi, etc.
            const currentTime = now.getHours() * 60 + now.getMinutes();
            
            // RÃ©cupÃ©rer tous les cours de la semaine actuelle
            const weekStart = getMonday(now);
            const events = await db.scheduleEvents.where('weekStart').equals(weekStart.toISOString().split('T')[0]).toArray();
            
            if (events.length === 0) {
                showNoNextClass();
                return;
            }
            
            // Convertir les jours en numÃ©ros (Lundi=1, Mardi=2, etc.)
            const dayMap = { 'Lundi': 1, 'Mardi': 2, 'Mercredi': 3, 'Jeudi': 4, 'Vendredi': 5, 'Samedi': 6, 'Dimanche': 0 };
            
            // Trouver le prochain cours
            let nextClass = null;
            let minTimeDiff = Infinity;
            
            for (const event of events) {
                const eventDay = dayMap[event.day];
                const [hours, minutes] = event.startTime.split(':').map(Number);
                const eventTime = hours * 60 + minutes;
                
                // Calculer la diffÃ©rence de temps en minutes
                let timeDiff;
                if (eventDay === currentDay) {
                    // MÃªme jour
                    timeDiff = eventTime - currentTime;
                } else if (eventDay > currentDay) {
                    // Jour suivant dans la semaine
                    timeDiff = (eventDay - currentDay) * 24 * 60 + eventTime - currentTime;
                } else {
                    // Prochain jour (dÃ©but de semaine prochaine)
                    timeDiff = (7 - currentDay + eventDay) * 24 * 60 + eventTime - currentTime;
                }
                
                // Garder seulement les cours futurs et trouver le plus proche
                if (timeDiff > 0 && timeDiff < minTimeDiff) {
                    minTimeDiff = timeDiff;
                    nextClass = { ...event, timeDiff };
                }
            }
            
            if (nextClass) {
                displayNextClass(nextClass);
            } else {
                showNoNextClass();
            }
        }

        async function displayNextClass(classData) {
            const widget = document.getElementById('next-class-widget');
            const noClassWidget = document.getElementById('no-next-class');
            const miniWidget = document.getElementById('next-class-mini-widget');
            
            widget.style.display = 'block';
            noClassWidget.style.display = 'none';
            miniWidget.style.display = 'block';
            
            // RÃ©cupÃ©rer les infos du cours
            const course = await db.courses.get(classData.courseId);
            const courseName = course ? course.name : 'Cours';
            
            document.getElementById('next-class-name').textContent = courseName;
            document.getElementById('next-class-location').textContent = classData.location || 'Salle non spÃ©cifiÃ©e';
            document.getElementById('next-class-time').textContent = `${classData.day} â€¢ ${classData.startTime} - ${classData.endTime}`;
            
            // Mettre Ã  jour le mini-widget
            document.getElementById('next-class-mini-name').textContent = courseName.length > 15 ? courseName.substring(0, 15) + '...' : courseName;
            
            // DÃ©marrer le compte Ã  rebours
            if (nextClassInterval) clearInterval(nextClassInterval);
            
            updateCountdown(classData.timeDiff, courseName);
            nextClassInterval = setInterval(() => {
                classData.timeDiff--;
                if (classData.timeDiff <= 0) {
                    clearInterval(nextClassInterval);
                    updateNextClass(); // RafraÃ®chir pour trouver le prochain cours
                } else {
                    updateCountdown(classData.timeDiff, courseName);
                }
            }, 60000); // Mise Ã  jour chaque minute
        }

        function updateCountdown(minutes, courseName = '') {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            const days = Math.floor(hours / 24);
            
            let countdownText;
            let miniCountdownText;
            
            if (days > 0) {
                const remainingHours = hours % 24;
                countdownText = `${days}j ${remainingHours}h`;
                miniCountdownText = `${days}j ${remainingHours}h`;
            } else if (hours > 0) {
                countdownText = `${hours}h ${mins.toString().padStart(2, '0')}min`;
                miniCountdownText = `${hours}h ${mins.toString().padStart(2, '0')}`;
            } else {
                countdownText = `${mins} min`;
                miniCountdownText = `${mins} min`;
            }
            
            document.getElementById('next-class-countdown').textContent = countdownText;
            document.getElementById('next-class-mini-countdown').textContent = miniCountdownText;
        }

        function showNoNextClass() {
            const widget = document.getElementById('next-class-widget');
            const noClassWidget = document.getElementById('no-next-class');
            const miniWidget = document.getElementById('next-class-mini-widget');
            
            widget.style.display = 'none';
            noClassWidget.style.display = 'block';
            miniWidget.style.display = 'none';
            
            if (nextClassInterval) {
                clearInterval(nextClassInterval);
                nextClassInterval = null;
            }
        }

        // ===== DASHBOARD =====
        async function updateDashboard() {
            await updateTodaySchedule();
            await updateStreak();
            await updateWeekSummary();
            updateSemesterProgress();
            updateNextClass(); // Mise Ã  jour du widget prochain cours
        }

        async function updateStreak() {
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Minuit du jour actuel
            const todayStr = today.toISOString().split('T')[0];
            
            // RÃ©cupÃ©rer ou crÃ©er le record de streak
            let streakData = await db.settings.get('streakData');
            
            if (!streakData) {
                // PremiÃ¨re visite - initialiser
                streakData = {
                    key: 'streakData',
                    value: {
                        currentStreak: 1,
                        lastVisit: todayStr,
                        longestStreak: 1
                    }
                };
                await db.settings.put(streakData);
                console.log('âœ… Streak initialisÃ©:', streakData.value);
            } else {
                const lastVisitStr = streakData.value.lastVisit;
                
                console.log('ğŸ“… Comparaison dates:', {
                    today: todayStr,
                    lastVisit: lastVisitStr,
                    areEqual: todayStr === lastVisitStr
                });
                
                // Comparer directement les chaÃ®nes de dates (YYYY-MM-DD)
                if (todayStr === lastVisitStr) {
                    // MÃªme jour - ne rien faire du tout
                    console.log('âœ… MÃªme jour - streak inchangÃ©:', streakData.value.currentStreak);
                } else {
                    // Calculer la diffÃ©rence en jours
                    const lastVisit = new Date(lastVisitStr);
                    lastVisit.setHours(0, 0, 0, 0);
                    const daysDiff = Math.floor((today - lastVisit) / (1000 * 60 * 60 * 24));
                    
                    console.log('ğŸ“Š DiffÃ©rence de jours:', daysDiff);
                    
                    if (daysDiff === 1) {
                        // Jour suivant - incrÃ©menter le streak
                        streakData.value.currentStreak++;
                        streakData.value.lastVisit = todayStr;
                        
                        console.log('ğŸ”¥ Streak incrÃ©mentÃ©:', streakData.value.currentStreak);
                        
                        // Mettre Ã  jour le record si nÃ©cessaire
                        if (streakData.value.currentStreak > streakData.value.longestStreak) {
                            streakData.value.longestStreak = streakData.value.currentStreak;
                        }
                        
                        await db.settings.put(streakData);
                        
                        // CÃ©lÃ©bration pour les milestones
                        if (streakData.value.currentStreak % 7 === 0) {
                            showNotification(`ğŸ”¥ ${streakData.value.currentStreak} jours de suite ! Continue comme Ã§a !`);
                            launchConfetti();
                        }
                    } else if (daysDiff > 1) {
                        // Plus d'un jour - streak cassÃ©, recommencer Ã  1
                        console.log('ğŸ’” Streak cassÃ© - retour Ã  1');
                        streakData.value.currentStreak = 1;
                        streakData.value.lastVisit = todayStr;
                        await db.settings.put(streakData);
                    } else {
                        // daysDiff < 1 (ne devrait pas arriver normalement)
                        console.warn('âš ï¸ Situation anormale - daysDiff:', daysDiff);
                        // On ne fait rien pour Ã©viter les bugs
                    }
                }
            }
            
            // Afficher le streak actuel et le record
            const currentStreakData = await db.settings.get('streakData');
            if (currentStreakData) {
                const streakCount = currentStreakData.value.currentStreak;
                const longestStreak = currentStreakData.value.longestStreak;
                
                console.log('ğŸ“Š Affichage streak:', {
                    current: streakCount,
                    record: longestStreak
                });
                
                document.getElementById('streak-count').innerText = streakCount;
                const recordEl = document.getElementById('streak-record');
                if (recordEl) {
                    recordEl.innerText = longestStreak;
                }
            } else {
                console.warn('âš ï¸ Aucune donnÃ©e de streak trouvÃ©e');
            }
        }
        
        // VÃ©rifier le streak Ã  minuit automatiquement
        function scheduleStreakCheck() {
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(0, 0, 1, 0); // 00:00:01 du lendemain
            
            const timeUntilMidnight = tomorrow - now;
            
            setTimeout(async () => {
                await updateStreak();
                scheduleStreakCheck(); // Reprogrammer pour le jour suivant
            }, timeUntilMidnight);
        }

        // ===== QUICK ACTIONS =====
        function quickAddCourse() {
            openCourseModal();
        }

        function quickAddGrade() {
            showTab('grades');
            document.querySelector('.nav-item:nth-child(4)').classList.add('active');
        }

        function quickAddTask() {
            showTab('tasks');
            document.querySelector('.nav-item:nth-child(6)').classList.add('active');
        }

        function openQuickMenu() {
            openSettings();
        }

        // ===== EXPORT/IMPORT =====
        async function exportAllData() {
            const data = {
                courses: await db.courses.toArray(),
                grades: await db.grades.toArray(),
                tasks: await db.tasks.toArray(),
                settings: await db.settings.toArray()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'mystudyspace-backup.json';
            a.click();
            showNotification('ğŸ’¾ DonnÃ©es exportÃ©es !');
        }

        function exportData() {
            exportAllData();
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                const text = await file.text();
                const data = JSON.parse(text);
                
                if(confirm('Importer ces donnÃ©es ? (Cela Ã©crasera vos donnÃ©es actuelles)')) {
                    await db.courses.clear();
                    await db.grades.clear();
                    await db.tasks.clear();
                    await db.settings.clear();
                    
                    await db.courses.bulkAdd(data.courses || []);
                    await db.grades.bulkAdd(data.grades || []);
                    await db.tasks.bulkAdd(data.tasks || []);
                    await db.settings.bulkAdd(data.settings || []);
                    
                    showNotification('âœ… DonnÃ©es importÃ©es !');
                    await refreshUI();
                    location.reload();
                }
            };
            input.click();
        }

        async function resetApp() {
            if(confirm('âš ï¸ ATTENTION : Cela supprimera TOUTES vos donnÃ©es. Continuer ?')) {
                if(confirm('Es-tu vraiment sÃ»r ? Cette action est irrÃ©versible.')) {
                    await db.delete();
                    location.reload();
                }
            }
        }

        // ===== NOTIFICATIONS & CONFETTI =====
        function showNotification(message, type = 'success') {
            // Route to the new toast system
            const toastType = type === 'warning' ? 'warning' : type === 'error' ? 'error' : 'success';
            showToast(message, toastType);
        }

        function launchConfetti() {
            const confettiToggle = document.getElementById('confettiToggle');
            if(!confettiToggle || !confettiToggle.checked) return;

            const colors = ['#3b82f6', '#8b5cf6', '#ec4899', '#22c55e', '#f59e0b'];
            for(let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + 'vw';
                    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                    document.body.appendChild(confetti);
                    setTimeout(() => confetti.remove(), 3000);
                }, i * 30);
            }
        }
        
        // ===== RESET STREAK =====
        async function resetStreak() {
            if(!confirm('âš ï¸ ÃŠtes-vous sÃ»r de vouloir rÃ©initialiser votre sÃ©rie de travail ? Cette action est irrÃ©versible.')) {
                return;
            }
            
            // Supprimer les donnÃ©es de streak
            await db.settings.delete('streakData');
            
            // RÃ©initialiser l'affichage
            document.getElementById('streak-count').innerText = '1';
            const recordEl = document.getElementById('streak-record');
            if (recordEl) {
                recordEl.innerText = '1';
            }
            
            // RecrÃ©er les donnÃ©es Ã  1
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayStr = today.toISOString().split('T')[0];
            
            const newStreakData = {
                key: 'streakData',
                value: {
                    currentStreak: 1,
                    lastVisit: todayStr,
                    longestStreak: 1
                }
            };
            await db.settings.put(newStreakData);
            
            showNotification('ğŸ”„ SÃ©rie de travail rÃ©initialisÃ©e !');
            console.log('âœ… Streak rÃ©initialisÃ©:', newStreakData.value);
        }

        // ===== SETTINGS TABS =====
        function switchSettingsTab(btn, panelId) {
            document.querySelectorAll('.settings-tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.settings-panel').forEach(p => p.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById(panelId).classList.add('active');
        }

        // ===== THÃˆME â€” mettre Ã  jour les swatches visuellement =====
        const THEME_NAMES = ['light','dark','midnight','nord','ocean','sunset','forest','rose'];
        function updateThemeSwatches(active) {
            THEME_NAMES.forEach(t => {
                const el = document.getElementById('swatch-' + t);
                if (el) el.classList.toggle('active', t === active);
            });
        }

        // ===== RAYON DES CARTES =====
        function setRadius(mode) {
            setSetting('borderRadius', mode);
            const map = { sharp: { sm:'4px', md:'6px', lg:'8px', xl:'10px' },
                          normal: { sm:'8px', md:'12px', lg:'16px', xl:'24px' },
                          round:  { sm:'12px', md:'20px', lg:'28px', xl:'36px' } };
            const r = map[mode] || map.normal;
            document.documentElement.style.setProperty('--radius-sm', r.sm);
            document.documentElement.style.setProperty('--radius-md', r.md);
            document.documentElement.style.setProperty('--radius-lg', r.lg);
            document.documentElement.style.setProperty('--radius-xl', r.xl);
            ['sharp','normal','round'].forEach(m => {
                const btn = document.getElementById('radius-' + m);
                if (btn) {
                    btn.style.background = m === mode ? 'var(--primary)' : '';
                    btn.style.color      = m === mode ? 'white' : '';
                    btn.style.borderColor = m === mode ? 'var(--primary)' : 'var(--border)';
                }
            });
        }

        // ===== HORLOGE TEMPS RÃ‰EL =====
        let clockInterval = null;
        function toggleClock(on) {
            setSetting('showClock', on);
            const el = document.getElementById('live-clock');
            if (!el) return;
            if (on) {
                el.style.display = '';
                clockInterval = setInterval(updateClock, 1000);
                updateClock();
            } else {
                el.style.display = 'none';
                clearInterval(clockInterval);
            }
        }
        function updateClock() {
            const el = document.getElementById('live-clock');
            if (!el) return;
            const now = new Date();
            el.textContent = now.toLocaleTimeString('fr-FR', { hour:'2-digit', minute:'2-digit', second:'2-digit' });
        }

        // ===== PATCH setTheme pour mettre Ã  jour les swatches =====
        const _origSetTheme = typeof setTheme === 'function' ? setTheme : null;

        // ===== SUPPRESSION EN MASSE DES COURS =====
        async function deleteAllCourses() {
            const courses = await db.courses.toArray();
            if (courses.length === 0) return showNotification('â„¹ï¸ Aucun cours Ã  supprimer');

            const confirmed = confirm(`âš ï¸ Supprimer les ${courses.length} cours et toutes leurs notes/fichiers ?

Cette action est irrÃ©versible.`);
            if (!confirmed) return;
            const doubleConfirm = confirm('â— DerniÃ¨re confirmation : vraiment tout supprimer ?');
            if (!doubleConfirm) return;

            for (const course of courses) {
                await db.grades.where('courseId').equals(course.id).delete();
                await db.files.where('courseId').equals(course.id).delete();
            }
            await db.courses.clear();
            await db.scheduleEvents.clear();
            showNotification('ğŸ—‘ï¸ Tous les cours supprimÃ©s');
            await refreshUI();
        }

        // ===== RECHERCHE COURS =====
        function searchCourses(query) {
            const q = query.toLowerCase().trim();
            document.querySelectorAll('.course-card').forEach(card => {
                const name = card.querySelector('h4')?.textContent?.toLowerCase() || '';
                card.style.display = (!q || name.includes(q)) ? '' : 'none';
            });
        }

        // ===== VUE GRILLE / LISTE =====
        let coursesViewMode = 'grid';
        function toggleCoursesView() {
            coursesViewMode = coursesViewMode === 'grid' ? 'list' : 'grid';
            const list = document.getElementById('coursesList');
            const btn  = document.getElementById('coursesViewBtn');
            if (coursesViewMode === 'list') {
                list.classList.remove('md:grid-cols-2');
                list.classList.add('grid-cols-1');
                btn.innerHTML = '<i class="fas fa-th-large"></i>';
            } else {
                list.classList.add('md:grid-cols-2');
                list.classList.remove('grid-cols-1');
                btn.innerHTML = '<i class="fas fa-list"></i>';
            }
        }

        // ===== COULEURS PERSONNALISÃ‰ES =====
        function applyCustomColor(type, value) {
            if (type === 'primary') {
                document.documentElement.style.setProperty('--primary', value);
                setSetting('customPrimary', value);
            } else {
                document.documentElement.style.setProperty('--accent', value);
                setSetting('customAccent', value);
            }
        }

        // ===== POLICE =====
        function applyFont(font) {
            document.body.style.fontFamily = font;
            setSetting('fontFamily', font);
        }

        // ===== DENSITÃ‰ =====
        function setDensity(mode) {
            setSetting('density', mode);
            const root = document.documentElement;
            ['compact', 'normal', 'comfortable'].forEach(m => {
                const btn = document.getElementById(`density-${m}`);
                if (btn) {
                    btn.style.background = m === mode ? 'var(--primary)' : '';
                    btn.style.color      = m === mode ? 'white' : '';
                    btn.style.borderColor = m === mode ? 'var(--primary)' : 'var(--border)';
                }
            });
            if (mode === 'compact') {
                root.style.setProperty('--spacing', '0.75rem');
                document.querySelectorAll('.p-6').forEach(el => el.classList.replace('p-6', 'p-4'));
                document.querySelectorAll('.p-5').forEach(el => el.classList.replace('p-5', 'p-3'));
            } else if (mode === 'comfortable') {
                root.style.setProperty('--spacing', '1.5rem');
            }
        }

        // ===== MODE FOCUS =====
        function toggleFocusMode(on) {
            setSetting('focusMode', on);
            document.querySelectorAll('.stat-card, .floating-action').forEach(el => {
                el.style.opacity = on ? '0' : '';
                el.style.pointerEvents = on ? 'none' : '';
            });
            showNotification(on ? 'ğŸ¯ Mode focus activÃ©' : 'ğŸ”“ Mode focus dÃ©sactivÃ©');
        }

        // ===== RACCOURCIS CLAVIER =====
        document.addEventListener('keydown', (e) => {
            // Ctrl+K or Cmd+K = command palette
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                openCommandPalette();
                return;
            }
            if (!e.altKey) return;
            // Alt+D = toggle dark mode
            if (e.key === 'd') { e.preventDefault(); quickToggleDark(); return; }
            const tabs = ['dashboard','courses','schedule','grades','stats','tasks','achievements'];
            const idx = parseInt(e.key) - 1;
            if (idx >= 0 && idx < tabs.length) {
                e.preventDefault();
                showTab(tabs[idx]);
            }
        });

        // ===== RÃ‰SUMÃ‰ SEMAINE =====
        async function updateWeekSummary() {
            const container = document.getElementById('week-summary');
            if (!container) return;
            const weekStartStr = currentWeekStart.toISOString().split('T')[0];
            const events = await db.scheduleEvents.where('weekStart').equals(weekStartStr).toArray();
            const courses = await db.courses.toArray();

            if (events.length === 0) {
                container.innerHTML = '<p class="text-sm opacity-50 italic">Aucun cours cette semaine</p>';
                return;
            }

            const byDay = ['Lun','Mar','Mer','Jeu','Ven'];
            const grouped = {};
            for (const ev of events) {
                const label = byDay[ev.day] || '?';
                if (!grouped[label]) grouped[label] = [];
                const course = courses.find(c => c.id === ev.courseId);
                const name = course ? course.name : (ev.freeName || 'Cours');
                grouped[label].push({ name, startTime: ev.startTime, color: course?.color || ev.freeColor || '#3b82f6' });
            }

            container.innerHTML = Object.entries(grouped).map(([day, evts]) => `
                <div class="flex items-center gap-3 text-sm">
                    <span class="font-bold w-8 text-xs opacity-60">${day}</span>
                    <div class="flex flex-wrap gap-1">
                        ${evts.map(ev => `<span class="px-2 py-0.5 rounded text-xs text-white font-medium" style="background:${ev.color};">${ev.name.substring(0,15)}${ev.name.length>15?'â€¦':''}</span>`).join('')}
                    </div>
                </div>
            `).join('');
        }

        // ===== PROGRESSION SEMESTRE =====
        function updateSemesterProgress() {
            const now = new Date();
            // Semestre 2 typique : dÃ©but janvier, fin juin
            const semStart = new Date(now.getFullYear(), 0, 13);  // 13 jan
            const semEnd   = new Date(now.getFullYear(), 5, 30);  // 30 juin
            const total  = semEnd - semStart;
            const elapsed = Math.max(0, Math.min(now - semStart, total));
            const pct = Math.round((elapsed / total) * 100);

            const bar   = document.getElementById('semester-progress-bar');
            const label = document.getElementById('semester-percent');
            const startLbl = document.getElementById('semester-start-label');
            const endLbl   = document.getElementById('semester-end-label');
            if (bar) bar.style.width = pct + '%';
            if (label) label.textContent = pct + '%';
            if (startLbl) startLbl.textContent = semStart.toLocaleDateString('fr-FR', { day:'numeric', month:'short' });
            if (endLbl)   endLbl.textContent   = semEnd.toLocaleDateString('fr-FR', { day:'numeric', month:'short' });
        }

        // ===== CHARGEMENT DES PREFS VISUELLES =====
        async function loadVisualPrefs() {
            const customPrimary = await getSetting('customPrimary');
            const customAccent  = await getSetting('customAccent');
            const fontFamily    = await getSetting('fontFamily');
            const density       = await getSetting('density') || 'normal';

            if (customPrimary) {
                document.documentElement.style.setProperty('--primary', customPrimary);
                const el = document.getElementById('customPrimaryColor');
                if (el) el.value = customPrimary;
            }
            if (customAccent) {
                document.documentElement.style.setProperty('--accent', customAccent);
                const el = document.getElementById('customAccentColor');
                if (el) el.value = customAccent;
            }
            if (fontFamily) {
                document.body.style.fontFamily = fontFamily;
                const el = document.getElementById('fontSelect');
                if (el) el.value = fontFamily;
            }
            setDensity(density);
        }

        // ===== SYSTÃˆME DE SUCCÃˆS ET TITRES =====
        
        // DÃ©finition des succÃ¨s avec progression
        const ACHIEVEMENTS = [
            { 
                id: 'first-step', 
                name: 'Premier Pas', 
                desc: 'CrÃ©er votre premiÃ¨re tÃ¢che', 
                icon: 'ğŸ¯', 
                xp: 10, 
                target: 1,
                condition: () => checkTaskCount(1),
                progress: async () => {
                    const tasks = await db.tasks.toArray();
                    return { current: tasks.length, target: 1 };
                }
            },
            { 
                id: 'studious', 
                name: 'Studieux', 
                desc: 'ComplÃ©ter 10 tÃ¢ches', 
                icon: 'ğŸ“', 
                xp: 50, 
                target: 10,
                condition: () => checkCompletedTasks(10),
                progress: async () => {
                    const tasks = await db.tasks.where('status').equals('done').toArray();
                    return { current: tasks.length, target: 10 };
                }
            },
            { 
                id: 'marathonian', 
                name: 'Marathonien', 
                desc: '7 jours de suite actif', 
                icon: 'ğŸ’§', 
                xp: 100, 
                target: 7,
                condition: () => checkStreak(7),
                progress: async () => {
                    const streak = await getSetting('streak') || 1;
                    return { current: Math.min(streak, 7), target: 7 };
                }
            },
            { 
                id: 'file-master', 
                name: 'Archiviste', 
                desc: 'Stocker 20 fichiers', 
                icon: 'ğŸ“‚', 
                xp: 75, 
                target: 20,
                condition: () => checkFileCount(20),
                progress: async () => {
                    const files = await db.files.toArray();
                    return { current: files.length, target: 20 };
                }
            },
            { 
                id: 'excellence', 
                name: 'Excellence', 
                desc: 'Obtenir une moyenne de 18+', 
                icon: 'ğŸŒŸ', 
                xp: 150, 
                target: 18,
                condition: () => checkAverage(18),
                progress: async () => {
                    const courses = await db.courses.toArray();
                    if (courses.length === 0) return { current: 0, target: 18, isAverage: true };
                    
                    let totalAvg = 0;
                    let count = 0;
                    
                    for (const course of courses) {
                        const grades = await db.grades.where('courseId').equals(course.id).toArray();
                        if (grades.length > 0) {
                            let sum = 0, coefSum = 0;
                            grades.forEach(g => {
                                sum += g.value * g.coef;
                                coefSum += g.coef;
                            });
                            totalAvg += sum / coefSum;
                            count++;
                        }
                    }
                    
                    const avg = count > 0 ? totalAvg / count : 0;
                    return { current: Math.round(avg * 10) / 10, target: 18, isAverage: true };
                }
            },
            { 
                id: 'organized', 
                name: 'OrganisÃ©', 
                desc: 'CrÃ©er 5 cours', 
                icon: 'ğŸ“š', 
                xp: 30, 
                target: 5,
                condition: () => checkCourseCount(5),
                progress: async () => {
                    const courses = await db.courses.toArray();
                    return { current: courses.length, target: 5 };
                }
            },
            { 
                id: 'perfectionist', 
                name: 'Perfectionniste', 
                desc: '10 notes au-dessus de 15', 
                icon: 'ğŸ’¯', 
                xp: 120, 
                target: 10,
                condition: () => checkHighGrades(10, 15),
                progress: async () => {
                    const grades = await db.grades.toArray();
                    const highGrades = grades.filter(g => g.value >= 15);
                    return { current: highGrades.length, target: 10 };
                }
            },
            { 
                id: 'productive', 
                name: 'Productif', 
                desc: '50 tÃ¢ches complÃ©tÃ©es', 
                icon: 'âš¡', 
                xp: 200, 
                target: 50,
                condition: () => checkCompletedTasks(50),
                progress: async () => {
                    const tasks = await db.tasks.where('status').equals('done').toArray();
                    return { current: tasks.length, target: 50 };
                }
            },
            { 
                id: 'legend', 
                name: 'LÃ©gende', 
                desc: '100 tÃ¢ches complÃ©tÃ©es', 
                icon: 'ğŸ‘‘', 
                xp: 500, 
                target: 100,
                condition: () => checkCompletedTasks(100),
                progress: async () => {
                    const tasks = await db.tasks.where('status').equals('done').toArray();
                    return { current: tasks.length, target: 100 };
                }
            }
        ];

        // DÃ©finition des titres par niveau
        const TITLES = [
            { level: 1, title: 'ğŸ“ Ã‰tudiant', minXP: 0 },
            { level: 2, title: 'ğŸ“š Apprenti', minXP: 50 },
            { level: 3, title: 'ğŸ’ª Travailleur acharnÃ©', minXP: 150 },
            { level: 4, title: 'ğŸŒŸ Ã‰toile montante', minXP: 300 },
            { level: 5, title: 'ğŸ”¥ Expert', minXP: 500 },
            { level: 6, title: 'âš¡ Prodige', minXP: 800 },
            { level: 7, title: 'ğŸ’ MaÃ®tre', minXP: 1200 },
            { level: 8, title: 'ğŸ‘‘ LÃ©gende', minXP: 1700 },
            { level: 9, title: 'ğŸ† Champion', minXP: 2500 },
            { level: 10, title: 'ğŸŒŒ GÃ©nie absolu', minXP: 3500 }
        ];

        // Fonctions de vÃ©rification des conditions
        async function checkTaskCount(min) {
            const tasks = await db.tasks.toArray();
            return tasks.length >= min;
        }

        async function checkCompletedTasks(min) {
            const tasks = await db.tasks.where('status').equals('done').toArray();
            return tasks.length >= min;
        }

        async function checkStreak(days) {
            const streak = await getSetting('streak') || 1;
            return streak >= days;
        }

        async function checkFileCount(min) {
            const files = await db.files.toArray();
            return files.length >= min;
        }

        async function checkAverage(minAvg) {
            const courses = await db.courses.toArray();
            if (courses.length === 0) return false;
            
            let totalAvg = 0;
            let count = 0;
            
            for (const course of courses) {
                const grades = await db.grades.where('courseId').equals(course.id).toArray();
                if (grades.length > 0) {
                    let sum = 0, coefSum = 0;
                    grades.forEach(g => {
                        sum += g.value * g.coef;
                        coefSum += g.coef;
                    });
                    totalAvg += sum / coefSum;
                    count++;
                }
            }
            
            return count > 0 && (totalAvg / count) >= minAvg;
        }

        async function checkCourseCount(min) {
            const courses = await db.courses.toArray();
            return courses.length >= min;
        }

        async function checkHighGrades(count, minGrade) {
            const grades = await db.grades.toArray();
            const highGrades = grades.filter(g => g.value >= minGrade);
            return highGrades.length >= count;
        }

        // SystÃ¨me d'XP et de niveaux
        async function getUserXP() {
            return await getSetting('userXP') || 0;
        }

        async function addXP(amount) {
            const currentXP = await getUserXP();
            const newXP = currentXP + amount;
            await setSetting('userXP', newXP);
            await checkLevelUp(newXP);
            await updateAchievementsDisplay();
            return newXP;
        }

        async function getUserLevel() {
            const xp = await getUserXP();
            for (let i = TITLES.length - 1; i >= 0; i--) {
                if (xp >= TITLES[i].minXP) {
                    return TITLES[i].level;
                }
            }
            return 1;
        }

        async function getUserTitle() {
            const xp = await getUserXP();
            for (let i = TITLES.length - 1; i >= 0; i--) {
                if (xp >= TITLES[i].minXP) {
                    return TITLES[i].title;
                }
            }
            return TITLES[0].title;
        }

        async function getNextLevelXP() {
            const currentLevel = await getUserLevel();
            const nextLevel = TITLES.find(t => t.level === currentLevel + 1);
            return nextLevel ? nextLevel.minXP : TITLES[TITLES.length - 1].minXP;
        }

        async function checkLevelUp(currentXP) {
            const currentLevel = await getUserLevel();
            const nextLevel = TITLES.find(t => t.level === currentLevel + 1);
            
            if (nextLevel && currentXP >= nextLevel.minXP) {
                showNotification(`ğŸ‰ Niveau ${nextLevel.level} atteint ! Nouveau titre : ${nextLevel.title}`);
                await updateGreeting();
            }
        }

        // Gestion des succÃ¨s dÃ©bloquÃ©s
        async function getUnlockedAchievements() {
            return await getSetting('unlockedAchievements') || [];
        }

        async function unlockAchievement(achievementId) {
            const unlocked = await getUnlockedAchievements();
            if (!unlocked.includes(achievementId)) {
                unlocked.push(achievementId);
                await setSetting('unlockedAchievements', unlocked);
                
                const achievement = ACHIEVEMENTS.find(a => a.id === achievementId);
                if (achievement) {
                    await addXP(achievement.xp);
                    showNotification(`ğŸ† SuccÃ¨s dÃ©bloquÃ© : ${achievement.icon} ${achievement.name} (+${achievement.xp} XP) !`);
                }
            }
        }

        async function checkAchievements() {
            for (const achievement of ACHIEVEMENTS) {
                const unlocked = await getUnlockedAchievements();
                if (!unlocked.includes(achievement.id)) {
                    const isUnlocked = await achievement.condition();
                    if (isUnlocked) {
                        await unlockAchievement(achievement.id);
                    }
                }
            }
        }

        // Affichage des succÃ¨s
        async function updateAchievementsDisplay() {
            const grid = document.getElementById('achievements-grid');
            if (!grid) return;
            
            const unlocked = await getUnlockedAchievements();
            const xp = await getUserXP();
            const level = await getUserLevel();
            const title = await getUserTitle();
            const nextLevelXP = await getNextLevelXP();
            const currentLevelXP = TITLES.find(t => t.level === level)?.minXP || 0;
            const xpInCurrentLevel = xp - currentLevelXP;
            const xpNeededForNextLevel = nextLevelXP - currentLevelXP;
            const xpProgress = xpNeededForNextLevel > 0 ? (xpInCurrentLevel / xpNeededForNextLevel) * 100 : 100;
            
            // Mise Ã  jour des infos de niveau
            document.getElementById('user-level').textContent = level;
            document.getElementById('user-xp').textContent = xp;
            document.getElementById('current-title').textContent = title;
            document.getElementById('xp-needed').textContent = Math.max(0, nextLevelXP - xp);
            document.getElementById('xp-progress-bar').style.width = Math.min(xpProgress, 100) + '%';
            
            // GÃ©nÃ©ration des cartes de succÃ¨s
            const achievementsWithProgress = await Promise.all(
                ACHIEVEMENTS.map(async (achievement) => {
                    const progress = achievement.progress ? await achievement.progress() : null;
                    return { ...achievement, progressData: progress };
                })
            );
            
            grid.innerHTML = achievementsWithProgress.map(achievement => {
                const isUnlocked = unlocked.includes(achievement.id);
                const prog = achievement.progressData;
                const percentage = prog ? Math.min((prog.current / prog.target) * 100, 100) : 0;
                
                return `
                    <div class="card p-4 ${isUnlocked ? '' : 'opacity-50'}" style="border: 2px solid ${isUnlocked ? 'var(--primary)' : 'var(--border)'};">
                        <div class="flex items-start justify-between mb-3">
                            <div class="text-4xl ${isUnlocked ? '' : 'grayscale'}">${achievement.icon}</div>
                            <div class="px-2 py-1 rounded text-xs font-bold text-white" style="background: ${isUnlocked ? 'linear-gradient(135deg, #22c55e, #16a34a)' : '#94a3b8'};">
                                ${isUnlocked ? 'âœ“ DÃ©bloquÃ©' : 'ğŸ”’ VerrouillÃ©'}
                            </div>
                        </div>
                        <h4 class="font-bold text-lg mb-1">${achievement.name}</h4>
                        <p class="text-sm opacity-70 mb-3">${achievement.desc}</p>
                        
                        ${!isUnlocked && prog ? `
                            <div class="mb-3">
                                <div class="flex justify-between text-xs mb-1 font-semibold">
                                    <span style="color: var(--primary);">Progression</span>
                                    <span style="color: var(--primary);">
                                        ${prog.isAverage ? `${prog.current}/20` : `${prog.current}/${prog.target}`}
                                    </span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden" style="background: var(--border);">
                                    <div class="h-full rounded-full transition-all duration-500" style="width: ${percentage}%; background: linear-gradient(90deg, var(--primary), var(--secondary));"></div>
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="flex items-center gap-2 text-sm font-bold" style="color: var(--primary);">
                            <i class="fas fa-star"></i>
                            <span>${achievement.xp} XP</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            // GÃ©nÃ©ration de la progression des titres
            const titlesContainer = document.getElementById('titles-progression');
            if (titlesContainer) {
                titlesContainer.innerHTML = TITLES.map((titleData, index) => {
                    const isUnlocked = xp >= titleData.minXP;
                    const isCurrent = titleData.level === level;
                    const nextTitle = TITLES[index + 1];
                    const xpNeeded = nextTitle ? nextTitle.minXP - titleData.minXP : 0;
                    
                    return `
                        <div class="card p-4 transition-all ${isCurrent ? 'ring-2 ring-offset-2' : ''}" 
                             style="border: 2px solid ${isUnlocked ? 'var(--primary)' : 'var(--border)'}; ${isCurrent ? 'ring-color: var(--primary);' : ''}">
                            <div class="flex items-center gap-4">
                                <div class="flex-shrink-0">
                                    <div class="w-16 h-16 rounded-full flex items-center justify-center text-2xl font-bold ${isUnlocked ? '' : 'opacity-30 grayscale'}" 
                                         style="background: ${isUnlocked ? 'linear-gradient(135deg, var(--primary), var(--secondary))' : 'var(--border)'}; color: white;">
                                        ${titleData.level}
                                    </div>
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1">
                                        <h4 class="font-bold text-lg ${isUnlocked ? '' : 'opacity-50'}">${titleData.title}</h4>
                                        ${isCurrent ? '<span class="px-2 py-1 rounded text-xs font-bold text-white" style="background: linear-gradient(135deg, var(--primary), var(--secondary));">ACTUEL</span>' : ''}
                                        ${isUnlocked && !isCurrent ? '<span class="px-2 py-1 rounded text-xs font-bold" style="background: #22c55e; color: white;">âœ“ DÃ‰BLOQUÃ‰</span>' : ''}
                                        ${!isUnlocked ? '<span class="px-2 py-1 rounded text-xs font-bold" style="background: #94a3b8; color: white;">ğŸ”’ VERROUILLÃ‰</span>' : ''}
                                    </div>
                                    <p class="text-sm opacity-70">
                                        ${isUnlocked ? `DÃ©bloquÃ© avec ${titleData.minXP} XP` : `Requis : ${titleData.minXP} XP`}
                                        ${nextTitle && isUnlocked ? ` â€¢ ${xpNeeded} XP pour le niveau suivant` : ''}
                                    </p>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        // VÃ©rifier les succÃ¨s aprÃ¨s certaines actions
        async function checkAndUpdateAchievements() {
            await checkAchievements();
            await updateAchievementsDisplay();
            await updateGreeting();
        }

        // ===== REFRESH UI =====
        async function refreshUI() {
            await renderCourses();
            await renderGrades();
            await renderTasks();
            await updateDashboard();
        }

        // ===== INIT =====
        (async () => {
            await loadSettings();
            await loadVisualPrefs();
            await initSchedule();
            await refreshUI();
            updateGreeting();
            await updateAchievementsDisplay();
            
            startFloatingEmojis('dashboard');
            scheduleStreakCheck();
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => {
                        b.style.background = 'var(--border)';
                        b.style.color = 'var(--text-main)';
                    });
                    this.style.background = 'var(--primary)';
                    this.style.color = 'white';
                });
            });
            
            document.querySelector('.filter-btn').style.background = 'var(--primary)';
            document.querySelector('.filter-btn').style.color = 'white';

            // ğŸ†• INIT NEW FEATURES
            initScrollProgress();
            initParticles();
            initPomodoro();
            loadHabits();
            loadStickyNotes();
            loadExamCountdowns();
            initCommandPalette();
            populateSimCourses();
            fetchWeather();
            addRippleToButtons();
            updateDarkToggleIcon();
        })();

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ†• SCROLL PROGRESS BAR
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function initScrollProgress() {
            const bar = document.getElementById('scroll-progress');
            window.addEventListener('scroll', () => {
                const scrollTop = window.scrollY;
                const docHeight = document.documentElement.scrollHeight - window.innerHeight;
                const pct = docHeight > 0 ? (scrollTop / docHeight) * 100 : 0;
                bar.style.width = pct + '%';
            });
            // Nav scroll effect
            const nav = document.querySelector('nav.card');
            window.addEventListener('scroll', () => {
                if (window.scrollY > 10) nav.classList.add('scrolled');
                else nav.classList.remove('scrolled');
            });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ†• PARTICLE BACKGROUND
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function initParticles() {
            const canvas = document.getElementById('particle-canvas');
            const ctx = canvas.getContext('2d');
            let particles = [];
            
            function resize() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
            resize();
            window.addEventListener('resize', resize);

            class Particle {
                constructor() { this.reset(); }
                reset() {
                    this.x = Math.random() * canvas.width;
                    this.y = Math.random() * canvas.height;
                    this.size = Math.random() * 2 + 0.5;
                    this.speedX = (Math.random() - 0.5) * 0.4;
                    this.speedY = (Math.random() - 0.5) * 0.4;
                    this.opacity = Math.random() * 0.5 + 0.1;
                    this.life = Math.random() * 200 + 100;
                    this.maxLife = this.life;
                }
                update() {
                    this.x += this.speedX;
                    this.y += this.speedY;
                    this.life--;
                    if (this.life <= 0) this.reset();
                    if (this.x < 0 || this.x > canvas.width) this.speedX *= -1;
                    if (this.y < 0 || this.y > canvas.height) this.speedY *= -1;
                }
                draw() {
                    const alpha = (this.life / this.maxLife) * this.opacity;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(99,102,241,${alpha})`;
                    ctx.fill();
                }
            }

            for (let i = 0; i < 60; i++) particles.push(new Particle());

            // Draw connections
            function drawConnections() {
                for (let i = 0; i < particles.length; i++) {
                    for (let j = i + 1; j < particles.length; j++) {
                        const dx = particles[i].x - particles[j].x;
                        const dy = particles[i].y - particles[j].y;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        if (dist < 120) {
                            ctx.beginPath();
                            ctx.strokeStyle = `rgba(99,102,241,${0.06 * (1 - dist/120)})`;
                            ctx.lineWidth = 0.5;
                            ctx.moveTo(particles[i].x, particles[i].y);
                            ctx.lineTo(particles[j].x, particles[j].y);
                            ctx.stroke();
                        }
                    }
                }
            }

            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                particles.forEach(p => { p.update(); p.draw(); });
                drawConnections();
                requestAnimationFrame(animate);
            }
            animate();
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ†• POMODORO TIMER
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        let pomState = {
            running: false,
            interval: null,
            mode: 'work', // 'work' | 'short' | 'long'
            timeLeft: 25 * 60,
            sessions: 0,
            WORK: 25 * 60,
            SHORT: 5 * 60,
            LONG: 15 * 60,
        };
        const POM_CIRCUMFERENCE = 2 * Math.PI * 54; // r=54

        function pomodoroToggle() {
            if (pomState.running) {
                clearInterval(pomState.interval);
                pomState.running = false;
                document.getElementById('pom-btn-icon').className = 'fas fa-play';
                document.getElementById('pom-btn-label').textContent = 'Reprendre';
                document.getElementById('pomodoro-pulse-wrapper').classList.remove('pomodoro-pulsing');
            } else {
                pomState.running = true;
                document.getElementById('pom-btn-icon').className = 'fas fa-pause';
                document.getElementById('pom-btn-label').textContent = 'Pause';
                document.getElementById('pomodoro-pulse-wrapper').classList.add('pomodoro-pulsing');
                pomState.interval = setInterval(pomodoroTick, 1000);
            }
        }

        function pomodoroTick() {
            pomState.timeLeft--;
            updatePomodoroDisplay();
            if (pomState.timeLeft <= 0) {
                clearInterval(pomState.interval);
                pomState.running = false;
                // Session complete
                if (pomState.mode === 'work') {
                    pomState.sessions++;
                    document.getElementById('pom-sessions').textContent = pomState.sessions;
                    showToast('ğŸ… Pomodoro terminÃ© ! Prends une pause !', 'success');
                    launchConfetti();
                    // Auto switch to break
                    if (pomState.sessions % 4 === 0) {
                        pomState.mode = 'long';
                        pomState.timeLeft = pomState.LONG;
                        document.getElementById('pom-mode').textContent = 'Grande pause';
                    } else {
                        pomState.mode = 'short';
                        pomState.timeLeft = pomState.SHORT;
                        document.getElementById('pom-mode').textContent = 'Petite pause';
                    }
                } else {
                    pomState.mode = 'work';
                    pomState.timeLeft = pomState.WORK;
                    document.getElementById('pom-mode').textContent = 'Travail';
                    showToast('ğŸ’ª Retour au travail !', 'info');
                }
                document.getElementById('pom-btn-icon').className = 'fas fa-play';
                document.getElementById('pom-btn-label').textContent = 'DÃ©marrer';
                document.getElementById('pomodoro-pulse-wrapper').classList.remove('pomodoro-pulsing');
                const sessionsLeft = 4 - (pomState.sessions % 4);
                document.getElementById('pom-until-break').textContent = sessionsLeft + ' sessions';
                updatePomodoroDisplay();
            }
        }

        function pomodoroReset() {
            clearInterval(pomState.interval);
            pomState.running = false;
            pomState.mode = 'work';
            pomState.timeLeft = pomState.WORK;
            document.getElementById('pom-btn-icon').className = 'fas fa-play';
            document.getElementById('pom-btn-label').textContent = 'DÃ©marrer';
            document.getElementById('pom-mode').textContent = 'Travail';
            document.getElementById('pomodoro-pulse-wrapper').classList.remove('pomodoro-pulsing');
            updatePomodoroDisplay();
        }

        function pomodoroSkip() {
            clearInterval(pomState.interval);
            pomState.running = false;
            pomState.timeLeft = 0;
            pomodoroTick();
        }

        function updatePomodoroDisplay() {
            const min = Math.floor(pomState.timeLeft / 60).toString().padStart(2,'0');
            const sec = (pomState.timeLeft % 60).toString().padStart(2,'0');
            document.getElementById('pom-time').textContent = `${min}:${sec}`;
            
            const total = pomState.mode === 'work' ? pomState.WORK : (pomState.mode === 'short' ? pomState.SHORT : pomState.LONG);
            const progress = 1 - (pomState.timeLeft / total);
            const ring = document.getElementById('pom-ring');
            if (ring) ring.style.strokeDashoffset = POM_CIRCUMFERENCE * (1 - progress);
        }

        function initPomodoro() { updatePomodoroDisplay(); }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ†• WEATHER (Open-Meteo API - Free, no key needed!)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function fetchWeather() {
            try {
                const resp = await fetch('https://api.open-meteo.com/v1/forecast?latitude=43.2965&longitude=5.3698&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,wind_speed_10m&daily=weather_code,temperature_2m_max,temperature_2m_min&wind_speed_unit=kmh&timezone=Europe%2FParis&forecast_days=4');
                if (!resp.ok) throw new Error('Weather API error');
                const data = await resp.json();
                const cur = data.current;

                document.getElementById('weather-temp').textContent = Math.round(cur.temperature_2m) + 'Â°';
                document.getElementById('weather-feels').textContent = Math.round(cur.apparent_temperature);
                document.getElementById('weather-wind').textContent = Math.round(cur.wind_speed_10m);
                document.getElementById('weather-humidity').textContent = cur.relative_humidity_2m;
                document.getElementById('weather-icon').textContent = weatherCodeToEmoji(cur.weather_code);
                document.getElementById('weather-desc').textContent = weatherCodeToDesc(cur.weather_code);
                
                // Forecast
                const fc = document.getElementById('weather-forecast');
                const days = ['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'];
                fc.innerHTML = data.daily.time.map((d, i) => {
                    const date = new Date(d);
                    return `<div><div class="opacity-70">${days[date.getDay()]}</div><div>${weatherCodeToEmoji(data.daily.weather_code[i])}</div><div class="font-bold">${Math.round(data.daily.temperature_2m_max[i])}Â°</div></div>`;
                }).join('');
            } catch(e) {
                document.getElementById('weather-desc').textContent = 'MÃ©tÃ©o indisponible';
                document.getElementById('weather-temp').textContent = '--Â°';
            }
        }

        function weatherCodeToEmoji(code) {
            if (code === 0) return 'â˜€ï¸';
            if (code <= 2) return 'ğŸŒ¤ï¸';
            if (code <= 3) return 'â˜ï¸';
            if (code <= 49) return 'ğŸŒ«ï¸';
            if (code <= 55) return 'ğŸŒ§ï¸';
            if (code <= 67) return 'ğŸŒ¨ï¸';
            if (code <= 77) return 'ğŸŒ¨ï¸';
            if (code <= 82) return 'ğŸŒ§ï¸';
            if (code <= 86) return 'ğŸŒ¨ï¸';
            if (code <= 95) return 'â›ˆï¸';
            return 'ğŸŒ©ï¸';
        }

        function weatherCodeToDesc(code) {
            if (code === 0) return 'Ciel dÃ©gagÃ©';
            if (code <= 2) return 'Partiellement nuageux';
            if (code <= 3) return 'Nuageux';
            if (code <= 49) return 'Brumeux';
            if (code <= 55) return 'Bruine lÃ©gÃ¨re';
            if (code <= 67) return 'Pluie';
            if (code <= 77) return 'Neige';
            if (code <= 82) return 'Averses';
            if (code <= 95) return 'Orage';
            return 'Orage violent';
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ†• STICKY NOTES
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const STICKY_COLORS = ['#fef9c3','#fce7f3','#e0f2fe','#dcfce7','#fef3c7','#f3e8ff'];
        let stickyNotes = [];

        function loadStickyNotes() {
            try { stickyNotes = JSON.parse(localStorage.getItem('amupro_sticky') || '[]'); }
            catch(e) { stickyNotes = []; }
            renderStickyNotes();
        }

        function saveStickyNotes() {
            localStorage.setItem('amupro_sticky', JSON.stringify(stickyNotes));
        }

        function addStickyNote() {
            const color = STICKY_COLORS[stickyNotes.length % STICKY_COLORS.length];
            stickyNotes.unshift({ id: Date.now(), text: '', color, createdAt: new Date().toISOString() });
            saveStickyNotes();
            renderStickyNotes();
            setTimeout(() => {
                const firstTextarea = document.querySelector('#sticky-notes-container textarea');
                if (firstTextarea) firstTextarea.focus();
            }, 50);
        }

        function renderStickyNotes() {
            const container = document.getElementById('sticky-notes-container');
            if (!container) return;
            if (stickyNotes.length === 0) {
                container.innerHTML = '<p class="text-xs opacity-50 italic text-center py-4">Clique sur + pour ajouter une note ğŸ“Œ</p>';
                return;
            }
            container.innerHTML = stickyNotes.map(note => `
                <div class="sticky-note" style="background:${note.color};">
                    <button onclick="deleteStickyNote(${note.id})" 
                            style="position:absolute; top:6px; right:8px; background:none; border:none; cursor:pointer; opacity:0.5; color:rgba(0,0,0,0.6);" 
                            title="Supprimer">Ã—</button>
                    <textarea rows="3" style="color:rgba(0,0,0,0.75);"
                        onchange="updateStickyNote(${note.id}, this.value)"
                        placeholder="Ã‰cris ta note...">${note.text}</textarea>
                    <div style="font-size:0.6rem; opacity:0.4; margin-top:4px;">
                        ${new Date(note.createdAt).toLocaleDateString('fr-FR')}
                    </div>
                </div>
            `).join('');
        }

        function updateStickyNote(id, text) {
            const note = stickyNotes.find(n => n.id === id);
            if (note) { note.text = text; saveStickyNotes(); }
        }

        function deleteStickyNote(id) {
            stickyNotes = stickyNotes.filter(n => n.id !== id);
            saveStickyNotes();
            renderStickyNotes();
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ†• HABITS TRACKER
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        let habits = [];
        let selectedHabitEmoji = 'ğŸ“š';

        function loadHabits() {
            try { habits = JSON.parse(localStorage.getItem('amupro_habits') || '[]'); }
            catch(e) { habits = []; }
            renderHabits();
        }

        function saveHabits() { localStorage.setItem('amupro_habits', JSON.stringify(habits)); }

        function setHabitEmoji(emoji) {
            selectedHabitEmoji = emoji;
            document.querySelectorAll('#habitModal .emoji-btn').forEach(b => b.style.background = '');
            event.target.style.background = 'var(--primary)';
            event.target.style.color = 'white';
        }

        function openHabitModal() { document.getElementById('habitModal').classList.add('active'); }
        function closeHabitModal() { document.getElementById('habitModal').classList.remove('active'); }

        function saveHabit() {
            const name = document.getElementById('habit-name-input').value.trim();
            if (!name) return showToast('âš ï¸ Donne un nom Ã  ton habitude', 'warning');
            
            habits.push({
                id: Date.now(),
                name,
                emoji: selectedHabitEmoji,
                days: {} // { "2026-02-14": true }
            });
            saveHabits();
            renderHabits();
            closeHabitModal();
            document.getElementById('habit-name-input').value = '';
            showToast('âœ… Habitude ajoutÃ©e !', 'success');
        }

        function toggleHabitDay(habitId, dateStr) {
            const habit = habits.find(h => h.id === habitId);
            if (!habit) return;
            habit.days[dateStr] = !habit.days[dateStr];
            saveHabits();
            renderHabits();
            if (habit.days[dateStr]) {
                showXPPop('+10 XP');
                showToast(`${habit.emoji} ${habit.name} âœ“`, 'success');
            }
        }

        function deleteHabit(habitId) {
            habits = habits.filter(h => h.id !== habitId);
            saveHabits();
            renderHabits();
        }

        function renderHabits() {
            const container = document.getElementById('habits-list');
            if (!container) return;

            const today = new Date();
            const week = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date(today);
                d.setDate(d.getDate() - i);
                week.push(d);
            }
            const dayNames = ['D','L','M','M','J','V','S'];

            if (habits.length === 0) {
                container.innerHTML = `<p class="text-sm opacity-50 italic text-center py-4">Aucune habitude. Commence dÃ¨s aujourd'hui ! ğŸ’ª</p>`;
                document.getElementById('habits-progress-text').textContent = '0%';
                document.getElementById('habits-progress-fill').style.width = '0%';
                return;
            }

            const todayStr = today.toISOString().split('T')[0];
            let doneTodayCount = 0;
            habits.forEach(h => { if (h.days[todayStr]) doneTodayCount++; });
            const pct = habits.length > 0 ? Math.round((doneTodayCount / habits.length) * 100) : 0;
            document.getElementById('habits-progress-text').textContent = pct + '%';
            document.getElementById('habits-progress-fill').style.width = pct + '%';

            container.innerHTML = habits.map(habit => {
                const streak = calculateHabitStreak(habit);
                const weekHtml = week.map(d => {
                    const ds = d.toISOString().split('T')[0];
                    const isToday = ds === todayStr;
                    const done = habit.days[ds];
                    return `<div class="habit-day ${done ? 'done' : ''} ${isToday ? 'today' : ''}" 
                                 onclick="toggleHabitDay(${habit.id}, '${ds}')"
                                 title="${d.toLocaleDateString('fr-FR')}">
                                ${dayNames[d.getDay()]}
                            </div>`;
                }).join('');
                return `
                    <div class="card p-4 flex items-center gap-4">
                        <div class="text-2xl flex-shrink-0">${habit.emoji}</div>
                        <div class="flex-1">
                            <div class="font-bold mb-2">${habit.name}
                                ${streak > 0 ? `<span class="ml-2 text-xs px-2 py-0.5 rounded-full font-bold text-white" style="background:linear-gradient(135deg,#f59e0b,#ef4444);">ğŸ”¥ ${streak}j</span>` : ''}
                            </div>
                            <div class="flex gap-1">${weekHtml}</div>
                        </div>
                        <button onclick="deleteHabit(${habit.id})" class="text-red-300 hover:text-red-500 transition ml-2">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            }).join('');
        }

        function calculateHabitStreak(habit) {
            let streak = 0;
            const today = new Date();
            for (let i = 0; i < 365; i++) {
                const d = new Date(today);
                d.setDate(d.getDate() - i);
                const ds = d.toISOString().split('T')[0];
                if (habit.days[ds]) streak++;
                else if (i > 0) break;
            }
            return streak;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ†• EXAM COUNTDOWNS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        let exams = [];
        let selectedExamColor = '#6366f1';

        function loadExamCountdowns() {
            try { exams = JSON.parse(localStorage.getItem('amupro_exams') || '[]'); }
            catch(e) { exams = []; }
            renderExamCountdowns();
        }

        function saveExams() { localStorage.setItem('amupro_exams', JSON.stringify(exams)); }

        function setExamColor(color) {
            selectedExamColor = color;
            document.querySelectorAll('[data-examcolor]').forEach(b => {
                b.style.outline = b.dataset.examcolor === color ? '3px solid white' : 'none';
                b.style.outlineOffset = '2px';
            });
        }

        function openExamModal() {
            const d = document.getElementById('examModal');
            const dateInput = document.getElementById('exam-date-input');
            const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate()+1);
            dateInput.value = tomorrow.toISOString().split('T')[0];
            d.classList.add('active');
        }
        function closeExamModal() { document.getElementById('examModal').classList.remove('active'); }

        function saveExam() {
            const name = document.getElementById('exam-name-input').value.trim();
            const date = document.getElementById('exam-date-input').value;
            if (!name || !date) return showToast('âš ï¸ Remplis tous les champs', 'warning');
            exams.push({ id: Date.now(), name, date, color: selectedExamColor });
            saveExams();
            renderExamCountdowns();
            closeExamModal();
            document.getElementById('exam-name-input').value = '';
            showToast('â³ Examen ajoutÃ© !', 'success');
        }

        function deleteExam(id) {
            exams = exams.filter(e => e.id !== id);
            saveExams();
            renderExamCountdowns();
        }

        function renderExamCountdowns() {
            const container = document.getElementById('exam-countdowns');
            if (!container) return;

            const now = new Date();
            const upcoming = exams
                .filter(e => new Date(e.date) >= now)
                .sort((a,b) => new Date(a.date) - new Date(b.date));

            if (upcoming.length === 0) {
                container.innerHTML = '<p class="text-sm opacity-50 italic col-span-full text-center py-4">Aucun examen planifiÃ© ğŸ‰</p>';
                return;
            }

            container.innerHTML = upcoming.map(exam => {
                const examDate = new Date(exam.date);
                const diff = examDate - now;
                const days = Math.floor(diff / (1000*60*60*24));
                const hrs = Math.floor((diff % (1000*60*60*24)) / (1000*60*60));
                const urgency = days <= 3 ? 'ğŸ”´' : days <= 7 ? 'ğŸŸ¡' : 'ğŸŸ¢';
                return `
                    <div class="exam-countdown-card" style="background:linear-gradient(135deg,${exam.color},${exam.color}99);">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <p class="text-xs opacity-80">${urgency} ${examDate.toLocaleDateString('fr-FR',{weekday:'long',day:'numeric',month:'long'})}</p>
                                <h4 class="font-bold text-lg mt-1">${exam.name}</h4>
                            </div>
                            <button onclick="deleteExam(${exam.id})" class="opacity-60 hover:opacity-100 transition text-white">
                                <i class="fas fa-times text-sm"></i>
                            </button>
                        </div>
                        <div class="flex gap-2">
                            <div class="exam-digit">${days}</div>
                            <div class="self-center font-bold opacity-70">j</div>
                            <div class="exam-digit">${hrs}</div>
                            <div class="self-center font-bold opacity-70">h</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update countdowns every minute
        setInterval(renderExamCountdowns, 60000);

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ†• GRADE SIMULATOR
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function populateSimCourses() {
            const courses = await db.courses.toArray();
            const sel = document.getElementById('sim-course');
            if (!sel) return;
            sel.innerHTML = '<option value="">Toutes matiÃ¨res</option>' +
                courses.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }

        async function updateSimulator() {
            const gradeSlider = document.getElementById('sim-grade-slider');
            const coefInput = document.getElementById('sim-coef');
            const courseSelect = document.getElementById('sim-course');
            if (!gradeSlider) return;
            
            const newGrade = parseFloat(gradeSlider.value);
            const coef = parseFloat(coefInput.value) || 1;
            const courseId = parseInt(courseSelect.value);
            
            document.getElementById('sim-grade-display').textContent = newGrade;
            
            // Calculate projected average
            const grades = await db.grades.toArray();
            if (grades.length === 0) {
                document.getElementById('sim-result').textContent = newGrade.toFixed(1);
                document.getElementById('sim-comment').textContent = 'Aucune note existante â€” cette note serait ta moyenne actuelle.';
                return;
            }
            
            let allGrades = [...grades, { value: newGrade, coef, courseId: courseId || (await db.courses.toArray())[0]?.id }];
            
            if (courseId) {
                const courseGrades = allGrades.filter(g => g.courseId === courseId);
                if (courseGrades.length === 0) {
                    document.getElementById('sim-result').textContent = '--';
                    return;
                }
                const sum = courseGrades.reduce((a,b) => a + b.value * (b.coef||1), 0);
                const coefSum = courseGrades.reduce((a,b) => a + (b.coef||1), 0);
                const avg = sum/coefSum;
                document.getElementById('sim-result').textContent = avg.toFixed(2);
                const current = grades.filter(g => g.courseId === courseId);
                const currAvg = current.length > 0 ? current.reduce((a,b) => a+b.value*(b.coef||1),0)/current.reduce((a,b) => a+(b.coef||1),0) : 0;
                const diff = avg - currAvg;
                document.getElementById('sim-comment').innerHTML = current.length > 0 
                    ? `${diff >= 0 ? 'ğŸ“ˆ' : 'ğŸ“‰'} ${diff >= 0 ? '+' : ''}${diff.toFixed(2)} par rapport Ã  la moyenne actuelle (${currAvg.toFixed(2)}/20)`
                    : 'PremiÃ¨re note pour cette matiÃ¨re';
            } else {
                const sum = allGrades.reduce((a,b) => a + b.value * (b.coef||1), 0);
                const coefSum = allGrades.reduce((a,b) => a + (b.coef||1), 0);
                const avg = sum/coefSum;
                document.getElementById('sim-result').textContent = avg.toFixed(2);
                document.getElementById('sim-comment').textContent = avg >= 14 ? 'ğŸŒŸ Excellent !' : avg >= 10 ? 'âœ“ ValidÃ©' : 'âš ï¸ Attention';
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ†• COMMAND PALETTE (Ctrl+K)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const COMMANDS = [
            { icon:'ğŸ ', label:'Dashboard', action:()=>showTab('dashboard'), keys:['dashboard','accueil','home'] },
            { icon:'ğŸ“š', label:'Mes Cours', action:()=>showTab('courses'), keys:['cours','matiÃ¨res'] },
            { icon:'ğŸ“…', label:'Planning / Agenda', action:()=>showTab('schedule'), keys:['planning','agenda','emploi'] },
            { icon:'ğŸ¯', label:'Notes', action:()=>showTab('grades'), keys:['notes','notes','moyennes'] },
            { icon:'ğŸ“Š', label:'Statistiques', action:()=>showTab('stats'), keys:['stats','statistiques'] },
            { icon:'âœ…', label:'TÃ¢ches', action:()=>showTab('tasks'), keys:['taches','tÃ¢ches','todo'] },
            { icon:'ğŸ†', label:'SuccÃ¨s', action:()=>showTab('achievements'), keys:['succes','succÃ¨s','xp'] },
            { icon:'â•', label:'Nouveau cours', action:()=>openCourseModal(), keys:['nouveau cours','ajouter cours'] },
            { icon:'ğŸ“', label:'Ajouter une note', action:()=>{showTab('grades');}, keys:['ajouter note','nouvelle note'] },
            { icon:'âœ”ï¸', label:'Nouvelle tÃ¢che', action:()=>quickAddTask(), keys:['nouvelle tache','ajouter tache'] },
            { icon:'â³', label:'Ajouter un examen', action:()=>openExamModal(), keys:['examen','exam','partiel'] },
            { icon:'ğŸ…', label:'Minuteur Pomodoro', action:()=>{showTab('dashboard'); showToast('ğŸ‘† Le Pomodoro est sur le Dashboard','info');}, keys:['pomodoro','minuteur','focus'] },
            { icon:'âš™ï¸', label:'ParamÃ¨tres', action:()=>openSettings(), keys:['paramÃ¨tres','settings','theme'] },
            { icon:'ğŸŒ™', label:'Mode sombre', action:()=>setTheme('dark'), keys:['sombre','dark','nuit'] },
            { icon:'â˜€ï¸', label:'Mode clair', action:()=>setTheme('light'), keys:['clair','light','jour'] },
            { icon:'ğŸŒŒ', label:'ThÃ¨me Galaxy', action:()=>setTheme('galaxy'), keys:['galaxy'] },
            { icon:'ğŸ’¾', label:'Exporter les donnÃ©es', action:()=>exportAllData(), keys:['exporter','backup','donnÃ©es'] },
            { icon:'ğŸ«', label:'ENT AMU', action:()=>window.open('https://ent.univ-amu.fr/','_blank'), keys:['ent','amu','universitÃ©'] },
            { icon:'ğŸ“§', label:'Mails AMU', action:()=>window.open('https://outlook.cloud.microsoft/mail/?realm=etu.univ-amu.fr','_blank'), keys:['mail','outlook','email'] },
        ];

        let commandIndex = 0;
        let filteredCommands = [...COMMANDS];

        function initCommandPalette() {
            document.addEventListener('keydown', e => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    openCommandPalette();
                }
                if (e.key === 'Escape') closeCommandPalette();
            });
        }

        function openCommandPalette() {
            const palette = document.getElementById('command-palette');
            palette.classList.add('active');
            document.getElementById('command-input').value = '';
            filteredCommands = [...COMMANDS];
            commandIndex = 0;
            renderCommands();
            setTimeout(() => document.getElementById('command-input').focus(), 50);
        }

        function closeCommandPalette() {
            document.getElementById('command-palette').classList.remove('active');
        }

        function filterCommands(query) {
            const q = query.toLowerCase();
            filteredCommands = COMMANDS.filter(c => 
                c.label.toLowerCase().includes(q) || 
                c.keys.some(k => k.includes(q))
            );
            commandIndex = 0;
            renderCommands();
        }

        function renderCommands() {
            const list = document.getElementById('command-list');
            if (filteredCommands.length === 0) {
                list.innerHTML = '<div style="padding:20px;text-align:center;opacity:0.5;font-size:0.875rem;">Aucun rÃ©sultat</div>';
                return;
            }
            list.innerHTML = filteredCommands.map((c, i) => `
                <div class="command-item ${i === commandIndex ? 'selected' : ''}" onclick="executeCommand(${i})">
                    <div class="command-icon">${c.icon}</div>
                    <span style="font-size:0.9rem; font-weight:600;">${c.label}</span>
                </div>
            `).join('');
        }

        function executeCommand(index) {
            const cmd = filteredCommands[index];
            if (cmd) {
                cmd.action();
                closeCommandPalette();
            }
        }

        function handleCommandKey(e) {
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                commandIndex = Math.min(commandIndex + 1, filteredCommands.length - 1);
                renderCommands();
                document.querySelectorAll('.command-item')[commandIndex]?.scrollIntoView({block:'nearest'});
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                commandIndex = Math.max(commandIndex - 1, 0);
                renderCommands();
                document.querySelectorAll('.command-item')[commandIndex]?.scrollIntoView({block:'nearest'});
            } else if (e.key === 'Enter') {
                executeCommand(commandIndex);
            }
        }

        // showToast defined earlier in file

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ†• XP POP ANIMATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function showXPPop(text, x, y) {
            const el = document.createElement('div');
            el.className = 'xp-pop';
            el.textContent = text;
            el.style.left = (x || window.innerWidth/2 - 30) + 'px';
            el.style.top = (y || window.innerHeight/2) + 'px';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 1500);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ†• QUICK DARK TOGGLE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function quickToggleDark() {
            const theme = document.documentElement.getAttribute('data-theme');
            const isDark = ['dark','midnight','matrix','neon','cyberpunk','galaxy','lava','batman','ironman','hulk','spiderman','nord','chrome','gold','copper','steel','ice'].includes(theme);
            setTheme(isDark ? 'light' : 'dark');
            updateDarkToggleIcon();
        }

        function updateDarkToggleIcon() {
            const icon = document.getElementById('darkToggleIcon');
            if (!icon) return;
            const theme = document.documentElement.getAttribute('data-theme');
            const isDark = ['dark','midnight','matrix','neon','cyberpunk','galaxy'].includes(theme);
            icon.className = isDark ? 'fas fa-sun' : 'fas fa-moon';
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ†• RIPPLE EFFECT ON BUTTONS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function addRippleToButtons() {
            document.querySelectorAll('.btn-primary, .ripple-btn').forEach(btn => {
                btn.classList.add('ripple-btn');
                btn.addEventListener('click', function(e) {
                    const r = document.createElement('span');
                    r.classList.add('ripple');
                    const rect = this.getBoundingClientRect();
                    const size = Math.max(rect.width, rect.height);
                    r.style.width = r.style.height = size + 'px';
                    r.style.left = (e.clientX - rect.left - size/2) + 'px';
                    r.style.top = (e.clientY - rect.top - size/2) + 'px';
                    this.appendChild(r);
                    setTimeout(() => r.remove(), 600);
                });
            });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ†• MOBILE BOTTOM BAR
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function setMobileActive(btn) {
            document.querySelectorAll('.mobile-tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

    </script>
</body>
</html>
