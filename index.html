<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyStudySpace Ultimate üöÄ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --primary: #3b82f6;
            --secondary: #8b5cf6;
            --accent: #ec4899;
            --bg-main: #f3f4f6;
            --bg-card: #ffffff;
            --text-main: #1f2937;
            --border: #e5e7eb;
        }

        [data-theme="dark"] {
            --primary: #60a5fa;
            --secondary: #a78bfa;
            --accent: #f472b6;
            --bg-main: #111827;
            --bg-card: #1f2937;
            --text-main: #f9fafb;
            --border: #374151;
        }

        /* Fix pour les inputs en mode sombre */
        [data-theme="dark"] input,
        [data-theme="dark"] select,
        [data-theme="dark"] textarea {
            background: #374151;
            color: #f9fafb;
        }

        [data-theme="dark"] input::placeholder,
        [data-theme="dark"] textarea::placeholder {
            color: #9ca3af;
        }

        [data-theme="dark"] option {
            background: #374151;
            color: #f9fafb;
        }

        [data-theme="dark"] .schedule-cell[contenteditable="true"] {
            color: #f9fafb;
        }

        [data-theme="ocean"] {
            --primary: #06b6d4;
            --secondary: #0891b2;
            --accent: #22d3ee;
            --bg-main: #ecfeff;
            --bg-card: #ffffff;
            --text-main: #164e63;
            --border: #a5f3fc;
        }

        [data-theme="sunset"] {
            --primary: #f97316;
            --secondary: #ea580c;
            --accent: #fb923c;
            --bg-main: #fff7ed;
            --bg-card: #ffffff;
            --text-main: #7c2d12;
            --border: #fed7aa;
        }

        [data-theme="forest"] {
            --primary: #22c55e;
            --secondary: #16a34a;
            --accent: #4ade80;
            --bg-main: #f0fdf4;
            --bg-card: #ffffff;
            --text-main: #14532d;
            --border: #bbf7d0;
        }

        /* Am√©lioration g√©n√©rale du contraste pour tous les inputs */
        input, select, textarea {
            background: var(--bg-card);
            color: var(--text-main);
        }

        input::placeholder,
        textarea::placeholder {
            color: rgba(0, 0, 0, 0.4);
        }

        [data-theme="dark"] input::placeholder,
        [data-theme="dark"] textarea::placeholder {
            color: #9ca3af;
        }

        body { 
            font-family: 'Segoe UI', sans-serif; 
            background-color: var(--bg-main);
            color: var(--text-main);
            transition: all 0.3s ease;
        }
        
        /* OPTIMISATIONS RESPONSIVE */
        
        /* Mobile First - par d√©faut */
        @media (max-width: 768px) {
            /* Navigation mobile */
            nav .flex.space-x-6 {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
            }
            
            nav .flex.space-x-6::-webkit-scrollbar {
                display: none;
            }
            
            .nav-item {
                white-space: nowrap;
                font-size: 0.75rem;
                padding: 0.5rem 0.75rem;
            }
            
            .nav-item i {
                display: none;
            }
            
            /* Stats cards en colonne sur mobile */
            .stat-card {
                font-size: 0.9rem;
            }
            
            .stat-card .text-4xl {
                font-size: 2rem !important;
            }
            
            /* Grilles responsive */
            .grid.grid-cols-2,
            .grid.grid-cols-3,
            .grid.grid-cols-4 {
                grid-template-columns: 1fr !important;
            }
            
            .grid.md\:grid-cols-2,
            .grid.md\:grid-cols-3,
            .grid.md\:grid-cols-4 {
                grid-template-columns: 1fr !important;
            }
            
            /* Formulaires mobile */
            .flex.gap-4 {
                flex-direction: column !important;
            }
            
            /* Planning mobile - scroll horizontal */
            .schedule-grid {
                font-size: 0.7rem;
                grid-template-columns: 60px repeat(5, minmax(100px, 1fr)) !important;
            }
            
            .schedule-header {
                padding: 8px 4px;
                font-size: 0.7rem;
            }
            
            .schedule-cell {
                min-height: 60px;
                padding: 4px;
                font-size: 0.65rem;
            }
            
            /* Scroll horizontal pour l'agenda */
            .overflow-x-auto {
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch;
            }
            
            /* Modals mobile */
            .modal-content {
                width: 95%;
                max-height: 90vh;
                padding: 20px;
            }
            
            /* Boutons mobile */
            .floating-action {
                bottom: 20px;
                right: 20px;
                width: 50px;
                height: 50px;
            }
            
            /* Cartes cours mobile */
            .course-card {
                margin-bottom: 1rem;
            }
            
            /* Notifications mobile */
            .notification {
                right: 10px;
                left: 10px;
                top: 70px;
            }
            
            /* Cache certains badges sur mobile */
            .badge:not(:first-child):not(:nth-child(2)) {
                display: none;
            }
            
            /* Textes plus petits sur mobile */
            h2, h3 {
                font-size: 1.25rem !important;
            }
            
            h4 {
                font-size: 1rem !important;
            }
            
            /* Espacement r√©duit */
            .space-y-6 > * + * {
                margin-top: 1rem !important;
            }
            
            .gap-4 {
                gap: 0.5rem !important;
            }
            
            /* Padding r√©duit sur mobile */
            .p-6 {
                padding: 1rem !important;
            }
            
            .p-5 {
                padding: 0.875rem !important;
            }
            
            /* Input file sur mobile */
            input[type="file"] {
                font-size: 0.75rem;
            }
        }
        
        /* Tablette - optimisations interm√©diaires */
        @media (min-width: 769px) and (max-width: 1024px) {
            .schedule-grid {
                grid-template-columns: 70px repeat(5, 1fr) !important;
            }
            
            .grid.md\:grid-cols-2 {
                grid-template-columns: repeat(2, 1fr) !important;
            }
            
            .grid.md\:grid-cols-3 {
                grid-template-columns: repeat(2, 1fr) !important;
            }
            
            .grid.md\:grid-cols-4 {
                grid-template-columns: repeat(2, 1fr) !important;
            }
            
            .stat-card .text-4xl {
                font-size: 2.5rem !important;
            }
            
            /* Navigation tablette */
            .nav-item {
                font-size: 0.85rem;
            }
            
            /* Modals tablette */
            .modal-content {
                max-width: 80%;
            }
        }
        
        /* Desktop - optimisations larges √©crans */
        @media (min-width: 1025px) {
            /* Agenda plus large sur desktop */
            .schedule-grid {
                min-width: 1000px;
            }
            
            /* Grilles optimales */
            .grid.md\:grid-cols-2 {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .grid.md\:grid-cols-3 {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .grid.md\:grid-cols-4 {
                grid-template-columns: repeat(4, 1fr);
            }
            
            /* Hover effects seulement sur desktop */
            .card:hover {
                transform: translateY(-5px);
            }
            
            /* Scroll plus fluide */
            .overflow-y-auto {
                scrollbar-width: thin;
                scrollbar-color: var(--primary) var(--border);
            }
            
            .overflow-y-auto::-webkit-scrollbar {
                width: 8px;
            }
            
            .overflow-y-auto::-webkit-scrollbar-track {
                background: var(--border);
            }
            
            .overflow-y-auto::-webkit-scrollbar-thumb {
                background: var(--primary);
                border-radius: 4px;
            }
        }
        
        /* Tr√®s grands √©crans */
        @media (min-width: 1440px) {
            .max-w-7xl {
                max-width: 90rem;
            }
        }
        
        /* Mode paysage mobile */
        @media (max-height: 500px) and (orientation: landscape) {
            .modal-content {
                max-height: 95vh;
                overflow-y: auto;
            }
            
            .stat-card {
                padding: 15px;
            }
        }
        
        /* Touch improvements pour mobile/tablette */
        @media (hover: none) and (pointer: coarse) {
            /* Boutons plus grands pour le touch */
            button, .nav-item, .filter-btn {
                min-height: 44px;
                min-width: 44px;
            }
            
            /* D√©sactiver les hover effects sur tactile */
            .card:hover {
                transform: none;
            }
            
            .schedule-cell:hover {
                background: var(--bg-card);
            }
            
            /* Meilleure zone de tap */
            input[type="checkbox"] {
                width: 20px;
                height: 20px;
            }
        }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .nav-item.active { 
            border-bottom: 3px solid var(--primary); 
            color: var(--primary);
            font-weight: 600;
        }

        .nav-item-mobile {
            transition: all 0.2s;
        }

        .nav-item-mobile.active {
            background: var(--primary) !important;
            color: white !important;
            font-weight: 600;
        }

        .nav-item-mobile:hover {
            background: var(--border) !important;
        }

        [data-theme="dark"] .nav-item-mobile:hover {
            background: #374151 !important;
        }

        [data-theme="dark"] .nav-item-mobile.active {
            background: var(--primary) !important;
        }
        
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        .schedule-grid { 
            display: grid; 
            gap: 1px; 
            background: var(--border);
            border: 2px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }
        
        .schedule-header { 
            background: var(--primary); 
            color: white;
            padding: 12px 8px; 
            font-weight: bold; 
            text-align: center; 
        }
        
        .schedule-cell { 
            background: var(--bg-card); 
            min-height: 70px; 
            padding: 8px; 
            font-size: 0.85rem;
            transition: all 0.2s;
            position: relative;
        }
        
        .schedule-cell:hover {
            background: rgba(59, 130, 246, 0.05);
        }
        
        .stat-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border-radius: 12px;
            padding: 20px;
            animation: slideIn 0.5s ease;
        }
        
        .progress-bar {
            background: var(--border);
            border-radius: 10px;
            overflow: hidden;
            height: 8px;
        }
        
        .progress-fill {
            background: linear-gradient(90deg, var(--primary), var(--accent));
            height: 100%;
            transition: width 0.5s ease;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .emoji-picker {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .emoji-btn {
            font-size: 1.5rem;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .emoji-btn:hover {
            background: var(--border);
            transform: scale(1.2);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background: var(--bg-card);
            padding: 30px;
            border-radius: 16px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            color: var(--text-main);
        }
        
        /* Am√©lioration des checkbox et inputs en mode sombre */
        [data-theme="dark"] input[type="checkbox"] {
            filter: brightness(1.2);
            background: #374151;
        }

        [data-theme="dark"] input[type="time"],
        [data-theme="dark"] input[type="date"],
        [data-theme="dark"] input[type="number"],
        [data-theme="dark"] input[type="text"],
        [data-theme="dark"] input[type="file"] {
            background: #374151;
            color: #f9fafb;
            border-color: #4b5563;
        }

        [data-theme="dark"] input[type="color"] {
            background: #374151;
            border-color: #4b5563;
        }

        [data-theme="dark"] .emoji-btn:hover {
            background: #374151;
        }

        [data-theme="dark"] details summary {
            color: var(--text-main);
        }
        
        .gradient-text {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .floating-action {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            transition: all 0.3s;
            z-index: 100;
        }
        
        .floating-action:hover {
            transform: scale(1.1) rotate(90deg);
        }

        @media (max-width: 768px) {
            .floating-action {
                bottom: 20px;
                right: 20px;
                width: 56px;
                height: 56px;
            }

            .floating-action:active {
                transform: scale(0.95);
            }
        }
        
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: var(--primary);
            animation: fall 3s linear;
        }
        
        @keyframes fall {
            to { transform: translateY(100vh) rotate(360deg); opacity: 0; }
        }
        
        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--bg-card);
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border-left: 4px solid var(--primary);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        
        .streak-flame {
            animation: pulse 1s infinite;
        }
    </style>
</head>
<body>

    <!-- Navigation Premium -->
    <nav class="card sticky top-0 z-50 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center space-x-4">
                    <span class="text-2xl font-bold gradient-text">
                        <i class="fas fa-graduation-cap"></i> <span class="hidden sm:inline">MyStudySpace</span>
                    </span>
                    <span class="badge hidden md:inline" style="background: var(--primary); color: white;">ULTIMATE</span>
                </div>
                
                <!-- Navigation Desktop -->
                <div class="hidden lg:flex space-x-6 items-center">
                    <button onclick="showTab('dashboard')" class="nav-item active px-3 py-2 text-sm font-medium hover:text-blue-600">
                        <i class="fas fa-home mr-1"></i> Dashboard
                    </button>
                    <button onclick="showTab('courses')" class="nav-item px-3 py-2 text-sm font-medium hover:text-blue-600">
                        <i class="fas fa-book mr-1"></i> Cours
                    </button>
                    <button onclick="showTab('schedule')" class="nav-item px-3 py-2 text-sm font-medium hover:text-blue-600">
                        <i class="fas fa-calendar mr-1"></i> Planning
                    </button>
                    <button onclick="showTab('grades')" class="nav-item px-3 py-2 text-sm font-medium hover:text-blue-600">
                        <i class="fas fa-chart-line mr-1"></i> Notes
                    </button>
                    <button onclick="showTab('stats')" class="nav-item px-3 py-2 text-sm font-medium hover:text-blue-600">
                        <i class="fas fa-chart-bar mr-1"></i> Stats
                    </button>
                    <button onclick="showTab('tasks')" class="nav-item px-3 py-2 text-sm font-medium hover:text-blue-600">
                        <i class="fas fa-tasks mr-1"></i> T√¢ches
                    </button>
                    <button onclick="openSettings()" class="px-3 py-2 text-sm font-medium hover:text-blue-600">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>

                <!-- Navigation Mobile -->
                <div class="flex lg:hidden items-center space-x-2">
                    <button onclick="openSettings()" class="px-3 py-2 text-sm font-medium hover:text-blue-600">
                        <i class="fas fa-cog"></i>
                    </button>
                    <button onclick="toggleMobileMenu()" class="px-3 py-2 text-sm font-medium hover:text-blue-600" id="mobileMenuBtn">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                </div>
            </div>

            <!-- Menu Mobile D√©roulant -->
            <div id="mobileMenu" class="lg:hidden hidden border-t pt-2 pb-3" style="border-color: var(--border);">
                <div class="flex flex-col space-y-1">
                    <button onclick="showTab('dashboard'); closeMobileMenu()" class="nav-item-mobile active px-3 py-3 text-sm font-medium text-left hover:bg-gray-50 rounded">
                        <i class="fas fa-home mr-2 w-5"></i> Dashboard
                    </button>
                    <button onclick="showTab('courses'); closeMobileMenu()" class="nav-item-mobile px-3 py-3 text-sm font-medium text-left hover:bg-gray-50 rounded">
                        <i class="fas fa-book mr-2 w-5"></i> Cours
                    </button>
                    <button onclick="showTab('schedule'); closeMobileMenu()" class="nav-item-mobile px-3 py-3 text-sm font-medium text-left hover:bg-gray-50 rounded">
                        <i class="fas fa-calendar mr-2 w-5"></i> Planning
                    </button>
                    <button onclick="showTab('grades'); closeMobileMenu()" class="nav-item-mobile px-3 py-3 text-sm font-medium text-left hover:bg-gray-50 rounded">
                        <i class="fas fa-chart-line mr-2 w-5"></i> Notes
                    </button>
                    <button onclick="showTab('stats'); closeMobileMenu()" class="nav-item-mobile px-3 py-3 text-sm font-medium text-left hover:bg-gray-50 rounded">
                        <i class="fas fa-chart-bar mr-2 w-5"></i> Stats
                    </button>
                    <button onclick="showTab('tasks'); closeMobileMenu()" class="nav-item-mobile px-3 py-3 text-sm font-medium text-left hover:bg-gray-50 rounded">
                        <i class="fas fa-tasks mr-2 w-5"></i> T√¢ches
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">

        <!-- DASHBOARD ULTIMATE -->
        <div id="dashboard" class="tab-content active space-y-6">
            
            <!-- Greeting personnalis√© -->
            <div class="card rounded-lg p-6 shadow-lg">
                <h2 class="text-3xl font-bold mb-2" id="greeting">üëã Salut champion !</h2>
                <p class="text-sm opacity-70" id="motivational-quote">La r√©ussite commence par un effort quotidien.</p>
            </div>

            <!-- Stats rapides -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="stat-card">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm opacity-80">Moyenne G√©n√©rale</p>
                            <p class="text-4xl font-bold mt-2" id="dash-global-avg">--/20</p>
                        </div>
                        <i class="fas fa-trophy text-5xl opacity-20"></i>
                    </div>
                    <div class="progress-bar mt-3">
                        <div class="progress-fill" id="avg-progress" style="width: 0%"></div>
                    </div>
                </div>

                <div class="stat-card" style="background: linear-gradient(135deg, #22c55e, #16a34a);">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm opacity-80">Fichiers stock√©s</p>
                            <p class="text-4xl font-bold mt-2" id="dash-files-count">0</p>
                        </div>
                        <i class="fas fa-file-alt text-5xl opacity-20"></i>
                    </div>
                </div>

                <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm opacity-80">S√©rie de travail</p>
                            <p class="text-4xl font-bold mt-2"><span id="streak-count">0</span> <i class="fas fa-fire streak-flame"></i></p>
                        </div>
                        <i class="fas fa-bolt text-5xl opacity-20"></i>
                    </div>
                </div>

                <div class="stat-card" style="background: linear-gradient(135deg, #ec4899, #db2777);">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm opacity-80">T√¢ches compl√©t√©es</p>
                            <p class="text-4xl font-bold mt-2"><span id="tasks-completed">0</span>/<span id="tasks-total">0</span></p>
                        </div>
                        <i class="fas fa-check-circle text-5xl opacity-20"></i>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card rounded-lg p-6 shadow-lg">
                <h3 class="text-xl font-bold mb-4">‚ö° Actions rapides</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4">
                    <button onclick="quickAddCourse()" class="p-3 md:p-4 rounded-lg border-2 border-dashed hover:border-solid transition" style="border-color: var(--primary);">
                        <i class="fas fa-plus-circle text-2xl md:text-3xl mb-2" style="color: var(--primary);"></i>
                        <p class="text-xs md:text-sm font-medium">Nouveau cours</p>
                    </button>
                    <button onclick="quickAddGrade()" class="p-3 md:p-4 rounded-lg border-2 border-dashed hover:border-solid transition" style="border-color: var(--secondary);">
                        <i class="fas fa-star text-2xl md:text-3xl mb-2" style="color: var(--secondary);"></i>
                        <p class="text-xs md:text-sm font-medium">Ajouter note</p>
                    </button>
                    <button onclick="quickAddTask()" class="p-3 md:p-4 rounded-lg border-2 border-dashed hover:border-solid transition" style="border-color: var(--accent);">
                        <i class="fas fa-clipboard-list text-2xl md:text-3xl mb-2" style="color: var(--accent);"></i>
                        <p class="text-xs md:text-sm font-medium">Nouvelle t√¢che</p>
                    </button>
                    <button onclick="exportData()" class="p-3 md:p-4 rounded-lg border-2 border-dashed hover:border-solid transition" style="border-color: #22c55e;">
                        <i class="fas fa-download text-2xl md:text-3xl mb-2" style="color: #22c55e;"></i>
                        <p class="text-xs md:text-sm font-medium">Exporter donn√©es</p>
                    </button>
                </div>
            </div>

            <!-- Prochain cours -->
            <div class="card rounded-lg p-6 shadow-lg">
                <h3 class="text-xl font-bold mb-4">üìÖ Aujourd'hui</h3>
                <div id="today-schedule" class="space-y-2">
                    <p class="text-sm opacity-70">Chargement du planning...</p>
                </div>
            </div>
        </div>

        <!-- COURS & FICHIERS AM√âLIOR√âS -->
        <div id="courses" class="tab-content space-y-6">
            <div class="card shadow-lg rounded-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold gradient-text">üìö Mes Mati√®res</h3>
                    <button onclick="openCourseModal()" class="px-6 py-2 rounded-lg font-medium text-white" style="background: linear-gradient(135deg, var(--primary), var(--secondary));">
                        <i class="fas fa-plus mr-2"></i> Nouveau Cours
                    </button>
                </div>

                <!-- Filtres -->
                <div class="flex gap-3 mb-6">
                    <button onclick="filterCourses('all')" class="filter-btn active px-4 py-2 rounded-lg transition" data-filter="all">Tous</button>
                    <button onclick="filterCourses('S1')" class="filter-btn px-4 py-2 rounded-lg transition" data-filter="S1">Semestre 1</button>
                    <button onclick="filterCourses('S2')" class="filter-btn px-4 py-2 rounded-lg transition" data-filter="S2">Semestre 2</button>
                </div>

                <div id="coursesList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </div>
        </div>

        <!-- AGENDA HEBDOMADAIRE -->
        <div id="schedule" class="tab-content">
            <div class="card shadow-lg rounded-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold gradient-text hidden md:block">üìÖ Mon Agenda Hebdomadaire</h3>
                    <h3 class="text-xl font-bold gradient-text md:hidden">üìÖ Agenda</h3>
                    <div class="flex gap-2 flex-wrap">
                        <div class="flex gap-1">
                            <button onclick="previousWeek()" class="px-3 py-2 rounded-lg border hover:bg-gray-100" title="Semaine pr√©c√©dente">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button onclick="currentWeek()" class="px-3 py-2 rounded-lg border hover:bg-blue-50 text-sm md:text-base" style="color: var(--primary);">
                                <span class="hidden md:inline">Aujourd'hui</span>
                                <i class="fas fa-home md:hidden"></i>
                            </button>
                            <button onclick="nextWeek()" class="px-3 py-2 rounded-lg border hover:bg-gray-100" title="Semaine suivante">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <button onclick="openScheduleSettings()" class="px-3 py-2 rounded-lg border hover:bg-purple-50 hidden md:block">
                            <i class="fas fa-palette mr-2"></i> Personnaliser
                        </button>
                        <button onclick="openScheduleSettings()" class="px-3 py-2 rounded-lg border hover:bg-purple-50 md:hidden" title="Personnaliser">
                            <i class="fas fa-palette"></i>
                        </button>
                        <button onclick="clearSchedule()" class="px-3 py-2 rounded-lg border hover:bg-red-50 text-red-600 hidden md:block">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button onclick="exportSchedule()" class="px-3 py-2 rounded-lg hidden md:block" style="background: var(--primary); color: white;">
                            <i class="fas fa-download mr-2"></i> Exporter
                        </button>
                        <button onclick="exportSchedule()" class="px-3 py-2 rounded-lg md:hidden" style="background: var(--primary); color: white;" title="Exporter">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                </div>
                
                <div class="mb-4 p-4 rounded-lg" style="background: var(--border);">
                    <p class="font-bold text-lg mb-2" id="weekDisplay">Semaine du ...</p>
                    <p class="text-sm opacity-70">
                        üí° <strong>Astuce :</strong> 
                        <span class="hidden md:inline">Clique sur une case pour ajouter/modifier un cours. Double-clique pour supprimer.</span>
                        <span class="md:hidden">Appuie sur + pour ajouter un cours. Appui long pour supprimer.</span>
                        <span class="md:hidden block mt-1">üëâ Fais d√©filer horizontalement pour voir tous les jours</span>
                    </p>
                </div>
                
                <div class="overflow-x-auto pb-4" style="-webkit-overflow-scrolling: touch;">
                    <div class="schedule-grid" id="scheduleGrid" style="min-width: 900px;"></div>
                </div>
            </div>
        </div>

        <!-- NOTES & ANALYSES -->
        <div id="grades" class="tab-content">
            <div class="card shadow-lg rounded-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold gradient-text">üéØ Mes Notes</h3>
                    <button onclick="saveAllGrades()" class="px-6 py-3 rounded-lg text-white font-medium" style="background: linear-gradient(135deg, #22c55e, #16a34a);">
                        <i class="fas fa-save mr-2"></i> Sauvegarder tout
                    </button>
                </div>
                
                <div class="card p-4 mb-6">
                    <h4 class="font-bold mb-3">‚ûï Ajouter une note</h4>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <select id="gradeCourseSelect" class="p-3 border rounded-lg" style="border-color: var(--border);">
                            <option>Choisir une mati√®re...</option>
                        </select>
                        <input type="number" id="gradeValue" placeholder="Note /20" min="0" max="20" step="0.25" class="p-3 border rounded-lg" style="border-color: var(--border);">
                        <input type="number" id="gradeCoef" placeholder="Coefficient" min="0.5" max="10" step="0.5" value="1" class="p-3 border rounded-lg" style="border-color: var(--border);">
                        <input type="text" id="gradeLabel" placeholder="Intitul√© (ex: Partiel)" class="p-3 border rounded-lg" style="border-color: var(--border);">
                    </div>
                    <button onclick="addGrade()" class="w-full mt-4 px-6 py-3 rounded-lg text-white font-medium" style="background: linear-gradient(135deg, #22c55e, #16a34a);">
                        <i class="fas fa-check mr-2"></i> Enregistrer la note
                    </button>
                </div>

                <!-- Affichage par mati√®re -->
                <div id="gradesList" class="space-y-6"></div>
            </div>
        </div>

        <!-- STATISTIQUES AVANC√âES -->
        <div id="stats" class="tab-content space-y-6">
            <div class="card shadow-lg rounded-lg p-6">
                <h3 class="text-2xl font-bold gradient-text mb-6">üìä Statistiques & Analyses</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card p-4">
                        <h4 class="font-bold mb-4">√âvolution de ta moyenne</h4>
                        <canvas id="gradesChart"></canvas>
                    </div>
                    
                    <div class="card p-4">
                        <h4 class="font-bold mb-4">R√©partition par mati√®re</h4>
                        <canvas id="subjectsChart"></canvas>
                    </div>
                    
                    <div class="card p-4">
                        <h4 class="font-bold mb-4">Progression mensuelle</h4>
                        <canvas id="progressChart"></canvas>
                    </div>
                    
                    <div class="card p-4">
                        <h4 class="font-bold mb-4">Insights personnalis√©s</h4>
                        <div id="insights" class="space-y-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- GESTIONNAIRE DE T√ÇCHES -->
        <div id="tasks" class="tab-content space-y-6">
            <div class="card shadow-lg rounded-lg p-6">
                <h3 class="text-2xl font-bold gradient-text mb-6">‚úÖ Mes T√¢ches</h3>
                
                <div class="card p-4 mb-6">
                    <div class="flex gap-4">
                        <input type="text" id="taskInput" placeholder="Nouvelle t√¢che..." class="flex-1 p-3 border rounded-lg" style="border-color: var(--border);">
                        <select id="taskPriority" class="p-3 border rounded-lg" style="border-color: var(--border);">
                            <option value="low">üü¢ Faible</option>
                            <option value="medium" selected>üü° Moyenne</option>
                            <option value="high">üî¥ Haute</option>
                        </select>
                        <input type="date" id="taskDate" class="p-3 border rounded-lg" style="border-color: var(--border);">
                        <button onclick="addTask()" class="px-6 py-3 rounded-lg text-white font-medium" style="background: var(--primary);">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="card p-4">
                        <h4 class="font-bold mb-3 flex items-center"><span class="w-3 h-3 rounded-full bg-yellow-400 mr-2"></span> √Ä faire</h4>
                        <div id="tasks-todo" class="space-y-2"></div>
                    </div>
                    <div class="card p-4">
                        <h4 class="font-bold mb-3 flex items-center"><span class="w-3 h-3 rounded-full bg-blue-400 mr-2"></span> En cours</h4>
                        <div id="tasks-inprogress" class="space-y-2"></div>
                    </div>
                    <div class="card p-4">
                        <h4 class="font-bold mb-3 flex items-center"><span class="w-3 h-3 rounded-full bg-green-400 mr-2"></span> Termin√©</h4>
                        <div id="tasks-done" class="space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Modal Param√®tres -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold gradient-text">‚öôÔ∏è Param√®tres</h3>
                <button onclick="closeSettings()" class="text-2xl">&times;</button>
            </div>

            <!-- Th√®mes -->
            <div class="mb-6">
                <h4 class="font-bold mb-3">üé® Th√®me</h4>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                    <button onclick="setTheme('light')" class="p-4 rounded-lg border-2 hover:border-blue-500 transition">
                        <div class="w-full h-12 rounded bg-gradient-to-r from-blue-500 to-purple-500 mb-2"></div>
                        <p class="text-xs font-medium">Clair</p>
                    </button>
                    <button onclick="setTheme('dark')" class="p-4 rounded-lg border-2 hover:border-blue-500 transition">
                        <div class="w-full h-12 rounded bg-gradient-to-r from-gray-800 to-gray-900 mb-2"></div>
                        <p class="text-xs font-medium">Sombre</p>
                    </button>
                    <button onclick="setTheme('ocean')" class="p-4 rounded-lg border-2 hover:border-blue-500 transition">
                        <div class="w-full h-12 rounded bg-gradient-to-r from-cyan-400 to-blue-500 mb-2"></div>
                        <p class="text-xs font-medium">Oc√©an</p>
                    </button>
                    <button onclick="setTheme('sunset')" class="p-4 rounded-lg border-2 hover:border-blue-500 transition">
                        <div class="w-full h-12 rounded bg-gradient-to-r from-orange-400 to-red-500 mb-2"></div>
                        <p class="text-xs font-medium">Coucher</p>
                    </button>
                    <button onclick="setTheme('forest')" class="p-4 rounded-lg border-2 hover:border-blue-500 transition">
                        <div class="w-full h-12 rounded bg-gradient-to-r from-green-400 to-emerald-500 mb-2"></div>
                        <p class="text-xs font-medium">For√™t</p>
                    </button>
                </div>
            </div>

            <!-- Personnalisation -->
            <div class="mb-6">
                <h4 class="font-bold mb-3">üë§ Personnalisation</h4>
                <input type="text" id="userName" placeholder="Ton pr√©nom" class="w-full p-3 border rounded-lg mb-3" style="border-color: var(--border);">
                <div class="mb-3">
                    <label class="block text-sm font-medium mb-2">Choisis ton avatar</label>
                    <div class="emoji-picker">
                        <span class="emoji-btn" onclick="setAvatar('üë®‚Äçüéì')">üë®‚Äçüéì</span>
                        <span class="emoji-btn" onclick="setAvatar('üë©‚Äçüéì')">üë©‚Äçüéì</span>
                        <span class="emoji-btn" onclick="setAvatar('ü¶∏‚Äç‚ôÇÔ∏è')">ü¶∏‚Äç‚ôÇÔ∏è</span>
                        <span class="emoji-btn" onclick="setAvatar('ü¶∏‚Äç‚ôÄÔ∏è')">ü¶∏‚Äç‚ôÄÔ∏è</span>
                        <span class="emoji-btn" onclick="setAvatar('üßô‚Äç‚ôÇÔ∏è')">üßô‚Äç‚ôÇÔ∏è</span>
                        <span class="emoji-btn" onclick="setAvatar('üßô‚Äç‚ôÄÔ∏è')">üßô‚Äç‚ôÄÔ∏è</span>
                        <span class="emoji-btn" onclick="setAvatar('üê±')">üê±</span>
                        <span class="emoji-btn" onclick="setAvatar('üê∂')">üê∂</span>
                        <span class="emoji-btn" onclick="setAvatar('ü¶ä')">ü¶ä</span>
                        <span class="emoji-btn" onclick="setAvatar('üêº')">üêº</span>
                        <span class="emoji-btn" onclick="setAvatar('ü¶Å')">ü¶Å</span>
                        <span class="emoji-btn" onclick="setAvatar('üêØ')">üêØ</span>
                        <span class="emoji-btn" onclick="setAvatar('üöÄ')">üöÄ</span>
                        <span class="emoji-btn" onclick="setAvatar('‚ö°')">‚ö°</span>
                        <span class="emoji-btn" onclick="setAvatar('üî•')">üî•</span>
                        <span class="emoji-btn" onclick="setAvatar('üíé')">üíé</span>
                    </div>
                </div>
            </div>

            <!-- Options -->
            <div class="mb-6">
                <h4 class="font-bold mb-3">üéØ Options</h4>
                <label class="flex items-center justify-between mb-3 p-3 rounded-lg card cursor-pointer">
                    <span>Animations</span>
                    <input type="checkbox" id="animationsToggle" checked class="w-5 h-5">
                </label>
                <label class="flex items-center justify-between mb-3 p-3 rounded-lg card cursor-pointer">
                    <span>Notifications</span>
                    <input type="checkbox" id="notificationsToggle" checked class="w-5 h-5">
                </label>
                <label class="flex items-center justify-between mb-3 p-3 rounded-lg card cursor-pointer">
                    <span>Confettis de r√©ussite</span>
                    <input type="checkbox" id="confettiToggle" checked class="w-5 h-5">
                </label>
            </div>

            <!-- Actions -->
            <div class="mb-6">
                <h4 class="font-bold mb-3">üíæ Donn√©es</h4>
                <button onclick="exportAllData()" class="w-full mb-2 px-4 py-3 rounded-lg border hover:bg-green-50" style="border-color: var(--border);">
                    <i class="fas fa-download mr-2"></i> Exporter toutes mes donn√©es
                </button>
                <button onclick="importData()" class="w-full mb-2 px-4 py-3 rounded-lg border hover:bg-blue-50" style="border-color: var(--border);">
                    <i class="fas fa-upload mr-2"></i> Importer des donn√©es
                </button>
                <button onclick="resetApp()" class="w-full px-4 py-3 rounded-lg border border-red-300 hover:bg-red-50 text-red-600">
                    <i class="fas fa-exclamation-triangle mr-2"></i> R√©initialiser l'application
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Nouveau Cours -->
    <div id="courseModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold gradient-text">‚ûï Nouveau Cours</h3>
                <button onclick="closeCourseModal()" class="text-2xl">&times;</button>
            </div>
            
            <input type="text" id="courseNameInput" placeholder="Nom de la mati√®re" class="w-full p-3 border rounded-lg mb-4" style="border-color: var(--border);">
            
            <select id="courseSemesterInput" class="w-full p-3 border rounded-lg mb-4" style="border-color: var(--border);">
                <option value="S1">Semestre 1</option>
                <option value="S2">Semestre 2</option>
            </select>
            
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Couleur de la mati√®re (pour l'agenda)</label>
                <div class="flex gap-2">
                    <button onclick="setCourseColor('#3b82f6')" class="w-10 h-10 rounded-full bg-blue-500 border-2 border-transparent hover:border-gray-800"></button>
                    <button onclick="setCourseColor('#8b5cf6')" class="w-10 h-10 rounded-full bg-purple-500 border-2 border-transparent hover:border-gray-800"></button>
                    <button onclick="setCourseColor('#ec4899')" class="w-10 h-10 rounded-full bg-pink-500 border-2 border-transparent hover:border-gray-800"></button>
                    <button onclick="setCourseColor('#22c55e')" class="w-10 h-10 rounded-full bg-green-500 border-2 border-transparent hover:border-gray-800"></button>
                    <button onclick="setCourseColor('#f59e0b')" class="w-10 h-10 rounded-full bg-amber-500 border-2 border-transparent hover:border-gray-800"></button>
                    <button onclick="setCourseColor('#ef4444')" class="w-10 h-10 rounded-full bg-red-500 border-2 border-transparent hover:border-gray-800"></button>
                    <button onclick="setCourseColor('#06b6d4')" class="w-10 h-10 rounded-full bg-cyan-500 border-2 border-transparent hover:border-gray-800"></button>
                </div>
            </div>
            
            <button onclick="addCourse()" class="w-full px-6 py-3 rounded-lg text-white font-medium" style="background: linear-gradient(135deg, var(--primary), var(--secondary));">
                <i class="fas fa-check mr-2"></i> Cr√©er le cours
            </button>
        </div>
    </div>

    <!-- Modal Personnalisation Agenda -->
    <div id="scheduleSettingsModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold gradient-text">üé® Personnaliser l'Agenda</h3>
                <button onclick="closeScheduleSettings()" class="text-2xl">&times;</button>
            </div>
            
            <div class="mb-6">
                <h4 class="font-bold mb-3">Horaires personnalis√©s</h4>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm mb-1">Heure de d√©but</label>
                        <input type="time" id="scheduleStartTime" value="08:00" class="w-full p-2 border rounded-lg" style="border-color: var(--border);">
                    </div>
                    <div>
                        <label class="block text-sm mb-1">Heure de fin</label>
                        <input type="time" id="scheduleEndTime" value="18:00" class="w-full p-2 border rounded-lg" style="border-color: var(--border);">
                    </div>
                </div>
            </div>

            <div class="mb-6">
                <h4 class="font-bold mb-3">Couleurs par mati√®re</h4>
                <p class="text-sm opacity-70 mb-3">Choisis une couleur pour chaque cours dans l'agenda</p>
                <div id="courseColorsList" class="space-y-2"></div>
            </div>

            <div class="mb-6">
                <h4 class="font-bold mb-3">Affichage</h4>
                <label class="flex items-center justify-between mb-3 p-3 rounded-lg card cursor-pointer">
                    <span>Afficher le week-end</span>
                    <input type="checkbox" id="showWeekendToggle" class="w-5 h-5">
                </label>
                <label class="flex items-center justify-between mb-3 p-3 rounded-lg card cursor-pointer">
                    <span>Vue compacte</span>
                    <input type="checkbox" id="compactViewToggle" class="w-5 h-5">
                </label>
            </div>

            <button onclick="applyScheduleSettings()" class="w-full px-6 py-3 rounded-lg text-white font-medium" style="background: linear-gradient(135deg, var(--primary), var(--secondary));">
                <i class="fas fa-save mr-2"></i> Appliquer les param√®tres
            </button>
        </div>
    </div>

    <!-- Modal Ajouter Cours √† l'Agenda -->
    <div id="addScheduleEventModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold gradient-text">‚ûï Ajouter un cours</h3>
                <button onclick="closeAddScheduleEvent()" class="text-2xl">&times;</button>
            </div>
            
            <select id="eventCourseSelect" class="w-full p-3 border rounded-lg mb-4" style="border-color: var(--border);">
                <option value="">S√©lectionner une mati√®re...</option>
            </select>

            <div class="grid grid-cols-2 gap-3 mb-4">
                <div>
                    <label class="block text-sm mb-1">Heure de d√©but</label>
                    <input type="time" id="eventStartTime" class="w-full p-2 border rounded-lg" style="border-color: var(--border);">
                </div>
                <div>
                    <label class="block text-sm mb-1">Heure de fin</label>
                    <input type="time" id="eventEndTime" class="w-full p-2 border rounded-lg" style="border-color: var(--border);">
                </div>
            </div>

            <input type="text" id="eventLocation" placeholder="Salle (optionnel)" class="w-full p-3 border rounded-lg mb-4" style="border-color: var(--border);">
            
            <textarea id="eventNotes" placeholder="Notes (optionnel)" class="w-full p-3 border rounded-lg mb-4" rows="2" style="border-color: var(--border);"></textarea>

            <button onclick="saveScheduleEvent()" class="w-full px-6 py-3 rounded-lg text-white font-medium" style="background: linear-gradient(135deg, var(--primary), var(--secondary));">
                <i class="fas fa-check mr-2"></i> Ajouter au planning
            </button>
        </div>
    </div>

    <!-- Floating Action Button -->
    <div class="floating-action" onclick="openQuickMenu()" title="Menu rapide">
        <i class="fas fa-magic text-2xl"></i>
    </div>

    <script>
        // ===== BASE DE DONN√âES =====
        const db = new Dexie("MyStudyAppUltimate");
        db.version(3).stores({
            courses: '++id, name, semester, color',
            files: '++id, courseId, name, blob',
            grades: '++id, courseId, label, value, coef, date',
            schedule: 'id, content',
            scheduleEvents: '++id, courseId, day, startTime, endTime, location, notes, weekStart',
            tasks: '++id, title, status, priority, date, completed',
            settings: 'key, value'
        });

        let selectedCourseColor = '#3b82f6';
        let copiedScheduleCell = null;
        let currentWeekStart = getMonday(new Date());
        let selectedScheduleCell = null;

        // ===== SETTINGS & THEME =====
        async function loadSettings() {
            const theme = await getSetting('theme') || 'light';
            const userName = await getSetting('userName') || 'Champion';
            const avatar = await getSetting('avatar') || 'üë®‚Äçüéì';
            
            setTheme(theme);
            document.getElementById('userName').value = userName;
            updateGreeting();
        }

        async function getSetting(key) {
            const setting = await db.settings.get(key);
            return setting ? setting.value : null;
        }

        async function setSetting(key, value) {
            await db.settings.put({ key, value });
        }

        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            setSetting('theme', theme);
        }

        async function setAvatar(emoji) {
            await setSetting('avatar', emoji);
            updateGreeting();
            showNotification('Avatar mis √† jour ! ' + emoji);
        }

        async function updateGreeting() {
            const hour = new Date().getHours();
            const userName = await getSetting('userName') || 'Champion';
            const avatar = await getSetting('avatar') || 'üë®‚Äçüéì';
            
            let greeting = '';
            if (hour < 12) greeting = 'Bonjour';
            else if (hour < 18) greeting = 'Bon apr√®s-midi';
            else greeting = 'Bonsoir';
            
            document.getElementById('greeting').innerHTML = `${avatar} ${greeting} ${userName} !`;
            
            // Citation motivante al√©atoire
            const quotes = [
                "La r√©ussite commence par un effort quotidien.",
                "Chaque jour est une nouvelle opportunit√©.",
                "Crois en toi et tout est possible !",
                "Le succ√®s est la somme de petits efforts r√©p√©t√©s.",
                "Tu es plus fort que tu ne le penses !",
                "L'√©chec est le fondement de la r√©ussite.",
                "Vise la lune, m√™me si tu la rates, tu atterriras parmi les √©toiles.",
                "Le seul moyen d'√©chouer est d'abandonner."
            ];
            document.getElementById('motivational-quote').innerText = quotes[Math.floor(Math.random() * quotes.length)];
        }

        document.getElementById('userName').addEventListener('change', (e) => {
            setSetting('userName', e.target.value);
            updateGreeting();
        });

        // ===== NAVIGATION =====
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item-mobile').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            
            // Marquer l'item actif dans la nav desktop
            const navButtons = document.querySelectorAll('.nav-item');
            navButtons.forEach(btn => {
                if(btn.textContent.toLowerCase().includes(tabId === 'dashboard' ? 'dashboard' : 
                   tabId === 'courses' ? 'cours' : 
                   tabId === 'schedule' ? 'planning' : 
                   tabId === 'grades' ? 'notes' :
                   tabId === 'stats' ? 'stats' : 't√¢ches')) {
                    btn.classList.add('active');
                }
            });

            // Marquer l'item actif dans la nav mobile
            const mobileButtons = document.querySelectorAll('.nav-item-mobile');
            mobileButtons.forEach(btn => {
                if(btn.textContent.toLowerCase().includes(tabId === 'dashboard' ? 'dashboard' : 
                   tabId === 'courses' ? 'cours' : 
                   tabId === 'schedule' ? 'planning' : 
                   tabId === 'grades' ? 'notes' :
                   tabId === 'stats' ? 'stats' : 't√¢ches')) {
                    btn.classList.add('active');
                }
            });
            
            if (tabId === 'stats') renderCharts();
            if (tabId === 'dashboard') updateDashboard();
            if (tabId === 'tasks') renderTasks();
        }

        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            const icon = document.querySelector('#mobileMenuBtn i');
            
            if(menu.classList.contains('hidden')) {
                menu.classList.remove('hidden');
                icon.classList.remove('fa-bars');
                icon.classList.add('fa-times');
            } else {
                menu.classList.add('hidden');
                icon.classList.remove('fa-times');
                icon.classList.add('fa-bars');
            }
        }

        function closeMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            const icon = document.querySelector('#mobileMenuBtn i');
            menu.classList.add('hidden');
            icon.classList.remove('fa-times');
            icon.classList.add('fa-bars');
        }

        // ===== MODALS =====
        function openSettings() {
            document.getElementById('settingsModal').classList.add('active');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        function openCourseModal() {
            document.getElementById('courseModal').classList.add('active');
        }

        function closeCourseModal() {
            document.getElementById('courseModal').classList.remove('active');
        }

        function setCourseColor(color) {
            selectedCourseColor = color;
        }

        // ===== COURS =====
        async function addCourse() {
            const name = document.getElementById('courseNameInput').value;
            const semester = document.getElementById('courseSemesterInput').value;
            
            if(!name) return showNotification('‚ö†Ô∏è Nom manquant', 'warning');

            await db.courses.add({ name, semester, color: selectedCourseColor });
            document.getElementById('courseNameInput').value = '';
            selectedCourseColor = '#3b82f6';
            closeCourseModal();
            showNotification('‚úÖ Cours ajout√© avec succ√®s !');
            await refreshUI();
            launchConfetti();
        }

        async function uploadFile(courseId, inputElement) {
            const file = inputElement.files[0];
            if (!file) return;

            await db.files.add({
                courseId: courseId,
                name: file.name,
                blob: file
            });
            showNotification('üìÑ Fichier ajout√© !');
            await refreshUI();
        }

        async function deleteFile(id) {
            if(confirm('Supprimer ce fichier ?')) {
                await db.files.delete(id);
                showNotification('üóëÔ∏è Fichier supprim√©');
                await refreshUI();
            }
        }

        async function deleteCourse(id) {
            if(confirm('Supprimer ce cours et tous ses fichiers/notes ?')) {
                await db.courses.delete(id);
                await db.files.where('courseId').equals(id).delete();
                await db.grades.where('courseId').equals(id).delete();
                showNotification('üóëÔ∏è Cours supprim√©');
                await refreshUI();
            }
        }

        function filterCourses(filter) {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            document.querySelectorAll('.course-card').forEach(card => {
                if(filter === 'all' || card.dataset.semester === filter) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        async function renderCourses() {
            const courses = await db.courses.toArray();
            const container = document.getElementById('coursesList');
            const select = document.getElementById('gradeCourseSelect');
            
            container.innerHTML = '';
            select.innerHTML = '<option value="">Choisir une mati√®re...</option>';

            // Grouper par semestre
            const s1Courses = courses.filter(c => c.semester === 'S1');
            const s2Courses = courses.filter(c => c.semester === 'S2');

            const renderSemesterCourses = async (semesterCourses, semesterName) => {
                if(semesterCourses.length === 0) return;

                const semesterDiv = document.createElement('div');
                semesterDiv.className = 'col-span-full mb-4';
                semesterDiv.innerHTML = `
                    <div class="flex items-center gap-3 mb-4">
                        <h4 class="text-xl font-bold gradient-text">${semesterName}</h4>
                        <div class="flex-1 h-px" style="background: var(--border);"></div>
                        <span class="badge" style="background: var(--border); color: var(--text-main);">${semesterCourses.length} cours</span>
                    </div>
                `;
                container.appendChild(semesterDiv);

                for (const course of semesterCourses) {
                    const option = document.createElement('option');
                    option.value = course.id;
                    option.innerText = `${course.name} (${course.semester})`;
                    select.appendChild(option);

                    const files = await db.files.where('courseId').equals(course.id).toArray();
                    const grades = await db.grades.where('courseId').equals(course.id).toArray();
                    const avgGrade = grades.length > 0 ? (grades.reduce((a, b) => a + (b.value * (b.coef || 1)), 0) / grades.reduce((a, b) => a + (b.coef || 1), 0)).toFixed(2) : '--';

                    const div = document.createElement('div');
                    div.className = 'card rounded-lg p-5 hover:shadow-xl transition course-card';
                    div.dataset.semester = course.semester;
                    div.style.borderLeft = `4px solid ${course.color || '#3b82f6'}`;
                    
                    div.innerHTML = `
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex-1">
                                <h4 class="font-bold text-xl mb-2" style="color: ${course.color}">${course.name}</h4>
                                <div class="flex gap-2 flex-wrap">
                                    <span class="badge text-xs" style="background: ${course.color}; color: white;">${course.semester}</span>
                                    <span class="badge text-xs" style="background: var(--border); color: var(--text-main);">
                                        üìä Moyenne: ${avgGrade}/20
                                    </span>
                                    <span class="badge text-xs" style="background: var(--border); color: var(--text-main);">
                                        üìÅ ${files.length} fichier${files.length > 1 ? 's' : ''}
                                    </span>
                                    <span class="badge text-xs" style="background: var(--border); color: var(--text-main);">
                                        üìù ${grades.length} note${grades.length > 1 ? 's' : ''}
                                    </span>
                                </div>
                            </div>
                            <button onclick="deleteCourse(${course.id})" class="text-red-500 hover:text-red-700 text-xl transition" title="Supprimer le cours">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">üìé Ajouter un fichier</label>
                            <input type="file" onchange="uploadFile(${course.id}, this)" accept=".pdf,.jpg,.jpeg,.png,.docx,.doc,.ppt,.pptx" class="text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:text-white hover:file:opacity-80 transition" style="file:background: ${course.color};">
                        </div>

                        <div class="card p-3 rounded-lg">
                            <div class="flex justify-between items-center mb-2">
                                <p class="text-xs font-bold uppercase opacity-60">üìÅ Fichiers (${files.length})</p>
                                ${files.length > 0 ? `<button onclick="downloadAllFiles(${course.id}, '${course.name}')" class="text-xs hover:underline" style="color: ${course.color};">Tout t√©l√©charger</button>` : ''}
                            </div>
                            <ul class="space-y-2 max-h-48 overflow-y-auto">
                                ${files.length === 0 ? '<li class="text-xs opacity-50 italic text-center py-2">Aucun fichier</li>' : ''}
                                ${files.map(f => `
                                    <li class="flex justify-between items-center text-sm p-3 rounded transition hover:shadow" style="background: var(--border);">
                                        <a href="${URL.createObjectURL(f.blob)}" target="_blank" class="truncate flex-1 hover:underline font-medium" style="color: var(--primary);">
                                            <i class="far fa-file-pdf mr-2"></i>${f.name}
                                        </a>
                                        <button onclick="deleteFile(${f.id})" class="ml-2 text-red-400 hover:text-red-600 transition">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    `;
                    container.appendChild(div);
                }
            };

            await renderSemesterCourses(s1Courses, 'üìò Semestre 1');
            await renderSemesterCourses(s2Courses, 'üìó Semestre 2');
            
            const fileCount = await db.files.count();
            document.getElementById('dash-files-count').innerText = fileCount;
        }

        async function downloadAllFiles(courseId, courseName) {
            const files = await db.files.where('courseId').equals(courseId).toArray();
            
            for(const file of files) {
                const url = URL.createObjectURL(file.blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = file.name;
                a.click();
                await new Promise(resolve => setTimeout(resolve, 200)); // D√©lai entre t√©l√©chargements
            }
            
            showNotification(`üì• ${files.length} fichier(s) de ${courseName} t√©l√©charg√©(s) !`);
        }

        // ===== NOTES =====
        async function addGrade() {
            const courseId = parseInt(document.getElementById('gradeCourseSelect').value);
            const value = parseFloat(document.getElementById('gradeValue').value);
            const coef = parseFloat(document.getElementById('gradeCoef').value) || 1;
            const label = document.getElementById('gradeLabel').value;
            const date = new Date().toISOString();

            if (!courseId || isNaN(value)) return showNotification('‚ö†Ô∏è Veuillez remplir les champs', 'warning');

            await db.grades.add({ courseId, value, coef, label, date });
            document.getElementById('gradeValue').value = '';
            document.getElementById('gradeLabel').value = '';
            document.getElementById('gradeCoef').value = '1';
            
            showNotification('üéØ Note enregistr√©e !');
            await refreshUI();
            
            if(value >= 15) launchConfetti();
        }

        async function renderGrades() {
            const courses = await db.courses.toArray();
            const container = document.getElementById('gradesList');
            container.innerHTML = '';
            
            let totalWeightedSum = 0;
            let totalCoef = 0;

            // Grouper par semestre
            const s1Courses = courses.filter(c => c.semester === 'S1');
            const s2Courses = courses.filter(c => c.semester === 'S2');

            const renderSemester = async (semesterCourses, semesterName) => {
                const semesterDiv = document.createElement('div');
                semesterDiv.className = 'mb-6';
                
                let semesterHtml = `
                    <div class="flex items-center gap-3 mb-4">
                        <h4 class="text-xl font-bold gradient-text">${semesterName}</h4>
                        <div class="flex-1 h-px" style="background: var(--border);"></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                `;

                let semesterTotal = 0;
                let semesterCount = 0;

                for (const course of semesterCourses) {
                    const grades = await db.grades.where('courseId').equals(course.id).toArray();
                    if (grades.length === 0) continue;

                    const weightedSum = grades.reduce((a, b) => a + (b.value * (b.coef || 1)), 0);
                    const coefSum = grades.reduce((a, b) => a + (b.coef || 1), 0);
                    const avg = (weightedSum / coefSum).toFixed(2);
                    
                    totalWeightedSum += parseFloat(avg);
                    totalCoef++;
                    semesterTotal += parseFloat(avg);
                    semesterCount++;

                    // Calcul des stats
                    const maxGrade = Math.max(...grades.map(g => g.value));
                    const minGrade = Math.min(...grades.map(g => g.value));
                    const lastGrade = grades.sort((a, b) => new Date(b.date) - new Date(a.date))[0];

                    semesterHtml += `
                        <div class="card rounded-lg p-5 hover:shadow-xl transition" style="border-left: 4px solid ${course.color || '#3b82f6'};">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex-1">
                                    <h5 class="font-bold text-lg mb-1" style="color: ${course.color}">${course.name}</h5>
                                    <div class="flex gap-2 flex-wrap">
                                        <span class="badge text-xs" style="background: ${course.color}; color: white;">
                                            ${grades.length} note${grades.length > 1 ? 's' : ''}
                                        </span>
                                        <span class="badge text-xs" style="background: var(--border); color: var(--text-main);">
                                            üìä Moy: ${avg}/20
                                        </span>
                                        ${avg >= 15 ? '<span class="badge text-xs" style="background: #22c55e; color: white;">üåü Excellent</span>' : 
                                          avg >= 12 ? '<span class="badge text-xs" style="background: #f59e0b; color: white;">üëç Bien</span>' : 
                                          avg >= 10 ? '<span class="badge text-xs" style="background: #3b82f6; color: white;">‚úì Valid√©</span>' : 
                                          '<span class="badge text-xs" style="background: #ef4444; color: white;">‚ö†Ô∏è √Ä am√©liorer</span>'}
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-3xl font-bold ${avg < 10 ? 'text-red-500' : avg < 14 ? 'text-yellow-500' : 'text-green-600'}">${avg}</div>
                                    <div class="text-xs opacity-60">/20</div>
                                </div>
                            </div>
                            
                            <div class="progress-bar mb-3">
                                <div class="progress-fill" style="width: ${(avg/20)*100}%; background: ${course.color || 'var(--primary)'}"></div>
                            </div>

                            <div class="grid grid-cols-3 gap-2 mb-3 text-center">
                                <div class="p-2 rounded" style="background: var(--border);">
                                    <div class="text-xs opacity-60">Meilleure</div>
                                    <div class="font-bold text-green-600">${maxGrade}/20</div>
                                </div>
                                <div class="p-2 rounded" style="background: var(--border);">
                                    <div class="text-xs opacity-60">Derni√®re</div>
                                    <div class="font-bold" style="color: ${course.color}">${lastGrade.value}/20</div>
                                </div>
                                <div class="p-2 rounded" style="background: var(--border);">
                                    <div class="text-xs opacity-60">Plus basse</div>
                                    <div class="font-bold text-red-600">${minGrade}/20</div>
                                </div>
                            </div>

                            <details class="cursor-pointer">
                                <summary class="font-medium text-sm mb-2 hover:opacity-70 transition">
                                    <i class="fas fa-chevron-down mr-2"></i>Voir toutes les notes (${grades.length})
                                </summary>
                                <ul class="space-y-2 mt-2 max-h-60 overflow-y-auto">
                                    ${grades.sort((a, b) => new Date(b.date) - new Date(a.date)).map(g => `
                                        <li class="flex justify-between items-center text-sm p-3 rounded transition hover:shadow" style="background: var(--border);">
                                            <div class="flex-1">
                                                <span class="font-medium">${g.label || 'Note'}</span>
                                                <div class="text-xs opacity-60 mt-1">
                                                    <i class="far fa-calendar mr-1"></i>${new Date(g.date).toLocaleDateString('fr-FR')}
                                                    ${g.coef > 1 ? `<span class="badge ml-2" style="background: ${course.color}; color: white; font-size: 0.6rem;">Coef. ${g.coef}</span>` : ''}
                                                </div>
                                            </div>
                                            <div class="flex items-center gap-3">
                                                <span class="font-mono font-bold text-lg ${g.value >= 15 ? 'text-green-600' : g.value >= 10 ? 'text-blue-600' : 'text-red-600'}">${g.value}/20</span>
                                                <button onclick="deleteGrade(${g.id})" class="text-red-300 hover:text-red-500 transition">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        </li>
                                    `).join('')}
                                </ul>
                            </details>
                        </div>
                    `;
                }

                semesterHtml += '</div>';

                if(semesterCount > 0) {
                    const semesterAvg = (semesterTotal / semesterCount).toFixed(2);
                    semesterHtml = `
                        <div class="flex items-center gap-3 mb-4">
                            <h4 class="text-xl font-bold gradient-text">${semesterName}</h4>
                            <div class="flex-1 h-px" style="background: var(--border);"></div>
                            <div class="text-right">
                                <div class="text-sm opacity-60">Moyenne ${semesterName}</div>
                                <div class="text-2xl font-bold ${semesterAvg >= 14 ? 'text-green-600' : semesterAvg >= 10 ? 'text-blue-600' : 'text-red-600'}">${semesterAvg}/20</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    ` + semesterHtml.split('</div>').slice(1).join('</div>');
                }

                semesterDiv.innerHTML = semesterHtml;
                container.appendChild(semesterDiv);
            };

            await renderSemester(s1Courses, 'üìò Semestre 1');
            await renderSemester(s2Courses, 'üìó Semestre 2');
            
            const globalAvg = totalCoef > 0 ? (totalWeightedSum / totalCoef).toFixed(2) : "--";
            document.getElementById('dash-global-avg').innerText = globalAvg + "/20";
            
            const avgProgress = globalAvg !== "--" ? (parseFloat(globalAvg) / 20) * 100 : 0;
            document.getElementById('avg-progress').style.width = avgProgress + '%';
        }

        async function deleteGrade(id) {
            if(confirm('Supprimer cette note ?')) {
                await db.grades.delete(id);
                showNotification('üóëÔ∏è Note supprim√©e');
                await refreshUI();
            }
        }

        async function saveAllGrades() {
            const grades = await db.grades.toArray();
            const courses = await db.courses.toArray();

            const data = {
                exportDate: new Date().toISOString(),
                courses: courses.map(c => ({
                    name: c.name,
                    semester: c.semester,
                    grades: grades.filter(g => g.courseId === c.id).map(g => ({
                        label: g.label,
                        value: g.value,
                        coef: g.coef,
                        date: g.date
                    }))
                }))
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `notes-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            showNotification('üíæ Notes sauvegard√©es !');
        }

        // ===== PLANNING / AGENDA =====
        function getMonday(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function formatDate(date) {
            return date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });
        }

        function previousWeek() {
            currentWeekStart = new Date(currentWeekStart);
            currentWeekStart.setDate(currentWeekStart.getDate() - 7);
            initSchedule();
        }

        function currentWeek() {
            currentWeekStart = getMonday(new Date());
            initSchedule();
        }

        function nextWeek() {
            currentWeekStart = new Date(currentWeekStart);
            currentWeekStart.setDate(currentWeekStart.getDate() + 7);
            initSchedule();
        }

        async function initSchedule() {
            const showWeekend = await getSetting('showWeekend') || false;
            const compactView = await getSetting('compactView') || false;
            const scheduleStart = await getSetting('scheduleStart') || '08:00';
            const scheduleEnd = await getSetting('scheduleEnd') || '18:00';

            // Calcul des heures
            const startHour = parseInt(scheduleStart.split(':')[0]);
            const endHour = parseInt(scheduleEnd.split(':')[0]);
            const hours = [];
            for(let h = startHour; h <= endHour; h++) {
                hours.push(`${h.toString().padStart(2, '0')}:00`);
            }

            const days = showWeekend 
                ? ['Heure', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche']
                : ['Heure', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi'];

            const grid = document.getElementById('scheduleGrid');
            grid.innerHTML = '';
            grid.style.gridTemplateColumns = `80px repeat(${days.length - 1}, 1fr)`;

            // Affichage de la semaine
            const weekEnd = new Date(currentWeekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            document.getElementById('weekDisplay').innerText = 
                `Semaine du ${formatDate(currentWeekStart)} au ${formatDate(weekEnd)}`;

            // En-t√™tes avec dates
            days.forEach((day, index) => {
                const div = document.createElement('div');
                div.className = 'schedule-header';
                
                if(index === 0) {
                    div.innerText = day;
                } else {
                    const dayDate = new Date(currentWeekStart);
                    dayDate.setDate(dayDate.getDate() + (index - 1));
                    const isToday = dayDate.toDateString() === new Date().toDateString();
                    
                    div.innerHTML = `
                        <div class="text-xs opacity-80">${day}</div>
                        <div class="font-bold ${isToday ? 'text-yellow-300' : ''}">${dayDate.getDate()}</div>
                    `;
                    
                    if(isToday) {
                        div.style.background = 'linear-gradient(135deg, var(--accent), var(--primary))';
                    }
                }
                
                grid.appendChild(div);
            });

            // Cellules de planning
            const courses = await db.courses.toArray();
            const weekStartStr = currentWeekStart.toISOString().split('T')[0];

            for (let h = 0; h < hours.length; h++) {
                // Colonne heure
                const timeDiv = document.createElement('div');
                timeDiv.className = 'p-2 text-center text-xs font-bold flex items-center justify-center';
                timeDiv.style.background = 'var(--border)';
                timeDiv.innerText = hours[h];
                grid.appendChild(timeDiv);

                // Cellules pour chaque jour
                for (let d = 1; d < days.length; d++) {
                    const cell = document.createElement('div');
                    cell.className = 'schedule-cell relative group';
                    cell.dataset.day = d - 1; // 0 = lundi
                    cell.dataset.hour = hours[h];
                    
                    // V√©rifier s'il y a un √©v√©nement
                    const events = await db.scheduleEvents
                        .where('weekStart').equals(weekStartStr)
                        .and(e => e.day === (d - 1) && e.startTime === hours[h])
                        .toArray();

                    if(events.length > 0) {
                        const event = events[0];
                        const course = courses.find(c => c.id === event.courseId);
                        
                        if(course) {
                            const duration = calculateDuration(event.startTime, event.endTime);
                            cell.innerHTML = `
                                <div class="p-2 rounded h-full" style="background: ${course.color}20; border-left: 3px solid ${course.color};">
                                    <div class="font-bold text-sm" style="color: ${course.color};">${course.name}</div>
                                    <div class="text-xs opacity-70 mt-1">${event.startTime} - ${event.endTime}</div>
                                    ${event.location ? `<div class="text-xs opacity-60 mt-1"><i class="fas fa-map-marker-alt mr-1"></i>${event.location}</div>` : ''}
                                </div>
                            `;
                            
                            // Si dur√©e > 1h, √©tendre la cellule
                            if(duration > 1) {
                                cell.style.gridRow = `span ${duration}`;
                            }
                        }
                    }

                    // Bouton ajouter au survol
                    const addBtn = document.createElement('button');
                    addBtn.innerHTML = '<i class="fas fa-plus"></i>';
                    addBtn.className = 'absolute top-1 right-1 w-6 h-6 rounded-full text-xs opacity-0 group-hover:opacity-100 transition';
                    addBtn.style.background = 'var(--primary)';
                    addBtn.style.color = 'white';
                    addBtn.onclick = () => openAddScheduleEvent(d - 1, hours[h]);
                    cell.appendChild(addBtn);

                    // Double-clic pour supprimer (desktop) ou long press (mobile)
                    let pressTimer;
                    cell.addEventListener('touchstart', (e) => {
                        if(events.length > 0) {
                            pressTimer = setTimeout(() => {
                                if(confirm('Supprimer ce cours ?')) {
                                    db.scheduleEvents.delete(events[0].id);
                                    initSchedule();
                                    showNotification('üóëÔ∏è Cours supprim√©');
                                }
                            }, 800);
                        }
                    });

                    cell.addEventListener('touchend', () => {
                        clearTimeout(pressTimer);
                    });

                    cell.addEventListener('touchmove', () => {
                        clearTimeout(pressTimer);
                    });

                    cell.ondblclick = async () => {
                        if(events.length > 0) {
                            if(confirm('Supprimer ce cours ?')) {
                                await db.scheduleEvents.delete(events[0].id);
                                await initSchedule();
                                showNotification('üóëÔ∏è Cours supprim√©');
                            }
                        }
                    };

                    grid.appendChild(cell);
                }
            }
        }

        function calculateDuration(startTime, endTime) {
            const start = parseInt(startTime.split(':')[0]);
            const end = parseInt(endTime.split(':')[0]);
            return end - start;
        }

        function openScheduleSettings() {
            document.getElementById('scheduleSettingsModal').classList.add('active');
            renderCourseColorsList();
        }

        function closeScheduleSettings() {
            document.getElementById('scheduleSettingsModal').classList.remove('active');
        }

        async function renderCourseColorsList() {
            const courses = await db.courses.toArray();
            const container = document.getElementById('courseColorsList');
            
            container.innerHTML = courses.map(course => `
                <div class="flex items-center justify-between p-3 rounded-lg card">
                    <span class="font-medium">${course.name}</span>
                    <input type="color" value="${course.color || '#3b82f6'}" 
                           onchange="updateCourseColor(${course.id}, this.value)"
                           class="w-12 h-8 rounded cursor-pointer">
                </div>
            `).join('');
        }

        async function updateCourseColor(courseId, color) {
            await db.courses.update(courseId, { color });
            showNotification('üé® Couleur mise √† jour !');
            await initSchedule();
        }

        async function applyScheduleSettings() {
            const startTime = document.getElementById('scheduleStartTime').value;
            const endTime = document.getElementById('scheduleEndTime').value;
            const showWeekend = document.getElementById('showWeekendToggle').checked;
            const compactView = document.getElementById('compactViewToggle').checked;

            await setSetting('scheduleStart', startTime);
            await setSetting('scheduleEnd', endTime);
            await setSetting('showWeekend', showWeekend);
            await setSetting('compactView', compactView);

            closeScheduleSettings();
            await initSchedule();
            showNotification('‚úÖ Param√®tres appliqu√©s !');
        }

        function openAddScheduleEvent(day, hour) {
            selectedScheduleCell = { day, hour };
            document.getElementById('addScheduleEventModal').classList.add('active');
            document.getElementById('eventStartTime').value = hour;
            
            // Auto-remplir heure de fin (+1h)
            const endHour = parseInt(hour.split(':')[0]) + 1;
            document.getElementById('eventEndTime').value = `${endHour.toString().padStart(2, '0')}:00`;
            
            // Remplir le select des cours
            populateEventCourseSelect();
        }

        function closeAddScheduleEvent() {
            document.getElementById('addScheduleEventModal').classList.remove('active');
            selectedScheduleCell = null;
        }

        async function populateEventCourseSelect() {
            const courses = await db.courses.toArray();
            const select = document.getElementById('eventCourseSelect');
            
            select.innerHTML = '<option value="">S√©lectionner une mati√®re...</option>' +
                courses.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }

        async function saveScheduleEvent() {
            const courseId = parseInt(document.getElementById('eventCourseSelect').value);
            const startTime = document.getElementById('eventStartTime').value;
            const endTime = document.getElementById('eventEndTime').value;
            const location = document.getElementById('eventLocation').value;
            const notes = document.getElementById('eventNotes').value;

            if(!courseId || !selectedScheduleCell) {
                return showNotification('‚ö†Ô∏è Mati√®re manquante', 'warning');
            }

            const weekStartStr = currentWeekStart.toISOString().split('T')[0];

            await db.scheduleEvents.add({
                courseId,
                day: selectedScheduleCell.day,
                startTime,
                endTime,
                location,
                notes,
                weekStart: weekStartStr
            });

            // Reset form
            document.getElementById('eventLocation').value = '';
            document.getElementById('eventNotes').value = '';

            closeAddScheduleEvent();
            await initSchedule();
            showNotification('‚úÖ Cours ajout√© √† l\'agenda !');
        }

        async function clearSchedule() {
            if(confirm('Effacer tout l\'emploi du temps de cette semaine ?')) {
                const weekStartStr = currentWeekStart.toISOString().split('T')[0];
                await db.scheduleEvents.where('weekStart').equals(weekStartStr).delete();
                await initSchedule();
                showNotification('üóëÔ∏è Planning effac√©');
            }
        }

        async function exportSchedule() {
            const weekStartStr = currentWeekStart.toISOString().split('T')[0];
            const events = await db.scheduleEvents.where('weekStart').equals(weekStartStr).toArray();
            const courses = await db.courses.toArray();

            let text = `MON AGENDA - Semaine du ${formatDate(currentWeekStart)}\n\n`;

            const days = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche'];
            
            days.forEach((dayName, dayIndex) => {
                const dayEvents = events.filter(e => e.day === dayIndex).sort((a, b) => a.startTime.localeCompare(b.startTime));
                
                if(dayEvents.length > 0) {
                    text += `\n=== ${dayName.toUpperCase()} ===\n`;
                    dayEvents.forEach(event => {
                        const course = courses.find(c => c.id === event.courseId);
                        if(course) {
                            text += `${event.startTime} - ${event.endTime} : ${course.name}`;
                            if(event.location) text += ` (${event.location})`;
                            if(event.notes) text += ` - ${event.notes}`;
                            text += '\n';
                        }
                    });
                }
            });

            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `agenda-${weekStartStr}.txt`;
            a.click();
            showNotification('üì• Agenda export√© !');
        }

        async function updateTodaySchedule() {
            const dayIndex = new Date().getDay(); // 0=Dimanche, 1=Lundi, etc.
            const container = document.getElementById('today-schedule');
            
            if(dayIndex === 0 || dayIndex === 6) {
                container.innerHTML = '<p class="text-sm opacity-70">üå¥ C\'est le week-end ! Profite-en pour te reposer.</p>';
                return;
            }

            const weekStartStr = getMonday(new Date()).toISOString().split('T')[0];
            const events = await db.scheduleEvents
                .where('weekStart').equals(weekStartStr)
                .and(e => e.day === (dayIndex - 1))
                .toArray();

            events.sort((a, b) => a.startTime.localeCompare(b.startTime));

            const courses = await db.courses.toArray();

            let html = '';
            for(const event of events) {
                const course = courses.find(c => c.id === event.courseId);
                if(course) {
                    html += `
                        <div class="flex items-center gap-3 p-3 rounded-lg" style="background: ${course.color}20; border-left: 3px solid ${course.color};">
                            <span class="font-mono font-bold text-sm">${event.startTime}</span>
                            <div class="flex-1">
                                <div class="font-bold" style="color: ${course.color};">${course.name}</div>
                                ${event.location ? `<div class="text-xs opacity-70"><i class="fas fa-map-marker-alt mr-1"></i>${event.location}</div>` : ''}
                            </div>
                        </div>
                    `;
                }
            }
            
            container.innerHTML = html || '<p class="text-sm opacity-70">Aucun cours aujourd\'hui</p>';
        }

        // ===== T√ÇCHES =====
        async function addTask() {
            const title = document.getElementById('taskInput').value;
            const priority = document.getElementById('taskPriority').value;
            const date = document.getElementById('taskDate').value;
            
            if(!title) return showNotification('‚ö†Ô∏è Titre manquant', 'warning');

            await db.tasks.add({
                title,
                priority,
                date,
                status: 'todo',
                completed: false
            });

            document.getElementById('taskInput').value = '';
            document.getElementById('taskDate').value = '';
            showNotification('‚úÖ T√¢che ajout√©e !');
            await renderTasks();
            updateStreak();
        }

        async function renderTasks() {
            const tasks = await db.tasks.toArray();
            
            const todoContainer = document.getElementById('tasks-todo');
            const inprogressContainer = document.getElementById('tasks-inprogress');
            const doneContainer = document.getElementById('tasks-done');
            
            todoContainer.innerHTML = '';
            inprogressContainer.innerHTML = '';
            doneContainer.innerHTML = '';

            const containers = {
                'todo': todoContainer,
                'inprogress': inprogressContainer,
                'done': doneContainer
            };

            tasks.forEach(task => {
                const priorityColor = task.priority === 'high' ? 'red' : task.priority === 'medium' ? 'yellow' : 'green';
                const div = document.createElement('div');
                div.className = `card p-3 rounded-lg cursor-move ${task.completed ? 'opacity-50' : ''}`;
                div.draggable = true;
                div.ondragstart = (e) => e.dataTransfer.setData('taskId', task.id);
                
                div.innerHTML = `
                    <div class="flex items-start gap-2">
                        <input type="checkbox" ${task.completed ? 'checked' : ''} onchange="toggleTask(${task.id})" class="mt-1">
                        <div class="flex-1">
                            <p class="font-medium text-sm ${task.completed ? 'line-through' : ''}">${task.title}</p>
                            ${task.date ? `<p class="text-xs opacity-60 mt-1">üìÖ ${new Date(task.date).toLocaleDateString('fr-FR')}</p>` : ''}
                        </div>
                        <button onclick="deleteTask(${task.id})" class="text-red-300 hover:text-red-500">
                            <i class="fas fa-times text-xs"></i>
                        </button>
                    </div>
                `;
                
                containers[task.status].appendChild(div);
            });

            // Drag & Drop
            ['tasks-todo', 'tasks-inprogress', 'tasks-done'].forEach(id => {
                const container = document.getElementById(id);
                container.ondragover = (e) => e.preventDefault();
                container.ondrop = async (e) => {
                    e.preventDefault();
                    const taskId = parseInt(e.dataTransfer.getData('taskId'));
                    const newStatus = id.replace('tasks-', '');
                    await db.tasks.update(taskId, { status: newStatus });
                    await renderTasks();
                };
            });

            updateTaskStats();
        }

        async function toggleTask(id) {
            const task = await db.tasks.get(id);
            await db.tasks.update(id, { completed: !task.completed });
            await renderTasks();
            if(!task.completed) {
                showNotification('üéâ T√¢che compl√©t√©e !');
                launchConfetti();
            }
        }

        async function deleteTask(id) {
            if(confirm('Supprimer cette t√¢che ?')) {
                await db.tasks.delete(id);
                showNotification('üóëÔ∏è T√¢che supprim√©e');
                await renderTasks();
            }
        }

        async function updateTaskStats() {
            const tasks = await db.tasks.toArray();
            const completed = tasks.filter(t => t.completed).length;
            const total = tasks.length;
            
            document.getElementById('tasks-completed').innerText = completed;
            document.getElementById('tasks-total').innerText = total;
        }

        // ===== STATISTIQUES =====
        let gradesChart, subjectsChart, progressChart;

        async function renderCharts() {
            const courses = await db.courses.toArray();
            const grades = await db.grades.toArray();

            // Chart 1: √âvolution des notes
            const ctx1 = document.getElementById('gradesChart');
            if(gradesChart) gradesChart.destroy();
            
            const sortedGrades = grades.sort((a, b) => new Date(a.date) - new Date(b.date));
            const labels = sortedGrades.map((g, i) => `Note ${i+1}`);
            const values = sortedGrades.map(g => g.value);

            gradesChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Notes',
                        data: values,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, max: 20 }
                    }
                }
            });

            // Chart 2: R√©partition par mati√®re
            const ctx2 = document.getElementById('subjectsChart');
            if(subjectsChart) subjectsChart.destroy();
            
            const courseNames = [];
            const courseAvgs = [];
            const courseColors = [];

            for(const course of courses) {
                const cGrades = await db.grades.where('courseId').equals(course.id).toArray();
                if(cGrades.length > 0) {
                    const avg = cGrades.reduce((a, b) => a + (b.value * (b.coef || 1)), 0) / cGrades.reduce((a, b) => a + (b.coef || 1), 0);
                    courseNames.push(course.name);
                    courseAvgs.push(avg.toFixed(2));
                    courseColors.push(course.color || '#3b82f6');
                }
            }

            subjectsChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: courseNames,
                    datasets: [{
                        label: 'Moyenne',
                        data: courseAvgs,
                        backgroundColor: courseColors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, max: 20 }
                    }
                }
            });

            // Chart 3: Progression mensuelle (simulation)
            const ctx3 = document.getElementById('progressChart');
            if(progressChart) progressChart.destroy();

            progressChart = new Chart(ctx3, {
                type: 'line',
                data: {
                    labels: ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Juin'],
                    datasets: [{
                        label: 'Moyenne mensuelle',
                        data: [12, 13.5, 14, 15, 14.5, 16],
                        borderColor: 'rgb(139, 92, 246)',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, max: 20 }
                    }
                }
            });

            // Insights
            renderInsights();
        }

        async function renderInsights() {
            const container = document.getElementById('insights');
            const courses = await db.courses.toArray();
            const grades = await db.grades.toArray();
            
            let insights = [];

            // Meilleure mati√®re
            let bestCourse = null;
            let bestAvg = 0;
            for(const course of courses) {
                const cGrades = await db.grades.where('courseId').equals(course.id).toArray();
                if(cGrades.length > 0) {
                    const avg = cGrades.reduce((a, b) => a + (b.value * (b.coef || 1)), 0) / cGrades.reduce((a, b) => a + (b.coef || 1), 0);
                    if(avg > bestAvg) {
                        bestAvg = avg;
                        bestCourse = course.name;
                    }
                }
            }
            if(bestCourse) insights.push(`üèÜ Ta meilleure mati√®re : <strong>${bestCourse}</strong> (${bestAvg.toFixed(2)}/20)`);

            // Nombre total de notes
            insights.push(`üìä Tu as <strong>${grades.length}</strong> notes enregistr√©es`);

            // Encouragement
            if(bestAvg >= 15) insights.push(`üåü Excellent travail ! Continue comme √ßa !`);
            else if(bestAvg >= 12) insights.push(`üí™ Bon effort ! Tu peux encore mieux faire !`);
            else insights.push(`üìö Accroche-toi, la pers√©v√©rance paie toujours !`);

            container.innerHTML = insights.map(i => `<p class="text-sm p-3 rounded-lg card">${i}</p>`).join('');
        }

        // ===== DASHBOARD =====
        async function updateDashboard() {
            await updateTodaySchedule();
            await updateStreak();
        }

        async function updateStreak() {
            // Simulation de s√©rie bas√©e sur les t√¢ches compl√©t√©es
            const tasks = await db.tasks.toArray();
            const completed = tasks.filter(t => t.completed).length;
            const streak = Math.floor(completed / 3); // 1 jour par 3 t√¢ches
            document.getElementById('streak-count').innerText = streak;
        }

        // ===== QUICK ACTIONS =====
        function quickAddCourse() {
            openCourseModal();
        }

        function quickAddGrade() {
            showTab('grades');
            document.querySelector('.nav-item:nth-child(4)').classList.add('active');
        }

        function quickAddTask() {
            showTab('tasks');
            document.querySelector('.nav-item:nth-child(6)').classList.add('active');
        }

        function openQuickMenu() {
            openSettings();
        }

        // ===== EXPORT/IMPORT =====
        async function exportAllData() {
            const data = {
                courses: await db.courses.toArray(),
                grades: await db.grades.toArray(),
                tasks: await db.tasks.toArray(),
                settings: await db.settings.toArray()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'mystudyspace-backup.json';
            a.click();
            showNotification('üíæ Donn√©es export√©es !');
        }

        function exportData() {
            exportAllData();
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                const text = await file.text();
                const data = JSON.parse(text);
                
                if(confirm('Importer ces donn√©es ? (Cela √©crasera vos donn√©es actuelles)')) {
                    await db.courses.clear();
                    await db.grades.clear();
                    await db.tasks.clear();
                    await db.settings.clear();
                    
                    await db.courses.bulkAdd(data.courses || []);
                    await db.grades.bulkAdd(data.grades || []);
                    await db.tasks.bulkAdd(data.tasks || []);
                    await db.settings.bulkAdd(data.settings || []);
                    
                    showNotification('‚úÖ Donn√©es import√©es !');
                    await refreshUI();
                    location.reload();
                }
            };
            input.click();
        }

        async function resetApp() {
            if(confirm('‚ö†Ô∏è ATTENTION : Cela supprimera TOUTES vos donn√©es. Continuer ?')) {
                if(confirm('Es-tu vraiment s√ªr ? Cette action est irr√©versible.')) {
                    await db.delete();
                    location.reload();
                }
            }
        }

        // ===== NOTIFICATIONS & CONFETTI =====
        function showNotification(message, type = 'success') {
            const notif = document.createElement('div');
            notif.className = 'notification';
            notif.innerHTML = `<p class="text-sm font-medium">${message}</p>`;
            document.body.appendChild(notif);

            setTimeout(() => {
                notif.style.opacity = '0';
                setTimeout(() => notif.remove(), 300);
            }, 3000);
        }

        function launchConfetti() {
            const confettiToggle = document.getElementById('confettiToggle');
            if(!confettiToggle || !confettiToggle.checked) return;

            const colors = ['#3b82f6', '#8b5cf6', '#ec4899', '#22c55e', '#f59e0b'];
            for(let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + 'vw';
                    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                    document.body.appendChild(confetti);
                    setTimeout(() => confetti.remove(), 3000);
                }, i * 30);
            }
        }

        // ===== REFRESH UI =====
        async function refreshUI() {
            await renderCourses();
            await renderGrades();
            await renderTasks();
            await updateDashboard();
        }

        // ===== INIT =====
        (async () => {
            await loadSettings();
            await initSchedule();
            await refreshUI();
            updateGreeting();
            
            // Style des boutons filtres
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => {
                        b.style.background = 'var(--border)';
                        b.style.color = 'var(--text-main)';
                    });
                    this.style.background = 'var(--primary)';
                    this.style.color = 'white';
                });
            });
            
            // Active le premier filtre
            document.querySelector('.filter-btn').style.background = 'var(--primary)';
            document.querySelector('.filter-btn').style.color = 'white';
        })();
    </script>
</body>
</html>
